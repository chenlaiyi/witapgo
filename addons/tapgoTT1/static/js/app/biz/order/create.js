define(["core","tpl","biz/plugin/diyform","biz/order/invoice"],function(y,e,c,t){var k={params:{orderid:0,goods:[],coupon_goods:[],merchs:[],iscarry:0,isverify:0,isvirtual:0,isonlyverifygoods:0,dispatch_price:0,deductenough_enough:0,merch_deductenough_enough:0,deductenough_money:0,merch_deductenough_money:0,addressid:0,contype:0,couponid:0,card_id:0,card_price:0,wxid:0,wxcardid:0,wxcode:"",isnodispatch:0,nodispatch:"",packageid:0,card_packageid:0,new_area:"",address_street:"",discountprice:0,isdiscountprice:0,lotterydiscountprice:0,gift_price:0,giftid:0,show_card:!1,city_express_state:!1,include_dispath:0,oldrealprice:"0",olddeductcredit:"0",olddeductcredit2:"0",olddeduct:"0",dispatchprice:"0",march_enoughprice:"0",enoughprice:"0"},invoice_info:{},init:function(e,t,r){var i=k.getCookie("company"),a=k.getCookie("entity"),d=decodeURIComponent(k.getCookie("number")),c=decodeURIComponent(k.getCookie("title"));if(t&&t.title&&(k.invoice_info=t),(d||c)&&(k.invoice_info={company:"true"===i,entity:"true"===a,number:d,title:c}),c){var o="["+(1==k.invoice_info.entity?"纸质":"电子")+"] ";o+=k.invoice_info.title,o+=" （"+(1==k.invoice_info.company?"单位":"个人")+(k.invoice_info.number?": "+k.invoice_info.number:"")+"）",$("#invoicename").val(o)}k.params=$.extend(k.params,e||{}),r&&k.params.isverify&&(k.params.iscarry=r),k.params.couponid=0,$("#coupondiv").find(".fui-cell-label").html("优惠券"),$("#coupondiv").find(".fui-cell-info").html("");var s=y.getNumber($(".discountprice").val()),u=y.getNumber($(".isdiscountprice").val());0<s&&$(".discount").show(),0<u&&$(".isdiscount").show(),k.params.city_express_state?($(".fui-cell-group.city_express.external").show(),$("#showdispatchprice div:first-child").text("同城运费")):($(".fui-cell-group.city_express.external").hide(),$("#showdispatchprice div:first-child").text("运费"));var n=!1;if(void 0!==window.selectedAddressData)n=window.selectedAddressData;else if(void 0!==window.editAddressData)(n=window.editAddressData).address=n.areas.replace(/ /gi,"")+" "+n.address;else{var l=k.getCookie("id"),m=k.getCookie("mobile"),p=decodeURIComponent(k.getCookie("realname")),h=decodeURIComponent(k.getCookie("addressd"));0<l&&(n={id:l,mobile:m,address:h,realname:p})}n&&(k.params.addressid=n.id,$("#addressInfo .has-address").show(),$("#addressInfo .no-address").hide(),$("#addressInfo .icon-dingwei").show(),$("#addressInfo .realname").html(n.realname),$("#addressInfo .mobile").html(n.mobile),$("#addressInfo .address").html(n.address),$("#addressInfo a").attr("href",y.getUrl("member/address/selector")),$("#addressInfo a").click(function(){window.orderSelectedAddressID=n.id}));var g=!(document.cookie="id=0");if(void 0===window.selectedStoreData&&(window.selectedStoreData=null==JSON.parse(localStorage.getItem("selectedStoreData"))?void 0:JSON.parse(localStorage.getItem("selectedStoreData"))),void 0!==window.selectedStoreData){g=window.selectedStoreData,k.params.storeid=g.id;var f="#carrierInfo";1==k.params.isforceverifystore&&1==k.params.isverify&&(f="#forceStoreInfo"),$(f+" .storename").html(g.storename),$(f+" .realname").html(g.realname),$(f+"_mobile").html(g.mobile),$(f+" .address").html(g.address),$(f).find(".no-address").css("display","none"),$(f).find(".has-address").css("display","block"),$(f).find(".fui-list-media").css("display","block"),$(f).find(".text").css("display","block"),$(f).find(".title").css("display","block"),$(f).find(".subtitle").css("display","block"),k.params.iscarry=1,$("#carrierTab").find("a:eq(1)").addClass("active"),$("#carrierTab").find("a:eq(0)").removeClass("active"),$(".exchange-withpostage").hide(),$(".exchange-withoutpostage").show(),$("#addressInfo").hide(),$("#carrierInfo").show(),$("#memberInfo").show(),$("#showdispatchprice").hide(),k.caculate(),localStorage.removeItem("selectedStoreData")}if(FoxUI.tab({container:$("#carrierTab"),handlers:{tab1:function(){$(".exchange-withoutpostage").hide(),$(".exchange-withpostage").show(),k.params.iscarry=0,$("#addressInfo").show(),$("#carrierInfo").hide(),$("#memberInfo").hide(),$("#showdispatchprice").show(),k.caculate()},tab2:function(){k.params.iscarry=1,$(".exchange-withpostage").hide(),$(".exchange-withoutpostage").show(),$("#addressInfo").hide(),$("#carrierInfo").show(),$("#memberInfo").show(),$("#showdispatchprice").hide(),k.caculate()}}}),0<(d=$(".fui-number")).length){var _=d.data("maxbuy")||0,v=d.data("goodsid"),w=d.data("minbuy")||0,b=d.data("unit")||"件";d.numbers({max:_,min:w,minToast:"{min}"+b+"起售",maxToast:"最多购买{max}"+b,callback:function(e){if($.each(k.params.goods,function(){if(this.goodsid==v)return this.total=e,!1}),$.each(k.params.coupon_goods,function(){if(this.goodsid==v)return this.total=e,!1}),k.params.contype=0,k.params.couponid=0,k.params.wxid=0,k.params.wxcardid="",k.params.wxcode="",!(k.params.couponmerchid=0)===k.caculate()){$("#coupondiv").find(".fui-cell-label").html("优惠券"),$("#coupondiv").find(".fui-cell-info").html(""),$("#goodscount").html(e);var t=y.getNumber(d.closest(".goods-item").find(".marketprice").html())*e;$(".goodsprice").html(y.number_format(t,2))}}})}$("#deductcredit").click(function(){k.calcCouponPrice(),k.calcCardPrice()}),$("#deductcredit2").click(function(){k.calcCouponPrice(),k.calcCardPrice()}),k.bindCoupon(),k.bindCard(),$(document).click(function(){$("input,select,textarea").each(function(){$(this).attr("data-value",$(this).val())}),$(":checkbox,:radio").each(function(){$(this).attr("data-checked",$(this).prop("checked"))})}),$("input,select,textarea").each(function(){var e=$(this).attr("data-value")||"";""!=e&&$(this).val(e)}),$(":checkbox,:radio").each(function(){var e="true"===$(this).attr("data-checked");$(this).prop("checked",e)}),$(".buybtn").click(function(){k.submit(this,e.token)}),k.caculate(),$(".fui-cell-giftclick").click(function(){k.giftPicker=new FoxUIModal({content:$("#gift-picker-modal").html(),extraClass:"picker-modal",maskClick:function(){k.giftPicker.close()}}),k.giftPicker.container.find(".btn-danger").click(function(){k.giftPicker.close()}),k.giftPicker.show();var e=$("#giftid").val();$(".gift-item").each(function(){$(this).val()==e&&$(this).prop("checked","true")}),$(".gift-item").on("click",function(){$.ajax({url:y.getUrl("goods/detail/querygift",{id:$(this).val()}),cache:!0,success:function(e){0<(e=window.JSON.parse(e)).status&&($("#giftid").val(e.result.id),$("#gifttitle").text(e.result.title))}})})}),$(".show-allshop-btn").click(function(){$(this).closest(".store-container").addClass("open")}),k.initaddress(),$(".card-list-modal").click(function(){$(".card-list-modal").removeClass("in"),$(".card-list-group").removeClass("in")})},getCookie:function(e){for(var t=e+"=",r=document.cookie.split(";"),i=0;i<r.length;i++){for(var a=r[i];" "==a.charAt(0);)a=a.substring(1);if(-1!=a.indexOf(t))return a.substring(t.length,a.length)}return""},giftPicker:function(){k.giftPicker=new FoxUIModal({content:$("#option-picker-modal").html(),extraClass:"picker-modal",maskClick:function(){k.packagePicker.close()}})},bindCard:function(){$("#selectCard").unbind("click").click(function(){$("#cardloading").show(),$("#showdispatchprice div:first-child").text("同城运费"),y.json("membercard/query",{money:0,type:0,goods:k.params.goods,discountprice:k.params.discountprice,isdiscountprice:k.params.isdiscountprice},function(t){$("#cardloading").hide(),0<t.result.cards.length||0<t.result.wxcards.length?($("#selectCard").show().find(".badge").html(t.result.cards.length).show(),$("#selectCard").find(".text-danger").hide(),require(["../addons/tapgo_ttv2/plugin/membercard/static/js/picker.js"],function(e){e.show({card_id:k.params.card_id,cards:t.result.cards,onCancel:function(){k.params.card_id=0,$("#selectCard").find(".fui-cell-label").html("不使用会员卡"),$("#selectCard").find(".fui-cell-info").html(""),k.calcCardPrice()},onCaculate:function(){k.params.card_id=0,k.caculate()},onSelected:function(e){k.params.card_id=e.card_id,k.params.card_price=e.card_price,$("#selectCard").find(".fui-cell-label").html("已选择"),$("#selectCard").find(".fui-cell-info").html(e.card_name),$("#selectCard").data(e),k.calcCardPrice()}})})):(FoxUI.toast.show("未找到会员卡!"),k.hideCard())},!1,!0)})},hideCard:function(){$("#selectCard").hide(),$("#selectCard").find(".badge").html("0").hide(),$("#selectCard").find(".text").show()},hideCoupon:function(){$("#coupondiv").hide(),$("#coupondiv").find(".badge").html("0").hide(),$("#coupondiv").find(".text").show()},caculate:function(){var e=y.getNumber($(".goodsprice").html())-y.getNumber($(".taskdiscountprice").val())-y.getNumber($(".lotterydiscountprice").val())-y.getNumber($(".discountprice").val())-y.getNumber($(".isdiscountprice").val())-y.getNumber($("#taskcut").val());return 0<$(".shownum").length&&(e=y.getNumber($(".marketprice").html())*parseInt($(".shownum").val())),0==k.params.fromcart&&1==k.params.goods.length&&(k.params.goods[0].total=parseInt($(".shownum").val())),void 0!==window.selectedAddressData&&(k.params.addressid=window.selectedAddressData.id),y.json("order/create/caculate",{totalprice:e,addressid:k.params.addressid,dispatchid:k.params.dispatchid,dflag:k.params.iscarry,goods:k.params.goods,packageid:k.params.card_packageid,liveid:k.params.liveid,card_id:k.params.card_id,giftid:k.params.giftid,goods_dispatch:k.params.goods_dispatch},function(e){if(console.log("caculate",e),0==e.status)return $(".shownum").val(1<$(".shownum").val()?$(".shownum").val()-1:$(".shownum").val()),$(".shownum").data("value",1<$(".shownum").data("value")?$(".shownum").data("value")-1:$(".shownum").data("value")),FoxUI.toast.show(e.result.message),!1;if(1==e.status){if(k.params.oldrealprice=e.result.realprice,k.params.olddeduct=e.result.deductcredit,k.params.olddeductcredit=e.result.deductmoney,0==e.result.include_dispath&&(e.result.realprice-e.result.price<e.result.deductcredit2?e.result.deductcredit2=e.result.realprice-e.result.price:e.result.deductcredit2=e.result.deductcredit2),k.params.olddeductcredit2=y.number_format(e.result.deductcredit2,2),k.params.include_dispath=e.result.include_dispath,$.each(e.result.goods,function(e,r){$.each(k.params.coupon_goods,function(e,t){r.goodsid==t.goodsid&&(k.params.coupon_goods[e].discounttype=r.discounttype,k.params.coupon_goods[e].discountunitprice=r.discountunitprice,k.params.coupon_goods[e].isdiscountunitprice=r.isdiscountunitprice)})}),1==e.result.goods.length&&0==e.result.isdiscountprice&&e.result.goods[0].discountunitprice){var t=e.result.goods[0].discountunitprice*e.result.goods[0].total;$(".discount #showdiscountprice").html(y.number_format(t,2)),$(".discount #discountprice").val(t)}var r=parseInt($(".shownum").val()),i=k.params.goods[0].goodsid+"_"+r+"_isgift";if(0==k.params.fromcart&&1==e.result.isgift&&0==k.params.giftid&&1!=k.getCookie(i)){k.params.goods[0].goodsid,k.params.goods[0].optionid,k.params.giftid,k.params.liveid;document.cookie=i+"=1"}else document.cookie=i+"=-1";k.params.iscarry?$(".dispatchprice").html("0.00"):$(".dispatchprice").html(y.number_format(e.result.price,2)),e.result.taskdiscountprice&&$("#taskdiscountprice").val(y.number_format(e.result.taskdiscountprice,2)),e.result.lotterydiscountprice&&$("#lotterydiscountprice").val(y.number_format(e.result.lotterydiscountprice,2)),e.result.discountprice&&$("#discountprice").val(y.number_format(e.result.discountprice,2)),e.result.buyagain&&($("#buyagain").val(y.number_format(e.result.buyagain,2)),$("#showbuyagainprice").html(y.number_format(e.result.buyagain,2)).parents(".fui-cell").show()),e.result.isdiscountprice&&$("#isdiscountprice").val(y.number_format(e.result.isdiscountprice,2)),e.result.deductcredit&&($("#deductcredit_money").html(y.number_format(e.result.deductmoney,2)),$("#deductcredit_info").html(e.result.deductcredit),$("#deductcredit").data("credit",e.result.deductcredit),$("#deductcredit").data("money",y.number_format(e.result.deductmoney,2))),e.result.deductcredit2&&($("#deductcredit2_money").html(e.result.deductcredit2),$("#deductcredit2").data("credit2",e.result.deductcredit2)),0<e.result.include_dispath?$("#include_dispath").show():$("#include_dispath").hide(),0<e.result.seckillprice?($("#seckillprice").show(),$("#seckillprice_money").html(y.number_format(e.result.seckillprice,2))):($("#seckillprice").hide(),$("#seckillprice_money").html(0)),0<e.result.couponcount?($("#coupondiv").show().find(".badge").html(e.result.couponcount).show(),$("#coupondiv").find(".text").hide()):(k.params.couponid=0,$("#coupondiv").hide().find(".badge").html(0).hide()),0<e.result.merch_deductenough_money?($("#merch_deductenough").show(),$("#merch_deductenough_money").html(y.number_format(e.result.merch_deductenough_money,2)),$("#merch_deductenough_enough").html(y.number_format(e.result.merch_deductenough_enough,2))):($("#merch_deductenough").hide(),$("#merch_deductenough_money").html("0.00"),$("#merch_deductenough_enough").html("0.00")),0<e.result.deductenough_money?($("#deductenough").show(),$("#deductenough_money").html(y.number_format(e.result.deductenough_money,2)),$("#deductenough_enoughdeduct").html(y.number_format(e.result.deductenough_money,2)),$("#deductenough_enough").html(y.number_format(e.result.deductenough_enough,2))):($("#deductenough").hide(),$("#deductenough_money").html("0.00"),$("#deductenough_enoughdeduct").html("0.00"),$("#deductenough_enough").html("0.00")),e.result.merchs&&(k.params.merchs=e.result.merchs),1==e.result.isnodispatch?(k.isnodispatch=1,k.nodispatch=e.result.nodispatch,FoxUI.toast.show(k.nodispatch)):(k.isnodispatch=0,k.nodispatch=""),k.params.city_express_state=e.result.city_express_state,k.params.city_express_state?($(".fui-cell-group.city_express.external").show(),$("#showdispatchprice div:first-child").text("同城运费")):($(".fui-cell-group.city_express.external").hide(),$("#showdispatchprice div:first-child").text("运费")),0<k.params.liveid&&0==k.params.card_id&&($(".goodsprice").html(y.number_format(e.result.realprice-e.result.price,2)),$(".marketprice").html(y.number_format(e.result.realprice-e.result.price,2))),k.calcCouponPrice(),k.calcCardPrice()}},!0,!0),!0},totalPrice:function(e){var t=y.getNumber($(".goodsprice").html());0<k.params.packageid||0<k.params.card_packageid?(t=y.getNumber($(".bigprice-packageprice").html()),$("#showpackageprice").show()):$("#showpackageprice").hide();var r=t-y.getNumber($(".showtaskdiscountprice").html())-y.getNumber($(".showlotterydiscountprice").html())-y.getNumber($(".showdiscountprice").html())-y.getNumber($(".showisdiscountprice").html())-e-y.getNumber($("#buyagain").val()),i=y.getNumber($("#taskcut").val()),a=y.getNumber($(".dispatchprice").html()),d=0;0<$("#merch_deductenough_money").length&&""!=$("#merch_deductenough_money").html()&&(d=y.getNumber($("#merch_deductenough_money").html()),k.params.march_enoughprice=d);var c=0;0<$("#deductenough_money").length&&""!=$("#deductenough_money").html()&&(c=y.getNumber($("#deductenough_money").html()),k.params.enoughprice=c);0<k.params.card_packageid&&0==k.params.card_id&&(r-=y.getNumber($(".packageprice").html())),r=r-d-c+a-i,k.params.dispatchprice=a;var o=0,s=0;if(k.params.oldrealprice=r,$("#deductcredit").prop("checked")){if(o=y.getNumber($("#deductcredit").data("money")),$("#deductcredit_money").html(y.number_format(o,2)),0<$("#deductcredit2").length){var u=y.getNumber($("#deductcredit2").data("credit2"));if(0<=r-o){var n=0==k.params.include_dispath?y.number_format(r-o-a,2):y.number_format(k.params.oldrealprice-o,2);"number"==typeof(n=100*n<100*u?n:u)&&(n=y.number_format(n,2)),$("#deductcredit2_money").parent().parent().show(),$("#deductcredit2_money").html(n),$("#deductcredit2").prop("checked")&&(s=n),n<=0&&($("#deductcredit2_money").parent().parent().hide(),$("#deductcredit2").prop("checked",!1))}}}else $("#deductcredit").prop("checked")||(0<$("#deductcredit").length&&($("#deductcredit_money").html(y.number_format(k.params.olddeductcredit,2)),$("#deductcredit").data("credit",y.number_format(k.params.olddeductcredit,2))),0<$("#deductcredit2").length&&($("#deductcredit2_money").parent().parent().show(),$("#deductcredit2_money").html(k.params.olddeductcredit2)),$("#deductcredit2").prop("checked")&&(s=$("#deductcredit2").data("credit2")));var l=0;return 0<$("#seckillprice_money").length&&""!=$("#seckillprice_money").html()&&(l=y.getNumber($("#seckillprice_money").html())),(r=(r=(r+"").replace(/,/g,""))-(o=(o+"").replace(/,/g,""))-(s=(s+"").replace(/,/g,""))-(l=(l+"").replace(/,/g,"")))<=0&&(r=0),0<k.params.gift_price&&t>parseInt(k.params.gift_price)?($(".giftdiv").show(),$("#giftid").val(k.params.giftid)):($(".giftdiv").hide(),$("#giftid").val(0)),$(".totalprice").html(y.number_format(r)),(0<k.params.packageid||0<k.params.card_packageid)&&$(".total-packageid").html(y.number_format(r)),k.bindCoupon(),k.bindCard(),r},calcCouponPrice:function(){var e=y.getNumber($(".goodsprice").html()),i=0,t=y.getNumber($(".taskdiscountprice").val()),r=y.getNumber($("#taskcut").val()),a=y.getNumber($(".lotterydiscountprice").val()),d=y.getNumber($(".discountprice").val()),c=y.getNumber($(".isdiscountprice").val()),o=y.getNumber($("#carddeduct_money").html());if(0==k.params.couponid&&0==k.params.wxid)return $("#coupondeduct_div").hide(),$("#coupondeduct_text").html(""),$("#coupondeduct_money").html("0"),0<t?($(".showtaskdiscountprice").html($(".taskdiscountprice").val()),$(".istaskdiscount").show()):$(".istaskdiscount").hide(),0<r?($(".showtaskcut").html($("#taskcut").val()),$(".taskcut").show()):$(".istaskdiscount").hide(),0<a?($(".showlotterydiscountprice").html($(".lotterydiscountprice").val()),$(".islotterydiscount").show()):$(".islotterydiscount").hide(),0<d?($(".showdiscountprice").html($(".discountprice").val()),$(".discount").show()):$(".discount").hide(),0<c?($(".showisdiscountprice").html($(".isdiscountprice").val()),$(".isdiscount").show()):$(".isdiscount").hide(),0<o?$("#carddeduct_div").show():$("#carddeduct_div").hide(),0<o?k.totalPrice(o):k.totalPrice(0);y.json("order/create/getcouponprice",{goods:k.params.coupon_goods,goodsprice:e,real_price:k.realPrice(),couponid:k.params.couponid,contype:k.params.contype,wxid:k.params.wxid,wxcardid:k.params.wxcardid,wxcode:k.params.wxcode,discountprice:d,isdiscountprice:c,addressid:k.params.addressid},function(e){if(1==e.status){console.log("getcouponprice优惠券",e),$("#coupondeduct_text").html(e.result.coupondeduct_text),k.params.include_dispath=e.result.include_dispatch,1==e.result.include_dispatch?k.params.olddeductcredit2=y.number_format(e.result.deductcredit2+k.params.dispatchprice-k.params.enoughprice-k.params.march_enoughprice,2):k.params.enoughprice>e.result.deductcredit2||k.params.march_enoughprice>e.result.deductcredit2?k.params.olddeductcredit2=y.number_format(e.result.deductcredit2,2):k.params.olddeductcredit2=y.number_format(e.result.deductcredit2-k.params.enoughprice-k.params.march_enoughprice,2),k.params.olddeduct=e.result.deductcredit,k.params.olddeductcredit=e.result.deductmoney,$("#deductcredit2").data("credit2",k.params.olddeductcredit2),$("#deductcredit2_money").html(k.params.olddeductcredit2),$("#deductcredit_info").html(k.params.olddeduct),$("#deductcredit_money").html(k.params.olddeductcredit),$("#deductcredit").data("credit",k.params.olddeductcredit).data("money",k.params.olddeductcredit),i=e.result.deductprice;var t=e.result.discountprice,r=e.result.isdiscountprice;0<t?($(".showdiscountprice").html(t),$(".discount").show()):($(".showdiscountprice").html(0),$(".discount").hide()),0<r?($(".showisdiscountprice").html(r),$(".isdiscount").show()):($(".showisdiscountprice").html(0),$(".isdiscount").hide()),0<i?($("#coupondeduct_div").show(),$("#coupondeduct_money").html(y.number_format(i,2))):($("#coupondeduct_div").hide(),$("#coupondeduct_text").html(""),$("#coupondeduct_money").html("0"))}else 0<d?($(".showdiscountprice").html($(".discountprice").val()),$(".discount").show()):$(".discount").hide(),0<c?($(".showisdiscountprice").html($(".isdiscountprice").val()),$(".isdiscount").show()):$(".isdiscount").hide(),i=0;return 0<o?k.totalPrice(o+i):k.totalPrice(i)},!0,!0)},calcCardPrice:function(){if(k.params.show_card){var e=y.getNumber($(".goodsprice").html());0<k.params.packageid&&(e=y.getNumber($(".bigprice-packageprice").html())),$("#carddeduct_div").hide(),$("#carddeduct_text").html(""),$("#carddeduct_money").html("0");var d=0,c=(y.getNumber($(".taskdiscountprice").val()),y.getNumber($("#taskcut").val()),y.getNumber($(".lotterydiscountprice").val()),y.getNumber($(".discountprice").val())),o=y.getNumber($(".isdiscountprice").val()),s=y.getNumber($("#coupondeduct_money").html()),u=(y.getNumber($("#deductenough_enough").html()),y.getNumber($("#merch_deductenough_enough").html())),n="";if(0==k.params.card_id)return 0<k.params.card_packageid?$("#showpackageprice").show():$("#showpackageprice").hide(),$("#taskcut").val(k.params.taskcut),$(".showtaskcut").html(k.params.taskcut),0<k.params.taskcut&&(k.params.discountprice=0,k.params.isdiscountprice=0,k.params.deductenough_enough=0,k.params.merch_deductenough_enough=0,$("#deductenough_enough").html("0.00"),$("#merch_deductenough_enough").html("0.00"),$("#deductenough_money").html("0.00"),$("#merch_deductenough_money").html("0.00"),$("#deductenough").hide(),$("#merch_deductenough").hide()),0<k.params.lotterydiscountprice&&(k.params.discountprice=0,k.params.isdiscountprice=0),0<k.params.card_packageid&&(k.params.discountprice=0,k.params.isdiscountprice=0,$("#showdiscountprice").html("0"),$("#discountprice").attr("value","0"),$(".discount").hide(),$("#showisdiscountprice").html("0"),$("#isdiscountprice").attr("value","0"),$(".isdiscount").hide(),$("#deductenough").hide(),$("#deductenough_money").html("0.00"),$("#deductenough_enoughdeduct").html("0.00"),$("#deductenough_enough").html("0.00"),$("#merch_deductenough").hide(),$("#merch_deductenough_money").html("0.00"),$("#merch_deductenough_enough").html("0.00")),0<k.params.liveid&&(k.params.discountprice=0,k.params.isdiscountprice=0),0<k.params.lotterydiscountprice&&$("#lotterydiscountprice").val(k.params.lotterydiscountprice),0<k.params.lotterydiscountprice&&$(".showlotterydiscountprice").html(k.params.lotterydiscountprice),y.getNumber($(".dispatchprice").html())<=0&&(k.params.iscarry?$(".dispatchprice").html("0.00"):$(".dispatchprice").html(y.number_format(k.params.dispatch_price,2))),0<k.params.discountprice&&($("#discountprice").attr("value",k.params.discountprice),$(".showdiscountprice").html(k.params.discountprice)),0<k.params.isdiscountprice&&($("#isdiscountprice").attr("value",k.params.isdiscountprice),$(".showisdiscountprice").html(k.params.isdiscountprice)),0<c||0<k.params.discountprice?$(".discount").show():$(".discount").hide(),0<o||0<k.params.isdiscountprice?$(".isdiscount").show():$(".isdiscount").hide(),k.params.city_express_state?($(".fui-cell-group.city_express.external").show(),$("#showdispatchprice div:first-child").text("同城运费")):($(".fui-cell-group.city_express.external").hide(),$("#showdispatchprice div:first-child").text("运费")),s?k.totalPrice(s):k.totalPrice(0);y.json("order/create/getcardprice",{goods:k.params.goods,goodsprice:e,card_id:k.params.card_id,liveid:k.params.liveid,card_price:k.params.card_price,deductenough_enough:k.params.deductenough_enough,merch_deductenough_enough:k.params.merch_deductenough_enough,dispatch_price:$(".dispatchprice").html(),lotterydiscountprice:k.params.lotterydiscountprice,taskcut:k.params.taskcut,discountprice:k.params.discountprice,isdiscountprice:k.params.isdiscountprice,goods_dispatch:k.params.goods_dispatch},function(e){if(console.log(e,"getcardprice会员卡接口"),1==e.status){$("#discountprice").attr("value",e.result.discountprice),$("#isdiscountprice").attr("value",e.result.isdiscountprice);var t=e.result.discountprice,r=e.result.isdiscountprice;0<t?($(".showdiscountprice").html(t),$(".discount").show()):($(".showdiscountprice").html(0),$(".discount").hide()),0<r?($(".showisdiscountprice").html(r),$(".isdiscount").show()):($(".showisdiscountprice").html(0),$(".isdiscount").hide()),$("#carddeduct_text").html(e.result.carddeduct_text),d=e.result.carddeductprice,n=e.result.cardname,$("#selectCard").find(".fui-cell-label").html("已选择"),$("#selectCard").find(".fui-cell-info").html(n),$(".islotterydiscount").hide();var i=e.result.dispatch_price;1==k.params.iscarry&&0<i&&(i=0),$(".dispatchprice").html(y.number_format(i,2)),0<d&&($("#carddeduct_div").show(),$("#carddeduct_money").html(y.number_format(d,2))),$("#taskcut").val(y.number_format(e.result.taskcut,2)),$(".showtaskcut").html(y.number_format(e.result.taskcut,2)),0<e.result.taskcut?$(".taskcut").show():$(".taskcut").hide(),$("#lotterydiscountprice").val(y.number_format(e.result.lotterydiscountprice,2)),$(".showlotterydiscountprice").html(y.number_format(e.result.lotterydiscountprice,2)),e.result.deductcredit&&($("#deductcredit_money").html(y.number_format(e.result.deductmoney,2)),$("#deductcredit_info").html(e.result.deductcredit),$("#deductcredit").data("credit",e.result.deductcredit),$("#deductcredit").data("money",y.number_format(e.result.deductmoney,2))),e.result.deductcredit2&&($("#deductcredit2_money").html(e.result.deductcredit2),$("#deductcredit2").data("credit2",e.result.deductcredit2)),0==e.result.dispatch_price&&1==e.result.shipping?$("#showdispatchprice div:first-child").html("运费(<span style='color: #ff0000'>会员卡包邮</span>)"):k.params.city_express_state?($(".fui-cell-group.city_express.external").show(),$("#showdispatchprice div:first-child").text("同城运费")):($(".fui-cell-group.city_express.external").hide(),$("#showdispatchprice div:first-child").text("运费"));var a=y.getNumber($(".packageprice").html());0<k.params.card_packageid&&0<a||a<=0?$("#showpackageprice").hide():$("#showpackageprice").show(),0<e.result.deductenough_money?($("#deductenough").show(),$("#deductenough_money").html(y.number_format(e.result.deductenough_money,2)),$("#deductenough_enoughdeduct").html(y.number_format(e.result.deductenough_money,2)),$("#deductenough_enough").html(y.number_format(e.result.deductenough_enough,2))):($("#deductenough").hide(),$("#deductenough_money").html("0.00"),$("#deductenough_enoughdeduct").html("0.00"),$("#deductenough_enough").html("0.00")),e.result.totalprice<u&&($("#merch_deductenough").hide(),$("#merch_deductenough_money").html("0.00"),$("#merch_deductenough_enough").html("0.00")),0<k.params.liveid&&($(".goodsprice").html(y.number_format(e.result.goodsprice,2)),$(".marketprice").html(y.number_format(e.result.goodsprice,2)))}else 0<c?($(".showdiscountprice").html($(".discountprice").val()),$(".discount").show()):$(".discount").hide(),0<o?($(".showisdiscountprice").html($(".isdiscountprice").val()),$(".isdiscount").show()):$(".isdiscount").hide(),d=0;return 0<k.params.couponid&&k.calcCouponPrice(),0<s?k.totalPrice(d+s):k.totalPrice(d)},!0,!0)}},submit:function(e,t){var r=$(e),i=parseInt($("#giftid").val());if(k.params.mustbind,!r.attr("stop")){if(k.params.iscarry||k.params.isverify||k.params.isvirtual||k.params.isonlyverifygoods){if($(":input[name=carrier_realname]").isEmpty()&&0==$(":input[name=carrier_realname]").attr("data-set"))return void FoxUI.toast.show("请填写联系人");if($(":input[name=carrier_mobile]").isEmpty()&&0==$(":input[name=carrier_mobile]").attr("data-set"))return void FoxUI.toast.show("请填写联系电话");if(!$(":input[name=carrier_mobile]").isMobile()&&0==$(":input[name=carrier_mobile]").attr("data-set"))return void FoxUI.toast.show("联系电话需请填写11位手机号")}if(k.params.isonlyverifygoods){if(1==k.params.isforceverifystore&&0==k.params.storeid)return void FoxUI.toast.show("请选择核销门店")}else if(k.params.iscarry||k.params.isverify||k.params.isvirtual){if(k.params.iscarry&&0==k.params.storeid)return void FoxUI.toast.show("请选择自提点");if(1==k.params.isforceverifystore&&0==k.params.storeid)return void FoxUI.toast.show("请选择核销门店")}else{if(0==k.params.addressid)return void FoxUI.toast.show("请选择收货地址");if(1==k.isnodispatch)return void FoxUI.toast.show(k.nodispatch)}var a="";if(k.params.has_fields)if(!(a=c.getData(".diyform-container")))return;0==k.params.fromcart&&1==k.params.goods.length&&(k.params.goods[0].total=parseInt($(".shownum").val())),r.attr("stop",1);var d={orderid:k.params.orderid,id:k.params.id,goods:k.params.goods,card_id:k.params.card_id,giftid:i,gdid:k.params.gdid,liveid:k.params.liveid,diydata:a,dispatchtype:k.params.iscarry?1:0,fromcart:k.params.fromcart,carrierid:k.params.iscarry?k.params.storeid:0,addressid:k.params.iscarry?0:k.params.addressid,carriers:k.params.iscarry||k.params.isvirtual||k.params.isverify?{carrier_realname:$(":input[name=carrier_realname]").val(),carrier_mobile:$(":input[name=carrier_mobile]").val(),realname:$("#carrierInfo .realname").html(),mobile:$("#carrierInfo_mobile").html(),storename:$("#carrierInfo .storename").html(),address:$("#carrierInfo .address").html()}:"",remark:$("#remark").val(),officcode:$("#officcode").val(),deduct:0<$("#deductcredit").length&&$("#deductcredit").prop("checked")?1:0,deduct2:0<$("#deductcredit2").length&&$("#deductcredit2").prop("checked")?1:0,contype:k.params.contype,couponid:k.params.couponid,wxid:k.params.wxid,wxcardid:k.params.wxcardid,wxcode:k.params.wxcode,invoicename:$("#invoicename").val(),submit:!0,real_price:k.realPrice(),token:t,packageid:k.params.card_packageid,fromquick:k.params.fromquick,goods_dispatch:k.params.goods_dispatch};k.params.isverify&&k.params.isforceverifystore&&(d.carrierid=k.params.storeid),FoxUI.loader.show("mini"),y.json("order/create/submit",d,function(e){if(r.removeAttr("stop",1),0==e.status)return FoxUI.loader.hide(),void FoxUI.toast.show(e.result.message);if(-1==e.status)return FoxUI.loader.hide(),void FoxUI.alert(e.result.message);if(3==e.status)return FoxUI.loader.hide(),k.endtime=e.result.endtime||0,k.imgcode=e.result.imgcode||0,void require(["biz/member/account"],function(e){e.initQuick({action:"bind",backurl:btoa(location.href),endtime:k.endtime,imgcode:k.imgcode,success:function(){var e=k.params;e.refresh=!0,k.open(e)}})});document.cookie="number=",document.cookie="title=";var t=y.getUrl("order/pay",{id:e.result.orderid});y.options&&y.options.siteUrl&&(t=y.options.siteUrl+"app"+t.substr(1)),location.href=t},!1,!0)}},initaddress:function(e){var t=["foxui.picker"];k.params.new_area&&(t=["foxui.picker","foxui.citydatanew"]),require(t,function(){if($("#areas").cityPicker({title:"请选择所在城市",new_area:k.params.new_area,address_street:k.params.address_street,onClose:function(e){var t=$("#areas").attr("data-value"),r=t.split(" ");if(k.params.new_area&&$("#areas").attr("data-datavalue",t),k.params.new_area&&k.params.address_street){var i=r[1],a=r[2];i+="",a+="";var d=k.loadStreetData(i,a),c=$('<input type="text" id="street"  name="street" data-value="" value="" placeholder="所在街道"  class="fui-input" readonly=""/>'),o=$("#street").closest(".fui-cell-info");$("#street").remove(),o.append(c),c.cityPicker({title:"请选择所在街道",street:1,data:d,onClose:function(e){var t=$("#street").attr("data-value");$("#street").attr("data-datavalue",t)}})}}}),k.params.new_area&&k.params.address_street){var e=$("#areas").attr("data-value");if(e){var t=e.split(" "),r=t[1],i=t[2],a=k.loadStreetData(r,i);$("#street").cityPicker({title:"请选择所在街道",street:1,data:a})}}}),$(document).on("click","#btn-submit",function(){if(!$(this).attr("submit"))if($("#realname").isEmpty())FoxUI.toast.show("请填写收件人");else{var e=/(境外地区)+/.test($("#areas").val()),t=/(台湾)+/.test($("#areas").val()),r=/(澳门)+/.test($("#areas").val()),i=/(香港)+/.test($("#areas").val());if(e||t||r||i){if($("#mobile").isEmpty())return void FoxUI.toast.show("请填写手机号码")}else if(!$("#mobile").isMobile())return void FoxUI.toast.show("请填写正确手机号码");$("#areas").isEmpty()?FoxUI.toast.show("请填写所在地区"):$("#address").isEmpty()?FoxUI.toast.show("请填写详细地址"):($("#btn-submit").html("正在处理...").attr("submit",1),window.editAddressData={realname:$("#realname").val(),mobile:$("#mobile").val(),address:$("#address").val(),areas:$("#areas").val(),street:$("#street").val(),streetdatavalue:$("#street").attr("data-datavalue"),datavalue:$("#areas").attr("data-datavalue"),isdefault:$("#isdefault").is(":checked")?1:0},y.json("member/address/submit",{id:$("#addressid").val(),addressdata:window.editAddressData},function(e){$("#btn-submit").html("保存地址").removeAttr("submit"),window.editAddressData.id=e.result.addressid,1==e.status?(FoxUI.toast.show("保存成功!"),$("#addaddress").css("display","none"),window.location.reload()):FoxUI.toast.show(e.result.message)},!0,!0))}})},loadStreetData:function(e,t){var r="../addons/tapgo_ttv2/static/js/dist/area/list/"+e.substring(0,2)+"/"+e+".xml",i=k.loadXmlFile(r).childNodes[0].getElementsByTagName("county"),a=[];if(0<i.length)for(var d=0;d<i.length;d++){var c=i[d];if(c.getAttribute("code")==t)for(var o=c.getElementsByTagName("street"),s=0;s<o.length;s++){var u=o[s];a.push({text:u.getAttribute("name"),value:u.getAttribute("code"),children:[]})}}return a},bindCoupon:function(){$("#coupondiv").unbind("click").click(function(){$("#coupondiv").attr("is_open")||($("#coupondiv").attr("is_open",!0),$("#couponloading").show(),y.json("sale/coupon/util/query",{money:0,type:0,merchs:k.params.merchs,goods:k.params.goods},function(t){$("#couponloading").hide(),0<t.result.coupons.length||0<t.result.wxcards.length?($("#coupondiv").show().find(".badge").html(t.result.coupons.length+t.result.wxcards.length).show(),$("#coupondiv").find(".text").hide(),require(["biz/sale/coupon/picker"],function(e){e.show({couponid:k.params.couponid,coupons:t.result.coupons,wxcards:t.result.wxcards,onClose:function(){$("#coupondiv").removeAttr("is_open")},onCancel:function(){k.params.contype=0,k.params.couponid=0,k.params.wxid=0,k.params.wxcardid="",k.params.wxcode="",k.params.couponmerchid=0,$("#coupondiv").find(".fui-cell-label").html("优惠券"),$("#coupondiv").find(".fui-cell-info").html(""),k.calcCouponPrice(),$("#deductcredit").prop("checked")||$("#deductcredit2").prop("checked")||k.caculate()},onSelected:function(e){k.params.contype=e.contype,1==k.params.contype?(k.params.couponid=0,k.params.wxid=e.wxid,k.params.wxcardid=e.wxcardid,k.params.wxcode=e.wxcode,k.params.couponmerchid=e.merchid,$("#coupondiv").find(".fui-cell-label").html("已选择"),$("#coupondiv").find(".fui-cell-info").html(e.couponname),$("#coupondiv").data(e)):2==k.params.contype?(k.params.couponid=e.couponid,k.params.wxid=0,k.params.wxcardid="",k.params.wxcode="",k.params.couponmerchid=e.merchid,$("#coupondiv").find(".fui-cell-label").html("已选择"),$("#coupondiv").find(".fui-cell-info").html(e.couponname),$("#coupondiv").data(e)):(k.params.contype=0,k.params.couponid=0,k.params.wxid=0,k.params.wxcardid="",k.params.wxcode="",k.params.couponmerchid=0,$("#coupondiv").find(".fui-cell-label").html("优惠券"),$("#coupondiv").find(".fui-cell-info").html("")),k.calcCouponPrice()}})})):(FoxUI.toast.show("未找到优惠券!"),k.hideCoupon())},!1,!0))})},hideCoupon:function(){$("#coupondiv").hide(),$("#coupondiv").find(".badge").html("0").hide(),$("#coupondiv").find(".text").show(),$("#coupondiv").removeAttr("is_open")},loadXmlFile:function(e){var t=null;if(window.ActiveXObject)(t=new ActiveXObject("Microsoft.XMLDOM")).async=!1,t.load(e)||t.loadXML(e);else if(document.implementation&&document.implementation.createDocument){var r=new window.XMLHttpRequest;r.open("GET",e,!1),r.send(null),t=r.responseXML}else t=null;return t}};return $(document).on("click","#invoicename",function(){var e=$(this).data("type");t.open(k.invoice_info,function(e){k.invoice_info=e;var t="["+(1==k.invoice_info.entity?"纸质":"电子")+"] ";t+=k.invoice_info.title,t+=" （"+(1==k.invoice_info.company?"单位":"个人")+(k.invoice_info.number?": "+k.invoice_info.number:"")+"）",$("#invoicename").val(t)},e)}),k.realPrice=function(){var e=y.getNumber($(".goodsprice").html())-y.getNumber($(".showtaskdiscountprice").html())-y.getNumber($(".showlotterydiscountprice").html())-y.getNumber($(".showdiscountprice").html())-y.getNumber($(".showisdiscountprice").html())-y.getNumber($("#buyagain").val()),t=y.getNumber($("#taskcut").val()),r=(y.getNumber($("#deductenough_enough").html()),y.getNumber($("#merch_deductenough_enough").html()),y.getNumber($("#merch_deductenough_money").html())),i=y.getNumber($("#deductenough_money").html());r=0;0<$("#merch_deductenough_money").length&&""!=$("#merch_deductenough_money").html()&&(r=y.getNumber($("#merch_deductenough_money").html()));i=0;0<$("#deductenough_money").length&&""!=$("#deductenough_money").html()&&(i=y.getNumber($("#deductenough_money").html()));0<k.params.card_packageid&&0==k.params.card_id&&(e-=y.getNumber($(".packageprice").html()));k.params.show_card&&(e-=y.getNumber($("#carddeduct_money").html())),e=e-r-i-t;var a=0;return 0<$("#seckillprice_money").length&&""!=$("#seckillprice_money").html()&&(a=y.getNumber($("#seckillprice_money").html())),(e-=a)<=0&&(e=0),e},k});