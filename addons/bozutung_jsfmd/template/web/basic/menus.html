<!DOCTYPE html>
<html>
<head>
	<title>{$_W['slwl']['lang']['sys_name']}</title>
	<meta name="keywords" content="" />
	<meta name="description" content="">
	{template 'public/header'}

	<link href="{MODULE_URL}template/public/css/iconfont.css?v={SLWL_VERSION}" rel="stylesheet">
	<link href="{MODULE_URL}template/public/awesome/css/all.min.css?v={SLWL_VERSION}" rel="stylesheet">
</head>
<body class="layui-layout-body">
<div class="layui-layout layui-layout-admin">
	{template 'public/top'}
	{template 'public/left'}

	<div class="layui-body">
		<div class="layui-main">

			<form class="layui-form fixed" action="" method="post" enctype="multipart/form-data" id="data-form">
				<input type="hidden" name="token" value="{$_W['token']}" />
				<div class="layui-tab layui-tab-brief" lay-filter="tab">
					<ul class="layui-tab-title">
						<li class="layui-this">底部导航</li>
					</ul>
					<div class="layui-tab-content">
						<!-- 底部导航 -->
						<!-- 启用状态 -->
						<div class="layui-tab-item layui-show">
							<div class="layui-form-item">
								<label class="layui-form-label">状态</label>
								<div class="layui-input-block">
									<input type="radio" name="enabled" value="1"
										title="显示" {if $smeta['enabled']==1 }checked{/if}>
									<input type="radio" name="enabled" value="0"
										title="隐藏" {if $smeta['enabled']==0 }checked{/if}>
								</div>
							</div>
							<!-- 个数 -->
							<div class="layui-form-item">
								<div class="layui-input-block">
									<button class="layui-btn" lay-submit lay-filter="one">保存</button>
									<button type="button" class="layui-btn" id="btn-img-upload">添加</button>
									<button type="button" class="layui-btn layui-btn-danger" id="btn-img-empty">全部删除</button>
									<span style="margin-left: 10px;">最多支持 5 个</span>
								</div>
							</div>

							<div class="photo-list box-font-panel">
								{loop $smeta['items'] $index $item}
								<blockquote class="layui-elem-quote photo-item">
									<input type="hidden" class="input-attr" name="options[attachment][]" value="{$item['attachment']}">
									<input type="hidden" class="input-pic" name="options[pic_highlight][]" value="{$item['pic_highlight']}">
									<input type="hidden" class="input-icon" name="options[icon][]" value="{$item['icon']}">
									<div class="layui-form-item box-item">
										<div class="box-img">
											{if $item['icon'] }
												<i class="{$item['icon']}"></i>
											{else}
												<img class="pic" src="{php echo tomedia($item['attachment'])}">
												<img class="pic-highlight" src="{php echo tomedia($item['pic_highlight'])}">
											{/if}
										</div>
										<div class="box-group mb">
											<label class="layui-form-label">标题</label>
											<div class="layui-input-block">
												<input type="text" name="options[title][]" class="layui-input input-filename" value="{$item['title']}">
											</div>
										</div>
										<div class="box-group input-link">
											<label class="layui-form-label">链接</label>
											<div class="layui-input-block">
												{php echo slwl_tpl_form_show_link('options[page_url][]', $item['page_url']);}
											</div>
										</div>
										<div class="layui-input-inline box-btn">
											<button type="button" class="layui-btn layui-btn-primary btn-move-top">置顶</button>
											<button type="button" class="layui-btn layui-btn-primary btn-move-up">上移</button>
											<button type="button" class="layui-btn layui-btn-primary btn-move-down">下移</button>
											<button type="button" class="layui-btn layui-btn-primary btn-move-bottom">置底</button>
											<button type="button" class="layui-btn layui-btn-danger btn-delete">删除</button>
										</div>
										<div class="layui-input-inline box-btn2">
											<button type="button" class="layui-btn btn-replace-icon">图标</button>
											<button type="button" class="layui-btn btn-replace-pic">图片</button>
											<button type="button" class="layui-btn btn-replace-pic-highlight">高亮</button>

											<button type="button" class="layui-btn layui-btn-primary visibility">占位</button>
											<button type="button" class="layui-btn layui-btn-danger visibility">占位</button>
										</div>
									</div>
								</blockquote>
								{/loop}
							</div>
						</div>
					</div>
				</div>
			</form>

			<div class="photo-clone" style="display: none;">
				<blockquote class="layui-elem-quote photo-item photo-item-common">
					<input type="hidden" class="input-attr" name="options[attachment][]">
					<input type="hidden" class="input-pic" name="options[pic_highlight][]">
					<input type="hidden" class="input-icon" name="options[icon][]">
					<div class="layui-form-item box-item">
						<div class="box-img"><i class="iconfont icon-ui-courses"></i></div>
						<div class="box-group mb">
							<label class="layui-form-label">标题</label>
							<div class="layui-input-block">
								<input type="text" name="options[title][]" class="layui-input input-filename">
							</div>
						</div>
						<div class="box-group input-link">
							<label class="layui-form-label">链接</label>
							<div class="layui-input-block">
								{php echo slwl_tpl_form_show_link('page_url');}
							</div>
						</div>
						<div class="layui-input-inline box-btn">
							<button type="button" class="layui-btn layui-btn-primary btn-move-top">置顶</button>
							<button type="button" class="layui-btn layui-btn-primary btn-move-up">上移</button>
							<button type="button" class="layui-btn layui-btn-primary btn-move-down">下移</button>
							<button type="button" class="layui-btn layui-btn-primary btn-move-bottom">置底</button>
							<button type="button" class="layui-btn layui-btn-danger btn-delete">删除</button>
						</div>
						<div class="layui-input-inline box-btn2">
							<button type="button" class="layui-btn btn-replace-icon">图标</button>
							<button type="button" class="layui-btn btn-replace-pic">图片</button>
							<button type="button" class="layui-btn btn-replace-pic-highlight">高亮</button>

							<button type="button" class="layui-btn layui-btn-primary visibility">占位</button>
							<button type="button" class="layui-btn layui-btn-danger visibility">占位</button>
						</div>
					</div>
				</blockquote>

			</div>

			<script type="text/javascript">
				$(function () {
					function checkItemNum() {
						var $item_num = $('.photo-list').children('.photo-item').length;

						if ($item_num >= 5) {
							layer.msg('最多支持 5 个' , {
								offset: '20%',
								shift: 6,
							});
							return false;
						} else {
							return true;
						}
					}

					// 添加
					$(document).on('click', '#btn-img-upload', function () {
						var $item_num = $('.photo-list').children('.photo-item').length;

						if (checkItemNum()) {
							$obj = $('.photo-clone .photo-item-common').clone(true);

							$obj.find('.input-icon').attr('name', 'options[icon][]').val('iconfont icon-nav-sports');
							$obj.find('.input-filename').attr('name', 'options[title][]').val('首页');
							$obj.find('.input-link input[name="page_url"]').attr('name', 'options[page_url][]').val('@home');

							$('.photo-list').append($obj);
						}
					});

					// 换图标
					$(document).on('click', '.btn-replace-icon', function () {
						let $_this = $(this).closest('.photo-item');

						myutil.myShowFontSelect(function(href, permission, param) {
							$_this.find('.box-img').empty();
							$_this.find('.input-attr').val('');

							$_this.find('.input-icon').val(href);
							$_this.find('.box-img').html('<i class="' + href + '">');
						});
					});

					// 换图片
					$(document).on('click', '.btn-replace-pic', function () {
						let $_this = $(this).closest('.photo-item');

						require(["util"], function(util){
							options = '.str_replace("\"", "\'", json_encode($options)).';
							util.image('', function(url){
								// console.log(url);
								$_this.find('.box-img').empty();
								$_this.find('.input-icon').val('');

								if(url.url){
									$_this.find('.input-attr').val(url.attachment);
									$_this.find('.box-img').html(
										'<img class="pic" src="' + url.url + '">' +
										'<img class="pic-highlight" src="' + url.url + '">'
									);
								}
								if(url.media_id){
									$_this.find('.input-attr').val(url.media_id);
								}
							}, options);
						});
					});
					// 换图片-高亮
					$(document).on('click', '.btn-replace-pic-highlight', function () {
						let $_this = $(this).closest('.photo-item');

						// 判断是否有子元素
						if ($_this.find('.box-img>img').length <= 0) {
							layer.msg("请先添加图片" , {
								offset: '20%',
								shift: 6,
							});
							return false;
						}

						require(["util"], function(util){
							options = '.str_replace("\"", "\'", json_encode($options)).';
							util.image('', function(url){
								if(url.url){
									$_this.find('.input-pic').val(url.attachment);
									$_this.find('.box-img .pic-highlight').attr('src', url.url);
								}
							}, options);
						});
					});

					// 清空
					$(document).on('click', '#btn-img-empty', function () {
						layer.confirm("确定要删除吗", {
							offset: '20%',
							btn: ["再想想", "删除"],
							success: function (layero, index) {
								this.enterEsc = function (event) {
									if (event.keyCode === 13) {
										$('.photo-list').empty();
										layer.close(index);
										return false; //阻止系统默认回车事件
									}
									if (event.keyCode === 27) {
										layer.close(index);
										return false; //阻止系统默认回车事件
									}
								};
								$(document).on('keydown', this.enterEsc);   //监听键盘事件，关闭层
							}
							, end: function(){
								$(document).off('keydown', this.enterEsc);  //解除键盘关闭事件
							}
						}, function(i){
							layer.close(i);
						}, function(i) {
							$('.photo-list').empty();
						});
					});

					// 置顶
					$(document).on('click', '.btn-move-top', function () {
						var $obj = $(this).closest('.photo-item');
						var $box = $(this).closest('.photo-list');

						if ($obj.prev().html != '') {
							$obj.prependTo($box);
						}
					});

					// 上移
					$(document).on('click', '.btn-move-up', function () {
						var $obj = $(this).closest('.photo-item');

						if ($obj.prev().html != '') {
							$obj.insertBefore($obj.prev());
						}
					});

					// 下移
					$(document).on('click', '.btn-move-down', function () {
						var $obj = $(this).closest('.photo-item');

						if ($obj.next().html != '') {
							$obj.insertAfter($obj.next());
						}
					});

					// 置底
					$(document).on('click', '.btn-move-bottom', function () {
						var $obj = $(this).closest('.photo-item');
						var $box = $(this).closest('.photo-list');

						if ($obj.prev().html != '') {
							$obj.appendTo($box);
						}
					});

					// 删除
					$(document).on('click', '.btn-delete', function () {
						var $obj = $(this);
						layer.confirm("确定要删除吗", {
							offset: '20%',
							btn: ["再想想", "删除"],
							success: function (layero, index) {
								this.enterEsc = function (event) {
									if (event.keyCode === 13) {
										$obj.closest('.photo-item').remove();
										layer.close(index);
										return false; //阻止系统默认回车事件
									}
									if (event.keyCode === 27) {
										layer.close(index);
										return false; //阻止系统默认回车事件
									}
								};
								$(document).on('keydown', this.enterEsc);   //监听键盘事件，关闭层
							}
							, end: function(){
								$(document).off('keydown', this.enterEsc);  //解除键盘关闭事件
							}
						}, function(i){
							layer.close(i);
						}, function(i) {
							$obj.closest('.photo-item').remove();
						});
					});
				});
			</script>
			<script>
				layui.use('form', function(){
					var form = layui.form;

					form.on('submit(one)', function(data){
						let url = "{php echo webUrl('',['do'=>'basic/menus'])}";
						var $obj = $(this);

						if (!$obj.hasClass('lock')) {
							$obj.addClass('lock'); // 不能再点击

							$.ajax({
								type: "POST",
								url: url,
								dataType: 'json',
								data: data.field,
								success: function (rs) {

									if (rs.code == '0') {
										layer.msg("成功" , {
											time: 500
										}, function () {
											window.location.href = "{php echo webUrl('',['do'=>'basic/menus'])}";
										});
									} else {
										layer.msg(rs.msg, {
											offset: '20%',
											shift: 6,
										});
									}
									$obj.removeClass('lock');
								},
								error: function () {
									layer.msg("保存过程发生错误，请与管理员联系" , {
										offset: '20%',
										shift: 6,
									});
									$obj.removeClass('lock');
								}
							});
						}

						return false;
					});
				});
			</script>

		</div>
	</div>

	{template 'public/copyright'}
</div>

{template 'public/footer'}
</body>
</html>
