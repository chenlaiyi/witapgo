<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="keywords" http-equiv="{$school['title']} - 考勤数据统计">
    <link rel="shortcut icon" href="{$_W['siteroot']}{$_W['config']['upload']['attachdir']}/{if !empty($_W['setting']['copyright']['icon'])}{$_W['setting']['copyright']['icon']}{else}images/global/wechat.jpg{/if}" />
    <link rel="stylesheet" href="{MODULE_URL}public/web/css/sp_public.css">
    <link rel="stylesheet" href="{MODULE_URL}public/web/css/sp_population.css">
    <link rel="stylesheet" href="{MODULE_URL}public/web/css/index.css">
    <title>{$school['title']} - 考勤数据统计</title>
    <style>
        .down1_top{width:100%;height: 20%;position: absolute;text-align: center;z-index:2}
        .down1_image{width: 100%;height: 100%;position: absolute;}
        .down1_select{ outline: none;-webkit-appearance: none;-moz-appearance: none;appearance: none;width:auto;margin-top: 0.2rem;height: 0.3rem;line-height: 0.3rem;background-color: rgba(11, 51, 123, 0.5);border-radius: 0.1rem;color:white;font-size:0.15rem;text-align: center;text-align-last: center;padding: 0 2%;}
    .down1_select :focus{border:none;
        outline: none; }
        .select_op{text-align: center;text-align-last:center}
        .activity-img{padding: 0.05rem;float:left}
        .activity-desc{float:left;width:calc(100% - 0.6rem)}
        .activity-desc h5{ height: 0.2rem;line-height: 0.2rem;padding-top: 0.05rem}
        .activity-time{font-weight: lighter;background-color: rgba(255, 255, 255, 0.12);border-radius: 0.44rem;padding: 0 0.06rem;}
        .activity-bj{font-weight: lighter;background-color: rgba(58, 102, 239, 0.5);border-radius: 0.44rem;padding: 0 0.06rem;}
        .pull-right{float:right !important;}
        .activity-bjtz{font-weight: lighter;background-color: rgba(129, 117, 199, 0.5);border-radius: 0.44rem;padding: 0 0.06rem;}
        .bjq_voice{font-weight: lighter;background-color: rgba(252, 179, 34, 0.5);border-radius: 0.44rem;padding: 0 0.06rem;}
        .bjq_share{font-weight: lighter;background-color: rgba(129, 117, 199, 0.5);border-radius: 0.44rem;padding: 0 0.06rem;}
    </style>
</head>
<body class="background">
<div class="expand">
    <div class="expand_left"></div>
    <div class="expand_right"></div>
    <div class="expand_circle"></div>
</div>
<div class="open-page">
    <div class="circle-red">
        <div class="circle-blue">
            <div class="circle-yellow"></div>
        </div>
    </div>
</div>
{template 'common/header_base'}
<section class="c-content-pop l-center-flex l-content-pop">
    <div class="c-content_item l-content_item">
        <div class="o-box c-content_box-up1"></div>
        <div class="o-box c-content_box-down1" style="position: relative">
            <div class="down1_top">
            <select style="width:30%" id="ChooseNjId" class="down1_select" onclick="checkbj();">
                {loop $njchecklog $row}
                <option value="{$row['sid']}" class="select_op">{$row['sname']}</option>
                {/loop}
            </select>
            </div>
        <div class="down1_image"></div>
        </div>
    </div>
    <div class="c-content_item l-content_item">
            <div class="o-box c-right_box1 in_check_list" style="height: 48.5%;margin:0 .1rem 0;" >
                <div class="o-list">
                    <div class="o-list_title">考勤记录</div>
                    <div class="data-list_wrap">
                        <ul class="o-list_wrap check_ul">
                            {loop $lastkq $row}
                            <li class="o-list_item inddexs">
                                <div class="activity-row1">
                                    <div class="col-xs-3 activity-img" style="width:0.6rem;"><img style="width:0.4rem;height:0.4rem;border-radius:50%;" src="{php echo tomedia($row['thumb'])}" class="img-responsive" alt="">
                                    </div>
                                    <div class="col-xs-8 activity-desc">
                                        <h5>
                                            <span >{$row['name']}</span>
                                            <span class="activity-bj">{$row['bjname']}</span>
                                            {if !empty($row['pname'])}
                                            <span class="activity-bj" style="background-color: rgba(255,95,187,0.5);">{$row['pname']}</span>
                                            {/if}
                                            {if $row['type'] =='进校'}<span class="bjq_share pull-right">{$row['type']}</span>{else}<span class="bjq_voice pull-right">{$row['type']}</span>{/if}
                                        </h5>
                                        <h5>
                                            {if $row['checktype'] == 1}
                                            <span class="activity-time" style="background-color: rgba(37,65,255, 0.5);" >{$row['mac']}</span>
                                            {else}
                                            <span class="activity-time" style="background-color: rgba(94, 255, 39, 0.5);" >微信签到</span>
                                            {/if}
                                            <span class="activity-time" >{php echo date("Y-m-d H:i",$row['createtime'])}</span></h5>
                                    </div>
                                </div>
                            </li>
                            {/loop}
                        </ul>
                    </div>
                </div>
            </div>
        <div class="o-box c-content_box-down2"></div>
    </div>
    <div class="c-content_item l-content_item">
        <div class="o-box c-content_box-up3"></div>
        <div class="o-box c-content_box-down3"></div>
    </div>
</section>
<script type="text/javascript" src="{MODULE_URL}public/web/js/jquery.min.js"></script>
<script type="text/javascript" src="{MODULE_URL}public/web/js/echarts.min.js"></script>
<script type="text/javascript" src="{MODULE_URL}public/web/js/index.js"></script>
<script type="text/javascript" src="{MODULE_URL}public/web/js/sp_bg.js"></script>
<script type="text/javascript" src="{MODULE_URL}public/web/js/title.js"></script>
<script type="text/javascript">
    var GPC_do = "{$_GPC['do']}";
    //打开时加载动画
    setTimeout(function () {
        $(".expand_circle").css({"display": "none"});
        $(".expand_left").css({"transform": "translateX(100%)"});
        $(".expand_right").css({"transform": "translateX(-100%)"});
        setTimeout(function () {
            $(".expand").css({"z-index": -1});
        }, 500)
    }, 1000);
    checkbj();
    setTimeout(function () {
        checknewinfo({$lasttime});
    }, 2000);
    $.ajax({
        url: "{php echo $this->createWebUrl('bdcheck',array('op'=>'firstdata','schoolid'=>$schoolid))}",
        type: "POST",
        dataType: "json",
        success: function (res) {
            drawCharts($('.c-content_box-up1')[0], res.bing_ka);
            drawCharts($('.c-content_box-up3')[0], res.kq_check);
            drawCharts($('.c-content_box-down2')[0], res.njchecktoday);
            drawCharts($('.c-content_box-down3')[0], res.qj_check);
        }
    });
    function checkbj() {
        let nj_id = $("#ChooseNjId").val();
        $.ajax({
            url: "{php echo $this->createWebUrl('bdcheck',array('op'=>'get_class_check','schoolid'=>$schoolid))}",
            type: "POST",
            dataType: "json",
            data:{
              nj_id:nj_id
            },
            success: function (res) {
                drawCharts($('.down1_image')[0], res);
            }
        });
    }
    //实时ajax
    function checknewinfo(lasttime){
        $.ajax({
            url: "{php echo $this->createwebUrl('bdcheck',array('op'=>'real_time_data','schoolid'=>$schoolid))}",
            data: {weid: "{$weid}",lasttime:lasttime},
            type: "POST",
            dataType: "json",
            success: function (data) {
                if(data.lastkq.check == true){
                    let kq_html =  '<li class="o-list_item inddexs" style="height:0">' +
                        '   <div class="activity-row1">' +
                        '       <div class="col-xs-3 activity-img" style="width:0.6rem;"><img style="width:0.4rem;height:0.4rem;border-radius:50%;" src="'+ data.lastkq.data.thumb +'" class="img-responsive" alt="">' +
                        '       </div>' +
                        '       <div class="col-xs-8 activity-desc">' +
                        '           <h5>' +
                        '               <span >' + data.lastkq.data.name+ '</span>' +
                        '               <span class="activity-bj">'+ data.lastkq.data.bjname +'</span>\n' ;
                    if(data.lastkq.data.pname){
                        kq_html +=' <span class="activity-bj" style="background-color: rgba(255,95,187,0.5);">'+data.lastkq.data.pname +'</span>';
                    }
                    if(data.lastkq.data.type == '进校'){
                        kq_html += '<span class="bjq_share pull-right">'+ data.lastkq.data.type +'</span>';
                    }else{
                        kq_html += '<span class="bjq_voice pull-right">'+ data.lastkq.data.type +'</span>';
                    }
                    kq_html +=  '           </h5>' +
                        '           <h5>' ;
                    if(data.lastkq.data.checktype == 1){
                        kq_html +=' <span class="activity-time" style="background-color: rgba(37,65,255, 0.5);" >'+ data.lastkq.data.mac+'</span>';
                    }else{
                        kq_html +=' <span class="activity-time" style="background-color: rgba(94, 255, 39, 0.5);" >微信签到</span>';
                    }
                    kq_html +=  '           <span class="activity-time" >'+data.lastkq.data.createtime +'</span></h5>' +
                        '       </div>' +
                        '   </div>' +
                        '</li>';

                    $(kq_html).prependTo('.check_ul').fadeIn('slow');
                    let _first=$('.check_ul li:first');
                    _first.animate({height: '+0.52rem'}, "normal");
                    let _last=$('.check_ul li:last');
                    setTimeout(function () {
                        _last.remove();
                    }, 2000);
                }
                drawCharts($(".c-content_box-down2")[0], data.njchecktoday);
                setTimeout(function(){checknewinfo(data.lasttime)}, 2000);
            },
            error: function () {
                setTimeout(function(){checknewinfo(lasttime)}, 2000);
            },
        });

    };
</script>
</body>
</html>