<?php
 goto LVp12; hiyxX: define('BEST_CSERVICEGROUP', 'messikefu_cservicegroup'); goto IuEfz; nKTFU: define('BEST_XCXFANSKEFU', 'messikefu_xcxfanskefu'); goto QIyDP; whzR2: define('ROOT_PATH', IA_ROOT . '/addons/cy163_customerservice_plugin_p/'); goto J9822; LVp12: defined('IN_IA') or exit('Access Denied'); goto whzR2; QIyDP: define('BEST_XCXCHAT', 'messikefu_xcxchat'); goto mAOFe; Dsu02: define('BEST_XCXCSERVICE', 'messikefu_xcxcservice'); goto nKTFU; F9apd: define('BEST_KUAIJIE', 'messikefu_kuaijie'); goto kkkNm; uxP8a: define('BEST_BIAOQIAN', 'messikefu_biaoqian'); goto F9apd; IuEfz: define('BEST_FANSKEFU', 'messikefu_fanskefu'); goto QSuaG; kkkNm: define('BEST_XCX', 'messikefu_xcx'); goto Dsu02; CcGET: define('BEST_CSERVICE', 'messikefu_cservice'); goto hiyxX; WotNf: define('NEWSTATIC_ROOT', '../addons/cy163_customerservice/newstatic'); goto PAmGh; QSuaG: define('BEST_PINGJIA', 'messikefu_pingjia'); goto rwbuL; jvMr3: define('MD_ROOT_Z', '../addons/cy163_customerservice/'); goto WotNf; rwbuL: define('BEST_KEFUANDGROUP', 'messikefu_kefuandgroup'); goto uxP8a; mAOFe: define('BEST_XCXAUTO', 'messikefu_xcxauto'); goto zSO1b; J9822: define('MD_ROOT', '../addons/cy163_customerservice_plugin_p/static'); goto jvMr3; PAmGh: define('BEST_CHAT', 'messikefu_chat'); goto CcGET; zSO1b: define('BEST_ZIDONGHUIFU', 'messikefu_zdhf'); goto mXvww; mXvww: class Cy163_customerservice_plugin_pModuleSite extends WeModuleSite { public function doMobileKefulogin() { include_once ROOT_PATH . 'inc/mobile/kefulogin.php'; } public function doMobileKefucenter() { include_once ROOT_PATH . 'inc/mobile/kefucenter.php'; } public function doMobileFinishjd() { goto wbAZL; amHoj: GIUiC: goto brPiq; t5QIx: $id = intval($_GPC['id']); goto gxNz4; bkySO: $dataupkefu['nowfkid'] = 0; goto fEFhz; XN9bL: $resArr['url'] = $this->createMobileUrl('kefucenter', array("isjd" => $isjd)); goto amHoj; OkfYA: echo json_encode($resArr); goto Q1YuG; gxNz4: $cservice = pdo_fetch('SELECT * FROM ' . tablename(BEST_CSERVICE) . " WHERE weid = {$_W['uniacid']} AND id = {$id}"); goto bkySO; FVNBr: $fkid = intval($_GPC['fkid']); goto LoS6v; LoS6v: $dataupfk['nowjd'] = 0; goto jqJZ8; brPiq: $resArr['error'] = 0; goto vS_Er; CBLuv: NmN7o: goto XN9bL; odRqe: $isjd = intval($_GPC['isjd']); goto KSdFQ; FdXJm: goto GIUiC; goto CBLuv; byPna: pdo_update(BEST_FANSKEFU, $dataupfk, array("id" => $fkid)); goto t5QIx; tNz1A: pdo_update(BEST_CSERVICE, $dataupkefu, array("id" => $cservice['id'])); goto odRqe; fEFhz: $dataupkefu['nowjdnum'] = $cservice['nowjdnum'] - 1; goto tNz1A; z3zNe: $resArr['url'] = $this->createMobileUrl('kefucenter', array("toopenid" => $lastjd[0]['fansopenid'], "isjd" => $isjd)); goto FdXJm; Q1YuG: exit; goto tRYT1; KSdFQ: $lastjd = pdo_fetchall('SELECT fansopenid FROM ' . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W['uniacid']} AND kefuopenid = '{$cservice['content']}' AND nowjd = {$isjd} ORDER BY jdtime ASC LIMIT 1"); goto TX8g1; vS_Er: $resArr['msg'] = '结束会话成功！'; goto OkfYA; TX8g1: if (empty($lastjd)) { goto NmN7o; } goto z3zNe; jqJZ8: $dataupfk['jdtime'] = 0; goto byPna; wbAZL: global $_W, $_GPC; goto FVNBr; tRYT1: } public function doMobileFinishjdxcx() { goto uTOHe; QO2UM: $resArr['msg'] = '参数错误！'; goto KvV5v; jPlZs: if (!($fkid == 0)) { goto zGk7k; } goto EC7aJ; SDa_V: $fkid = intval($_GPC['fkid']); goto jPlZs; GR0df: $resArr['error'] = 0; goto u8yyC; Qrn9s: $dataupfk['nowkefu'] = 0; goto yh0vq; yh0vq: pdo_update(BEST_XCXFANSKEFU, $dataupfk, array("id" => $fkid)); goto WJmyW; vRoYf: exit; goto K0KTn; oHMFV: exit; goto rZ2Df; WJmyW: $resArr['url'] = $this->createMobileUrl('kefucenter', array("isxcx" => 1)); goto GR0df; KvV5v: echo json_encode($resArr); goto vRoYf; EC7aJ: $resArr['error'] = 1; goto QO2UM; K0KTn: zGk7k: goto Qrn9s; u8yyC: $resArr['msg'] = '结束接待成功！'; goto X_iU2; uTOHe: global $_W, $_GPC; goto SDa_V; X_iU2: echo json_encode($resArr); goto oHMFV; rZ2Df: } public function doMobilePcupload() { goto enZkA; Y306J: exit; goto kEW5u; nl43S: $img_info = getimagesize($targetName); goto sQhhA; UNNfM: if (file_exists($updir)) { goto VNl9u; } goto y9O1p; DXqPJ: ZDjBs: goto VFLSi; I5u6g: xmopD: goto UWJuk; guiEq: $isqiniu = $this->getmoduleconfig('isqiniu'); goto yq9aY; EJOt1: $resarr['error'] = 1; goto m4KAx; VvjAU: load()->func('file'); goto c8rfE; V7rQc: goto IX745; goto I5u6g; bK5bc: $resarr['message'] = '上传成功'; goto WexeA; ktiXQ: $resarr['imgurl'] = $qiniuurl . '/' . $randimgurl; goto bK5bc; WVs4O: if (empty($_W['setting']['remote']['type'])) { goto bJnSp; } goto VvjAU; ugoHD: $url = $_FILES['jUploaderFile']['tmp_name']; goto jRwxU; Yaojs: die(json_encode($resarr)); goto z22iN; IfteO: goto sf_O0; goto DXqPJ; o7MYT: move_uploaded_file($url, $targetName); goto WZyQr; c8rfE: $remotestatus = file_remote_upload($randimgurl, true); goto z4hHi; WexeA: die(json_encode($resarr)); goto IfteO; Cj9FK: $resarr['message'] = '远程附件上传失败，请检查配置并重新上传'; goto YhADF; yTPzW: IX745: goto H2HG8; jRwxU: $updir = '../attachment/images/' . $_W['uniacid'] . '/' . date('Y', time()) . '/' . date('m', time()) . '/'; goto UNNfM; YhADF: die(json_encode($resarr)); goto uhKn1; Tuy2u: $targetName = '../attachment/' . $randimgurl; goto o7MYT; zei4y: echo json_encode($resarr, true); goto Y306J; AMcPS: $resarr['error'] = 1; goto Cj9FK; gGxr3: $resarr['realimgurl'] = $randimgurl; goto zM3i_; oFd5Y: goto IX745; goto bdYbd; z4hHi: if (is_error($remotestatus)) { goto o_hXb; } goto gGxr3; sQhhA: if (!($img_info[0] > 640)) { goto YTPvn; } goto lJhZN; H2HG8: $resarr['realimgurl'] = $randimgurl; goto xXKSA; oggli: o_hXb: goto AMcPS; lJhZN: $this->mkThumbnail($targetName, 640, null, $targetName); goto cDOeL; UWJuk: $remotestatus = $this->doQiuniu($randimgurl, true); goto XaeD7; FKDVG: $resarr['message'] = '上传成功'; goto Q3IGn; qJHq_: die(json_encode($resarr)); goto nzqFe; z22iN: goto KsLDH; goto oggli; uhKn1: KsLDH: goto b2tyM; cDOeL: YTPvn: goto guiEq; VFLSi: $resarr['error'] = 1; goto meaDI; yq9aY: if ($isqiniu == 1) { goto xmopD; } goto KtZ2m; WZyQr: if (file_exists($targetName)) { goto d8E0g; } goto EJOt1; zM3i_: $resarr['imgurl'] = tomedia($randimgurl); goto VkO2_; bdYbd: l3YX0: goto WVs4O; enZkA: global $_W, $_FILES, $_GPC; goto ugoHD; XaeD7: if (is_error($remotestatus)) { goto ZDjBs; } goto A0QwF; xr12n: $randimgurl = 'images/' . $_W['uniacid'] . '/' . date('Y', time()) . '/' . date('m', time()) . '/' . date('YmdHis') . rand(1000, 9999) . '.jpg'; goto Tuy2u; E3zh0: $resarr['error'] = 0; goto nl43S; m4KAx: $resarr['message'] = '上传文件失败'; goto jmqD1; y9O1p: mkdir($updir, 0777, true); goto SrZcX; xXKSA: $resarr['imgurl'] = tomedia($randimgurl); goto FKDVG; b2tyM: bJnSp: goto yTPzW; KtZ2m: if ($isqiniu == 3) { goto l3YX0; } goto V7rQc; meaDI: $resarr['message'] = '远程附件上传失败，请检查配置并重新上传'; goto qJHq_; Q3IGn: cLtYB: goto zei4y; nzqFe: sf_O0: goto oFd5Y; VkO2_: $resarr['message'] = '上传成功'; goto Yaojs; jmqD1: goto cLtYB; goto Dv3zZ; Dv3zZ: d8E0g: goto E3zh0; A0QwF: $resarr['realimgurl'] = $randimgurl; goto EoZkd; SrZcX: VNl9u: goto xr12n; EoZkd: $qiniuurl = $this->getmoduleconfig('qiniuurl'); goto ktiXQ; kEW5u: } public function doMobileJietuupload() { goto zvkqR; dvwS6: die(json_encode($resarr)); goto kjPAD; tDPuN: $base64_data = base64_decode($base64_body); goto D2CoO; ha1yD: $resarr['error'] = 1; goto gPaKK; d6Tjz: goto abL6p; goto aZ8vM; aZ8vM: xcb7w: goto OWNNf; yKpt0: $resarr['realimgurl'] = $randimgurl; goto EFcC0; EFcC0: $resarr['imgurl'] = tomedia($randimgurl); goto w_Hj3; MHKFW: $resarr['imgurl'] = $qiniuurl . '/' . $randimgurl; goto dgx8A; ZTPvq: echo json_encode($resarr, true); goto dRWN9; MGaPE: die(json_encode($resarr)); goto MPWkL; GVH9u: IYr3t: goto HvIVG; Q7Erj: $this->mkThumbnail($targetName, 640, null, $targetName); goto u_0Vo; OWNNf: $remotestatus = $this->doQiuniu($randimgurl, true); goto Xq5yn; eLhG1: load()->func('file'); goto TpE7U; Frm8_: die(json_encode($resarr)); goto Kxej1; ZvNHJ: $resarr['realimgurl'] = $randimgurl; goto XkEVb; RHHnl: $resarr['message'] = '上传成功'; goto RItXf; sBqR7: if (is_error($remotestatus)) { goto MyhC7; } goto yKpt0; BlqWN: aU23k: goto EbH2W; n80rd: goto abL6p; goto yz9Jc; kjPAD: goto uk0BA; goto p0d5S; gPaKK: $resarr['message'] = '上传文件失败'; goto IBLZ3; D2CoO: $updir = '../attachment/images/' . $_W['uniacid'] . '/' . date('Y', time()) . '/' . date('m', time()) . '/'; goto Fn4S4; RDY6V: rlpRJ: goto WBlw9; MPWkL: goto l_HNZ; goto RDY6V; YhkUt: $base64_body = substr(strstr($base64_url, ','), 1); goto tDPuN; TF1IJ: $resarr['realimgurl'] = $randimgurl; goto K1bez; v1BYF: file_put_contents($targetName, $base64_data); goto vmXvT; gNy2H: $resarr['error'] = 1; goto BwKDw; vmXvT: if (file_exists($targetName)) { goto aU23k; } goto ha1yD; s0ik_: if (empty($_W['setting']['remote']['type'])) { goto IYr3t; } goto eLhG1; u_0Vo: VPpHt: goto wQN9B; TpE7U: $remotestatus = file_remote_upload($randimgurl, true); goto sBqR7; Kxej1: l_HNZ: goto n80rd; K1bez: $qiniuurl = $this->getmoduleconfig('qiniuurl'); goto MHKFW; Fn4S4: if (file_exists($updir)) { goto qnxEA; } goto IDTCY; Fv8Xa: $randimgurl = 'images/' . $_W['uniacid'] . '/' . date('Y', time()) . '/' . date('m', time()) . '/' . date('YmdHis') . rand(1000, 9999) . '.jpg'; goto Vfy7C; HvIVG: abL6p: goto ZvNHJ; Vfy7C: $targetName = '../attachment/' . $randimgurl; goto v1BYF; Y2dXu: if ($isqiniu == 3) { goto zOf3W; } goto d6Tjz; EbH2W: $resarr['error'] = 0; goto WgP9S; dgx8A: $resarr['message'] = '上传成功'; goto MGaPE; IsS0a: $resarr['message'] = '远程附件上传失败，请检查配置并重新上传'; goto Frm8_; BwKDw: $resarr['message'] = '远程附件上传失败，请检查配置并重新上传'; goto I3csn; yz9Jc: zOf3W: goto s0ik_; I3csn: die(json_encode($resarr)); goto rYerh; WBlw9: $resarr['error'] = 1; goto IsS0a; Xq5yn: if (is_error($remotestatus)) { goto rlpRJ; } goto TF1IJ; b53Dz: if ($isqiniu == 1) { goto xcb7w; } goto Y2dXu; rYerh: uk0BA: goto GVH9u; RItXf: DhdVu: goto ZTPvq; Xw77p: qnxEA: goto Fv8Xa; Fwx05: if (!($img_info[0] > 640)) { goto VPpHt; } goto Q7Erj; w_Hj3: $resarr['message'] = '上传成功'; goto dvwS6; dRWN9: exit; goto g0KTH; IBLZ3: goto DhdVu; goto BlqWN; k0Pd8: $base64_url = $_GPC['img']; goto YhkUt; WgP9S: $img_info = getimagesize($targetName); goto Fwx05; wQN9B: $isqiniu = $this->getmoduleconfig('isqiniu'); goto b53Dz; zvkqR: global $_W, $_GPC; goto k0Pd8; XkEVb: $resarr['imgurl'] = tomedia($randimgurl); goto RHHnl; IDTCY: mkdir($updir, 0777, true); goto Xw77p; p0d5S: MyhC7: goto gNy2H; g0KTH: } public function doQiuniu($filename, $auto_delete_local = true) { goto O8Xy7; t9v87: load()->func('file'); goto v1S6s; fRM4Q: $uploadmgr = new Qiniu\Storage\UploadManager($config); goto Z2lL3; ECJ2x: list($ret, $err) = $uploadmgr->putFile($uploadtoken, $filename, ATTACHMENT_ROOT . '/' . $filename); goto BG7TR; ne9a3: $qiniuaccesskey = $isqiniu == 1 ? $qiniuaccesskey : $_W['setting']['remote']['qiniu']['accesskey']; goto cMa5f; Z2lL3: $putpolicy = Qiniu\base64_urlSafeEncode(json_encode(array("scope" => $qiniubucket . ':' . $filename))); goto hC1ZN; moLf4: zyfQE: goto i7TgF; Qv4ph: $qiniubucket = $isqiniu == 1 ? $qiniubucket : $_W['setting']['remote']['qiniu']['bucket']; goto t9v87; FKdIh: $config = new Qiniu\Config(); goto fRM4Q; Mm6rg: die(json_encode($resarr)); goto DqCAa; jwk_J: $auth = new Qiniu\Auth($qiniuaccesskey, $qiniusecretkey); goto FKdIh; Jm07O: $qiniuaccesskey = $this->getmoduleconfig('qiniuaccesskey'); goto Ikdmq; i7TgF: $resarr['error'] = 1; goto NXVtN; YBpu0: goto a3XUs; goto moLf4; cMa5f: $qiniusecretkey = $isqiniu == 1 ? $qiniusecretkey : $_W['setting']['remote']['qiniu']['secretkey']; goto Qv4ph; hC1ZN: $uploadtoken = $auth->uploadToken($qiniubucket, $filename, 3600, $putpolicy); goto ECJ2x; YPloV: kN2Kn: goto fI_a5; hvkAR: $qiniubucket = $this->getmoduleconfig('qiniubucket'); goto ne9a3; O8Xy7: global $_W; goto OkV2w; DqCAa: a3XUs: goto xTAlf; Ikdmq: $qiniusecretkey = $this->getmoduleconfig('qiniusecretkey'); goto hvkAR; fI_a5: if ($err !== null) { goto zyfQE; } goto FIdI5; NXVtN: $resarr['message'] = '远程附件上传失败，请检查配置并重新上传'; goto Mm6rg; FIdI5: return true; goto YBpu0; BG7TR: if (!$auto_delete_local) { goto kN2Kn; } goto MljzG; v1S6s: require_once IA_ROOT . '/framework/library/qiniu/autoload.php'; goto jwk_J; OkV2w: $isqiniu = $this->getmoduleconfig('isqiniu'); goto Jm07O; MljzG: file_delete($filename); goto YPloV; xTAlf: } public function mkThumbnail($src, $width = null, $height = null, $filename = null) { goto lsFtA; GIGm1: if (!(isset($width) && $width <= 0)) { goto Ldh3g; } goto Ji9Ts; Wd1A9: r4iDX: goto K6wpQ; puBh3: return true; goto ewkHh; rkhC3: $size = getimagesize($src); goto u1TkV; cT2N0: $src_img = $imagecreatefunc($src); goto yHokp; KNuv8: return false; goto sYHmX; DMn0t: list($src_w, $src_h, $src_type) = $size; goto tFpe8; Gjexi: x1TlT: goto DMn0t; Z0GzR: return false; goto Gjexi; cLWs2: header('Content-Type: ' . $src_mime); goto Q8ldo; tz3Af: Ldh3g: goto OLHOd; tFpe8: $src_mime = $size['mime']; goto FvRPM; K1t2u: h9jVi: goto GIGm1; s5Xgg: $imagefunc($dest_img, $filename); goto sV6Ek; CJZik: imagedestroy($dest_img); goto puBh3; u1TkV: if ($size) { goto x1TlT; } goto Z0GzR; yHokp: $dest_img = imagecreatetruecolor($width, $height); goto fohYt; fohYt: imagecopyresampled($dest_img, $src_img, 0, 0, 0, 0, $width, $height, $src_w, $src_h); goto eqnsh; wVOiu: if (isset($height)) { goto t390c; } goto UbfDw; OLHOd: if (!(isset($height) && $height <= 0)) { goto m08sA; } goto KNuv8; eqnsh: $imagefunc = 'image' . $img_type; goto U0hWZ; oHS_3: goto nua0p; goto B31OU; OrECt: $width = $src_w * ($height / $src_h); goto x5LBz; Ji9Ts: return false; goto tz3Af; tP3IY: if (isset($width)) { goto oiCWX; } goto OrECt; sV6Ek: nua0p: goto HRkK7; HRkK7: imagedestroy($src_img); goto CJZik; x5LBz: oiCWX: goto wVOiu; SFBag: t390c: goto bEMQ5; bEMQ5: $imagecreatefunc = 'imagecreatefrom' . $img_type; goto cT2N0; FvRPM: switch ($src_type) { case 1: $img_type = 'gif'; goto F3fqh; case 2: $img_type = 'jpeg'; goto F3fqh; case 3: $img_type = 'png'; goto F3fqh; case 15: $img_type = 'wbmp'; goto F3fqh; default: return false; } goto Wd1A9; K6wpQ: F3fqh: goto tP3IY; UbfDw: $height = $src_h * ($width / $src_w); goto SFBag; lsFtA: if (!(!isset($width) && !isset($height))) { goto h9jVi; } goto lKNH7; U0hWZ: if ($filename) { goto Dw4bR; } goto cLWs2; lKNH7: return false; goto K1t2u; Q8ldo: $imagefunc($dest_img); goto oHS_3; B31OU: Dw4bR: goto s5Xgg; sYHmX: m08sA: goto rkhC3; ewkHh: } public function getmoduleconfig($key) { goto Ttpii; EM0MD: $settings = unserialize($setting['settings']); goto wi6IC; Ttpii: global $_W, $_GPC; goto aZU9L; wi6IC: return $settings[$key]; goto wThTn; aZU9L: $setting = pdo_fetch('SELECT settings FROM ' . tablename('uni_account_modules') . " WHERE uniacid = {$_W['uniacid']} AND module = 'cy163_customerservice'"); goto EM0MD; wThTn: } public function doMobileDuvoice() { goto M4JP9; M4JP9: global $_W, $_GPC; goto JdVIO; SFH0g: $fkid = intval($_GPC['fkid']); goto k7ruj; lzyuh: Niqzt: goto U41VR; d3YHH: $dataup['hasyuyindu'] = 1; goto kWlEd; avqhF: die(json_encode($resarr)); goto JwGQp; FVlux: if (!($chatres['openid'] != $openid)) { goto Niqzt; } goto d3YHH; kWlEd: pdo_update(BEST_CHAT, $dataup, array("id" => $chatres['id'])); goto lzyuh; U41VR: $resarr['error'] = 0; goto avqhF; dNvl6: $media_id = $_GPC['media_id']; goto SFH0g; JdVIO: $openid = $_SESSION['openid']; goto dNvl6; k7ruj: $chatres = pdo_fetch('SELECT * FROM ' . tablename(BEST_CHAT) . " WHERE weid = {$_W['uniacid']} AND content = '{$media_id}' AND fkid = {$fkid}"); goto FVlux; JwGQp: } public function doMobileGetvoice() { goto J4KG6; Jpay7: RRIfZ: goto ejPov; EZzRm: $resarr['voicefile'] = $chatres['content']; goto korOL; e71Jc: $policy = array("persistentOps" => $fops, "persistentPipeline" => $liedui); goto tI3y8; nNsZ_: $resarr['msg'] = "访问微信接口错误, 错误代码: {$result['errcode']}, 错误信息: {$result['errmsg']}"; goto Hm033; LyG9s: $updir = '../attachment/audios/' . $_W['uniacid'] . '/' . date('Y', time()) . '/' . date('m', time()) . '/'; goto lO9Kf; VRYyY: $resarr['error'] = 1; goto nNsZ_; mreii: $liedui = empty($liedui) ? '' : $liedui; goto zZOcN; lQHmu: if (!($isqiniu == 0 || $qiniuaccesskey == '' || $qiniusecretkey == '' || $qiniubucket == '')) { goto IXDMu; } goto wGw44; NX1zK: $chatres = $chatres2; goto StoSq; hEQut: $dataup['content'] = $qiniuurl . '/' . $ret['key']; goto Ywvnz; TR25E: $result = @json_decode($response['content'], true); goto YRlFu; x_b7l: if (!is_error($response)) { goto h1I_H; } goto MKAzb; ozMSi: $policy = array("persistentOps" => $fops); goto gAAXD; xqFqM: mkdir($updir, 0777, true); goto sGhRa; Mgmqz: $auth = new Qiniu\Auth($qiniuaccesskey, $qiniusecretkey); goto JKmvU; YZ5n3: $liedui = $this->getmoduleconfig('liedui'); goto mreii; hGEDX: $resarr['error'] = 0; goto EZzRm; JeMTz: @fwrite($fp, $response['content']); goto OsmK1; zZOcN: if (!empty($liedui)) { goto W1LJu; } goto ozMSi; iAa4u: if ($err !== null) { goto Nj2z3; } goto guEl2; LfcOj: die(json_encode($resarr)); goto Jpay7; kAmBd: $qiniubucket = $isqiniu == 1 ? $qiniubucket : $_W['setting']['remote']['qiniu']['bucket']; goto d9jhu; bXQVc: $resarr['msg'] = '远程附件上传失败，请检查配置并重新上传'; goto LfcOj; hrKQX: $qiniuaccesskey = $isqiniu == 1 ? $qiniuaccesskey : $_W['setting']['remote']['qiniu']['accesskey']; goto qi3eW; FcDNq: IXDMu: goto XXQgV; mtjK0: require_once IA_ROOT . '/framework/library/qiniu/autoload.php'; goto Mgmqz; MO9cn: $chatres = pdo_fetch('SELECT * FROM ' . tablename(BEST_CHAT) . " WHERE weid = {$_W['uniacid']} AND content = '{$media_id}' AND fkid = {$fkid}"); goto E9G17; wkAdW: $resarr['error'] = 1; goto AAZYO; lO9Kf: if (file_exists($updir)) { goto CSd9s; } goto xqFqM; fNtZ4: list($ret, $err) = $uploadmgr->putFile($uploadtoken, $savemp3, $targetName); goto iAa4u; Hm033: die(json_encode($resarr)); goto TTfAY; Ywvnz: if (!($chatres['openid'] != $openid)) { goto uphxR; } goto yBjnd; ahijN: $resarr['msg'] = '获取语音资源配置错误！'; goto uouRg; d9jhu: $qiniuurl = $isqiniu == 1 ? $qiniuurl : $_W['setting']['remote']['qiniu']['url']; goto lQHmu; SmSLY: Nj2z3: goto W2MRK; sGhRa: CSd9s: goto XxWDA; wU8tc: $uploadtoken = $auth->uploadToken($qiniubucket, null, 3600, $policy); goto fNtZ4; oxs2Y: $dataup['mp3du'] = 0; goto yYE3j; TTfAY: USLHW: goto LyG9s; OsmK1: @fclose($fp); goto Ach5D; qi3eW: $qiniusecretkey = $isqiniu == 1 ? $qiniusecretkey : $_W['setting']['remote']['qiniu']['secretkey']; goto kAmBd; uREyw: $qiniuaccesskey = $this->getmoduleconfig('qiniuaccesskey'); goto Aop4X; YRlFu: if (empty($result['errcode'])) { goto USLHW; } goto VRYyY; gIq1T: $fops = $fops . '|saveas/' . $putpolicy; goto YZ5n3; d4F5V: $fkid = intval($_GPC['fkid']); goto pIqtb; MKAzb: $resarr['error'] = 1; goto uoB1_; fzwg4: $resarr['error'] = 1; goto z9ou8; tI3y8: ygVfw: goto wU8tc; pIqtb: $chatid = intval($_GPC['chatid']); goto MO9cn; z0rAV: load()->func('file'); goto mtjK0; W2MRK: $resarr['error'] = 1; goto bXQVc; qyzxU: $qiniuurl = $this->getmoduleconfig('qiniuurl'); goto hrKQX; NJq0c: if (!empty($chatres2)) { goto hiiam; } goto wkAdW; yrxHK: $targetName = '../attachment/' . $randvoiceurl; goto mZCyc; cB8TJ: $resarr['error'] = 0; goto jQffP; aMb0q: die(json_encode($resarr)); goto nR50o; YrvT9: $uploadmgr = new Qiniu\Storage\UploadManager($config); goto icAuU; DFmw0: $fops = 'avthumb/mp3/ab/320k/ar/44100/acodec/libmp3lame'; goto gIq1T; dpnKx: $access_token = $account_api->getAccessToken(); goto Ww9Y1; xPDgV: $resarr['msg'] = '解析成功'; goto aMb0q; guEl2: pdo_update(BEST_CHAT, array("mp3du" => 1), array("id" => $chatres['id'])); goto eMm9v; yKAkL: die(json_encode($resarr)); goto vnyiM; EUqZg: W1LJu: goto e71Jc; bNp9G: $resarr['weidu'] = 1; goto HclIv; yYE3j: pdo_update(BEST_CHAT, $dataup, array("id" => $chatres['id'])); goto cB8TJ; PCLMP: Y8CI0: goto e00OL; IAGzr: die(json_encode($resarr)); goto Y9DV0; A_JvZ: $isqiniu = $this->getmoduleconfig('isqiniu'); goto uREyw; WYCbP: $qiniubucket = $this->getmoduleconfig('qiniubucket'); goto qyzxU; r409f: if (!($chatres['mp3du'] == 1)) { goto Y8CI0; } goto fzwg4; StoSq: IyBF0: goto r409f; z9ou8: $resarr['msg'] = '语音正在加载中，请稍后！'; goto jifT2; JKmvU: $config = new Qiniu\Config(); goto YrvT9; XXQgV: $media_id = $_GPC['media_id']; goto d4F5V; jJIxu: $response = ihttp_get($url); goto x_b7l; AZORM: EQE7e: goto yRDRY; jifT2: die(json_encode($resarr)); goto PCLMP; Ach5D: $savemp3 = 'audios/' . $_W['uniacid'] . '/' . date('Y', time()) . '/' . date('m', time()) . '/' . date('YmdHis') . rand(1000, 9999) . '.mp3'; goto z0rAV; uouRg: die(json_encode($resarr)); goto FcDNq; AAZYO: $resarr['msg'] = '获取微信媒体参数失败！'; goto IAGzr; eMm9v: sleep(5); goto K7olU; vnyiM: h1I_H: goto TR25E; nR50o: goto RRIfZ; goto SmSLY; J4KG6: global $_W, $_GPC; goto Pjxdo; gAAXD: goto ygVfw; goto EUqZg; E9G17: if (!empty($chatres)) { goto IyBF0; } goto mrrjv; yBjnd: $dataup['hasyuyindu'] = 1; goto bNp9G; yRDRY: $account_api = WeAccount::create(); goto dpnKx; K7olU: file_delete($randvoiceurl); goto hEQut; icAuU: $putpolicy = Qiniu\base64_urlSafeEncode($qiniubucket . ':' . $savemp3); goto DFmw0; wGw44: $resarr['error'] = 1; goto ahijN; KdmA6: load()->func('communication'); goto A_JvZ; korOL: die(json_encode($resarr)); goto AZORM; Ww9Y1: $url = 'http://file.api.weixin.qq.com/cgi-bin/media/get?access_token=' . $access_token . '&media_id=' . $media_id; goto jJIxu; Pjxdo: $openid = $_SESSION['openid']; goto KdmA6; uoB1_: $resarr['msg'] = "访问公众平台接口失败, 错误: {$response['message']}"; goto yKAkL; jQffP: $resarr['voicefile'] = $qiniuurl . '/' . $ret['key']; goto xPDgV; mrrjv: $chatres2 = pdo_fetch('SELECT * FROM ' . tablename(BEST_CHAT) . " WHERE weid = {$_W['uniacid']} AND id = {$chatid}"); goto NJq0c; Y9DV0: hiiam: goto NX1zK; e00OL: if (!(strpos($chatres['content'], '.mp3') !== false)) { goto EQE7e; } goto hGEDX; Aop4X: $qiniusecretkey = $this->getmoduleconfig('qiniusecretkey'); goto WYCbP; XxWDA: $randvoiceurl = 'audios/' . $_W['uniacid'] . '/' . date('Y', time()) . '/' . date('m', time()) . '/' . date('YmdHis') . rand(1000, 9999) . '.amr'; goto yrxHK; HclIv: uphxR: goto oxs2Y; mZCyc: $fp = @fopen($targetName, 'wb'); goto JeMTz; ejPov: } public function doWebQianru() { goto xLUE1; REG8e: pdo_update(BEST_CSERVICE, $data, array("id" => $id)); goto ZuFAq; K3o2h: goto YL_DR; goto geThw; arVPc: $operation = !empty($_GPC['op']) ? $_GPC['op'] : 'display'; goto PczfX; IJAeQ: $row['qrset'] = unserialize($row['qrmsg']); goto smAU9; geThw: Sfbcr: goto b0j12; stnf6: HRzYs: goto pM5Ib; qx6Hl: include $this->template('web/qianru'); goto uan_4; XZ2ZT: Ld7m7: goto wCjcZ; pM5Ib: $id = intval($_GPC['id']); goto F1s0T; jswXG: goto YL_DR; goto XZ2ZT; PblA7: if ($operation == 'qianru') { goto Sfbcr; } goto XfrAF; XfrAF: if ($operation == 'qrset') { goto HRzYs; } goto jswXG; xLUE1: global $_GPC, $_W; goto arVPc; F1s0T: $qrset = array("qrsetbgcolor" => trim($_GPC['qrsetbgcolor']), "qrsettextcolor" => trim($_GPC['qrsettextcolor']), "qrsettext" => trim($_GPC['qrsettext']), "qrsettextsize" => intval($_GPC['qrsettextsize']), "qrwidth" => intval($_GPC['qrwidth']), "qrbottom" => intval($_GPC['qrbottom']), "qrright" => intval($_GPC['qrright']), "qrsetlineheight" => intval($_GPC['qrsetlineheight']), "qrphonetu" => trim($_GPC['qrphonetu']), "qrbottom2" => intval($_GPC['qrbottom2']), "qrright2" => intval($_GPC['qrright2']), "qrwidth2" => intval($_GPC['qrwidth2'])); goto qxaho; Rwg6z: $row = pdo_fetch('SELECT * FROM ' . tablename(BEST_CSERVICE) . " WHERE weid = '{$_W['uniacid']}' AND ctype = 1 AND id = {$id}"); goto IJAeQ; smAU9: goto YL_DR; goto stnf6; b0j12: $id = intval($_GPC['id']); goto Rwg6z; eWEIZ: foreach ($cservicelist as $k => $v) { goto qtAht; qtAht: $qrset = unserialize($v['qrmsg']); goto yODsv; UTeTQ: $cservicelist[$k]['scripthtml2'] = htmlentities('<a href="' . $scripturl2 . '" style="z-index:10001;position:absolute;right:' . $qrset['qrright2'] . 'px;bottom:' . $qrset['qrbottom2'] . 'px;"><img style="height:auto;width:' . $qrset['qrwidth2'] . 'px;" src="' . tomedia($qrset['qrphonetu']) . '" /></a>'); goto C5SOm; C5SOm: rlLW0: goto XmMuk; lNdnp: $scripturl2 = $_W['siteroot'] . 'app/index.php?i=' . $_W['uniacid'] . '&c=entry&do=chat&m=cy163_customerservice&toopenid=' . $v['content']; goto UTeTQ; yODsv: $scripturl = $_W['siteroot'] . 'app/index.php?i=' . $_W['uniacid'] . '&c=entry&do=index&m=cy163_customerservice_plugin_p&toopenid=' . $v['content']; goto CuppY; gy1eo: $cservicelist[$k]['scripthtml'] = ''; goto gkiqB; r7gfp: mHbUK: goto VAeBf; gkiqB: $cservicelist[$k]['scripthtml2'] = ''; goto ba_QM; XmMuk: qermt: goto OeAt8; hGk7u: $cservicelist[$k]['scripthtml'] = htmlspecialchars($scripthtml); goto lNdnp; VAeBf: $scripthtml = '<script type="text/javascript" src="' . $_W['siteroot'] . 'addons/cy163_customerservice_plugin_p/static/qianru.js"></script>
									<script type="text/javascript">
										document.getElementById("kfiframe").src="' . $scripturl . '";
										var xfkefu = document.getElementById("xfkefu");
										xfkefu.style.background = "' . $qrset['qrsetbgcolor'] . '";
										xfkefu.style.color = "' . $qrset['qrsettextcolor'] . '";
										xfkefu.innerText = "' . $qrset['qrsettext'] . '";
										xfkefu.style.fontSize = "' . $qrset['qrsettextsize'] . 'px";
										xfkefu.style.lineHeight = xfkefu.style.paddingTop = xfkefu.style.paddingBottom = "' . $qrset['qrsetlineheight'] . 'px";
										xfkefu.style.width = "' . $qrset['qrwidth'] . 'px";
										xfkefu.style.bottom = "' . $qrset['qrbottom'] . 'px";
										xfkefu.style.right = "' . $qrset['qrright'] . 'px";
									</script>
									'; goto hGk7u; ba_QM: goto rlLW0; goto r7gfp; CuppY: if (!empty($qrset)) { goto mHbUK; } goto gy1eo; OeAt8: } goto CvXeU; wCjcZ: $cservicelist = pdo_fetchall('SELECT * FROM ' . tablename(BEST_CSERVICE) . " WHERE weid = '{$_W['uniacid']}' AND ctype = 1 ORDER BY displayorder ASC"); goto eWEIZ; PczfX: if ($operation == 'display') { goto Ld7m7; } goto PblA7; qxaho: $data['qrmsg'] = serialize($qrset); goto REG8e; ZuFAq: message('设置成功！', referer(), 'success'); goto bYCju; bYCju: YL_DR: goto qx6Hl; CvXeU: Ui8w1: goto K3o2h; uan_4: } public function doWebCservice() { global $_W, $_GPC; include IA_ROOT . '/addons/cy163_customerservice/inc/web/cservice.php'; } public function doWebCgroup() {  goto yo6rI; B2NK1: foreach ($cservicegrouplist as $k => $v) { $cservicegrouplist[$k]['servicegroupurl'] = $_W['siteroot'] . 'app/' . str_replace('./', '', $this->createMobileUrl('index', array("groupid" => $v['id']))); Q1ib6: } goto lDs1Z; jGyom: include $this->template('web/cgroup'); goto Sftvc; yo6rI: global $_W, $_GPC; goto UAwqZ; UAwqZ: $cservicegrouplist = pdo_fetchall('SELECT * FROM ' . tablename(BEST_CSERVICEGROUP) . " WHERE weid = {$_W['uniacid']} ORDER BY displayorder ASC"); goto B2NK1; lDs1Z: U1yCX: goto jGyom; Sftvc: } public function doMobileIndex() { goto s9AgB; Fq4qI: if (empty($array2[0])) { goto KOrHF; } goto X2o2b; Gw37j: $datafanskefu['fangke'] = serialize($fangkearr); goto DwRwL; PNowk: $title = '和' . $cservice['name'] . '的对话'; goto oAjB3; e5QeR: pdo_update(BEST_FANSKEFU, $datafanskefuup, array("id" => $fkid)); goto PNowk; yVlg9: mkRYK: goto lltKA; Vtf3p: SrH21: goto dgKTv; nSl6x: ooVch: goto TxM10; GF9oW: We_BE: goto igt_A; X2o2b: foreach ($array2[0] as $kk => $vv) { goto TnwAc; TnwAc: if (empty($vv)) { goto sXJIN; } goto oBPGf; tpwJQ: sXJIN: goto AN940; oBPGf: $cservice['autoreply'] = str_replace($vv, '<a href=\'' . $vv . '\'>' . $vv . '</a>', $cservice['autoreply']); goto tpwJQ; AN940: gxSzW: goto w4mqb; w4mqb: } goto fD7Lz; bwSXM: if (!empty($cservicegroup)) { goto hBhrQ; } goto z4zqr; lh2Dp: goto IQcqW; goto NiqW1; aVGJ3: $ipurl = 'https://apis.map.qq.com/ws/location/v1/ip?ip=' . $_W['clientip'] . '&key=' . $mapkey; goto jYJhI; DwRwL: pdo_insert(BEST_FANSKEFU, $datafanskefu); goto OEaQz; myd_I: av7sI: goto SiFej; lazxL: $condition .= ' AND ((day3 = 1 AND isxingqi = 1) OR isxingqi = 0))'; goto EytFe; XdT65: goto mkRYK; goto m_B3A; kBLuh: $kefuandgroup = pdo_fetchall('SELECT kefuid FROM ' . tablename(BEST_KEFUANDGROUP) . " WHERE weid = {$_W['uniacid']} AND groupid = {$cservicegroup['id']}"); goto IxksK; HlOJj: JU3DD: goto CNyHG; tam3T: preg_match_all($regex, $cservice['autoreply'], $array2); goto Fq4qI; SiFej: $zhouji = date('w'); goto wYl4a; c8iOb: $datafanskefu['fansopenid'] = $openid; goto cmzq4; fD7Lz: ecGJL: goto tHnls; oTnCG: $regex = '@(?i)\\b((?:[a-z][\\w-]+:(?:/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:\'".,<>?«»“”‘’]))@'; goto tam3T; lZgLa: $mapkey = $this->getmoduleconfig('mapkey'); goto wStc3; kyMkG: $ipres = json_decode($ipres, true); goto lPjxS; s9AgB: global $_W, $_GPC; goto lZgLa; NECXj: $hasfanskefu = pdo_fetch('SELECT * FROM ' . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W['uniacid']} AND fansopenid = '{$openid}' AND kefuopenid = '{$toopenid}'"); goto KewtO; l7rmz: $ipres = file_get_contents($ipurl); goto vB5ZE; YWjBp: $suiji = $this->getmoduleconfig('suiji'); goto N7Bbr; H7mnp: $openid = md5($jiamistr); goto hnt1q; pRR3w: $condition .= ' AND ((day1 = 1 AND isxingqi = 1) OR isxingqi = 0))'; goto mMxE4; ditPC: if (!($zhouji == '0')) { goto JU3DD; } goto Ttjh7; JRGQB: $nowhouradd = $nowhour + 1; goto NbfuY; NiqW1: GStMo: goto gpxj2; lltKA: $jiamistr = $this->get_lang() . $this->browse_info() . $this->get_os() . $latitude . $longitude; goto H7mnp; vNc4i: $cservicegroup = pdo_fetch('SELECT * FROM ' . tablename(BEST_CSERVICEGROUP) . " WHERE weid = {$_W['uniacid']} AND id = {$groupid}"); goto Sxmem; iyuGW: foreach ($kefuandgroup as $k => $v) { $kefuids[] = $v['kefuid']; jI6pK: } goto eA9mP; dgKTv: $ipurl = 'https://apis.map.qq.com/ws/location/v1/ip?ip=' . $_W['clientip'] . '&key=' . $mapkey; goto fNh3x; WOy4v: if (!($zhouji == '2')) { goto ooVch; } goto R5ruy; hs4K1: $fangkearr = array("lang" => $this->get_lang(), "browse" => $this->browse_info(), "os" => $this->get_os(), "ip" => $_W['clientip'], "laiyuan" => $_SERVER['HTTP_REFERER'], "latitude" => $ipres['result']['location']['lat'], "longitude" => $ipres['result']['location']['lng'], "nation" => $ipres['result']['ad_info']['nation'], "province" => $ipres['result']['ad_info']['province'], "city" => $ipres['result']['ad_info']['city'], "district" => $ipres['result']['ad_info']['district'], "gzhname" => $_W['account']['name']); goto wg4g0; cBU1B: if (!($zhouji == '4')) { goto ZBYj7; } goto Q2w1i; wg4g0: $datafanskefu['weid'] = $_W['uniacid']; goto c8iOb; NbfuY: $condition = "weid = {$_W['uniacid']} AND id in (" . implode(',', $kefuids) . ") AND ((iszx = 0 AND (
					(lingjie = 0 AND endhour >= {$nowhouradd} AND starthour <= {$nowhour}) OR 
					(lingjie = 1 AND (starthour < {$nowhouradd} OR endhour > {$nowhour}))
				)"; goto myd_I; xuatO: $fangkearr = unserialize($hasfanskefu['fangke']); goto pal1c; fX6VZ: $chatcon = pdo_fetchall('SELECT * FROM ' . tablename(BEST_CHAT) . " WHERE fkid = {$hasfanskefu['id']} AND weid = {$_W['uniacid']} AND type != 5 AND type != 6 ORDER BY time ASC"); goto W_s_E; CRKt5: goto k2ZpN; goto yo9Et; F5bsF: $nowhour = intval(date('H', TIMESTAMP)); goto HyfPU; vB5ZE: $ipres = json_decode($ipres, true); goto hs4K1; Sxmem: if (!empty($cservicegroup)) { goto Lz2cV; } goto F5bsF; wNFM6: if (!empty($toopenid)) { goto gXDor; } goto Cfh8m; ixHRK: $latitude = $ipres['result']['location']['lat'] . random(4, 1); goto wTsJj; xyVN8: $title = '请选择客服'; goto ikbWv; TF1o0: if (!($zhouji == '5')) { goto WMwIF; } goto CuaE0; CuaE0: $condition .= ' AND ((day5 = 1 AND isxingqi = 1) OR isxingqi = 0))'; goto HWkoE; m_B3A: xb1_f: goto aVGJ3; pal1c: if ($fangkearr['latitude'] == '' || $fangkearr['ip'] != $_W['clientip']) { goto SrH21; } goto CUQUK; VIOOo: if (!($zhouji == '6')) { goto pRE8S; } goto sYQtI; F7Rdg: IQcqW: goto KJvZA; KJvZA: $cservicelist = pdo_fetchall('SELECT * FROM ' . tablename(BEST_CSERVICE) . ' WHERE ' . $condition . $orderby); goto bwSXM; L9Xd3: Lz2cV: goto kBLuh; ZvlFe: if (empty($toopenid)) { goto OaN1x; } goto jy22n; eA9mP: urXxM: goto hjQSR; igt_A: $datafanskefuup['fangke'] = serialize($fangkearr); goto CRKt5; NlsEu: $datafanskefu['kefuavatar'] = tomedia($cservice['thumb']); goto B4x6F; hnt1q: $toopenid = trim($_GPC['toopenid']); goto wNFM6; Ttjh7: $condition .= ' AND ((day7 = 1 AND isxingqi = 1) OR isxingqi = 0))'; goto HlOJj; KewtO: if (empty($hasfanskefu)) { goto ZSNmT; } goto xuatO; bkWjs: k2ZpN: goto SauW1; tHnls: KOrHF: goto SQEeB; Zzlz6: setcookie('kflongitude', $longitude, time() + 3600 * 24 * 7); goto yVlg9; SMBjN: setcookie('kflatitude', $latitude, time() + 3600 * 24 * 7); goto Zzlz6; LW1jP: pRE8S: goto ditPC; IL5d_: RDMDM: goto pMklw; Zun2Z: $auto = explode('|', $cservice['fansauto']); goto NECXj; N7Bbr: if ($suiji == 1) { goto GStMo; } goto mJqfs; OEaQz: $hasfanskefu = pdo_fetch('SELECT * FROM ' . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W['uniacid']} AND fansopenid = '{$openid}' AND kefuopenid = '{$toopenid}'"); goto bkWjs; mJqfs: $orderby = ' ORDER BY displayorder ASC'; goto lh2Dp; CUQUK: $fangkearr['laiyuan'] = $_SERVER['HTTP_REFERER']; goto yOUfj; mDhRO: $datafanskefu['fansavatar'] = tomedia($defaultavatar); goto UMp1L; UsqPk: $ipres = json_decode($ipres, true); goto ixHRK; EUfzu: foreach ($chatcon as $k => $v) { goto Lstkb; FAWPW: $chatcon[$k]['time'] = ''; goto lpnM1; i3RHK: $chatcon[$k]['time'] = $v['time']; goto TORnd; UhyLN: if (!(!empty($array2[0]) && ($v['type'] == 1 || $v['type'] == 2))) { goto OZNrx; } goto ybq07; lpnM1: goto ajwcH; goto ic76r; WZqTv: $chatcontime = $v['time']; goto yVQSn; PZSSX: F3_lZ: goto BXW6O; ybq07: foreach ($array2[0] as $kk => $vv) { goto qDgBe; PwS2r: Dbnch: goto Y4Shx; Y4Shx: A1e6F: goto r4T6e; qDgBe: if (empty($vv)) { goto Dbnch; } goto MNwmq; MNwmq: $chatcon[$k]['content'] = str_replace($vv, '<a href=\'' . $vv . '\'>' . $vv . '</a>', $chatcon[$k]['content']); goto PwS2r; r4T6e: } goto PZSSX; kokN2: $chatcon[$k]['content'] = $this->guolv($chatcon[$k]['content']); goto yJM3G; yJM3G: $regex = '@(?i)\\b((?:[a-z][\\w-]+:(?:/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:\'".,<>?«»“”‘’]))@'; goto Kom2X; Lstkb: if ($v['time'] - $chatcontime > 7200) { goto OZ3Km; } goto FAWPW; TORnd: ajwcH: goto WZqTv; C7w3U: sR1nW: goto Vm6v7; ic76r: OZ3Km: goto i3RHK; Kom2X: preg_match_all($regex, $chatcon[$k]['content'], $array2); goto UhyLN; BXW6O: OZNrx: goto C7w3U; yVQSn: $chatcon[$k]['content'] = preg_replace('/\\xEE[\\x80-\\xBF][\\x80-\\xBF]|\\xEF[\\x81-\\x83][\\x80-\\xBF]/', '[无法识别字符]', $v['content']); goto kokN2; Vm6v7: } goto T6B75; ikbWv: gXDor: goto ZvlFe; R5ruy: $condition .= ' AND ((day2 = 1 AND isxingqi = 1) OR isxingqi = 0))'; goto nSl6x; TxM10: if (!($zhouji == '3')) { goto FxU3k; } goto lazxL; MOCUs: $condition = "weid = {$_W['uniacid']} AND ctype = 1 AND ((iszx = 0 AND (
					(lingjie = 0 AND endhour >= {$nowhouradd} AND starthour <= {$nowhour}) OR 
					(lingjie = 1 AND (starthour < {$nowhouradd} OR endhour > {$nowhour}))
				)"; goto so0Iv; fNh3x: $ipres = file_get_contents($ipurl); goto kyMkG; yo9Et: ZSNmT: goto qe3r5; jy22n: $cservice = pdo_fetch('SELECT * FROM ' . tablename(BEST_CSERVICE) . " WHERE weid = {$_W['uniacid']} AND ctype = 1 AND content = '{$toopenid}'"); goto Zun2Z; sYQtI: $condition .= ' AND ((day6 = 1 AND isxingqi = 1) OR isxingqi = 0))'; goto LW1jP; jYJhI: $ipres = file_get_contents($ipurl); goto UsqPk; VciAT: if (empty($_COOKIE['kflatitude'])) { goto xb1_f; } goto pxBaG; Cfh8m: $groupid = intval($_GPC['groupid']); goto vNc4i; HyfPU: $nowhouradd = $nowhour + 1; goto MOCUs; yOUfj: $fangkearr['gzhname'] = $_W['account']['name']; goto CK216; IxksK: $kefuids = array(0); goto iyuGW; B4x6F: $datafanskefu['kefunickname'] = $cservice['name']; goto Gw37j; W_s_E: $chatcontime = 0; goto EUfzu; wYl4a: if (!($zhouji == '1')) { goto p9HmS; } goto pRR3w; DG6FO: ZBYj7: goto TF1o0; Q2w1i: $condition .= ' AND ((day4 = 1 AND isxingqi = 1) OR isxingqi = 0))'; goto DG6FO; oAjB3: OaN1x: goto QoJsU; BYack: $longitude = $_COOKIE['kflongitude']; goto XdT65; lPjxS: $fangkearr = array("lang" => $this->get_lang(), "browse" => $this->browse_info(), "os" => $this->get_os(), "ip" => $_W['clientip'], "laiyuan" => $_SERVER['HTTP_REFERER'], "latitude" => $ipres['result']['location']['lat'], "longitude" => $ipres['result']['location']['lng'], "nation" => $ipres['result']['ad_info']['nation'], "province" => $ipres['result']['ad_info']['province'], "city" => $ipres['result']['ad_info']['city'], "district" => $ipres['result']['ad_info']['district'], "gzhname" => $_W['account']['name']); goto GF9oW; gpxj2: $orderby = ' ORDER BY rand()'; goto F7Rdg; CNyHG: $condition .= ' OR (iszx = 1 AND isrealzx = 1))'; goto YWjBp; pMklw: hBhrQ: goto xyVN8; SQEeB: e3hoJ: goto fX6VZ; wTsJj: $longitude = $ipres['result']['location']['lng'] . random(4, 1); goto SMBjN; pxBaG: $latitude = $_COOKIE['kflatitude']; goto BYack; wStc3: $defaultavatar = $this->getmoduleconfig('defaultavatar'); goto VciAT; QoJsU: include $this->template('pcchat'); goto VL1gI; EytFe: FxU3k: goto cBU1B; qe3r5: $ipurl = 'https://apis.map.qq.com/ws/location/v1/ip?ip=' . $_W['clientip'] . '&key=' . $mapkey; goto l7rmz; so0Iv: goto av7sI; goto L9Xd3; UMp1L: $datafanskefu['fansnickname'] = '游客'; goto NlsEu; BWvnv: if (!$cservice['autoreply']) { goto e3hoJ; } goto oTnCG; CK216: goto We_BE; goto Vtf3p; SauW1: $fkid = $hasfanskefu['id']; goto BWvnv; mMxE4: p9HmS: goto WOy4v; cmzq4: $datafanskefu['kefuopenid'] = $cservice['content']; goto mDhRO; ny2Wj: $datafanskefuup['kefunotread'] = 0; goto e5QeR; HWkoE: WMwIF: goto VIOOo; hjQSR: $nowhour = intval(date('H', TIMESTAMP)); goto JRGQB; z4zqr: foreach ($cservicelist as $k => $v) { goto WbxKv; bV_mC: if (empty($kefuandgroup)) { goto auZQ1; } goto Tq1vV; Tq1vV: unset($cservicelist[$k]); goto SrLq8; WbxKv: $kefuandgroup = pdo_fetch('SELECT id FROM ' . tablename(BEST_KEFUANDGROUP) . " WHERE kefuid = {$v['id']}"); goto bV_mC; DzBp0: RTZIT: goto X9eT2; SrLq8: auZQ1: goto DzBp0; X9eT2: } goto IL5d_; T6B75: d2oNi: goto ny2Wj; VL1gI: } public function updatenowjdnum() { goto i3uwh; HIJLt: $cservicelist = pdo_fetchall('SELECT id,content FROM ' . tablename(BEST_CSERVICE) . " WHERE weid = {$_W['uniacid']} AND ctype = 1"); goto NO_BY; NO_BY: foreach ($cservicelist as $k => $v) { goto eNunJ; fsWht: $data['nowjdnum'] = $nowjdnum; goto e7tTI; toTsM: yN3RM: goto G7GwC; eNunJ: $nowjdnum = pdo_fetchcolumn('SELECT COUNT(*) FROM ' . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W['uniacid']} AND nowjd > 0 AND kefuopenid = '{$v['content']}'"); goto x5Sfh; G7GwC: YljvR: goto q1S8P; x5Sfh: if (empty($nowjdnum)) { goto yN3RM; } goto fsWht; e7tTI: pdo_update(BEST_CSERVICE, $data, array("id" => $v['id'])); goto toTsM; q1S8P: } goto F1Meq; F1Meq: a21PE: goto vXbIP; i3uwh: global $_W, $_GPC; goto HIJLt; vXbIP: } public function doMobileXiaxian() { goto SR5H1; iByOf: if (!($type == 'kefu')) { goto WxBfJ; } goto mAd3R; O80mf: $type = trim($_GPC['type']); goto IZ9AH; iQrk5: $data['notread'] = 0; goto ochAo; pgJ47: WxBfJ: goto fA9Wr; mAd3R: $data['kfzx'] = 0; goto iQrk5; GeuvE: snLOl: goto iByOf; nxLSP: pdo_update(BEST_FANSKEFU, $data, array("id" => $fkid)); goto GeuvE; ochAo: pdo_update(BEST_FANSKEFU, $data, array("id" => $fkid)); goto pgJ47; P5D3c: $data['kefunotread'] = 0; goto nxLSP; wqmB0: $data['fszx'] = 0; goto P5D3c; SR5H1: global $_W, $_GPC; goto TN5K6; TN5K6: $fkid = intval($_GPC['fkid']); goto O80mf; IZ9AH: if (!($type == 'fans')) { goto snLOl; } goto wqmB0; fA9Wr: } public function doMobileShangxian() { goto YnE0O; Dpx4d: $fkid = intval($_GPC['fkid']); goto jICcT; wRDYF: pdo_update(BEST_FANSKEFU, $data, array("id" => $fkid)); goto R4IwO; Dy3Ju: $data['kfzx'] = 1; goto wRDYF; jICcT: $type = trim($_GPC['type']); goto X5aSE; ngJrK: pdo_update(BEST_FANSKEFU, $data, array("id" => $fkid)); goto eEUjt; zxzC3: $data['fszx'] = 1; goto ngJrK; NDyR2: if (!($type == 'kefu')) { goto PWS1x; } goto Dy3Ju; R4IwO: PWS1x: goto mLTnu; YnE0O: global $_W, $_GPC; goto Dpx4d; X5aSE: if (!($type == 'fans')) { goto scAPV; } goto zxzC3; eEUjt: scAPV: goto NDyR2; mLTnu: } public function doMobileGetnew() { goto b15ZR; X662J: $resArr['html'] = $html; goto d2p0Y; pbgvz: $html = ''; goto K7pgB; wOmUP: exit; goto sbHe3; pRhMI: mHg3U: goto KhEiZ; EgZSY: foreach ($newfans as $k => $v) { goto wEW_i; GTT6I: t1Dnc: goto BWAuV; z5p5c: MZzC8: goto DcsN3; NaxRS: $fansopenids[$k] = $v['fansopenid']; goto GTT6I; bYo0X: JuF27: goto mXXMJ; DcsN3: $notread = '<span class="notread">' . $v['notread'] . '</span>'; goto bYo0X; mXXMJ: $html .= '<a href="' . $this->createMobileUrl('kefucenter', array("toopenid" => $v['fansopenid'])) . '" style="color:#fff;">
						<li data-openid="' . $v['fansopenid'] . '" class="new" style="position:relative;">
							<img class="avatar" src="' . $v['fansavatar'] . '" width="30" height="30">
							<p class="name">' . $v['fansnickname'] . '</p>
							' . $notread . '
						</li></a>'; goto NaxRS; I84lr: goto JuF27; goto z5p5c; wEW_i: if ($v['notread'] > 0) { goto MZzC8; } goto ClFz1; ClFz1: $notread = ''; goto I84lr; BWAuV: } goto pRhMI; XmfNr: if (empty($newfans)) { goto GuiML; } goto EgZSY; d2p0Y: $resArr['fansopenids'] = $fansopenids; goto BO68m; KhEiZ: GuiML: goto X662J; K7pgB: $fansopenids = array(); goto XmfNr; vNVdj: $openid = $_SESSION['openid']; goto ULOyI; BO68m: echo json_encode($resArr); goto wOmUP; ULOyI: $newfans = pdo_fetchall('SELECT * FROM ' . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W['uniacid']} AND kefuopenid = '{$openid}' AND notread > 0 ORDER BY lasttime DESC"); goto pbgvz; b15ZR: global $_W, $_GPC; goto vNVdj; sbHe3: } public function doMobileDonotread() { goto k9r8l; DthO0: $fkid = intval($_GPC['fkid']); goto sRo_A; j8jdE: $data['notread'] = 0; goto IZp1U; HxoT6: pdo_update(BEST_FANSKEFU, $data, array("id" => $fkid)); goto SsH1u; k9r8l: global $_W, $_GPC; goto DthO0; No34D: eMSlB: goto IHmap; SsH1u: Bf1ew: goto IeBHm; IZp1U: pdo_update(BEST_FANSKEFU, $data, array("id" => $fkid)); goto No34D; sRo_A: $type = trim($_GPC['type']); goto AUpy_; IeBHm: if (!($type == 'kefu')) { goto eMSlB; } goto j8jdE; S920Y: $data['kefunotread'] = 0; goto HxoT6; AUpy_: if (!($type == 'fans')) { goto Bf1ew; } goto S920Y; IHmap: } public function doMobileDonotread2() { goto Kif7W; kyEqi: pdo_update(BEST_XCXFANSKEFU, $data, array("id" => $fkid)); goto orCa5; d4H2j: $fkid = intval($_GPC['fkid']); goto zyDz_; Kif7W: global $_W, $_GPC; goto d4H2j; zyDz_: $data['notread'] = 0; goto kyEqi; orCa5: } public function doMobileAddbiaoqian() { goto gwYV5; TfkFL: la0hu: goto sesRi; gwYV5: global $_W, $_GPC; goto KVczu; qsgvy: echo json_encode($resArr); goto Na2j8; fL42V: $data['telphone'] = $telphone; goto R738_; YMnBg: if ($has) { goto VN9vg; } goto wew4R; sMku0: if (!empty($name)) { goto clLJx; } goto FgJWu; u1GBS: $resArr['error'] = 1; goto vmhuQ; Y2qVi: $resArr['msg'] = '请填写标签内容！'; goto h23vy; hZe3z: exit; goto AYm3D; rK1cC: exit; goto pRD0M; WZngv: $realname = trim($_GPC['realname']); goto O8QGk; R738_: pdo_insert(BEST_BIAOQIAN, $data); goto j5tLd; vmhuQ: $resArr['msg'] = '未获取到您的客服信息！'; goto qsgvy; lnaBj: $resArr['msg'] = '添加用户标签成功！'; goto iuFI3; O8QGk: $telphone = trim($_GPC['telphone']); goto VX1U3; sesRi: $name = trim($_GPC['name']); goto sMku0; VX1U3: $toopenid = trim($_GPC['toopenid']); goto mJLuU; iuFI3: echo json_encode($resArr); goto rK1cC; h23vy: echo json_encode($resArr); goto hZe3z; wew4R: $data['weid'] = $_W['uniacid']; goto M8ex0; FgJWu: $resArr['error'] = 1; goto Y2qVi; KVczu: $openid = $_SESSION['openid']; goto EVu7_; MSQoO: VN9vg: goto s9Gt8; H0M0R: $data['fensiopenid'] = $toopenid; goto bBBEh; dACLw: $data['realname'] = $realname; goto fL42V; EVu7_: if (!empty($openid)) { goto la0hu; } goto u1GBS; mJLuU: $has = pdo_fetch('SELECT * FROM ' . tablename(BEST_BIAOQIAN) . " WHERE kefuopenid = '{$openid}' AND fensiopenid = '{$toopenid}' AND weid = {$_W['uniacid']}"); goto YMnBg; M8ex0: $data['kefuopenid'] = $openid; goto H0M0R; Na2j8: exit; goto TfkFL; j5tLd: goto N4yAa; goto MSQoO; bBBEh: $data['name'] = $name; goto dACLw; s9Gt8: pdo_update(BEST_BIAOQIAN, array("name" => $name, "realname" => $realname, "telphone" => $telphone), array("kefuopenid" => $openid, "fensiopenid" => $toopenid, "weid" => $_W['uniacid'])); goto Jhs2O; OdVw5: $resArr['error'] = 0; goto lnaBj; Jhs2O: N4yAa: goto OdVw5; AYm3D: clLJx: goto WZngv; pRD0M: } public function sendtplmsg($senddata) { goto DTfcq; NZlUV: $send['msgtype'] = 'text'; goto wVLM_; znMnQ: $tpl_kefu = $this->getmoduleconfig('tpl_kefu'); goto kaD7a; SLLqd: $istplon = $this->getmoduleconfig('istplon'); goto znMnQ; b1HYI: $send['touser'] = $senddata['openid']; goto NZlUV; iDO3F: $account_api->sendCustomNotice($send); goto nQeK5; qNlse: XkZYV: goto JJZYC; Pd022: $texturl = '<a href=\'' . $senddata['url'] . '\'>点击查看</a>'; goto b1HYI; wVLM_: $send['text'] = array("content" => urlencode($senddata['first'])); goto rSqKa; OUAND: $account_api->sendTplNotice($senddata['openid'], $tpl_kefu, $postdata, $senddata['url'], '#980000'); goto qNlse; z6Jru: EQ7LI: goto I10G1; kaD7a: if (!($istplon == 1)) { goto oLC2T; } goto km6Ip; nQeK5: goto XkZYV; goto z6Jru; JJZYC: oLC2T: goto fR61k; DTfcq: global $_GPC, $_W; goto SLLqd; rSqKa: $account_api = WeAccount::create(); goto iDO3F; VHUcV: $account_api = WeAccount::create(); goto OUAND; km6Ip: if ($tpl_kefu != '' && $senddata['wherefrom'] != 1) { goto EQ7LI; } goto Pd022; I10G1: $postdata = array("keyword1" => array("value" => $senddata['keyword1'], "color" => "#ff510"), "keyword2" => array("value" => date('Y-m-d H:i:s', TIMESTAMP), "color" => "#ff510"), "remark" => array("value" => $senddata['first'], "color" => "#0000CD")); goto VHUcV; fR61k: } public function doMobileAddchat() { goto jv95w; JH2vL: $tplcon = $data['nickname'] . '发送了图片'; goto Nc93m; zX_Ad: $resArr['error'] = 1; goto jGGWy; pBs0v: $tplcon = $this->guolv($tplcon); goto BJlUr; BTOP0: $data['weid'] = $_W['uniacid']; goto Akz40; LKYNi: n9sbr: goto gzIUX; h_yx4: if (!($cservice['day4'] == 0)) { goto KdRBc; } goto q5lZQ; P8jin: $guotime = TIMESTAMP - $fanskefu['lasttime']; goto cbjhw; CeQmI: exit; goto POqSn; Bze0z: if ($zhouji == '1') { goto vfcDG; } goto rAgdr; Akz40: $type = intval($_GPC['type']); goto umJ4E; lZCaB: $resArr['jqravatar'] = tomedia($cservice['thumb']); goto kvGJK; DspSo: k0Au6: goto F2Z89; eRmil: $resArr['msg'] = $notonlinemsg; goto P9Uxe; Q3Fdc: $data['avatar'] = $fanskefu['fansavatar']; goto fr3mm; TorJ_: x99KT: goto JhG5n; DW_J8: if ($zhouji == '4') { goto Z25ma; } goto A2lsT; sgPEi: if (!($zdhf['hftype'] == 3)) { goto pcIW7; } goto oxMY2; XxjlO: exit; goto AkCaY; unMKF: goto E246c; goto zAQOw; srNUQ: $zdhf = pdo_fetch('select * from ' . tablename(BEST_ZIDONGHUIFU) . " where weid = {$_W['uniacid']} AND ((title = '{$chatcontent}' AND type = 1) OR (INSTR('{$chatcontent}',title) AND type = 2)) ORDER BY paixu DESC"); goto OF5XQ; K1BsD: $notonlinemsg = !empty($cservice['notonline']) ? $cservice['notonline'] : '客服不在线哦！'; goto P2Kjs; xInbK: $dataup_fanskefu['wherefrom'] = 0; goto o_izr; vLIVc: echo json_encode($resArr); goto CeQmI; rugzK: $resArr['datetime'] = date('Y-m-d H:i:s', $data['time']); goto cgnj8; np_H2: goto iYhK9; goto OxR2o; ggyTG: foreach ($otherfanskefus as $k => $v) { goto Zhzrb; mTYNu: pdo_update(BEST_FANSKEFU, $dataotherfk, array("id" => $v['id'])); goto AwMMc; tJOsH: $dataotherfk['jdtime'] = 0; goto mTYNu; AwMMc: DZSYz: goto dyzkV; Zhzrb: $dataotherfk['nowjd'] = 0; goto tJOsH; dyzkV: } goto xwUw5; ac_9R: $resArr['msg'] = ''; goto ZEMgq; nCdPd: echo json_encode($resArr); goto vVm95; Lb5q_: goto fM8W7; goto kbGi3; xSnPd: bL__o: goto eW2dZ; RAMTw: $resArr['error'] = 0; goto ac_9R; T5mIM: $this->updatenowjdnum(); goto bPZ4t; QZkVs: $resArr['msg'] = $notonlinemsg; goto NeeKp; j0FNS: pdo_insert(BEST_CHAT, $datajqr); goto CCZI9; Nsuvp: echo json_encode($resArr); goto jYjpm; B0y6L: exit; goto y15Xb; AL6GA: M7MW2: goto Unrle; MRnFl: goto IBhpt; goto N4w04; mE1eD: if ($zhouji == '0') { goto ag7mp; } goto uTNkd; v65b8: pcIW7: goto lZCaB; Y3sB3: goto IPSIb; goto DspSo; FplUw: AQprh: goto vuffe; dAWzY: $resArr['error'] = 1; goto kERO4; TKcoZ: $resArr['msg'] = $notonlinemsg; goto d6PUq; g8jvo: exit; goto ybNZr; hVF2q: tXB9G: goto Vget3; HhruI: $resArr['error'] = 1; goto K4XV6; FeEyT: TJjfp: goto O79Ig; xdZxM: $datajqr['type'] = $zdhf['hftype'] == 0 || $zdhf['hftype'] == 3 ? 2 : 4; goto NGbE7; ft2Eb: $cservice = pdo_fetch('SELECT * FROM ' . tablename(BEST_CSERVICE) . " WHERE weid = {$_W['uniacid']} AND ctype = 1 AND content = '{$_GPC['toopenid']}'"); goto emVIC; O79Ig: if (!($zdhf['hftype'] == 2)) { goto u1_NC; } goto XF_cN; cgnj8: $resArr['chatid'] = $chatid; goto R1Y71; aYc6M: $resArr['jqrcontent'] = htmlspecialchars_decode($zdhf['allcon']); goto v65b8; cjxD2: $resArr['msg'] = $notonlinemsg; goto vLIVc; QfoA1: u1_NC: goto sgPEi; o_izr: $dataup_fanskefu['fansdel'] = 0; goto RU0b1; PWjLP: fM8W7: goto XSICs; NeeKp: echo json_encode($resArr); goto B0y6L; gzIUX: goto nHvZ5; goto xSnPd; tNk4_: $datajqr['fkid'] = intval($_GPC['fkid']); goto EzwIE; BN8u7: $resArr['error'] = 1; goto QkTxV; jGGWy: $resArr['msg'] = '请输入对话内容！'; goto nCdPd; umJ4E: $data['type'] = $type; goto m5cEs; rJZ4T: $resArr['msg'] = $notonlinemsg; goto uYs95; E243L: pHLmL: goto Dp5Xl; A2lsT: if ($zhouji == '5') { goto bL__o; } goto eKU5d; NGbE7: $datajqr['isjqr'] = 1; goto j0FNS; qa3lC: if (empty($array2[0])) { goto LBuCi; } goto E8dAq; OF5XQ: if (empty($zdhf)) { goto aYmq9; } goto XHDp5; THXXT: $resArr['hftype'] = $zdhf['hftype']; goto tQew1; fr3mm: $data['toopenid'] = trim($_GPC['toopenid']); goto ic409; pZoii: $datajqr['content'] = $zdhf['content']; goto yhSJO; vabro: if (!($cservice['day2'] == 0)) { goto x99KT; } goto BN8u7; hqWRo: $dataup_fanskefu['nowjd'] = 1; goto tJBLm; xwreI: $datajqr['nickname'] = $cservice['name']; goto eyJHE; gqkvh: $resArr['jqrcontent'] = $zdhf['content']; goto FeEyT; jxnxA: exit; goto ohZ0x; ZjwLW: if (!($cservice['day3'] == 0)) { goto tXB9G; } goto ck9DW; ZwGGi: if (!($nowhour + 1 > $cservice['endhour'] && $nowhour < $cservice['starthour'])) { goto pHLmL; } goto OSG9a; d6PUq: echo json_encode($resArr); goto WfAyx; KacUZ: $datajqr['toopenid'] = $data['openid']; goto pms64; oJxRV: exit; goto Ct8ay; ohZ0x: KdRBc: goto VNGrN; SHrlW: MnC5x: goto LKYNi; kvGJK: $datajqr['weid'] = $_W['uniacid']; goto tNk4_; q5lZQ: $resArr['error'] = 1; goto rJZ4T; G0mi5: exit; goto SHrlW; ck9DW: $resArr['error'] = 1; goto Gebov; jv95w: global $_W, $_GPC; goto b10hc; eyJHE: $datajqr['avatar'] = tomedia($cservice['thumb']); goto xdZxM; POqSn: CQJyH: goto Y3sB3; WfAyx: exit; goto AL6GA; Cyc7r: $tplcon = $data['content']; goto f6kJQ; ic409: $data['time'] = TIMESTAMP; goto nnTmf; ZEMgq: $resArr['content'] = $this->doReplacecon($data['content'], $data['type']); goto rugzK; g6ipV: $lastcon = preg_replace('/\\xEE[\\x80-\\xBF][\\x80-\\xBF]|\\xEF[\\x81-\\x83][\\x80-\\xBF]/', '[无法识别字符]', $chatcontent); goto KVemV; tQew1: if (!($zdhf['hftype'] == 0)) { goto TJjfp; } goto pZoii; UuR1P: $tplurl = str_replace('cy163_customerservice_plugin_p', 'cy163_customerservice', $tplurl); goto YSzLN; uTNkd: $resArr['error'] = 1; goto R4_lo; uYs95: echo json_encode($resArr); goto jxnxA; R4_lo: $resArr['msg'] = $notonlinemsg; goto Nsuvp; vuffe: LBuCi: goto gqkvh; f4pcT: $dataup_fanskefu['lasttime'] = TIMESTAMP; goto TRdsK; SJ_zc: echo json_encode($resArr); goto g8jvo; kPs_s: $resArr['msg'] = $notonlinemsg; goto MZSCi; n4fxU: ECBWY: goto ft2Eb; uMHiZ: $dataup_fanskefu['notread'] = $fanskefu['notread'] + 1; goto fVBvf; nac7u: $resArr['error'] = 1; goto eRmil; Uim3C: $resArr['jqrtime'] = date('Y-m-d H:i:s', $jqrtime); goto THXXT; YSzLN: $senddata = array("openid" => $data['toopenid'], "url" => $tplurl, "first" => $tplcon, "keyword1" => $data['nickname']); goto D56h7; F2Z89: $nowhour = intval(date('H', TIMESTAMP)); goto ZwGGi; lXLLH: if ($zhouji == '3') { goto FbFDI; } goto DW_J8; K5usy: exit; goto TorJ_; eKU5d: if ($zhouji == '6') { goto BeYmT; } goto mE1eD; RU0b1: $dataup_fanskefu['kefudel'] = 0; goto cGfdR; Len99: if (!($cservice['isrealzx'] == 0)) { goto JhUmL; } goto K1BsD; RBRa1: $tplurl = $this->gettpldomain() . 'app/' . str_replace('./', '', $this->createMobileUrl('servicechat', array("ssopenid" => $data['openid'], "toopenid" => $data['openid']))); goto UuR1P; yhSJO: $regex = '@(?i)\\b((?:[a-z][\\w-]+:(?:/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:\'".,<>?«»“”‘’]))@'; goto eGzdY; D56h7: $this->sendtplmsg($senddata); goto Q2bpE; OxR2o: Z25ma: goto h_yx4; MY5EQ: $chatid = pdo_insertid(); goto srNUQ; N4w04: SMSSx: goto vabro; QkTxV: $resArr['msg'] = $notonlinemsg; goto q3kmh; f6kJQ: goto o18Y9; goto cnMYa; kERO4: $resArr['msg'] = $notonlinemsg; goto fTfTo; ybNZr: w7jt1: goto WhHE2; OF0uP: $resArr['error'] = 1; goto kPs_s; fVBvf: $dataup_fanskefu['guanlinum'] = $fanskefu['guanlinum'] + 1; goto xInbK; Dp5Xl: IPSIb: goto Lb5q_; JhG5n: IBhpt: goto qOWuL; lu_ZG: if (!($zdhf['kefuids'] == '' || in_array($cservice['id'], $zdhf_kefuids))) { goto s0iju; } goto fpLFG; iAnpy: if (!($cservice['day6'] == 0)) { goto MnC5x; } goto dAWzY; TRdsK: pdo_update(BEST_FANSKEFU, $dataup_fanskefu, array("id" => $fanskefu['id'])); goto RAMTw; K4XV6: $resArr['msg'] = $notonlinemsg; goto SJ_zc; VNGrN: iYhK9: goto xZPoI; BJlUr: pdo_insert(BEST_CHAT, $data); goto MY5EQ; P2Kjs: $resArr['error'] = 1; goto QZkVs; XHDp5: $zdhf_kefuids = unserialize($zdhf['kefuids']); goto lu_ZG; R1Y71: echo json_encode($resArr); goto XxjlO; E8dAq: foreach ($array2[0] as $kk => $vv) { goto zUBn8; WK3Ji: CMDqE: goto jhrBN; kUKBu: $vvurl = strstr($vv, 'http') ? $vv : 'http://' . $vv; goto TjDp1; zUBn8: if (empty($vv)) { goto CMDqE; } goto kUKBu; jhrBN: Gj0UQ: goto uRZu3; TjDp1: $zdhf['content'] = str_replace($vv, '<a href=\'' . $vvurl . '\'>' . $vv . '</a>', $zdhf['content']); goto WK3Ji; uRZu3: } goto FplUw; eW2dZ: if (!($cservice['day5'] == 0)) { goto OutyH; } goto nac7u; GatMZ: if (!($cservice['day1'] == 0)) { goto w7jt1; } goto HhruI; wQkOg: if (!($cservice['day7'] == 0)) { goto M7MW2; } goto uLDQB; vVm95: exit; goto n4fxU; JcyPw: X3Let: goto jvbUN; lIodn: $notonlinemsg = !empty($cservice['notonline']) ? $cservice['notonline'] : '客服不在线哦！'; goto gGvVl; fpLFG: $resArr['jqr'] = 1; goto iyOUj; OSG9a: $notonlinemsg = !empty($cservice['notonline']) ? $cservice['notonline'] : '客服不在线哦！'; goto OF0uP; Ct8ay: OutyH: goto LwV2r; oHlL3: FbFDI: goto ZjwLW; yAPQD: goto n9sbr; goto lfxWE; tlnm5: $resArr['error'] = 1; goto cjxD2; oxMY2: $datajqr['content'] = $zdhf['allcon']; goto aYc6M; qOWuL: goto JIRHP; goto cp7Wq; Vget3: zpr45: goto MRnFl; QHJ1i: $kefutplminute = $this->getmoduleconfig('kefutplminute'); goto P8jin; MZSCi: echo json_encode($resArr); goto BI8be; WhHE2: JIRHP: goto JcyPw; zAQOw: ag7mp: goto wQkOg; gGE7x: $data['nickname'] = $fanskefu['fansnickname']; goto Q3Fdc; gGvVl: $zhouji = date('w'); goto Bze0z; KRDde: $dataup_fanskefu['msgtype'] = $type; goto f4pcT; KVemV: if (!empty($chatcontent)) { goto ECBWY; } goto zX_Ad; fTfTo: echo json_encode($resArr); goto G0mi5; BI8be: exit; goto E243L; xZPoI: goto zpr45; goto oHlL3; Dfcoz: $notonlinemsg = !empty($cservice['notonline']) ? $cservice['notonline'] : '客服不在线哦！'; goto tlnm5; jYjpm: exit; goto unMKF; jvbUN: $data['fkid'] = intval($_GPC['fkid']); goto r4ECY; kzbha: exit; goto hVF2q; uLDQB: $resArr['error'] = 1; goto TKcoZ; XSICs: if (!($cservice['isxingqi'] == 1)) { goto X3Let; } goto lIodn; cbjhw: if (!($guotime > $kefutplminute)) { goto Zc2xm; } goto RBRa1; nnTmf: $data['content'] = $chatcontent; goto BTOP0; xwUw5: RPFMd: goto T5mIM; iyOUj: $jqrtime = $data['time'] + 1; goto Uim3C; YhcmJ: pdo_query('update ' . tablename(BEST_FANSKEFU) . ' set notread=notread+1,guanlinum=guanlinum+1,wherefrom=0 where id=:id', array(":id" => $data['fkid'])); goto QHJ1i; EzwIE: $datajqr['openid'] = trim($_GPC['toopenid']); goto KacUZ; lfxWE: BeYmT: goto iAnpy; b10hc: $chatcontent = trim($_GPC['content']); goto g6ipV; cp7Wq: vfcDG: goto GatMZ; XF_cN: $resArr['jqrcontent'] = $datajqr['content'] = tomedia($zdhf['imgcon']); goto QfoA1; LwV2r: nHvZ5: goto np_H2; CCZI9: s0iju: goto lUMdx; A4myo: $nowhour = intval(date('H', TIMESTAMP)); goto N7Ds5; cGfdR: $dataup_fanskefu['lastcon'] = $lastcon; goto KRDde; eGzdY: preg_match_all($regex, $zdhf['content'], $array2); goto qa3lC; m5cEs: if ($type == 3 || $type == 4) { goto PxQM5; } goto Cyc7r; y15Xb: JhUmL: goto PWjLP; q3kmh: echo json_encode($resArr); goto K5usy; rAgdr: if ($zhouji == '2') { goto SMSSx; } goto lXLLH; bPZ4t: p1KZn: goto uMHiZ; r4ECY: $fanskefu = pdo_fetch('SELECT * FROM ' . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W['uniacid']} AND id = {$data['fkid']}"); goto SOHI2; pms64: $datajqr['time'] = $jqrtime; goto xwreI; kbGi3: GWjU6: goto Len99; SOFic: if ($cservice['lingjie'] == 1) { goto k0Au6; } goto A4myo; tJBLm: $dataup_fanskefu['jdtime'] = TIMESTAMP; goto HgE_3; SpdtQ: echo json_encode($resArr); goto kzbha; N7Ds5: if (!($nowhour < $cservice['starthour'] || $nowhour + 1 > $cservice['endhour'])) { goto CQJyH; } goto Dfcoz; Q2bpE: Zc2xm: goto z7yCC; SOHI2: $data['openid'] = $fanskefu['fansopenid']; goto gGE7x; Gebov: $resArr['msg'] = $notonlinemsg; goto SpdtQ; cnMYa: PxQM5: goto JH2vL; lUMdx: aYmq9: goto YhcmJ; emVIC: if ($cservice['iszx'] == 1) { goto GWjU6; } goto SOFic; HgE_3: $otherfanskefus = pdo_fetchall('SELECT id,kefuopenid FROM ' . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W['uniacid']} AND nowjd > 0 AND fansopenid = '{$openid}' AND kefuopenid != '{$cservice['content']}'"); goto ggyTG; Nc93m: o18Y9: goto pBs0v; P9Uxe: echo json_encode($resArr); goto oJxRV; Unrle: E246c: goto yAPQD; z7yCC: if (!($fanskefu['nowjd'] == 0)) { goto p1KZn; } goto hqWRo; AkCaY: } public function gettpldomain() { goto hdwQ7; hdwQ7: global $_W, $_GPC; goto FyoLG; NenN1: return $tpldomain != '' ? $tpldomain : $_W['siteroot']; goto C3LJg; FyoLG: $tpldomain = $this->getmoduleconfig('tpldomain'); goto NenN1; C3LJg: } public function doMobileAddchatxcx() { goto dDU69; eY5sS: if (!($type == 3)) { goto C_3Xt; } goto AWL99; uZuQn: $dataup['lasttime'] = $data['time']; goto Q75Pq; AXpD2: $resArr['error'] = 1; goto mC6UU; Vfscu: $data['fkid'] = $fkid; goto hJte5; JEWmP: ZXiBg: goto rqLMv; AWL99: $msgtype = 'image'; goto NHb39; GSfAI: exit; goto TFjDB; pquKB: C_3Xt: goto Tv1xl; TFjDB: goto ZXiBg; goto EdaUD; kCZqS: if (!($addres['errcode'] == '40001')) { goto sCU2C; } goto lz3lI; HkQ82: $fanskefu = pdo_fetch('SELECT * FROM ' . tablename(BEST_XCXFANSKEFU) . " WHERE id = {$fkid}"); goto M2YuH; VZXjU: echo json_encode($resArr); goto SoIh_; e6AHu: $data['weid'] = $_W['uniacid']; goto Vfscu; y7wGD: fybls: goto M36YE; SoIh_: exit; goto JEWmP; QHN3C: $resArr['content'] = '<div class="concon">' . $chatcontent . '</div>'; goto y7wGD; mC6UU: $resArr['msg'] = '请输入对话内容！'; goto rLnUz; NHb39: $chatcontent = tomedia($chatcontent); goto ioyrN; BcNCs: $data['openid'] = $fanskefu['kefuopenid']; goto yoH2s; wTvOX: if ($addres['errcode'] != '0') { goto Joidc; } goto BcNCs; dDU69: global $_W, $_GPC; goto Q4Gpj; ajRfI: if (!empty($chatcontent)) { goto C7moN; } goto AXpD2; Q4Gpj: $fkid = intval($_GPC['fkid']); goto To895; xwrg7: pdo_insert(BEST_XCXCHAT, $data); goto uZuQn; gPcrT: $data['time'] = $addres['time']; goto fmsz0; M36YE: $resArr['error'] = 0; goto pgjwI; nBsdI: $resArr['content'] = '<div class="concon"><img src="' . $chatcontent . '" class="sssbbb" /></div>'; goto UyCWF; pgjwI: $resArr['msg'] = ''; goto nrBRp; QARxP: echo json_encode($resArr); goto GSfAI; Pk7hf: $resArr['error'] = 1; goto ImEhG; nrBRp: $resArr['datetime'] = date('Y-m-d H:i:s', $data['time']); goto QARxP; UyCWF: goto fybls; goto w8S1H; To895: $type = intval($_GPC['type']); goto XuoFU; WGFgn: Eejj9: goto eY5sS; EdaUD: Joidc: goto Pk7hf; lz3lI: $addres = $this->addxcxchat2($fanskefu['fansopenid'], $chatcontent, $msgtype, $fanskefu['gh_id'], 1); goto K7dlS; yoH2s: $data['toopenid'] = $fanskefu['fansopenid']; goto W8lll; u3QQN: $dataup['lastcon'] = preg_replace('/\\xEE[\\x80-\\xBF][\\x80-\\xBF]|\\xEF[\\x81-\\x83][\\x80-\\xBF]/', '[无法识别字符]', $chatcontent); goto WGFgn; wtuH8: C7moN: goto HkQ82; ImEhG: $resArr['msg'] = $this->getwxerrormsg($addres); goto VZXjU; Tv1xl: $addres = $this->addxcxchat2($fanskefu['fansopenid'], $chatcontent, $msgtype, $fanskefu['gh_id']); goto kCZqS; XuoFU: $chatcontent = trim($_GPC['content']); goto ajRfI; M2YuH: if (!($type == 2)) { goto Eejj9; } goto XiJ3J; hJte5: $data['msgtype'] = $msgtype; goto xwrg7; W8lll: $data['gh_id'] = $fanskefu['gh_id']; goto gPcrT; rLnUz: echo json_encode($resArr); goto aq2Km; w8S1H: Ez1FI: goto QHN3C; XiJ3J: $msgtype = 'text'; goto u3QQN; K7dlS: sCU2C: goto wTvOX; aq2Km: exit; goto wtuH8; Q75Pq: $dataup['msgtype'] = $msgtype; goto LVRNt; ioyrN: $dataup['lastcon'] = '[图片消息]'; goto pquKB; CrLpv: if ($type == 2) { goto Ez1FI; } goto nBsdI; LVRNt: pdo_update(BEST_XCXFANSKEFU, $dataup, array("id" => $fkid)); goto CrLpv; fmsz0: $data['content'] = $chatcontent; goto e6AHu; rqLMv: } public function addxcxchat2($touser, $content, $msgtype, $gh_id, $isnewtoken = 0) { goto IRdQF; c7DBR: $kefutokehures['time'] = $nowtime; goto ar7Nw; im2hr: $dataup['access_token'] = $access_token; goto gOCkv; gowkY: xI7Eh: goto im2hr; M0OhO: goto PVyQn; goto H4SNd; VS9EB: $data = array("touser" => $touser, "msgtype" => "image", "image" => array("media_id" => $imgres['media_id'])); goto dW4_r; MwuPT: $dataup['guoqitime'] = $nowtime + 3600; goto dwu8z; IX2HY: if ($isnewtoken == 1) { goto fbSMC; } goto e20My; DuHnH: $resArr['msg'] = '获取AccessToken失败！'; goto jCExY; dwu8z: pdo_update(BEST_XCX, $dataup, array("id" => $xcx['id'])); goto ssM8X; H4SNd: ZRTKC: goto p3Ugr; AAAKm: $source = file_get_contents($content); goto ldAdO; aBuEl: amwdG: goto fZ3jj; dMyIK: unlink('../addons/cy163_customerservice/' . $fileName); goto VS9EB; dIS5m: $access_token = $this->get_xcx_accessToken($xcx['appid'], $xcx['secret']); goto w6zV8; OSo7E: echo json_encode($resArr); goto wnFUC; ar7Nw: return $kefutokehures; goto Sw5uB; e20My: if ($xcx['guoqitime'] < TIMESTAMP) { goto ZRTKC; } goto mulfT; wnFUC: exit; goto NeM5V; px8st: $resArr['error'] = 1; goto DuHnH; eJd2v: $imgres = $this->curl_post2($imgurl, '../addons/cy163_customerservice/' . $fileName); goto dMyIK; w6zV8: if (!($access_token == 'error')) { goto xI7Eh; } goto px8st; bi0i1: $data = array("touser" => $touser, "msgtype" => "link", "link" => array("title" => $content['title'], "description" => $content['description'], "url" => $content['url'], "thumb_url" => $content['thumb_url'])); goto aBuEl; lOoUn: $kefutokehures = json_decode($kefutokehures, true); goto c7DBR; gAqRH: $kefutokehures = $this->curl_post($url, $json); goto lOoUn; yoOKu: if (!($msgtype == 'image')) { goto UbrOv; } goto GeuBU; ePvWA: $json = json_encode($data, JSON_UNESCAPED_UNICODE); goto gAqRH; HzXv2: $resArr['msg'] = '获取AccessToken失败！'; goto OSo7E; GeuBU: $fileName = time() . '.jpg'; goto AAAKm; dW4_r: UbrOv: goto Kjy2b; Gphgv: fbSMC: goto dIS5m; ldAdO: file_put_contents('../addons/cy163_customerservice/' . $fileName, $source); goto eldlf; dmgw5: $xcx = pdo_fetch('SELECT * FROM ' . tablename(BEST_XCX) . " WHERE uniacid = {$_W['uniacid']} AND gh_id = '{$gh_id}'"); goto IX2HY; YnSoA: if (!($access_token == 'error')) { goto PYbZ5; } goto fojYU; fZ3jj: $url = 'https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=' . $access_token; goto ePvWA; gOCkv: $dataup['guoqitime'] = $nowtime + 3600; goto LMkhh; TY17m: if (!($msgtype == 'text')) { goto gQTBx; } goto C8hjh; CSuPH: gQTBx: goto yoOKu; mulfT: $access_token = $xcx['access_token']; goto M0OhO; fojYU: $resArr['error'] = 1; goto HzXv2; C8hjh: $data = array("touser" => $touser, "msgtype" => "text", "text" => array("content" => $content)); goto CSuPH; Kjy2b: if (!($msgtype == 'link')) { goto amwdG; } goto bi0i1; ssM8X: PVyQn: goto OPbty; p3Ugr: $access_token = $this->get_xcx_accessToken($xcx['appid'], $xcx['secret']); goto YnSoA; IRdQF: global $_GPC, $_W; goto kFI6E; NeM5V: PYbZ5: goto zQhgU; jCExY: echo json_encode($resArr); goto Wzm5_; bHtim: ZzrWt: goto TY17m; LMkhh: pdo_update(BEST_XCX, $dataup, array("id" => $xcx['id'])); goto bHtim; zQhgU: $dataup['access_token'] = $access_token; goto MwuPT; eldlf: $imgurl = 'http://api.weixin.qq.com/cgi-bin/media/upload?access_token=' . $access_token . '&type=image'; goto eJd2v; Wzm5_: exit; goto gowkY; OPbty: goto ZzrWt; goto Gphgv; kFI6E: $nowtime = TIMESTAMP; goto dmgw5; Sw5uB: } public function get_xcx_accessToken($appid, $appsecret) { goto s8NJn; lzG6P: if ($res) { goto RkAtx; } goto HHYtc; vjoZz: $result = $this->curl_get_https($url); goto CApTJ; s8NJn: $url = 'https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=' . $appid . '&secret=' . $appsecret; goto vjoZz; VJCR4: goto H8EYn; goto biotm; HrFO7: H8EYn: goto OxpgK; qvOaw: return $res['access_token']; goto HrFO7; CApTJ: $res = json_decode($result, true); goto lzG6P; biotm: RkAtx: goto qvOaw; HHYtc: return 'error'; goto VJCR4; OxpgK: } public function curl_get_https($url) { goto Zbcot; ILSM2: return $tmpInfo; goto rUIec; bzXRl: curl_setopt($curl, CURLOPT_HEADER, 0); goto rr3DS; Iy112: curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, true); goto Cj4TY; okns5: curl_close($curl); goto ILSM2; f_WeG: curl_setopt($curl, CURLOPT_URL, $url); goto bzXRl; rr3DS: curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1); goto DWp2l; Cj4TY: $tmpInfo = curl_exec($curl); goto okns5; DWp2l: curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false); goto Iy112; Zbcot: $curl = curl_init(); goto f_WeG; rUIec: } public function getwxerrormsg($addres) { goto TUtUS; bfogX: $errmsg = $addres['errmsg']; goto cXqJe; gp93I: if ($addres['errcode'] == '-1') { goto h1QZn; } goto bfogX; wpPTz: $errmsg = '不合法的 OpenID，请开发者确认 OpenID 是否是其他小程序的 OpenID！'; goto LDcYo; o9ggS: bVFLg: goto zYDnx; ntlm3: ESPfI: goto wpPTz; FdNA7: goto FsoH3; goto o9ggS; CCc2e: $errmsg = '回复时间超过限制！'; goto inKWN; XmV9b: $errmsg = '客服接口下行条数超过上限！'; goto F9Emr; ulZUM: HyXsx: goto XmV9b; BQMxG: return $errmsg; goto igk3O; PMXGv: yr1jj: goto Ur06q; lb6i8: if ($addres['errcode'] == '40003') { goto ESPfI; } goto gGzXY; ewXtP: UlHE9: goto CCc2e; V7sRC: if ($addres['errcode'] == '48001') { goto yr1jj; } goto jMtww; D1FxQ: if ($addres['errcode'] == '40001') { goto bVFLg; } goto gp93I; NLEx5: $errmsg = '系统繁忙，此时请开发者稍候再试！'; goto YAG3x; yfFxb: goto FsoH3; goto ikfTE; ikfTE: h1QZn: goto NLEx5; BQ7U4: goto FsoH3; goto ewXtP; cXqJe: goto FsoH3; goto ulZUM; inKWN: goto FsoH3; goto ntlm3; Ur06q: $errmsg = 'API 功能未授权，请确认小程序已获得该接口！'; goto BQ7U4; zYDnx: $errmsg = '获取 access_token 时 AppSecret 错误，或者 access_token 无效。请开发者认真比对 AppSecret 的正确性，或查看是否正在为恰当的小程序调用接口！'; goto yfFxb; gGzXY: if ($addres['errcode'] == '40002') { goto O81gt; } goto D1FxQ; LDcYo: goto FsoH3; goto qK_zV; F9Emr: goto FsoH3; goto PMXGv; TUtUS: if ($addres['errcode'] == '45047') { goto HyXsx; } goto V7sRC; GBm8i: $errmsg = '不合法的凭证类型！'; goto FdNA7; qK_zV: O81gt: goto GBm8i; jMtww: if ($addres['errcode'] == '45015') { goto UlHE9; } goto lb6i8; YAG3x: FsoH3: goto BQMxG; igk3O: } public function curl_post($url, $data = array()) { goto rkysF; L49gr: curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1); goto Cz1bm; F12Wq: if (empty($data)) { goto QIuQt; } goto czeiG; nI5wd: curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); goto L49gr; CCA8B: cK27b: goto S77em; RmG7V: $rs = curl_exec($ch); goto hY3_2; BKa4U: goto cK27b; goto s0IAd; czeiG: curl_setopt($ch, CURLOPT_POST, 1); goto dYyzu; Q8T08: curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE); goto v9xhF; YVgWx: QIuQt: goto nI5wd; LxXyr: return $s; goto CCA8B; y5_8r: $s = '{"success": false,"msg":"' . curl_error($ch) . '" }'; goto LxXyr; N0CfP: curl_close($ch); goto euv4F; dYyzu: curl_setopt($ch, CURLOPT_POSTFIELDS, $data); goto YVgWx; s0IAd: uoLnl: goto y5_8r; euv4F: return $rs; goto BKa4U; hY3_2: if (curl_errno($ch)) { goto uoLnl; } goto N0CfP; Cz1bm: curl_setopt($ch, CURLOPT_TIMEOUT, 20); goto RmG7V; v9xhF: curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE); goto F12Wq; rkysF: $ch = curl_init(); goto jstli; jstli: curl_setopt($ch, CURLOPT_URL, $url); goto Q8T08; S77em: } public function doReplacecon($content, $msgtype, $istuwen = 0) { goto napVe; nZwnk: w1zuT: goto elH0S; tW8Tk: Yv0Lp: goto aMpio; tgecM: $content = $this->guolv($content); goto NxDa_; napVe: if (!($istuwen == 0)) { goto BfEa4; } goto tgecM; DsVsB: if (!($msgtype == 3 || $msgtype == 4)) { goto Yv0Lp; } goto mkCya; mkCya: $content = '<img src="' . $content . '" />'; goto tW8Tk; KU8jC: BfEa4: goto DsVsB; s6XeR: preg_match_all($regex, $content, $array2); goto bU557; elH0S: xLs3K: goto KU8jC; KfKVI: foreach ($array2[0] as $kk => $vv) { goto viX5e; vHYzS: ovfxR: goto Fdb7r; Fdb7r: HH2dj: goto nwRcL; NsyRb: $content = str_replace($vv, '<a href=\'' . $vv . '\'>' . $vv . '</a>', $content); goto vHYzS; viX5e: if (empty($vv)) { goto ovfxR; } goto NsyRb; nwRcL: } goto nZwnk; aMpio: return htmlspecialchars_decode($content); goto nJrQP; bU557: if (!(!empty($array2[0]) && ($msgtype == 1 || $msgtype == 2))) { goto xLs3K; } goto KfKVI; NxDa_: $regex = '@(?i)\\b((?:[a-z][\\w-]+:(?:/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:\'".,<>?«»“”‘’]))@'; goto s6XeR; nJrQP: } public function guolv($content) { goto ihm29; gwsbj: return $content; goto l7do3; ihm29: $mingan = $this->getmoduleconfig('mingan'); goto sZXww; vDSSY: $content = str_replace('
', '<br>', $content); goto gwsbj; F59jA: cc9GZ: goto s9j70; sZXww: if (empty($mingan)) { goto ucoE3; } goto umMRj; QtA8O: foreach ($sensitivewordarr as $k => $v) { goto kva0m; DMd9J: $content = str_replace($v, '***', $content); goto yPAEg; kva0m: if (empty($v)) { goto L8MNw; } goto DMd9J; yPAEg: L8MNw: goto qSXoB; qSXoB: wFYuj: goto LlY68; LlY68: } goto F59jA; s9j70: ucoE3: goto vDSSY; umMRj: $sensitivewordarr = explode('|', $mingan); goto QtA8O; l7do3: } public function get_os() { goto dtKNl; NFyuQ: $os = 'Other'; goto QNzmv; s5X9k: if (preg_match('/unix/i', $os)) { goto bupzf; } goto bX_NL; AhC4X: DUX8z: goto tr6oX; XWv6V: Gj5XZ: goto ne1uF; vvT1N: goto tX28q; goto sXCBp; kfRus: if (preg_match('/win/i', $os)) { goto WxzmU; } goto bO078; IXqrf: goto BbGKo; goto Qfv3N; bX_NL: if (preg_match('/bsd/i', $os)) { goto DUX8z; } goto NFyuQ; cqLsD: $os = $_SERVER['HTTP_USER_AGENT']; goto kfRus; QPPRU: return $os; goto YdvfG; Rka3q: goto yCVI9; goto ZvM5F; YdvfG: mOKhb: goto NHwP4; UmhuI: $os = 'Unix'; goto pBAc3; B_gy5: hFSR3: goto vvT1N; DZiaY: goto x06vZ; goto XWv6V; pBAc3: tX28q: goto Rka3q; TJp9L: return 'unknow'; goto m8KHI; exaJ7: bXByD: goto cqLsD; yFR3K: $os = 'Windows'; goto LJSlu; Rgde6: $os = 'Linux'; goto PtEKb; ZvM5F: rt7Tn: goto Rgde6; LJSlu: BbGKo: goto QPPRU; tr6oX: $os = 'BSD'; goto B_gy5; dtKNl: if (!empty($_SERVER['HTTP_USER_AGENT'])) { goto bXByD; } goto TJp9L; m8KHI: goto mOKhb; goto exaJ7; PtEKb: yCVI9: goto DZiaY; ne1uF: $os = 'MAC'; goto k9kyO; QNzmv: goto hFSR3; goto AhC4X; sXCBp: bupzf: goto UmhuI; bO078: if (preg_match('/mac/i', $os)) { goto Gj5XZ; } goto YoTim; Qfv3N: WxzmU: goto yFR3K; k9kyO: x06vZ: goto IXqrf; YoTim: if (preg_match('/linux/i', $os)) { goto rt7Tn; } goto s5X9k; NHwP4: } public function browse_info() { goto QW0b4; pwUg7: $br = $_SERVER['HTTP_USER_AGENT']; goto jZxvI; a5sKA: if (preg_match('/Firefox/i', $br)) { goto G5S9V; } goto FJhhl; jbue3: b9Lvv: goto eqetC; l0VHQ: NymgU: goto QmsOO; eqetC: $br = 'Safari'; goto KjRY3; pSkup: lazfc: goto ITPW_; KjRY3: GaVP9: goto DBftt; qNzU4: YqrI6: goto pp_Om; OV_Cn: cP8e2: goto VpKH3; jdfyi: goto RiapL; goto lvQuj; kyEN7: OQoNq: goto J4Yna; EU1gP: azSyD: goto yczzV; QmsOO: return $br; goto prAYu; lvQuj: FQOIk: goto pwUg7; VSHNj: if (preg_match('/Safari/i', $br)) { goto b9Lvv; } goto Kv5W5; yBq4b: G5S9V: goto b_LsI; MNU90: $br = 'Opera'; goto pSkup; prAYu: RiapL: goto wVWAK; jZxvI: if (preg_match('/MSIE/i', $br)) { goto cP8e2; } goto a5sKA; Oy3kq: return 'unknow'; goto jdfyi; J4Yna: goto YqrI6; goto yBq4b; QW0b4: if (!empty($_SERVER['HTTP_USER_AGENT'])) { goto FQOIk; } goto Oy3kq; FJhhl: if (preg_match('/Chrome/i', $br)) { goto azSyD; } goto VSHNj; Kv5W5: if (preg_match('/Opera/i', $br)) { goto IKHTA; } goto xOogR; DBftt: goto OQoNq; goto EU1gP; yczzV: $br = 'Chrome'; goto kyEN7; VpKH3: $br = 'MSIE'; goto l0VHQ; ITPW_: goto GaVP9; goto jbue3; b_LsI: $br = 'Firefox'; goto qNzU4; pp_Om: goto NymgU; goto OV_Cn; W0tLD: IKHTA: goto MNU90; xOogR: $br = 'Other'; goto SfIji; SfIji: goto lazfc; goto W0tLD; wVWAK: } public function curl_post2($url = "", $path = "") { goto uQ934; wWDCa: return $res; goto PNUYP; ltO3R: $result = curl_exec($curl); goto Fu2s5; SdLDu: $data = array("media" => '@' . $path); goto ktO1h; m_jZ2: curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1); goto Wnj4Z; V1sEZ: if (class_exists('CURLFile')) { goto bdEAH; } goto P0fTB; Fu2s5: $res = json_decode($result, true); goto wWDCa; BF9It: curl_setopt($curl, CURLOPT_POSTFIELDS, $data); goto m_jZ2; uQ934: $curl = curl_init(); goto V1sEZ; P1wIm: curl_setopt($curl, CURLOPT_SAFE_UPLOAD, true); goto Gcjxg; J167g: cGEIY: goto uPgc_; uPgc_: curl_setopt($curl, CURLOPT_URL, $url); goto q7X98; P0fTB: curl_setopt($curl, CURLOPT_SAFE_UPLOAD, false); goto SdLDu; ktO1h: goto cGEIY; goto KoqXS; Gcjxg: $data = array("media" => new CURLFile($path)); goto J167g; KoqXS: bdEAH: goto P1wIm; Wnj4Z: curl_setopt($curl, CURLOPT_USERAGENT, 'TEST'); goto ltO3R; q7X98: curl_setopt($curl, CURLOPT_POST, 1); goto BF9It; PNUYP: } public function get_lang() { goto gBqe3; Gsa4K: $lang = $_SERVER['HTTP_ACCEPT_LANGUAGE']; goto RoPEr; ojOo_: DIsIj: goto xZaay; kvvxY: O2iVw: goto Gsa4K; Ar3Sk: $lang = '繁体中文'; goto ojOo_; YlFYF: DZ8C0: goto Ar3Sk; RoPEr: $lang = substr($lang, 0, 5); goto ZYQmO; qUIJ7: QLPhq: goto iwkTW; uJXES: if (preg_match('/zh/i', $lang)) { goto DZ8C0; } goto DJqc4; hgPro: nX4gC: goto KlQsF; DJqc4: $lang = 'English'; goto vWtWK; KlQsF: return $lang; goto qUIJ7; wlr0k: oIboT: goto XcsMZ; gBqe3: if (!empty($_SERVER['HTTP_ACCEPT_LANGUAGE'])) { goto O2iVw; } goto pm0r6; tLqe1: goto QLPhq; goto kvvxY; vWtWK: goto DIsIj; goto YlFYF; ZYQmO: if (preg_match('/zh-cn/i', $lang)) { goto oIboT; } goto uJXES; XcsMZ: $lang = '简体中文'; goto hgPro; xZaay: goto nX4gC; goto wlr0k; pm0r6: return 'unknow'; goto tLqe1; iwkTW: } } ?>