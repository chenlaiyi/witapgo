{template 'public/header'}
{template 'public/comhead'}
<div class="panel panel-info">
	<div class="panel-body">
		<ul class="nav nav-tabs">
            {if $xxz}
            <li {if $_GPC['op']=='display'}class="active"{/if}><a href="{php echo $this->createWebUrl('promotefans', array('op' => 'display', 'schoolid' => $schoolid))}">推广设置</a></li>
            {/if}
            {if $dhgz}
            <li {if $_GPC['op']=='rule'}class="active"{/if}><a href="{php echo $this->createWebUrl('promotefans', array('op' => 'rule', 'schoolid' => $schoolid))}">兑换规则</a></li>
            {/if}
            <li {if $_GPC['op']=='form_record'}class="active"{/if}><a href="{php echo $this->createWebUrl('promotefans', array('op' => 'form_record', 'schoolid' => $schoolid))}">申请记录</a></li>
		</ul>
	</div>
</div> 
{if $operation == 'display'}

<form class="form-horizontal form" action="" method="post" enctype="multipart/form-data">
    <div class="tab-content">
        <div class="tab-pane active">
            <div class="panel panel-info">
                <div class="panel-heading">
                    基本信息
                </div>
                <div class="panel-body">
                    <input type="hidden" name="id" value="{$setInfo['id']}">
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label"><span class="require">* </span>自定义名称</label>
                        <div class="col-sm-4">
                            <input type="text" name="name" value="{$setInfo['name']}" class="form-control" />
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">推广积分</label>
                        <div class="col-sm-4">
                            <input type="text" name="tea_level" value="{$setInfo['tea_level']}" class="form-control" />
                        </div>
                        <div class="help-block" style="line-height:10px;">推广员获得积分,设置为0则不增加积分</div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">一级(推广员)</label>
                        <div class="col-sm-4">
                            <input type="text" name="tea_level1" value="{$setInfo['tea_level1']}" class="form-control" />
                        </div>
                        <div class="help-block" style="line-height:10px;">一级推广员获得积分,设置为0则不增加积分</div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">二级(推广员)</label>
                        <div class="col-sm-4">
                            <input type="text" name="tea_level2" value="{$setInfo['tea_level2']}" class="form-control" />
                        </div>
                        <div class="help-block" style="line-height:10px;">二级推广员获得积分,设置为0则不增加积分</div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">三级(推广员)</label>
                        <div class="col-sm-4">
                            <input type="text" name="tea_level3" value="{$setInfo['tea_level3']}" class="form-control" />
                        </div>
                        <div class="help-block" style="line-height:10px;">三级推广员获得积分,设置为0则不增加积分</div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">学生推广</label>
                        <div class="col-sm-4">
                            <input type="text" name="stu_level1" value="{$setInfo['stu_level1']}" class="form-control" />
                        </div>
                        <div class="help-block" style="line-height:10px;">学生获得积分,设置为0则不增加积分</div>
                    </div>

                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">允许查看层级</label>
                        <div class="col-sm-4">
                            <input type="text" name="show_level" value="{$setInfo['show_level']}" class="form-control" />
                        </div>
                        <div class="help-block" style="line-height:10px;">可以自行设定M值，0<=M<=3，M为某一个推广员可以看到子节点层数</div>
                    </div>

                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">允许推广层级</label>
                        <div class="col-sm-4">
                            <input type="text" name="promote_level" value="{$setInfo['promote_level']}" class="form-control" />
                        </div>
                        <div class="help-block" style="line-height:10px;">设定层级后,根据层级获得不同等级的积分值</div>
                    </div>
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">法律条例</label>
                        <div class="col-sm-4">
                            <textarea name="law" rows="5" style="resize: none; border:1px #e6e6e6 solid;width: 100%;">{$setInfo['law']}</textarea>
                        </div>
                        <div class="help-block" style="line-height:10px;">购买课程时弹出,关于法律条例提示,同意后方可购买,不同意则无法购买</div>
                    </div> 
                    <div class="form-group">
                        <label class="col-xs-12 col-sm-3 col-md-2 control-label">申请协议</label>
                        <div class="col-sm-4">
                            <textarea name="deal" rows="5" style="resize: none; border:1px #e6e6e6 solid;width: 100%;">{$setInfo['deal']}</textarea>
                        </div>
                        <div class="help-block" style="line-height:10px;">学生申请成为分享员时弹出</div>
                    </div> 
                </div>
            </div>
        </div>
        <div class="form-group col-sm-10">
            <input type="submit" name="submit" value="保存设置" class="btn btn-primary col-lg-1" />
            <input type="hidden" name="token" value="{$_W['token']}" />
        </div>
    </div>
</form>
{else if $operation == 'rule'}
<div class="main">
    <div class="panel panel-default">
        <div class="panel-body">
            <a class="btn btn-primary" href="javascript:;" onclick="set_rule(0)"><i class="fa fa-plus"></i>添加</a>
        </div>
    </div>
    <div class="panel panel-default">
        <form action="" method="post" class="form-horizontal form" >
            <input type="hidden" name="schoolid" value="{$schoolid}" />
            <div class="table-responsive panel-body">
                <table class="table table-hover">
                    <thead class="navbar-inner">
                    <tr>
					    <th style="width:100px;">排序</th>
                        <th>标题</th>
                        <th>积分值</th>
                        <th>金额</th>
                        <th>单日兑换限制</th>
                        <th>总兑换限制</th>
                        <th>创建时间</th>
                        <th>编辑/删除</th>
                    </tr>
                    </thead>
                    <tbody id="level-list">
                    {loop $list $row}
                    <tr>
					    <td>{$row['ssort']}</td>
                        <td>{$row['name']}</td>
                        <td>{$row['score']}</td>
                        <td>{$row['money']}</td>
                        <td>{$row['day_max']}</td>
                        <td>{$row['max']}</td>
                        <td><div class="type-parent">{php echo date("Y-m-d H:i",$row['createtime'])}</div></td>
                        <td>
                            <a class="btn btn-default btn-sm " href="javascript:;" onclick="set_rule(`{$row['id']}`)" title="编辑"><i class="fa fa-pencil"></i></a>&nbsp;&nbsp;
                            <a class="btn btn-default btn-sm " href="{php echo $this->createWebUrl('promotefans', array('op' => 'del_rule', 'id' => $row['id'], 'schoolid' => $schoolid))}" onclick="return confirm('确认删除此套餐吗？');return false;" title="删除"><i class="fa fa-times"></i></a></td>
                    </tr>
                    {/loop}
                    </tbody>
                </table>
            </div>
        </form>
    </div>
    {$pager}
</div>
<!-- 侧滑展示信息 -->
<div class="uploader-modal modal right fade" style="z-index:1050 !important;" id="info_bigbox" tabindex="-1" role="dialog" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog myModalleft" style="width: 25%;">
        <div class="modal-content" style="max-height:unset !important; padding: 15px;">
            <div class="modal-body">

                <div class="form-group">
                    <div class="col-sm-9 col-xs-6" style="width:100% !important">
                        <div style="min-height: 40px">
                            <div class="input-group text-info" id="dealword" style="width:100%; ">
                                <div style="width:100px;color:#343434;float: left;">排序</div> 
                                <div style="width:calc(100% - 100px);float: left;" >
                                    <input class="form-control" type="number" id="rule_ssort" >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>	

                <div class="form-group">
                    <div class="col-sm-9 col-xs-6" style="width:100% !important">
                        <div style="min-height: 40px">
                            <div class="input-group text-info" id="dealword" style="width:100%; ">
                                <div style="width:100px;color:#343434;float: left;">标题</div> 
                                <div style="width:calc(100% - 100px);float: left;" >
                                    <input class="form-control" type="text" id="rule_name" >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>	

                <div class="form-group">
                    <div class="col-sm-9 col-xs-6" style="width:100% !important">
                        <div style="min-height: 40px">
                            <div class="input-group text-info" id="dealword" style="width:100%; ">
                                <div style="width:100px;color:#343434;float: left;">积分值</div> 
                                <div style="width:calc(100% - 100px);float: left;" >
                                    <input class="form-control" type="text" id="rule_score" >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>	

                <div class="form-group">
                    <div class="col-sm-9 col-xs-6" style="width:100% !important">
                        <div style="min-height: 40px">
                            <div class="input-group text-info" id="dealword" style="width:100%; ">
                                <div style="width:100px;color:#343434;float: left;">金额</div> 
                                <div style="width:calc(100% - 100px);float: left;" >
                                    <input class="form-control" type="text" id="rule_money" >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>		

                <div class="form-group">
                    <div class="col-sm-9 col-xs-6" style="width:100% !important">
                        <div style="min-height: 40px">
                            <div class="input-group text-info" id="dealword" style="width:100%; ">
                                <div style="width:100px;color:#343434;float: left;">单日兑换限制</div> 
                                <div style="width:calc(100% - 100px);float: left;" >
                                    <input class="form-control" type="text" id="rule_day_max" >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>	

                <div class="form-group">
                    <div class="col-sm-9 col-xs-6" style="width:100% !important">
                        <div style="min-height: 40px">
                            <div class="input-group text-info" id="dealword" style="width:100%; ">
                                <div style="width:100px;color:#343434;float: left;">总兑换限制</div> 
                                <div style="width:calc(100% - 100px);float: left;" >
                                    <input class="form-control" type="text" id="rule_max" >
                                </div>
                            </div>
                        </div>
                    </div>
                </div>		
            </div>	
            <input type="hidden" id="rule_id" >
			<div class="modal-footer">	
				<button type="button" class="btn btn-default" data-dismiss="modal">关闭</button>
				<button type="button" class="btn btn-primary" onclick="save_rule()">确认</button>
			</div>
        </div>
       
    </div>
</div>
<!-- 侧滑展示信息 -->
<script>
    var FormData = []
    //显示规则
    function set_rule(id){
        $('body').toggleClass('modal-open');
        $('#info_bigbox').modal('toggle');
        $.ajax({
            url: "{php echo $this->createWebUrl('promotefans', array('op' => 'get_rule', 'schoolid' => $schoolid))}",
            type: "post",
            dataType: "json",
            data: {id:id},
            success: function(result) {
                let data = result.data
                $("#rule_id").val(data.id)
                $("#rule_ssort").val(data.ssort)
                $("#rule_name").val(data.name)
                $("#rule_score").val(data.score)
                $("#rule_money").val(data.money)
                $("#rule_day_max").val(data.day_max)
                $("#rule_max").val(data.max)
            }
        });

    }
    //设置保存规则数据
    function save_rule(){
        FormData = {
            'rule_id' : $("#rule_id").val(),
            'rule_ssort' : $("#rule_ssort").val(),
            'rule_name' : $("#rule_name").val(),
            'rule_score' : $("#rule_score").val(),
            'rule_money' : $("#rule_money").val(),
            'rule_day_max' : $("#rule_day_max").val(),
            'rule_max' : $("#rule_max").val(),
        }
        save_post_data(); //执行保存方法
    }
    //执行保存
    function save_post_data(){
        $.ajax({
            url: "{php echo $this->createWebUrl('promotefans', array('op' => 'save_rule', 'schoolid' => $schoolid))}",
            type: "post",
            dataType: "json",
            data: FormData,
            success: function(result) {
                ReToastGlobal(result.msg)
                setTimeout(function(){
                    location.reload()
                },1000)
            }
        });
    }
</script>
{else if $operation == 'form_record'}
<style>
    tr th,td{
        text-align: center;
    }
</style>
<div class="main">
    <div class="panel panel-info">
        <div class="panel-heading">缴费订单列表</div>
		<div class="panel-body">
			<form action="./index.php" method="get" class="form-horizontal" role="form">
				<input type="hidden" name="c" value="site">
				<input type="hidden" name="a" value="entry">
				<input type="hidden" name="m" value="fm_jiaoyu">
				<input type="hidden" name="do" value="promotefans"/>
				<input type="hidden" name="op" value="form_record"/>
				<input type="hidden" name="schoolid" value="{$schoolid}" />
				<input type="hidden" name="status" value="{$_GPC['status']}"/>
				<div class="form-group">
					<label class="col-xs-12 col-sm-3 col-md-1 control-label">支付状态</label>
					<div class="col-sm-9 col-xs-9 col-md-9">
						<div class="btn-group">
							<a href="{php echo $this->createWebUrl('promotefans', array('status' => '-1','op'=>'form_record', 'schoolid' => $schoolid))}" class="btn {if $status == -1}btn-primary{else}btn-default{/if}">不限</a>
							<a href="{php echo $this->createWebUrl('promotefans', array('status' => '0','op'=>'form_record', 'schoolid' => $schoolid))}" class="btn {if $status == 0}btn-primary{else}btn-default{/if}">待审核</a>
							<a href="{php echo $this->createWebUrl('promotefans', array('status' => '1','op'=>'form_record', 'schoolid' => $schoolid))}" class="btn {if $status == 1}btn-primary{else}btn-default{/if}">通过</a>
							<a href="{php echo $this->createWebUrl('promotefans', array('status' => '2','op'=>'form_record', 'schoolid' => $schoolid))}" class="btn {if $status == 2}btn-primary{else}btn-default{/if}">拒绝</a>
						</div>
					</div>
				</div>
				<div class="form-group clearfix">
					<label class="col-xs-12 col-sm-3 col-md-1 control-label">按姓名搜索</label>
                    <div class="col-sm-2 col-lg-2">
                        <input class="form-control" name="name" id="" type="text" value="{$_GPC['name']}">
                    </div>						
				</div>				
				<div class="form-group clearfix">				
					<label class="col-xs-12 col-sm-3 col-md-1 control-label">按课程搜索</label>
					<div class="col-sm-2 col-lg-2">
                        <select style="margin-right:15px;" name="kc_id" class="form-control">
                            {loop $kcList $r}
                            <option value="{$r['id']}" {if $r['id'] == $_GPC['kc_id']}selected{/if}>{$r['name']}</option>
                            {/loop}
						</select>
					</div>
				</div>				
				<div class="form-group clearfix">				
					<label class="col-xs-12 col-sm-3 col-md-1 control-label">按类型搜索</label>
					<div class="col-sm-2 col-lg-2">
						<select style="margin-right:15px;" name="type" class="form-control">
							<option value="0">不限</option>
							<option value="1" {if $_GPC['type'] == 1} selected {/if}>推广员</option>
							<option value="2" {if $_GPC['type'] == 2} selected {/if}>分享员</option>
						</select>
					</div>
				</div>				
				<div class="form-group clearfix">
					<label class="col-xs-12 col-sm-3 col-md-1 control-label">下单时间</label>
					<div class="col-sm-2 col-lg-2">
						{php echo tpl_form_field_daterange('createtime', array('start' => date('Y-m-d', $starttime), 'end' => date('Y-m-d', $endtime)));}
					</div>
					<div class="col-sm-2 col-lg-2" style="margin-left:50px">
						<button class="btn btn-default"><i class="fa fa-search"></i> 搜索</button>
					</div>	
				</div>
			</form>
		</div>		
    </div>
    <div class="panel panel-default">
        <form action="" method="post" class="form-horizontal form" >
            <input type="hidden" name="schoolid" value="{$schoolid}" />
            <div class="table-responsive panel-body">
                <table class="table table-hover">
                    <thead class="navbar-inner">
                    <tr>
					    <th>ID</th>
                        <th>姓名</th>
                        <th>手机号</th>
                        <th>关联课程</th>
                        <th>推广员</th>
                        <th>状态</th>
                        <th>时间</th>
                        <th>申请类型/理由</th>
                        <th>操作</th>
                    </tr>
                    </thead>
                    <tbody id="level-list">
                    {loop $list $row}
                    <tr>
					    <td>{$row['id']}</td>
                        <td>{$row['name']}</td>
                        <td>{$row['mobile']}</td>
                        <td>{$row['kcname']}</td>
                        <td>{$row['f_name']}</td>
                        <td>
                            {if $row['status'] == 0}
                                待审核
                            {else if $row['status'] == 1}
                                已审核
                            {else if $row['status'] == 2}
                                已拒绝
                            {/if}
                        </td>
                        <td>
                            {php echo date("Y-m-d",$row['createtime'])}
                        </td>
                        <td>
                            {if $row['sid']}
                            分享员【{$row['content']}】
                            {else}
                            推广员
                            {/if}
                        </td>
                        <td>
                            {if $row['status'] == 0}
                            <a class="btn btn-info btn-sm " href="{php echo $this->createWebUrl('promotefans', array('op' => 'changeForm', 'id' => $row['id'], 'schoolid' => $schoolid,'status'=>1))}" onclick="return confirm('是否确定同意当前操作？');return false;">同意</a>&nbsp;&nbsp;
                            <a class="btn btn-primary btn-sm " href="{php echo $this->createWebUrl('promotefans', array('op' => 'changeForm', 'id' => $row['id'], 'schoolid' => $schoolid,'status'=>2))}" onclick="return confirm('是否确定拒绝当前操作？');return false;">拒绝</a>&nbsp;&nbsp;
                            {/if}
                            <a class="btn btn-default btn-sm " href="{php echo $this->createWebUrl('promotefans', array('op' => 'del_form', 'id' => $row['id'], 'schoolid' => $schoolid))}" onclick="return confirm('确认删除此套餐吗？');return false;">删除</a>
                            {if $row['sid']}
                            <a class="btn btn-default btn-sm " onclick="showattribute(`{$row['sid']}`,2)">属性</a>
                            {else}
                            <a class="btn btn-default btn-sm " onclick="showattribute(`{$row['tid']}`,1)">属性</a>
                            {/if}
                        </td>
                    </tr>
                    {/loop}
                    </tbody>
                </table>
            </div>
        </form>
    </div>
    {$pager}
</div>
<!-- 侧滑展示信息 -->
<div class="uploader-modal modal right fade" style="z-index:1050 !important;"  id="info_bigbox" tabindex="-1" role="dialog" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
    <div class="modal-dialog myModalleft" style="width: 25%;">
        <div class="loading-layer"><div><img  style="margin-top:40%" src="{OSSURL}public/web/images/blue_four_round.png"></div></div>
        <div class="modal-content" id="info_box" style="max-height:unset !important;">
            
        </div>
    </div>
</div>
<!-- 侧滑展示信息 -->
<script>
    function showattribute(id,type){
        $('.loading-layer').show()
        $('body').toggleClass('modal-open');
        $('#info_bigbox').modal('toggle');
        $.ajax({
            url: "{php echo $this->createWebUrl('promotefans', array('op' => 'show_attribute', 'schoolid' => $schoolid))}",
            type: "post",
            dataType: "html",
            data: {
                id:id,
                type:type,
            },
            success: function(result) {
                console.log(result)
                setTimeout(function() {
                    $('.loading-layer').hide()
                }, 400);
                $('#info_box').html(result)
            },
        })
    }
</script>
{/if}
{template 'public/footer'}