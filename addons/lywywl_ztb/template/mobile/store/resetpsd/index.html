<!doctype html>
<html>
{template 'store/common/header'}
<!--CSS-->
<link rel="stylesheet" href="{__PLUGIN__}/validform/5.3.2/Validform.css">

<body class="bgf2">
<!--中心区域-->
<section class="mt24">
    <form action="{php echo $this->createMobileUrl('store.resetpsd',array('act'=>'resetpsd'));}" id="store_resetpsd" method="post">
    <ul class="registerList">
        <li>
            <input class="regInput font32" type="text" placeholder="请输入手机号码" name="model[mobile]" id="mobile" maxlength="11" datatype="m" nullmsg="请输入手机号码！" errormsg="请输入正确的手机号码！">
        </li>
        <li class="codepd">
            <input class="regInput font32" type="text" placeholder="请输入验证码" name="verifyCode" maxlength="6" datatype="n" nullmsg="请输入手机验证码！">
            <button type="button" class="codeBtn" id="btnSendSmsCode">获取验证码</button>
        </li>
    </ul>
    <h2 class="fn title">设置密码</h2>
    <ul class="registerList">
        <li>
            <input class="regInput font32" type="password" placeholder="请输入新密码（6-16字母和数字组合）" name="model[password]" maxlength="16" datatype="*6-16" nullmsg="请输入新密码！" errormsg="密码范围在6~16位之间！">
        </li>
        <li>
            <input class="regInput font32" type="password"  placeholder="请输入确认密码" name="model[password2]" maxlength="16" datatype="*" recheck="model[password]" nullmsg="请输入确认密码！" errormsg="您两次输入的密码不一致！">
        </li>
    </ul>
    <section class="btn-de">
        <input name="token" value="{$_W['token']}" type="hidden" />
        <input type="hidden" name="submit" value="submit"/>
        <button type="submit" class="Button" id="SubmitBtn">确认提交</button>
        <p class="mt40"> <a href="{php echo $this->createMobileUrl('store.login');}" class="returnLink">返回登录</a> </p>
    </section>
    </form>
</section>
<script src="{__PLUGIN__}/validform/5.3.2/Validform_v5.3.2_min.js"></script>
<script>
    $(function(){
        //为formContent 添加验证事件
        $("#store_resetpsd").Validform({
            tiptype: function (msg, o, cssctl) {
                if (!o.obj.is("form")) {
                    if (o.type == 2) {
                        //loading带文字
                        layer.open({
                            type: 2
                            , content: '数据提交中'
                            , time: 999 //999秒后自动关闭
                        });
                    } else {
                        layer.closeAll();
                        layer.open({
                            content: msg
                            , skin: 'msg'
                            , time: 2 //2秒后自动关闭
                            , style: 'bottom:0;'
                        });
                    }
                }
            },
            ajaxPost: true,
            tipSweep: true,
            beforeSubmit: function (curform) {
                $("#SubmitBtn").attr("disabled", true);
            },
            callback: function (data) {
                layer.closeAll();
                if(data.status == 1){
                    layer.open({
                        content: data.msg
                        , skin: 'msg'
                        , time: 2 //2秒后自动关闭
                        , style: 'bottom:0;'
                    });

                    setTimeout(function () {
                        window.location.href = data.url;
                    }, 2000);

                }else{
                    layer.open({
                        content: data.msg
                        , skin: 'msg'
                        , time: 2 //2秒后自动关闭
                        , style: 'bottom:0;'
                    });
                    $("#SubmitBtn").attr("disabled", false);
                }
            }
        });

        //发送短信验证码
        $("#btnSendSmsCode").click(function () {
            var mobile = $("#mobile");
            if (mobile.val() == "") {
                layer.open({
                    content: '请输入手机号码!'
                    , skin: 'msg'
                    , time: 2 //2秒后自动关闭
                    , style: 'bottom:0;'
                });
                mobile.focus();
                return;
            }
            var resg = /^1[3|4|5|6|7|8|9]\d{9}$/;
            var reg = new RegExp(resg);
            if (!reg.test(mobile.val())) {
                layer.open({ content: '手机号码输入有误,请重新输入！', skin: 'msg', time: 2,style: 'bottom:0;' });
                mobile.focus();
                return;
            }
            else {
                $(this).attr("disabled", true);
                var n = $(this).attr("time");
                if (n == null || parseInt(n) <= 0) {
                    $.ajax({
                        url: "{php echo $this->createMobileUrl('store.resetpsd',array('act'=>'sendSmsCode'));}",
                        type: "post",
                        dataType: "json",
                        data: { "mobile": $("#mobile").val() },
                        success: function (result) {
                            if (result.status == 0) {
                                layer.open({
                                    content: result.msg
                                    , skin: 'msg'
                                    , time: 2 //2秒后自动关闭
                                    , style: 'bottom:0;'
                                });
                                $("#btnSendSmsCode").removeAttr("disabled");
                            } else {
                                layer.open({
                                    content: result.msg
                                    , skin: 'msg'
                                    , time: 2 //2秒后自动关闭
                                    , style: 'bottom:0;'
                                });
                                SetTime(120);
                            }
                        }
                    });
                }
            }
        });
    });

    //短信发送计时
    function SetTime(n) {
        n--;
        var a = $("#btnSendSmsCode");
        if (n < 0) {
            $("#btnSendSmsCode").html("获取验证码");
            $("#btnSendSmsCode").removeAttr("disabled");
        } else {
            $("#btnSendSmsCode").attr("time", n).html(n + "秒重新获取");
            setTimeout("SetTime(" + n + ")", 1000);
        }
    };

</script>
</body>
</html>
