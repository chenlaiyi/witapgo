<!doctype html>
<html>
{template 'store/common/header'}
<link rel="stylesheet" href="{__PLUGIN__}/dropload/dropload.css">
<style>
    /*不滚动样式*/
    .scroll {position: fixed; width: 100%; height:100%; }
    body {position: static}
</style>
<script src="{__MOBILE_STORE_JS__}/mall.js"></script>
<body class="bgf2">
<section class="rel" style="height: 1.08rem;">
    <h2 class="screen fn font28 bgfff" style=" position: fixed;z-index: 10;width: 100%;">
        <dl class="retrie">
            <dt class="bor_b pd0_24">
                <a id="filter" href="javascript:;" style="width:auto!important">筛选<i class="sortIconI"></i> </a>
            </dt>
            <dd class="default">
                <form>
                    <!--筛选弹出层-->
                    <section class="interal_filter downlist">
                        <ul class="form">
                            <li><span>订单信息：</span><section><input type="text" placeholder="订单编号/OPENID" id="searchKey"></section></li>
                            <li><span>订单状态：</span><section>
                                <p class="select_box rel">
                                    <select id="searchStatus">
                                        <option value="">请选择</option>
                                        <option value="1" {if $status==1}selected="selected"{/if}>等待发货</option>
                                        <option value="2" {if $status==2}selected="selected"{/if}>已经发货</option>
                                        <option value="3" {if $status==3}selected="selected"{/if}>交易完成</option>
                                    </select>
                                </p>
                            </section></li>
                            <li><span>订单类型：</span><section>
                                <p class="select_box rel">
                                    <select id="searchTypes">
                                        <option value="">请选择</option>
                                        <option value="1">拓客商品</option>
                                        <option value="2">中奖商品</option>
                                    </select>
                                </p>
                            </section></li>
                        </ul>
                        <section class="retrieval mt24 clearfix">
                            <button type="reset" class="recharge_but font32"> 重置</button>
                            <button type="button" class="submit_but font32" id="btnSearch"> 搜索</button>
                        </section>
                    </section>
                </form>
            </dd>
        </dl>
    </h2>
</section>
<section class="h24"></section>

<section class="tabCon" id="ContentList">
    <section class="tabCon_item" id="LoadLists">

    </section>
</section>
<section class="h24"></section>
<section class="buttonBox">
    <section class="buttonFloat">
        <a href="{php echo $this->createMobileUrl('store.store_member',array('act'=>'index'))}" class="db font32 yellowBtn" style="background: #FFD112;">商家中心</a>
    </section>
</section>
<script src="{__PLUGIN__}/dropload/dropload.js"></script>
<script src="{__PLUGIN__}/artTemplate/template-native-debug.js"></script>
<script id="listtpl" type="text/html">
    <% for(var i = 0; i < rows.length; i++){ %>
    <section class="order_item writeoff_item" data-id="<%= rows[i].id %>" data-ordernumber="<%= rows[i].ordernumber %>"  data-status="<%= rows[i].status %>" data-fedex_id="<%= rows[i].fedex_id %>" data-fedex_code="<%= rows[i].fedex_code %>" data-fedex_number="<%= rows[i].fedex_number %>" data-mobile="<%= rows[i].mobile %>">
        <section class="order_num clearfix"><span class="font26 c9">订单编号：<%= rows[i].ordernumber %></span><span class="fr main_red font28"><%= rows[i].status_name %></span></section>
        <section class="order_goods">
            <img src="<%= rows[i].product_thumb %>"/>
            <h3><%= rows[i].product_title %></h3>
            <%if(rows[i].types==2){%>
            <p class="font20 c9"><span class="font32 main_red price"><%= rows[i].activity_name %></span></p>
            <%}%>
        </section>
        <section class="order_operate">
            <a href="javascript:;" class="details">查看订单</a>
            <%if(rows[i].status==1){%>
            <a href="javascript:;" class="deliver">发货</a>
            <%}%>
            <%if(rows[i].status>1 && rows[i].fedex_id>0){%>
            <a href="javascript:;" class="logistics">查看物流</a>
            <%}%>
        </section>
    </section>
    <% } %>
</script>
<script>
    $(function () {
        //点击筛选
        $('#filter').click(function(){
            var $filter = $(this);
            if($filter.hasClass('up')){
                $filter.removeClass('up');
                $('.downlist').hide();
            }else{
                $filter.addClass('up');
                $('.downlist').show();
            }
        });

        function setColor(id){
            if(id.val()==-1){
                id.css({"color":"#b4b4b4"})
            }else{
                id.css({"color":"#000"})
            }
        }
        setColor($(".select"))
        $(".select").click(function(){
            $(this).find("option").css({"color":"#000"})
        })
        $(".select").change(function(){
            setColor($(this))
        })

        var page = 0;
        var pageSize = 10;
        var dropload_me;
        var is_first = true;

        //点击搜索
        $('#btnSearch').click(function() {
            //隐藏筛选弹框
            $('#filter').removeClass('up');
            $('.downlist').hide();

            //筛选参数
            window.searchStatus = $('#searchStatus').val();
            window.searchKey = $('#searchKey').val();
            window.searchTypes = $('#searchTypes').val();

            //重新从第一页加载
            if(dropload_me){
                $('#LoadLists').empty();
                page = 0;
                dropload_me.unlock();
                dropload_me.noData(false);
                dropload_me.resetload();
            }

            if(is_first){
                is_first = false;
                $('#ContentList').dropload({
                    scrollArea : window,
                    domUp : {
                        domClass   : 'dropload-up',
                        domRefresh : '<div class="dropload-refresh">↓下拉刷新</div>',
                        domUpdate  : '<div class="dropload-update">↑释放更新</div>',
                        domLoad    : '<div class="dropload-load"><span class="loading"></span>数据加载中...</div>'
                    },
                    domDown : {
                        domClass   : 'dropload-down',
                        domRefresh : '<div class="dropload-refresh">↑上拉加载更多</div>',
                        domLoad    : '<div class="dropload-load"><span class="loading"></span>数据加载中...</div>',
                        domNoData  : '<div class="dropload-noData">暂无更多数据</div>'
                    },
                    loadUpFn : function(me){
                        $.ajax({
                            type: 'GET',
                            url: "{php echo $this->createMobileUrl('store.order_obj', array('act' => 'getJsonList'));}",
                            data:{
                                "page":1,
                                "pageSize":pageSize,
                                "status":window.searchStatus,
                                "types":window.searchTypes,
                                "key":window.searchKey,
                            },
                            dataType: 'json',
                            success: function(data){
                                var html = template("listtpl", data);
                                $('#LoadLists').html(html);
                                // 每次数据加载完，必须重置
                                me.resetload();
                                // 重置页数，重新获取loadDownFn的数据
                                page = 1;
                                window.delCount = 0;
                                // 解锁loadDownFn里锁定的情况
                                me.unlock();
                                me.noData(false);
                            },
                            error: function(xhr, type){
                                layer.open({
                                    content: '系统错误，稍后重试！'
                                    ,skin: 'msg'
                                    ,time: 2 //2秒后自动关闭
                                });
                                // 即使加载出错，也得重置
                                me.resetload();
                            }
                        });
                    },
                    loadDownFn : function(me){
                        dropload_me = me;
                        page++;
                        // 拼接HTML
                        var result = '';
                        $.ajax({
                            type: 'GET',
                            url: "{php echo $this->createMobileUrl('store.order_obj', array('act' => 'getJsonList'));}",
                            data:{
                                "page":page,
                                "pageSize":pageSize,
                                "status":window.searchStatus,
                                "types":window.searchTypes,
                                "key":window.searchKey,
                            },
                            dataType: 'json',
                            success: function(data){
                                var arrLen = data.rows.length;
                                if(arrLen > 0){
                                    var html = template("listtpl", data);
                                    // 如果没有数据
                                }else{
                                    // 锁定
                                    me.lock();
                                    // 无数据
                                    me.noData();
                                }

                                // 插入数据到页面，放到最后面
                                $('#LoadLists').append(html);
                                // 每次数据插入，必须重置
                                me.resetload()
                            },
                            error: function(xhr, type){
                                layer.open({
                                    content: '系统错误，稍后重试！'
                                    ,skin: 'msg'
                                    ,time: 2 //2秒后自动关闭
                                });
                                // 即使加载出错，也得重置
                                me.resetload();
                            }
                        });
                    },
                    threshold : 50
                });
            }

        }).trigger("click");

        //绑定详情
        $('#LoadLists').on('click','.details',function(){
            var Rowid = $(this).parents('.writeoff_item').data("id");

            //判断是否获取物流信息
            var status = $(this).parents('.writeoff_item').data("status");
            var fedex_id = $(this).parents('.writeoff_item').data("fedex_id");
            var fedex_code = $(this).parents('.writeoff_item').data("fedex_code");
            var fedex_number = $(this).parents('.writeoff_item').data("fedex_number");
            var mobile = $(this).parents('.writeoff_item').data("mobile");

            $.ajax({
                type: "get",
                url: "{php echo $this->createMobileUrl('store.order_obj', array('act' => 'details'));}",
                data: {
                    id: Rowid
                },
                success: function (Data) {
                    layer.open({
                        type: 1
                        ,content: Data
                        ,anim: 'up'
                        ,style: 'position:fixed; left:0; top:0; width:100%; height:100%;overflow:auto;background-color: #F2F2F2; border: none; -webkit-animation-duration: .5s; animation-duration: .5s;'
                    });

                    //判断是否获取物流信息
                    if(status>1 && fedex_id>0)
                    {
                        getOrderTraces(fedex_code,fedex_number,mobile);
                    }

                    scroll.afterOpen();
                    //清空浏览器历史记录
                    window.history.pushState({title: "title",url:"#"}, "title", "#");
                    //监听浏览器后退事件
                    window.addEventListener("popstate",
                            function(e) {
                                //后退关闭弹窗
                                closeWindows();
                            }, false);
                },
                error: function(xhr, type){
                    layer.open({
                        content: '系统错误，稍后重试！'
                        ,skin: 'msg'
                        ,time: 2 //2秒后自动关闭
                    });
                }
            });

        });

        //绑定发货
        $('#LoadLists').on('click','.deliver',function(){
            var Rowid = $(this).parents('.writeoff_item').data("id");

            $.ajax({
                type: "get",
                url: "{php echo $this->createMobileUrl('store.order_obj', array('act' => 'deliver'));}",
                data: {
                    id: Rowid
                },
                success: function (Data) {
                    layer.open({
                        type: 1
                        ,content: Data
                        ,anim: 'up'
                        ,style: 'position:fixed; left:0; top:0; width:100%; height:100%;overflow:auto;background-color: #F2F2F2; border: none; -webkit-animation-duration: .5s; animation-duration: .5s;'
                    });
                    scroll.afterOpen();
                    //清空浏览器历史记录
                    window.history.pushState({title: "title",url:"#"}, "title", "#");
                    //监听浏览器后退事件
                    window.addEventListener("popstate",
                            function(e) {
                                //后退关闭弹窗
                                closeWindows();
                            }, false);
                },
                error: function(xhr, type){
                    layer.open({
                        content: '系统错误，稍后重试！'
                        ,skin: 'msg'
                        ,time: 2 //2秒后自动关闭
                    });
                }
            });
        });

        //确认发货
        $(document).delegate("#fedexBtn", "click", function() {
            var ordernumber=$("#fedex_ordernumber").val();
            var fedex_id=$("#fedex_id").val();
            var fedex_name=$("#fedex_id").find("option:selected").text();
            var fedex_code=$("#fedex_id").find("option:selected").data("code");
            var fedex_number=$("#fedex_number").val();
            $.ajax({
                type: "post",
                url: "{php echo $this->createMobileUrl('store.order_obj', array('act' => 'deliver'));}",
                data: {
                    ordernumber: ordernumber,
                    fedex_id: fedex_id,
                    fedex_name: fedex_name,
                    fedex_code: fedex_code,
                    fedex_number: fedex_number
                },
                dataType:'json',
                success: function (data, status) {
                    if (data.status == 1) {
                        layer.open({
                            content: data.msg
                            ,skin: 'msg'
                            ,time: 2 //2秒后自动关闭
                        });
                        setTimeout(function () {
                            $('#btnSearch').trigger("click");
                        }, 2000);
                    }
                    else {
                        layer.open({
                            content: data.msg
                            ,skin: 'msg'
                            ,time: 2 //2秒后自动关闭
                        });
                    }
                }
            });
        });

        //绑定物流
        $('#LoadLists').on('click','.logistics',function(){
            var Ordernumber = $(this).parents('.writeoff_item').data("ordernumber");
            var fedex_code = $(this).parents('.writeoff_item').data("fedex_code");
            var fedex_number = $(this).parents('.writeoff_item').data("fedex_number");
            var mobile = $(this).parents('.writeoff_item').data("mobile");
            $.ajax({
                type: "get",
                url: "{php echo $this->createMobileUrl('store.order_logistics', array('act' => 'index'));}",
                data: {
                    ordernumber: Ordernumber,
                    types: 0
                },
                success: function (Data) {
                    layer.open({
                        type: 1
                        ,content: Data
                        ,anim: 'up'
                        ,style: 'position:fixed; left:0; top:0; width:100%; height:100%;overflow:auto;background-color: #F2F2F2; border: none; -webkit-animation-duration: .5s; animation-duration: .5s;'
                    });
                    getOrderAllTraces(fedex_code,fedex_number,mobile);
                    scroll.afterOpen();
                    //清空浏览器历史记录
                    window.history.pushState({title: "title",url:"#"}, "title", "#");
                    //监听浏览器后退事件
                    window.addEventListener("popstate",
                            function(e) {
                                //后退关闭弹窗
                                closeWindows();
                            }, false);
                },
                error: function(xhr, type){
                    layer.open({
                        content: '系统错误，稍后重试！'
                        ,skin: 'msg'
                        ,time: 2 //2秒后自动关闭
                    });
                }
            });
        });

        //内页物流
        $(document).delegate("#DetailsLogisticsBtn", "click", function() {
            var Ordernumber = $(this).data("ordernumber");
            var fedex_code = $(this).data("fedex_code");
            var fedex_number = $(this).data("fedex_number");
            var mobile = $(this).data("mobile");
            $.ajax({
                type: "get",
                url: "{php echo $this->createMobileUrl('store.order_logistics', array('act' => 'index'));}",
                data: {
                    ordernumber: Ordernumber,
                    types: 0
                },
                success: function (Data) {
                    layer.open({
                        type: 1
                        ,content: Data
                        ,anim: 'up'
                        ,style: 'position:fixed; left:0; top:0; width:100%; height:100%;overflow:auto;background-color: #F2F2F2; border: none; -webkit-animation-duration: .5s; animation-duration: .5s;'
                    });
                    getOrderAllTraces(fedex_code,fedex_number,mobile);
                    scroll.afterOpen();
                    //清空浏览器历史记录
                    window.history.pushState({title: "title",url:"#"}, "title", "#");
                    //监听浏览器后退事件
                    window.addEventListener("popstate",
                            function(e) {
                                //后退关闭弹窗
                                closeWindows();
                            }, false);
                },
                error: function(xhr, type){
                    layer.open({
                        content: '系统错误，稍后重试！'
                        ,skin: 'msg'
                        ,time: 2 //2秒后自动关闭
                    });
                }
            });
        });

    });

    //解决滚动弹窗滚动穿透
    // scroll.afterOpen 锁定
    // scroll.beforeClose 解锁
    var scroll = (function (className) {
        var scrollTop;
        return {
            afterOpen: function () {
                if(document.scrollingElement){
                    scrollTop = document.scrollingElement.scrollTop
                }
                else{
                    scrollTop = document.body.scrollTop;
                }
                document.body.classList.add(className);
                document.body.style.top = -scrollTop + 'px';
            },
            beforeClose: function () {
                document.body.classList.remove(className);
                if(document.scrollingElement){
                    document.scrollingElement.scrollTop = scrollTop;
                }
                document.body.scrollTop = scrollTop;
            }
        };
    })('scroll');

    function getOrderTraces(fedex_code,fedex_number,mobile) {
        $.ajax({
            type: "post",
            url: "{php echo $this->createMobileUrl('store.order_logistics', array('act' => 'getOrderTraces'));}",
            data: {
                "code": fedex_code,
                "number": fedex_number,
                "mobile": mobile
            },
            dataType:'json',
            success: function (result) {
                if (result.status === 1) {
                    var jsonData = JSON.parse(result.tracesData);
                    var expressHtml = "";
                    if(jsonData['Success']){
                        var item = jsonData['Traces'][jsonData['Traces'].length-1];
                        expressHtml="<p class='green'>"+(item['AcceptStation'])+"</p><time class='cb4 lh24 ml30 f14'>"+(item['AcceptTime'])+"</time>";
                    }else{
                        expressHtml="<p class='green'>获取物流信息失败，请稍后重试！</p>";
                    }
                    $("#logistics").html(expressHtml);
                } else {
                    layer.open({ content: result.msg, skin: 'msg', time: 2 });
                }
            }
        });
    }

    function getOrderAllTraces(fedex_code,fedex_number,mobile) {
        $.ajax({
            type: "post",
            url: "{php echo $this->createMobileUrl('store.order_logistics', array('act' => 'getOrderTraces'));}",
            data: {
                "code": fedex_code,
                "number": fedex_number,
                "mobile": mobile
            },
            dataType:'json',
            success: function (result) {
                if (result.status === 1) {
                    var jsonData = JSON.parse(result.tracesData);
                    var statusName = "未知";
                    if(jsonData['State']==2){
                        statusName = "在途中";
                    }else if(jsonData['State']==3){
                        statusName = "签收";
                    }else if(jsonData['State']==4){
                        statusName = "问题件";
                    }
                    $("#statusName").text(statusName);
                    var expressHtml = "";
                    if(jsonData['Success']){
                        $.each(jsonData['Traces'],function (i,item) {
                            expressHtml+="<li class='"+(i==(jsonData['Traces'].length -1)?"on":"")+"'><div class='lc'><i></i><em></em></div><div class='jd none'><p class='f14 lh20'>"+(item['AcceptStation'])+"</p><time class='font28'>"+(item['AcceptTime'])+"</time></div></li>";
                        })
                    }else{
                        expressHtml="<li class='on'><div class='lc'><i></i><em></em></div><div class='jd none'><p class='font28 lh20'>获取物流信息失败，请稍后重试！</p></div></li>";
                    }
                    $("#alllogistics").html(expressHtml);
                } else {
                    layer.open({ content: result.msg, skin: 'msg', time: 2 });
                }
            }
        });
    }

    //关闭关闭弹窗
    function closeWindows(){
        var layerArr = new Array();
        $(".layui-m-layer").each(function(){
            layerArr.push($(this).attr('index'));
        });
        layer.close(max(layerArr));
        scroll.beforeClose();
    }

    //获取数组中最大的值
    function max(arr){
        var num = arr[0];
        for(var i=0;i<arr.length;i++){
            if(num < arr[i]){
                num = arr[i]
            }
        }
        return num;
    }
</script>
</body>
</html>
