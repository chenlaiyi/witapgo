<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
    <meta name = "format-detection" content ="telephone=no">
    <meta http-equiv="Cache-Control" content="no-cache" />
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <title>{$title} - {$config['name']}</title>
    <link rel="stylesheet" type="text/css" href="{__MOBILE_STORE_CSS__}/base.css">
    <link rel="stylesheet" type="text/css" href="{__MOBILE_STORE_CSS__}/index.css?v=20191120">
    <link rel="stylesheet" type="text/css" href="{__MOBILE_STORE_PLUGIN__}/storeinvite/css/invite.css?v=20200219">
    <!-- 解决引用mui时ios输入框失去焦点页面跳到顶部问题 -->
    <style type="text/css">
        body{overflow: scroll; -webkit-overflow-scrolling: touch;}
    </style>
    <!-- 移动端适配 -->
    <script>
        var html = document.querySelector('html');
        changeRem();
        window.addEventListener('resize', changeRem);
        function changeRem() {
            var width = html.getBoundingClientRect().width;
            html.style.fontSize = width / 10 + 'px';
        }
    </script>
    <script src="{__MOBILE_STORE_JS__}/jquery-2.1.4.min.js"></script>
    <script src="{__PLUGIN__}/layer/mobile/2.0/layer.js"></script>
    <script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
    <script>
        // jssdk config 对象
        jssdkconfig = {php echo json_encode($_W['account']['jssdkconfig']);} || {};
        // 是否启用调试
        jssdkconfig.debug = false;
        jssdkconfig.jsApiList = [
            'checkJsApi',
            'updateAppMessageShareData',
            'updateTimelineShareData',
            'onMenuShareTimeline',
            'onMenuShareAppMessage',
            'onMenuShareQQ',
            'onMenuShareWeibo',
            'getLocation',
            'hideAllNonBaseMenuItem',
            'showAllNonBaseMenuItem',
            'hideMenuItems'
        ];
        wx.config(jssdkconfig);
        wx.error(function (res) {
            layer.open({ content: '对不起，微信JSSDK信息验证失败！', skin: 'msg', time: 2 });
        });
        wx.ready(function () {
            var title = "{$_share['title']}";
            var imgUrl = "{$_share['imgUrl']}";
            var link = "{$_share['link']}";
            var desc = "{$_share['desc']}";

            if (wx.onMenuShareTimeline) {
                //转发到朋友圈
                wx.onMenuShareTimeline({
                    title: title,
                    desc: desc,
                    link: link,
                    imgUrl: imgUrl,
                    success: function () {

                    },
                    cancel: function () {
                        layer.open({ content: '对不起，转发失败请重试！', skin: 'msg', time: 2 });
                    }
                });
                //转发给朋友
                wx.onMenuShareAppMessage({
                    title: title,
                    desc: desc,
                    link: link,
                    imgUrl: imgUrl,
                    type: 'link',
                    dataUrl: '',
                    success: function () {

                    },
                    cancel: function () {
                        layer.open({ content: '对不起，转发失败请重试！', skin: 'msg', time: 2 });
                    }
                });
                wx.onMenuShareQQ({
                    title: title, // 分享标题
                    desc: desc, // 分享描述
                    link: link, // 分享链接
                    imgUrl: imgUrl, // 分享图标
                    success: function () {

                    },
                    cancel: function () {
                        layer.open({ content: '对不起，转发失败请重试！', skin: 'msg', time: 2 });
                    }
                });
                wx.onMenuShareWeibo({
                    title: title, // 分享标题
                    desc: desc, // 分享描述
                    link: link, // 分享链接
                    imgUrl: imgUrl, // 分享图标
                    success: function () {

                    },
                    cancel: function () {
                        layer.open({ content: '对不起，转发失败请重试！', skin: 'msg', time: 2 });
                    }
                });
            }
            else{
                //新版发送朋友圈
                wx.updateTimelineShareData({
                    title: title, // 分享标题
                    link: link, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                    imgUrl: imgUrl, // 分享图标
                }, function(res) {

                });
                wx.updateAppMessageShareData({
                    title: title, // 分享标题
                    desc: desc, // 分享描述
                    link: link, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                    imgUrl: imgUrl, // 分享图标
                }, function(res) {

                });
            }
        });
    </script>
    <link rel="stylesheet" href="{__PLUGIN__}/dropload/dropload.css">
    <script src="{__MOBILE_STORE_JS__}/swiper.jquery.min.js"></script>
    <link rel="stylesheet" href="{__PLUGIN__}/clipboard/clipboard.min.js">
    <style>
        /*不滚动样式*/
        .scroll {position: fixed; width: 100%; height:100%; }
        body {position: static}
        .layui-m-layercont {padding: 20px 20px;line-height: 22px;text-align: center;}
    </style>
</head>
<body>
<section class="rel" style="height: 1.08rem;">
    <h2 class="screen fn font28 bgfff" style=" position: fixed;z-index: 10;width: 100%;">
        <dl class="retrie">
            <dt class="bor_b pd0_24">
                <a id="filter" href="javascript:;" style="width:auto!important">筛选<i class="sortIconI"></i> </a>
            </dt>
            <dd class="default">
                <form>
                    <!--筛选弹出层-->
                    <section class="interal_filter downlist">
                        <ul class="form">
                            <li><span>成员信息：</span><section><input type="text" placeholder="业务员名称/OPENID" id="searchKey"></section></li>
                            <li><span>成员状态：</span><section >
                                <p class="select_box rel">
                                    <select id="searchStatus">
                                        <option value="">请选择</option>
                                        <option value="1">启用</option>
                                        <option value="0">禁用</option>
                                    </select>
                                </p>
                            </section></li>
                        </ul>
                        <section class="retrieval mt24 clearfix">
                            <button type="reset" class="recharge_but font32"> 重置</button>
                            <button type="button" class="submit_but font32" id="btnSearch"> 搜索</button>
                        </section>
                    </section>
                </form>
            </dd>
        </dl>
    </h2>
</section>
<!--中心区域-->
<section class="pdBtm98">
    <section  id="ContentList">
        <ul class="mystaff" id="LoadLists">
        </ul>
    </section>
    <section class="buttonFloat clickBtn">
        <a href="{php echo $this->createMobileUrl('store.invite_center',array('act'=>'index'))}" class="db font32" style="width: 50%;    float: left;   color: #fff;   border-radius: 0.6rem 0 0 0.6rem;    background: #f92f4a;">分销中心</a>
        <a href="{php echo $this->createMobileUrl('store.invite_promoter', array('act' => 'create'));}" class="db font32" style="width: 50%;   float: left;    background: #FFD112;    color: #0e0e0e;border-radius: 0 0.6rem 0.6rem 0;">添加成员</a>
    </section>
</section>
<script src="{__PLUGIN__}/dropload/dropload.js"></script>
<script src="{__PLUGIN__}/artTemplate/template-native-debug.js"></script>
<script src="{__MOBILE_STORE_JS__}/index.js"></script>
<script id="listtpl" type="text/html">
    <% for(var i = 0; i < rows.length; i++){ %>
    <li data-id="<%= rows[i].id %>" data-mobilelinks="<%= rows[i].links_mobile %>" data-pclinks="<%= rows[i].links_pc %>" >
        <section class="staff_info">
            <img class="tx" src="<%= rows[i].headurl %>" alt="<%= rows[i].name %>">
            <h2 class="fn clearfix"><span class="mr10"><%= rows[i].name %></span>
                <%if(rows[i].mobile!=''){%>
                <span class=" ml10"><a href="tel:<%= rows[i].mobile %>"><img src="{__MOBILE_STORE_IMG__}/telIcon.png"  /><%= rows[i].mobile %></a></span>
                <%}%>
            </h2>
            <p>OPENID：<%= rows[i].openid %></p>
            <section class="number_list clearfix">
                <section class="statis_number">
                    <h4 class="font30 fn"><%= rows[i].invite_count%> 次</h4>
                    <p class="c6">获取返利</p>
                </section>
                <section class="statis_number">
                    <h4 class="font30 fn"><%= rows[i].invite_money%> 元</h4>
                    <p class="c6">返佣金额</p>
                </section>
                <section class="statis_number">
                    <h4 class="font30 fn"><%= rows[i].team_count%> 家</h4>
                    <p class="c6">下线商家</p>
                </section>
                <section class="statis_number">
                    <h4 class="font30 fn"><%= rows[i].royalty%>%</h4>
                    <p class="c6">返佣比例</p>
                </section>
                <section class="statis_number">
                    <h4 class="font30 fn"><%= rows[i].sell_count%> 次</h4>
                    <p class="c6">结算返利</p>
                </section>
                <section class="statis_number">
                    <h4 class="font30 fn"><%= rows[i].sell_money%> 元</h4>
                    <p class="c6">结算金额</p>
                </section>
            </section>
            <%if(rows[i].status==1){%>
            <span class="switch switch_on"><i class="slider"></i></span>
            <%}else{%>
            <span class="switch switch_off"><i class="slider"></i></span>
            <%}%>
        </section>
        <section class="operation staff_operate w33">
            <a href="javascript:;" class="edit bor_r font28"><span>编辑</span></a>
            <a href="javascript:;" class="exclusive bor_r font28"><span>专属链接</span></a>
            <a href="javascript:;" class="delete  font28"><span>删除</span></a>
        </section>
    </li>
    <% } %>
</script>
<script>
    $(function () {
        //点击筛选
        $('#filter').click(function(){
            var $filter = $(this);
            if($filter.hasClass('up')){
                $filter.removeClass('up');
                $('.downlist').hide();
            }else{
                $filter.addClass('up');
                $('.downlist').show();
            }
        });

        var page = 0;
        var pageSize = 10;
        var dropload_me;
        var is_first = true;

        //点击搜索
        $('#btnSearch').click(function() {
            //隐藏筛选弹框
            $('#filter').removeClass('up');
            $('.downlist').hide();

            //筛选参数
            window.searchStatus = $('#searchStatus').val();
            window.searchKey = $('#searchKey').val();
            window.delCount = 0;

            //重新从第一页加载
            if(dropload_me){
                $('#LoadLists').empty();
                page = 0;
                dropload_me.unlock();
                dropload_me.noData(false);
                dropload_me.resetload();
            }

            if(is_first){
                is_first = false;
                $('#ContentList').dropload({
                    scrollArea : window,
                    domUp : {
                        domClass   : 'dropload-up',
                        domRefresh : '<div class="dropload-refresh">↓下拉刷新</div>',
                        domUpdate  : '<div class="dropload-update">↑释放更新</div>',
                        domLoad    : '<div class="dropload-load"><span class="loading"></span>数据加载中...</div>'
                    },
                    domDown : {
                        domClass   : 'dropload-down',
                        domRefresh : '<div class="dropload-refresh">↑上拉加载更多</div>',
                        domLoad    : '<div class="dropload-load"><span class="loading"></span>数据加载中...</div>',
                        domNoData  : '<div class="dropload-noData">暂无更多数据</div>'
                    },
                    loadUpFn : function(me){
                        $.ajax({
                            type: 'GET',
                            url: "{php echo $this->createMobileUrl('store.invite_promoter', array('act' => 'getJsonList'));}",
                            data:{
                                "page":1,
                                "pageSize":pageSize,
                                "delCount":window.delCount,
                                "status":window.searchStatus,
                                "key":window.searchKey,
                            },
                            dataType: 'json',
                            success: function(data){
                                var html = template("listtpl", data);
                                $('#LoadLists').html(html);
                                // 每次数据加载完，必须重置
                                me.resetload();
                                // 重置页数，重新获取loadDownFn的数据
                                page = 1;
                                window.delCount = 0;
                                // 解锁loadDownFn里锁定的情况
                                me.unlock();
                                me.noData(false);
                            },
                            error: function(xhr, type){
                                layer.open({
                                    content: '系统错误，稍后重试！'
                                    ,skin: 'msg'
                                    ,time: 2 //2秒后自动关闭
                                });
                                // 即使加载出错，也得重置
                                me.resetload();
                            }
                        });
                    },
                    loadDownFn : function(me){
                        dropload_me = me;
                        page++;
                        // 拼接HTML
                        var result = '';
                        $.ajax({
                            type: 'GET',
                            url: "{php echo $this->createMobileUrl('store.invite_promoter', array('act' => 'getJsonList'));}",
                            data:{
                                "page":page,
                                "pageSize":pageSize,
                                "delCount":window.delCount,
                                "status":window.searchStatus,
                                "key":window.searchKey,
                            },
                            dataType: 'json',
                            success: function(data){
                                var arrLen = data.rows.length;
                                if(arrLen > 0){
                                    var html = template("listtpl", data);
                                    // 如果没有数据
                                }else{
                                    // 锁定
                                    me.lock();
                                    // 无数据
                                    me.noData();
                                }

                                // 插入数据到页面，放到最后面
                                $('#LoadLists').append(html);
                                // 每次数据插入，必须重置
                                me.resetload()
                            },
                            error: function(xhr, type){
                                layer.open({
                                    content: '系统错误，稍后重试！'
                                    ,skin: 'msg'
                                    ,time: 2 //2秒后自动关闭
                                });
                                // 即使加载出错，也得重置
                                me.resetload();
                            }
                        });
                    },
                    threshold : 50
                });
            }

        }).trigger("click");
    });

    //状态开关
    $('#LoadLists').on('click','.switch',function(){
        var switchobj = $(this);
        var status = switchobj.hasClass("switch_on") ? 0 : 1;
        var Rowid = switchobj.parents('li').data("id");
        $.ajax({
            type: "post",
            dataType: "json",
            url: "{php echo $this->createMobileUrl('store.invite_promoter', array('act' => 'setStatus'));}",
            data: {
                "id": Rowid,
                "status": status
            },
            success: function (jsonData, status) {
                if (jsonData.status == 1) {
                    if(switchobj.hasClass("switch_on")){
                        switchobj.removeClass("switch_on");
                        switchobj.addClass("switch_off");
                    }
                    else{
                        switchobj.removeClass("switch_off");
                        switchobj.addClass("switch_on");
                    }
                }
                else {
                    layer.open({
                        content: jsonData.msg
                        ,skin: 'msg'
                        ,time: 2 //2秒后自动关闭
                    });
                }
            }
        });
    });

    //编辑信息
    $('#LoadLists').on('click','.edit',function(){
        var userobj = $(this);
        var Rowid = userobj.parents('li').data("id");
        window.location.href = "{php echo $this->createMobileUrl('store.invite_promoter', array('act' => 'modify'));}&id="+Rowid;
    });

    //专属链接
    $('#LoadLists').on('click','.exclusive',function(){
        var data = $(this).parents('li').data();
        /*{if $create_qr_types == 0}*/
            var html ='<section class="obj_preview mb50"><em class="pcOWap">移动端分享链接</em><ul><li><p class="ewmRetail"><span class="billEwm" id="h5qrcode">二维码生成中，请耐心等待！</span></p><p id="copyh5txt" class="copytxt">'+ data.mobilelinks +'</p><a href="javascript:;" class="copybtn" onClick="copyH5TXT()"><img class="copyimg" src="{__MOBILE_STORE_IMG__}/link.png" alt="">复制链接</a> </li></ul></section><section class="obj_preview mb50"><em class="pcOWap">电脑端分享链接</em><ul><li><p class="ewmRetail"><span class="billEwm" id="pcqrcode">二维码生成中，请耐心等待！</span></p><p id="copypctxt" class="copytxt">'+ data.pclinks +'</p><a href="javascript:;" class="copybtn" onClick="copyPCTXT()"><img class="copyimg" src="{__MOBILE_STORE_IMG__}/link.png" alt="">复制链接</a> </li></ul></section> <section style="height:1.27rem"></section><section class="buttonFloat"><a href="javascript:;" class="db font32" style="background-color: #fee002;border-radius: 0.6rem;" onclick="closeWindows()">关闭</a></section>';
        /*{else}*/
            var html ='<section class="obj_preview mb50"><em class="pcOWap">移动端分享链接</em><ul><li><p class="ewmRetail"><img class="ewm" src="{php echo $this->createMobileUrl('store.invite_promoter', array('act' => 'qrPreview','ispc' => false ));}&id='+ data.id +'"></p><p id="copyh5txt" class="copytxt">'+ data.mobilelinks +'</p><a href="javascript:;" class="copybtn" onClick="copyH5TXT()"><img class="copyimg" src="{__MOBILE_STORE_IMG__}/link.png" alt="">复制链接</a> </li></ul></section><section class="obj_preview mb50"><em class="pcOWap">电脑端分享链接</em><ul><li><p class="ewmRetail"><img class="ewm" src="{php echo $this->createMobileUrl('store.invite_promoter', array('act' => 'qrPreview','ispc' => true ));}&id='+ data.id +'"></p><p id="copypctxt" class="copytxt">'+ data.pclinks +'</p><a href="javascript:;" class="copybtn" onClick="copyPCTXT()"><img class="copyimg" src="{__MOBILE_STORE_IMG__}/link.png" alt="">复制链接</a> </li></ul></section><section style="height:1.27rem"></section><section class="buttonFloat"><a href="javascript:;" class="db font32" style="background-color: #fee002;border-radius: 0.6rem;" onclick="closeWindows()">关闭</a></section>';
        /*{/if}*/
        //页面层
        layer.open({
            type: 1,
            title: ""
            ,content: html
            ,anim: 'up'
            ,style: 'position:fixed; left:0; top:0; width:100%; height:100%;overflow:auto;background-color: #F2F2F2; border: none; -webkit-animation-duration: .5s; animation-duration: .5s;'
        });
        scroll.afterOpen();
        /*{if $create_qr_types == 0}*/
        $.ajax({
            type: "post",
            dataType:'json',
            url: "{php echo $this->createMobileUrl('store.invite_promoter', array('act' => 'poster','ispc' => false));}&id="+data.id,
            data: {},
            success: function (data) {
                if (data.status == 1) {
                    $("#h5qrcode").html('<img src="'+ data.path +'">');
                }
                else {
                    $("#h5qrcode").html(data.msg);
                }
            }
        });
        $.ajax({
            type: "post",
            url: "{php echo $this->createMobileUrl('store.invite_promoter', array('act' => 'poster','ispc' => true));}&id="+data.id,
            data: {},
            dataType:'json',
            success: function (data) {
                if (data.status == 1) {
                    $("#pcqrcode").html('<img src="'+ data.path +'">');
                }
                else {
                    $("#pcqrcode").html(data.msg);
                }
            }
        });
        /*{/if}*/
    });

    //删除信息
    $('#LoadLists').on('click','.delete',function(){
        var delobj = $(this);
        var Rowid = delobj.parents('li').data("id");
        //询问框
        layer.open({
            content: '你确定要删除吗？'
            , btn: ['确定', '取消']
            , yes: function (index) {
                $.ajax({
                    type: "post",
                    dataType: "json",
                    url: "{php echo $this->createMobileUrl('store.invite_promoter', array('act' => 'del'));}",
                    data: {
                        id: Rowid
                    },
                    success: function (data, status) {
                        if (data.status == 1) {
                            window.delCount = window.delCount + 1;
                            delobj.parents('li').remove();
                            layer.open({
                                content: data.msg
                                ,skin: 'msg'
                                ,time: 2 //2秒后自动关闭
                            });
                        }
                        else {
                            layer.open({
                                content: data.msg
                                ,skin: 'msg'
                                ,time: 2 //2秒后自动关闭
                            });
                        }
                    }
                });
                layer.close(index);
            }
        });
    });

    //关闭弹窗
    function closeWindows(){
        layer.closeAll();
        scroll.beforeClose();
    }

    //复制文本到剪切板
    function copyH5TXT(){
        var copyDOM = document.querySelector('#copyh5txt'); //指定的DOM元素
        var range = document.createRange(); // 创建容器
        range.selectNode(copyDOM); // 选中需要复制的节点
        window.getSelection().addRange(range); // 执行选中元素
        var successful = document.execCommand('copy');// 执行 copy 操作
        try {
            var msg = successful ? 'successful' : 'unsuccessful';
            if(msg == 'successful'){
                //提示
                layer.open({
                    content: '已复制到剪切板'
                    ,skin: 'msg'
                    ,time: 2 //2秒后自动关闭
                });
            }
        } catch(err) {
            console.log('unable to copy');
        }
        window.getSelection().removeAllRanges(); // 移除选中的元素
    }
    //复制文本到剪切板
    function copyPCTXT(){
        var copyDOM = document.querySelector('#copypctxt'); //指定的DOM元素
        var range = document.createRange(); // 创建容器
        range.selectNode(copyDOM); // 选中需要复制的节点
        window.getSelection().addRange(range); // 执行选中元素
        var successful = document.execCommand('copy');// 执行 copy 操作
        try {
            var msg = successful ? 'successful' : 'unsuccessful';
            if(msg == 'successful'){
                //提示
                layer.open({
                    content: '已复制到剪切板'
                    ,skin: 'msg'
                    ,time: 2 //2秒后自动关闭
                });
            }
        } catch(err) {
            console.log('unable to copy');
        }
        window.getSelection().removeAllRanges(); // 移除选中的元素
    }

    //解决滚动弹窗滚动穿透
    // scroll.afterOpen 锁定
    // scroll.beforeClose 解锁
    var scroll = (function (className) {
        var scrollTop;
        return {
            afterOpen: function () {
                if(document.scrollingElement){
                    scrollTop = document.scrollingElement.scrollTop
                }
                else{
                    scrollTop = document.body.scrollTop;
                }
                document.body.classList.add(className);
                document.body.style.top = -scrollTop + 'px';
            },
            beforeClose: function () {
                document.body.classList.remove(className);
                if(document.scrollingElement){
                    document.scrollingElement.scrollTop = scrollTop;
                }
                document.body.scrollTop = scrollTop;
            }
        };
    })('scroll');

</script>
</body>
</html>