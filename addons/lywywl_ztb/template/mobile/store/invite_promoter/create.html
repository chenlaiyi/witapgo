<!doctype html>
<html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=0">
<meta name = "format-detection" content ="telephone=no">
<meta http-equiv="Cache-Control" content="no-cache" />
<meta name="apple-mobile-web-app-capable" content="yes" />
<title>{$title} - {$config['name']}</title>
<link rel="stylesheet" type="text/css" href="{__MOBILE_STORE_CSS__}/base.css">
<link rel="stylesheet" type="text/css" href="{__MOBILE_STORE_CSS__}/index.css?v=20191120">
<!-- 解决引用mui时ios输入框失去焦点页面跳到顶部问题 -->
<style type="text/css">
    body{overflow: scroll; -webkit-overflow-scrolling: touch;}
</style>
<!-- 移动端适配 -->
<script>
    var html = document.querySelector('html');
    changeRem();
    window.addEventListener('resize', changeRem);
    function changeRem() {
        var width = html.getBoundingClientRect().width;
        html.style.fontSize = width / 10 + 'px';
    }
</script>
<script src="{__MOBILE_STORE_JS__}/jquery-2.1.4.min.js"></script>
<script src="{__PLUGIN__}/layer/mobile/2.0/layer.js"></script>
<script src="https://res.wx.qq.com/open/js/jweixin-1.6.0.js"></script>
<script>
    // jssdk config 对象
    jssdkconfig = {php echo json_encode($_W['account']['jssdkconfig']);} || {};
    // 是否启用调试
    jssdkconfig.debug = false;
    jssdkconfig.jsApiList = [
        'checkJsApi',
        'updateAppMessageShareData',
        'updateTimelineShareData',
        'onMenuShareTimeline',
        'onMenuShareAppMessage',
        'onMenuShareQQ',
        'onMenuShareWeibo',
        'getLocation',
        'hideAllNonBaseMenuItem',
        'showAllNonBaseMenuItem',
        'hideMenuItems'
    ];
    wx.config(jssdkconfig);
    wx.error(function (res) {
        layer.open({ content: '对不起，微信JSSDK信息验证失败！', skin: 'msg', time: 2 });
    });
    wx.ready(function () {
        var title = "{$_share['title']}";
        var imgUrl = "{$_share['imgUrl']}";
        var link = "{$_share['link']}";
        var desc = "{$_share['desc']}";

        if (wx.onMenuShareTimeline) {
            //转发到朋友圈
            wx.onMenuShareTimeline({
                title: title,
                desc: desc,
                link: link,
                imgUrl: imgUrl,
                success: function () {

                },
                cancel: function () {
                    layer.open({ content: '对不起，转发失败请重试！', skin: 'msg', time: 2 });
                }
            });
            //转发给朋友
            wx.onMenuShareAppMessage({
                title: title,
                desc: desc,
                link: link,
                imgUrl: imgUrl,
                type: 'link',
                dataUrl: '',
                success: function () {

                },
                cancel: function () {
                    layer.open({ content: '对不起，转发失败请重试！', skin: 'msg', time: 2 });
                }
            });
            wx.onMenuShareQQ({
                title: title, // 分享标题
                desc: desc, // 分享描述
                link: link, // 分享链接
                imgUrl: imgUrl, // 分享图标
                success: function () {

                },
                cancel: function () {
                    layer.open({ content: '对不起，转发失败请重试！', skin: 'msg', time: 2 });
                }
            });
            wx.onMenuShareWeibo({
                title: title, // 分享标题
                desc: desc, // 分享描述
                link: link, // 分享链接
                imgUrl: imgUrl, // 分享图标
                success: function () {

                },
                cancel: function () {
                    layer.open({ content: '对不起，转发失败请重试！', skin: 'msg', time: 2 });
                }
            });
        }
        else{
            //新版发送朋友圈
            wx.updateTimelineShareData({
                title: title, // 分享标题
                link: link, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                imgUrl: imgUrl, // 分享图标
            }, function(res) {

            });
            wx.updateAppMessageShareData({
                title: title, // 分享标题
                desc: desc, // 分享描述
                link: link, // 分享链接，该链接域名或路径必须与当前页面对应的公众号JS安全域名一致
                imgUrl: imgUrl, // 分享图标
            }, function(res) {

            });
        }
    });
</script>
<link rel="stylesheet" href="{__PLUGIN__}/dropload/dropload.css">
<script src="{__MOBILE_STORE_JS__}/swiper.jquery.min.js"></script>
<style>
    /*不滚动样式*/
    .scroll {position: fixed; width: 100%; height:100%; }
    body {position: static}
    .layui-m-layercont {padding: 20px 20px;line-height: 22px;text-align: center;}
</style>
<body>
<section class="tabContainer" style="margin-bottom: 1.41rem;">
    <ul class="tabHd tabHd01 ">
        <li class="active" style="width: 50%;" id="tabs-nav-code"><span>扫码添加</span></li>
        <li style="width: 50%;" id="tabs-nav-user"><span>手动添加</span></li>
    </ul>
    <section class="swiper-container swiper-container-horizontal swiper-container-autoheight">
        <section class="swiper-wrapper">
            <section class="swiper-slide" id="tabs-content-code">
                <section class="tabCon">
                    <!--扫码添加-->
                    <section class="bgfff tc pt20"> <img class="addewm" src="{php echo $this->createMobileUrl('store.invite_promoter', array('act' => 'addQrPreview'));}"  width="205"  height="205" alt="扫码创建二维码"/>
                        <p class="font28 c6">分销业务员微信扫码创建</p>
                        <section class="copyScan">
                            <section class="tl pd24 font28 links copy_add_text" style="">
                                <section> {php echo replaceDieDomain($config, __MURL('user.store_promoter', array('store_id' => $store['id']), true, true));} </section>
                            </section>
                            <input type="button" class="copyBtn" id="btnAddCopy" value="复制链接" data-clipboard-action="copy" data-clipboard-target=".copy_add_text">
                        </section>
                        <img class="addewm" src="{php echo $this->createMobileUrl('store.invite_promoter', array('act' => 'adminQrPreview'));}"  width="205"  height="205" alt="扫码管理二维码"/>
                        <p class="font28 c6">微信扫码管理溯源统计</p>
                        <section class="copyScan">
                            <section class="tl pd24 font28 links copy_admin_text" style="">
                                <section> {php echo replaceDieDomain($config, __MURL('user.admins_storeinvite', array('store_id' => $store['id']), true, true));} </section>
                            </section>
                            <input type="button" class="copyBtn" id="btnAdminCopy" value="复制链接" data-clipboard-action="copy" data-clipboard-target=".copy_admin_text">
                        </section>
                    </section>
                </section>
            </section>
            <section class="swiper-slide" style="display: none;" id="tabs-content-user">
                <section class="tabCon">
                    <section class="tabCon_item">
                        <!--手动添加-->
                        <section style="background:#fff; padding-bottom:0.32rem">
                            <section style=" height:1.6rem;">
                                <section class="pd24 map_search clearfix">
                                    <section class="txt_item w80 fl">
                                        <input type="text" placeholder="请输入用户昵称" class="form_txt" id="searchKey">
                                    </section>
                                    <section class="w20 fr">
                                        <button class="but_search" id="btnSearch">搜索</button>
                                    </section>
                                </section>
                            </section>
                            <div id="ContentList">
                                <ul class="mystaff" id="LoadLists" >

                                </ul>
                            </div>
                        </section>
                    </section>
                </section>
            </section>
        </section>
    </section>
</section>
<section class="buttonFloat"><a href="{php echo $this->createMobileUrl('store.invite_promoter', array('act' => 'index'));}" style="background-color: #fee002;border-radius: 0.6rem;" class="db font32" >返回</a></section>
<script src="{__PLUGIN__}/dropload/dropload.js"></script>
<script src="{__PLUGIN__}/artTemplate/template-native-debug.js"></script>
<script src="{__MOBILE_STORE_JS__}/index.js"></script>
<script src="{__PLUGIN__}/clipboard/clipboard.min.js"></script>
<script id="listtpl" type="text/html">
    <% for(var i = 0; i < rows.length; i++){ %>
    <li>
        <section class="staff_info bor_t"> <img class="tx" src="<%= rows[i].headurl %>" alt="<%= rows[i].nickname %>"/>
            <h2 class="fn clearfix" style="margin-right: 1.68rem;"><span class="mr10"><%= rows[i].nickname %></span></h2>
            <p>OPENID：<%= rows[i].openid %></p>
            <button class="addBtn adduser" data-userid="<%= rows[i].id %>">添加</button>
        </section>
    </li>
    <% } %>
</script>
<script>
    $(function () {
        var page = 0;
        var pageSize = 10;
        var dropload_me;
        var is_first = true;

        //点击搜索
        $('#btnSearch').click(function() {
            //筛选参数
            window.searchKey = $('#searchKey').val();
            window.delCount = 0;

            //重新从第一页加载
            if(dropload_me){
                $('#LoadLists').empty();
                page = 0;
                dropload_me.unlock();
                dropload_me.noData(false);
                dropload_me.resetload();
            }

            if(is_first){
                is_first = false;
                $('#ContentList').dropload({
                    scrollArea : window,
                    domUp : {
                        domClass   : 'dropload-up',
                        domRefresh : '<div class="dropload-refresh">↓下拉刷新</div>',
                        domUpdate  : '<div class="dropload-update">↑释放更新</div>',
                        domLoad    : '<div class="dropload-load"><span class="loading"></span>数据加载中...</div>'
                    },
                    domDown : {
                        domClass   : 'dropload-down',
                        domRefresh : '<div class="dropload-refresh">↑上拉加载更多</div>',
                        domLoad    : '<div class="dropload-load"><span class="loading"></span>数据加载中...</div>',
                        domNoData  : '<div class="dropload-noData">暂无更多数据</div>'
                    },
                    loadUpFn : function(me){
                        $.ajax({
                            type: 'GET',
                            url: "{php echo $this->createMobileUrl('store.user_account', array('act' => 'getJsonList'));}",
                            data:{
                                "page":1,
                                "pageSize":pageSize,
                                "delCount":window.delCount,
                                "key":window.searchKey,
                            },
                            dataType: 'json',
                            success: function(data){
                                var html = template("listtpl", data);
                                $('#LoadLists').html(html);
                                // 每次数据加载完，必须重置
                                me.resetload();
                                // 重置页数，重新获取loadDownFn的数据
                                page = 1;
                                window.delCount = 0;
                                // 解锁loadDownFn里锁定的情况
                                me.unlock();
                                me.noData(false);
                            },
                            error: function(xhr, type){
                                layer.open({
                                    content: '系统错误，稍后重试！'
                                    ,skin: 'msg'
                                    ,time: 2 //2秒后自动关闭
                                });
                                // 即使加载出错，也得重置
                                me.resetload();
                            }
                        });
                    },
                    loadDownFn : function(me){
                        dropload_me = me;
                        page++;
                        // 拼接HTML
                        var result = '';
                        $.ajax({
                            type: 'GET',
                            url: "{php echo $this->createMobileUrl('store.user_account', array('act' => 'getJsonList'));}",
                            data:{
                                "page":page,
                                "pageSize":pageSize,
                                "delCount":window.delCount,
                                "key":window.searchKey,
                            },
                            dataType: 'json',
                            success: function(data){
                                var arrLen = data.rows.length;
                                if(arrLen > 0){
                                    var html = template("listtpl", data);
                                    // 如果没有数据
                                }else{
                                    // 锁定
                                    me.lock();
                                    // 无数据
                                    me.noData();
                                }

                                // 插入数据到页面，放到最后面
                                $('#LoadLists').append(html);
                                // 每次数据插入，必须重置
                                me.resetload()
                            },
                            error: function(xhr, type){
                                layer.open({
                                    content: '系统错误，稍后重试！'
                                    ,skin: 'msg'
                                    ,time: 2 //2秒后自动关闭
                                });
                                // 即使加载出错，也得重置
                                me.resetload();
                            }
                        });
                    },
                    threshold : 50
                });
            }

        }).trigger("click");

        //创建切换
        $(document).on("click", "#tabs-nav-code", function(){
            $("#tabs-nav-code").attr('class','active') ;
            $("#tabs-content-code").show();
            $("#tabs-nav-user").removeClass('active') ;
            $("#tabs-content-user").hide();
        });
        //创建切换
        $(document).on("click", "#tabs-nav-user", function(){
            $(document).scrollTop($(document).height());
            $("#tabs-nav-user").attr('class','active') ;
            $("#tabs-content-user").show();
            $("#tabs-nav-code").removeClass('active') ;
            $("#tabs-content-code").hide();
            $('#btnSearch').click();
        });

        //手动创建
        $(document).on('click','.adduser',function(){
            var addbtn = $(this);
            var userid = addbtn.attr("data-userid");
            addbtn.attr('disabled',true);
            $.ajax({
                type: "post",
                dataType: "json",
                url: "{php echo $this->createMobileUrl('store.invite_promoter', array('act' => 'addUser'));}",
                data: {"id": userid},
                success: function (data, status) {
                    addbtn.attr('disabled',false);
                    if (data.status == 1) {
                        layer.open({
                            content: data.msg
                            ,skin: 'msg'
                            ,time: 2 //2秒后自动关闭
                        });
                    }
                    else {
                        layer.open({
                            content: data.msg
                            ,skin: 'msg'
                            ,time: 2 //2秒后自动关闭
                        });
                    }
                }
            });
        });
    });

    var btnadd = document.getElementById('btnAddCopy');
    var clipboardadd = new Clipboard(btnadd);
    clipboardadd.on('success', function (e) {
        layer.open({ content: '内容已复制', skin: 'msg', time: 2 });
    });
    clipboardadd.on('error', function (e) {
        layer.open({ content: '对不起，浏览器不支持，请手动复制内容！', skin: 'msg', time: 2 });
    });

    var btnadmin = document.getElementById('btnAdminCopy');
    var clipboardadmin = new Clipboard(btnadmin);
    clipboardadmin.on('success', function (e) {
        layer.open({ content: '内容已复制', skin: 'msg', time: 2 });
    });
    clipboardadmin.on('error', function (e) {
        layer.open({ content: '对不起，浏览器不支持，请手动复制内容！', skin: 'msg', time: 2 });
    });

    //解决滚动弹窗滚动穿透
    // scroll.afterOpen 锁定
    // scroll.beforeClose 解锁
    var scroll = (function (className) {
        var scrollTop;
        return {
            afterOpen: function () {
                if(document.scrollingElement){
                    scrollTop = document.scrollingElement.scrollTop
                }
                else{
                    scrollTop = document.body.scrollTop;
                }
                document.body.classList.add(className);
                document.body.style.top = -scrollTop + 'px';
            },
            beforeClose: function () {
                document.body.classList.remove(className);
                if(document.scrollingElement){
                    document.scrollingElement.scrollTop = scrollTop;
                }
                document.body.scrollTop = scrollTop;
            }
        };
    })('scroll');
</script>
</body>
</html>