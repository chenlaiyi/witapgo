<!doctype html>
<html>
{template 'store/common/header'}
<link rel="stylesheet" href="{__PLUGIN__}/validform/5.3.2/Validform.css">
<body class="bgf2">
<!--中心区域-->
<section class="pd24">
    <section class="cash">
        <section class="rel cash_pd">
            <a href="{php echo $this->createMobileUrl('store.store_bill');}" class="exchange_record">资金明细</a>
            <h4 class="fn">当前金额</h4>
            <h2 class="">{$store['money']}</h2>
        </section>
    </section>
</section>
<form action="{php echo $this->createMobileUrl('store.store_recharge',array('act'=>'addOrder'));}" id="store_recharge" method="post">
<section class="cash_bg">
    <p class="font30">充值金额</p>
    <section class="cash_money"><span>¥</span><input class="regInput" type="number" name="money" id="money" min="0.00" step="0.01" datatype="*" nullmsg="请输入充值金额！"  onkeyup="if(isNaN(this.value)){this.value='0.00';}else{this.value}" onblur="this.value=FloatMoney(this.value)"></section>
    <section class="rel d_ib" style=" line-height:0.48rem; vertical-align:middle;font-size: 0.32rem;color: #888;">
        由于充值平台限制，在线充值将收取<span class="main_red">{$config['recharge_rate']}%</span>的充值费率 </section>
</section>
<ul class="cash_list clearfix">
    <li><span>￥</span><strong>20</strong></li>
    <li><span>￥</span><strong>30</strong></li>
    <li><span>￥</span><strong>50</strong></li>
    <li><span>￥</span><strong>80</strong></li>
    <li><span>￥</span><strong>100</strong></li>
    <li><span>￥</span><strong>500</strong></li>
</ul>
<section class="cash_bg">
    <p class="font30 c9">请选择支付方式</p>
    <section class="weix_pay">
        <img src="{__MOBILE_STORE_IMG__}/wx.png" width="65" height="65"  alt="微信支付"/>
        <p class="font30">微信支付</p>
        <input type="checkbox" id="wxpay" name="paytype" value="1" datatype="*" nullmsg="请选择支付方式！" checked>
        <label for="wxpay"></label>
    </section>
</section>
<section class="btn-de">
    <input name="token" value="{$_W['token']}" type="hidden" />
    <input type="hidden" name="submit" value="submit"/>
    <button type="submit" class="Button" id="SubmitBtn">提交</button>
</section>
</form>
{if !empty($config['buypushtmp_sub'])}
<div style="position: fixed;top: 120px;left: 15px;z-index:9999;">
    <wx-open-subscribe template="{$config['buypushtmp_sub']}" id="subscribe-btn">
        <template slot="style">
            <style>
                .subscribe-btn {width: 50px;height: 50px;padding: 8px;border-radius: 25px;border: 0;font-size: 12px;color: #fff;background-color: #07c160;}
            </style>
        </template>
        <template>
            <button class="subscribe-btn">充值通知</button>
        </template>
    </wx-open-subscribe>
</div>
<script>
    document.getElementById('subscribe-btn').addEventListener('success', function (e) {
        var status = JSON.parse(JSON.parse(e.detail.subscribeDetails)["{$config['buypushtmp_sub']}"])["status"];
        if(status == 'accept'){
            layer.open({content: '订阅成功，获得一次模版消息提醒！', skin: 'msg', time: 2});
        }
    });
</script>
{/if}
<script src="{__PLUGIN__}/validform/5.3.2/Validform_v5.3.2_min.js"></script>
<script>
    $(function(){
        $('.cash_list li').on('click',function(){
            var money = $(this).find('strong').html();
            $('#money').val(money);
        });

        //为formContent 添加验证事件
        $("#store_recharge").Validform({
            tiptype: function (msg, o, cssctl) {
                if (!o.obj.is("form")) {
                    if (o.type == 2) {
                        //loading带文字
                        layer.open({
                            type: 2
                            , content: '数据提交中'
                            , time: 999 //999秒后自动关闭
                        });
                    } else {
                        layer.closeAll();
                        layer.open({
                            content: msg
                            , skin: 'msg'
                            , time: 2 //2秒后自动关闭
                            , style: 'bottom:-50px;'
                        });
                    }
                }
            },
            ajaxPost: true,
            tipSweep: true,
            beforeSubmit: function (curform) {
                $("#SubmitBtn").attr("disabled", true);
            },
            callback: function (data) {
                layer.closeAll();
                if(data.status == 1){
                    /* {if empty($config['pay_domain']) } */
                    if (typeof WeixinJSBridge == "undefined"){
                        if( document.addEventListener ){
                            document.addEventListener('WeixinJSBridgeReady', jsApiCall, false);
                        }else if (document.attachEvent){
                            document.attachEvent('WeixinJSBridgeReady', jsApiCall);
                            document.attachEvent('onWeixinJSBridgeReady', jsApiCall);
                        }
                    }else{
                        jsApiCall(data);
                    }
                    /*{else}*/
                    window.location.href="{php echo $config['pay_domain'] . 'app' . substr(__MURL('store.store_recharge', array('act' => 'wxPay')), 1)}&paynumber="+data.paynumber;
                    /*{/if}*/
                }else{
                    layer.open({
                        content: data.msg
                        , skin: 'msg'
                        , time: 2 //2秒后自动关闭
                        , style: 'bottom:0;'
                    });
                    $("#SubmitBtn").attr("disabled", false);
                }
            }
        });
    });

    //调用微信JS api 支付
    function jsApiCall(data)
    {
        WeixinJSBridge.invoke(
            'getBrandWCPayRequest',
            JSON.parse(data.jsApiData),
            function(res){
                WeixinJSBridge.log(res.err_msg);
                if (res.err_msg == 'get_brand_wcpay_request:ok') {
                    //成功后跳转
                    location.href = "{php echo $this->createMobileUrl('store.store_recharge',array('act'=>'success'));}&paynumber="+data.paynumber;
                }else if(res.err_msg=='get_brand_wcpay_request:cancel'){
                    $("#SubmitBtn").attr("disabled", false);
                    layer.open({content: '取消支付', skin: 'msg', time: 2});
                }else{
                    $("#SubmitBtn").attr("disabled", false);
                    layer.open({content: res.err_desc + res.err_msg, skin: 'msg', time: 2});
                }

            }
        );
    }
    //格式化金额
    function FloatMoney(value) {
        if (value == "")
        {
            return "";
        }
        var value = Math.round(parseFloat(value) * 100) / 100;
        var xsd = value.toString().split(".");
        if (xsd.length == 1) {
            value = value.toString() + ".00";
            return value;
        }
        if (xsd.length > 1) {
            if (xsd[1].length == 1) {
                value = value.toString() + "0";
            }
            else if (xsd[1].length < 2) {
                value = value.toString();
            }
            return value;
        }
    }
</script>
</body>
</html>
