<!DOCTYPE html>
<html lang="zh-cn">
{template 'user/common/header'}
<link rel="stylesheet" href="{__PLUGIN__}/dropload/dropload.css">
<body>
<!--选项卡-->
<section class="tabContainer">
    <ul id="tabHd" class="tabHd">
        <li {if $status==0}class="active"{/if} data-status="0"><span>全部</span></li>
        {loop $orderObjAppStatus $index $value}
        <li {if $status==$index}class="active"{/if} data-status="{$index}"><span>{$value}</span></li>
        {/loop}
    </ul>
    <section class="tabCon" id="ContentList">
        <section class="tabCon_item" id="LoadLists">

        </section>
    </section>
</section>
<script src="{__PLUGIN__}/dropload/dropload.js"></script>
<script src="{__PLUGIN__}/artTemplate/template-native-debug.js"></script>
<script id="listtpl" type="text/html">
    <% for(var i = 0; i < rows.length; i++){ %>
    <section class="order_item">
        <section class="order_num clearfix">
            <span class="font28 c9">订单号：<%= rows[i].ordernumber%></span>
            <span class="fr main_red font28"><%= rows[i].status_name%></span>
        </section>
        <section class="order_goods">
            <img src="<%= rows[i].product_thumb%>"/>
            <h3><%= rows[i].product_title%></h3>
            <p class="font26 c9">
                下单时间：<%= rows[i].createtime%>
            </p>
        </section>
        <section class="order_operate">
            <a href="{php echo $this->createMobileUrl('user.order_obj',array('act'=>'detail','store_id'=>$store_id))}&ordernumber=<%=rows[i].ordernumber%>">查看订单</a>
            <%if(rows[i].status==2){%>
            <a href="javascript:confirmOrder('<%=rows[i].ordernumber%>');">确认收货</a>
            <%}%>
        </section>
    </section>
    <% } %>
</script>
<script>
    $(function () {
        var page = 0;
        var pageSize = 10;
        var dropload_me;
        var is_first = true;

        //点击选项卡
        $('#tabHd li').click(function() {
            //选中当前点击项
            $('#tabHd li').removeClass('active');
            $(this).addClass('active');

            //筛选参数
            window.searchStatus = $('#tabHd li.active').attr('data-status');

            //重新从第一页加载
            if(dropload_me){
                $('#LoadLists').empty();
                page = 0;
                dropload_me.unlock();
                dropload_me.noData(false);
                dropload_me.resetload();
            }

            if(is_first){
                is_first = false;
                $('#ContentList').dropload({
                    scrollArea : window,
                    domUp : {
                        domClass   : 'dropload-up',
                        domRefresh : '<div class="dropload-refresh">↓下拉刷新</div>',
                        domUpdate  : '<div class="dropload-update">↑释放更新</div>',
                        domLoad    : '<div class="dropload-load"><span class="loading"></span>数据加载中...</div>'
                    },
                    domDown : {
                        domClass   : 'dropload-down',
                        domRefresh : '<div class="dropload-refresh">↑上拉加载更多</div>',
                        domLoad    : '<div class="dropload-load"><span class="loading"></span>数据加载中...</div>',
                        domNoData  : '<div class="dropload-noData">暂无更多数据</div>'
                    },
                    loadUpFn : function(me){
                        $.ajax({
                            type: 'GET',
                            url: "{php echo $this->createMobileUrl('user.order_obj', array('act' => 'getJsonList','store_id' => $store_id));}",
                            data:{
                                "page":1,
                                "pageSize":pageSize,
                                "status":window.searchStatus,
                            },
                            dataType: 'json',
                            success: function(data){
                                var html = template("listtpl", data);
                                $('#LoadLists').html(html);
                                // 每次数据加载完，必须重置
                                me.resetload();
                                // 重置页数，重新获取loadDownFn的数据
                                page = 1;
                                // 解锁loadDownFn里锁定的情况
                                me.unlock();
                                me.noData(false);
                            },
                            error: function(xhr, type){
                                layer.open({
                                    content: '系统错误，稍后重试！'
                                    ,skin: 'msg'
                                    ,time: 2 //2秒后自动关闭
                                });
                                // 即使加载出错，也得重置
                                me.resetload();
                            }
                        });
                    },
                    loadDownFn : function(me){
                        dropload_me = me;
                        page++;
                        // 拼接HTML
                        var result = '';
                        $.ajax({
                            type: 'GET',
                            url: "{php echo $this->createMobileUrl('user.order_obj', array('act' => 'getJsonList','store_id' => $store_id));}",
                            data:{
                                "page":page,
                                "pageSize":pageSize,
                                "status":window.searchStatus,
                            },
                            dataType: 'json',
                            success: function(data){
                                var arrLen = data.rows.length;
                                if(arrLen > 0){
                                    var html = template("listtpl", data);
                                    // 如果没有数据
                                }else{
                                    // 锁定
                                    me.lock();
                                    // 无数据
                                    me.noData();
                                }

                                // 插入数据到页面，放到最后面
                                $('#LoadLists').append(html);
                                // 每次数据插入，必须重置
                                me.resetload()
                            },
                            error: function(xhr, type){
                                layer.open({
                                    content: '系统错误，稍后重试！'
                                    ,skin: 'msg'
                                    ,time: 2 //2秒后自动关闭
                                });
                                // 即使加载出错，也得重置
                                me.resetload();
                            }
                        });
                    },
                    threshold : 50
                });
            }
        });
        $('#tabHd li').eq(0).trigger("click");
    });

    function confirmOrder(ordernumber) {
        layer.open({
            content:'是否确认收货？',
            btn:['确定','取消'],
            yes:function (index, layero) {
                $.ajax({
                    url: "{php echo $this->createMobileUrl('user.order_obj',array('act'=>'confirmOrder','store_id'=>$store_id))}",
                    type: "post",
                    dataType: "json",
                    data: {ordernumber:ordernumber},
                    success: function (result) {
                        if (result.status === 1) {
                            layer.open({ content: result.msg, skin: 'msg', time: 2 });
                            window.location.reload();
                            return true;
                        } else {
                            layer.open({ content: result.msg, skin: 'msg', time: 2 });
                            return false;
                        }
                    }
                });
            }
        })
    }
</script>
</body>
</html>