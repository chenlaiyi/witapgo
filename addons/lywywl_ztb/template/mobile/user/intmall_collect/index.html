<!doctype html>
<html>
{template 'user/common/header'}
<link rel="stylesheet" href="{__PLUGIN__}/dropload/dropload.css">
<body class="bg_fff">
<!--收藏-->
<div class="swiper-slide" >
    <section id="ContentList">
        <ul class="swipe-delete2 collection" id="LoadLists">

        </ul>
    </section>
</div>
<script src="{__PLUGIN__}/dropload/dropload.js"></script>
<script src="{__PLUGIN__}/artTemplate/template-native-debug.js"></script>
<script id="listtpl" type="text/html">
    <% for(var i = 0; i < rows.length; i++){ %>
    <li data-id="<%= rows[i].id %>">
        <div class="behind2"> <i class="ui-btn delete-btn">删除</i> </div>
        <section class="scroll-delete2">
            <a href="{php echo $this->createMobileUrl('user.intmall_product',array('act'=>'detail'))}&id=<%= rows[i].product_id %>&store_id=<%= rows[i].store_id %>" >
            <section class="order_goods"> <img src="<%= rows[i].product_thumb_url %>" alt="<%= rows[i].product_title %>">
                <h3><%= rows[i].product_title %></h3>
                <p class="font20 c9">
                    <span class="font32 main_red price"><%= rows[i].product_score %></span>积分
                    <%if(rows[i].product_paymoney>0){%>
                    <span class="font32 black plus">+</span>
                    <span class="font32 main_red price"><%= rows[i].product_paymoney %></span>元</p>
                    <%}%>
            </section>
            </a>
        </section>
    </li>
    <% } %>
</script>
<script type="text/javascript">
    $(function() {
        var page = 0;
        var pageSize = 10;

        window.delCount = 0;

        $('#ContentList').dropload({
            scrollArea : window,
            domUp : {
                domClass   : 'dropload-up',
                domRefresh : '<div class="dropload-refresh">↓下拉刷新</div>',
                domUpdate  : '<div class="dropload-update">↑释放更新</div>',
                domLoad    : '<div class="dropload-load"><span class="loading"></span>数据加载中...</div>'
            },
            domDown : {
                domClass   : 'dropload-down',
                domRefresh : '<div class="dropload-refresh">↑上拉加载更多</div>',
                domLoad    : '<div class="dropload-load"><span class="loading"></span>数据加载中...</div>',
                domNoData  : '<div class="dropload-noData">暂无更多数据</div>'
            },
            loadUpFn : function(me){
                $.ajax({
                    type: 'GET',
                    url: "{php echo $this->createMobileUrl('user.intmall_collect', array('act' => 'getJsonList','store_id' => $store_id));}",
                    data:{
                        "page":1,
                        "pageSize":pageSize,
                        "delCount":window.delCount
                    },
                    dataType: 'json',
                    success: function(data){
                        var html = template("listtpl", data);
                        $('#LoadLists').html(html);
                        // 每次数据加载完，必须重置
                        me.resetload();
                        // 重置页数，重新获取loadDownFn的数据
                        page = 1;
                        delCount = 0;
                        // 解锁loadDownFn里锁定的情况
                        me.unlock();
                        me.noData(false);
                    },
                    error: function(xhr, type){
                        layer.open({
                            content: '系统错误，稍后重试！'
                            ,skin: 'msg'
                            ,time: 2 //2秒后自动关闭
                        });
                        // 即使加载出错，也得重置
                        me.resetload();
                    }
                });
            },
            loadDownFn : function(me){
                page++;
                // 拼接HTML
                var result = '';
                $.ajax({
                    type: 'GET',
                    url: "{php echo $this->createMobileUrl('user.intmall_collect', array('act' => 'getJsonList','store_id' => $store_id));}",
                    data:{
                        "page":page,
                        "pageSize":pageSize,
                        "delCount":window.delCount
                    },
                    dataType: 'json',
                    success: function(data){
                        var arrLen = data.rows.length;
                        if(arrLen > 0){
                            var html = template("listtpl", data);
                            // 如果没有数据
                        }else{
                            // 锁定
                            me.lock();
                            // 无数据
                            me.noData();
                        }

                        // 插入数据到页面，放到最后面
                        $('#LoadLists').append(html);
                        // 每次数据插入，必须重置
                        me.resetload()
                    },
                    error: function(xhr, type){
                        layer.open({
                            content: '系统错误，稍后重试！'
                            ,skin: 'msg'
                            ,time: 2 //2秒后自动关闭
                        });
                        // 即使加载出错，也得重置
                        me.resetload();
                    }
                });
            },
            threshold : 50
        });

        function prevent_default(e) {
            e.preventDefault();
        }

        function disable_scroll() {
            $(document).on('touchmove', prevent_default);
        }

        function enable_scroll() {
            $(document).unbind('touchmove', prevent_default)
        }

        var x;
        $(document).on("touchstart", ".swipe-delete2 li > .scroll-delete2", function(e) {
            console.log(e.originalEvent.pageX);$('.swipe-delete2 li > .scroll-delete2').css('left', '0px'); // close em all
            $(e.currentTarget).addClass('open');x = e.originalEvent.targetTouches[0].pageX; // anchor point
        });
        $(document).on("touchmove", ".swipe-delete2 li > .scroll-delete2", function(e) {
            var change = e.originalEvent.targetTouches[0].pageX - x;change = Math.min(Math.max( - 70, change), 0); // restrict to -100px left, 0px right
            e.currentTarget.style.left = change + 'px';
            if (change < -10) disable_scroll(); // disable scroll once we hit 10px horizontal slide
        });
        $(document).on("touchend", ".swipe-delete2 li > .scroll-delete2", function(e) {
            var left = parseInt(e.currentTarget.style.left);
            var new_left;
            if (left < -35) {
                new_left = '-70px'
            } else if (left > 35) {
                new_left = '70px'
            } else {
                new_left = '0px'
            }
            // e.currentTarget.style.left = new_left
            $(e.currentTarget).animate({
                        left: new_left
                    },
                    200);
            enable_scroll()
        });
        $(document).on("touchend", "li .delete-btn", function(e) {
            var collectid = $(this).parents('li').data("id");
            var item =  $(this);
            e.preventDefault();
            item.parents('li').slideUp('fast',
                    function() {
                        $(this).remove();
                        $.ajax({
                            type: "post",
                            dataType: "json",
                            url: "{php echo $this->createMobileUrl('user.intmall_collect', array('act' => 'del','store_id' => $store_id));}",
                            data: {
                                id: collectid
                            },
                            success: function (data, status) {
                                if (data.status == 1) {
                                    window.delCount = window.delCount + 1;
                                    layer.open({
                                        content: jsonData.msg
                                        ,skin: 'msg'
                                        ,time: 2 //2秒后自动关闭
                                    });
                                }
                                else {
                                    layer.open({
                                        content: jsonData.msg
                                        ,skin: 'msg'
                                        ,time: 2 //2秒后自动关闭
                                    });
                                }
                            }
                        });
                        layer.close(index);
                    });
        });


    });
</script>
</body>
</html>
