<!doctype html>
<html>
{template 'user/common/header'}
<link rel="stylesheet" href="{__PLUGIN__}/dropload/dropload.css">
<body>
<!--积分-->
<section class="integral_bg">
    <a href="{php echo $this->createMobileUrl('user.order_intmall',array('act'=>'index','store_id'=>$store_id))}" class="cash_record">兑换记录</a>
    <section class="current_score tc font32">当前积分 <span id="ScoreVal">{$userModel['score']}</span></section>
    <section class="go_exchange tc"><a href="{php echo $this->createMobileUrl('user.intmall_home',array('act'=>'index','store_id'=>$store_id))}"><i></i>去兑换</a></section>
</section>
<section class="bg_fff">
    <h2 class="integral_title tc font30 fn">积分收支明细</h2>
    <section id="ContentList">
    <ul class="integral_list"  id="LoadLists">

    </ul>
    </section>
</section>
<script src="{__PLUGIN__}/dropload/dropload.js"></script>
<script src="{__PLUGIN__}/artTemplate/template-native-debug.js"></script>
<script id="listtpl" type="text/html">
    <% for(var i = 0; i < rows.length; i++){ %>
    <li data-id="<%= rows[i].id %>">
        <%if(rows[i].types==1 || rows[i].types==3){%>
        <section class="fr fen main_green">+<%= rows[i].score %></section>
        <%}else{%>
        <section class="fr fen main_red">-<%= rows[i].score %></section>
        <%}%>
        <section>
            <h4 class="fn"><%= rows[i].types_name %>：<%= rows[i].note %></h4>
            <time class="font28 c9 db"><%= rows[i].createtime %></time>
        </section>
    </li>
    <% } %>
</script>
<script type="text/javascript">
    $(function() {
        var page = 0;
        var pageSize = 10;

        $('#ContentList').dropload({
            scrollArea : window,
            domUp : {
                domClass   : 'dropload-up',
                domRefresh : '<div class="dropload-refresh">↓下拉刷新</div>',
                domUpdate  : '<div class="dropload-update">↑释放更新</div>',
                domLoad    : '<div class="dropload-load"><span class="loading"></span>数据加载中...</div>'
            },
            domDown : {
                domClass   : 'dropload-down',
                domRefresh : '<div class="dropload-refresh">↑上拉加载更多</div>',
                domLoad    : '<div class="dropload-load"><span class="loading"></span>数据加载中...</div>',
                domNoData  : '<div class="dropload-noData">暂无更多数据</div>'
            },
            loadUpFn : function(me){
                $.ajax({
                    type: 'GET',
                    url: "{php echo $this->createMobileUrl('user.user_score', array('act' => 'getJsonList','store_id' => $store_id));}",
                    data:{
                        "page":1,
                        "pageSize":pageSize
                    },
                    dataType: 'json',
                    success: function(data){
                        var html = template("listtpl", data);
                        $("#ScoreVal").html(data.score);
                        $('#LoadLists').html(html);
                        // 每次数据加载完，必须重置
                        me.resetload();
                        // 重置页数，重新获取loadDownFn的数据
                        page = 1;
                        // 解锁loadDownFn里锁定的情况
                        me.unlock();
                        me.noData(false);
                    },
                    error: function(xhr, type){
                        layer.open({
                            content: '系统错误，稍后重试！'
                            ,skin: 'msg'
                            ,time: 2 //2秒后自动关闭
                        });
                        // 即使加载出错，也得重置
                        me.resetload();
                    }
                });
            },
            loadDownFn : function(me){
                page++;
                // 拼接HTML
                var result = '';
                $.ajax({
                    type: 'GET',
                    url: "{php echo $this->createMobileUrl('user.user_score', array('act' => 'getJsonList','store_id' => $store_id));}",
                    data:{
                        "page":page,
                        "pageSize":pageSize
                    },
                    dataType: 'json',
                    success: function(data){
                        var arrLen = data.rows.length;
                        if(arrLen > 0){
                            var html = template("listtpl", data);
                            // 如果没有数据
                        }else{
                            // 锁定
                            me.lock();
                            // 无数据
                            me.noData();
                        }

                        // 插入数据到页面，放到最后面
                        $('#LoadLists').append(html);
                        // 每次数据插入，必须重置
                        me.resetload()
                    },
                    error: function(xhr, type){
                        layer.open({
                            content: '系统错误，稍后重试！'
                            ,skin: 'msg'
                            ,time: 2 //2秒后自动关闭
                        });
                        // 即使加载出错，也得重置
                        me.resetload();
                    }
                });
            },
            threshold : 50
        });
    });
</script>
</body>
</html>
