<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <title>{php echo $config['name']} - 商户管理中心</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-title" content="{php echo $config['name']} - 商户管理中心">
    <link rel="shortcut icon" href="{if !empty($config['ico'])}{php echo tomedia($config['ico'])}{else}{$_W['siteroot']}addons/lywywl_ztb/resource/web/images/favicon.ico{/if}" />
    <!-- 告诉浏览器响应屏幕宽度 -->
    <meta content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" name="viewport">
    <link href="{__PLUGIN__}/bootstrap/bootstrap.min.css?v=3.3.6" rel="stylesheet">
    <link href="{__PLUGIN__}/font-awesome/font-awesome.min.css?v=4.4.0" rel="stylesheet">
    <link href="{__WEBAPP_CSS__}/zhutuike.css?v=1.0.1" rel="stylesheet">
    <link href="{__WEBAPP_CSS__}/skinblue.css?v=1.0.0" rel="stylesheet">
    <link rel="stylesheet" href="{__PLUGIN__}/iCheck/all.css">
    <link rel="stylesheet" href="{__PLUGIN__}/validform/5.3.2/Validform.css">
    <!--[if lt IE 9]>
    <script src="{__PLUGIN__}/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="{__PLUGIN__}/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
    <script type="text/javascript" src="{__WEBAPP_JS__}/jQuery-2.1.4.min.js"></script>
    <script type="text/javascript" src="{__PLUGIN__}/bootstrap/bootstrap.min.js"></script>
    <script src="{__PLUGIN__}/iCheck/icheck.min.js"></script>
    <script src="{__PLUGIN__}/validform/5.3.2/Validform_v5.3.2.js"></script>
    <script src="{__PLUGIN__}/layer/mobile/2.0/layer.js"></script>
    <script type="text/javascript" src="{MODULE_URL}resource/webapp/plugin/js/require.js"></script>
    <script type="text/javascript" src="{__WEBAPP_JS__}/myconfig.js"></script>
    <style>
        blockquote, body, button, caption, dd, div, dl, dt, fieldset, figure, form, h1, h2, h3, h4, h5, h6, hr, html, input, legend, li, menu, ol, p, pre, table, td, textarea, th, ul { margin: 0; padding: 0 }
        address, article, aside, details, figcaption, figure, footer, header, hgroup, menu, nav, section { display: block }
        li { list-style: none;}
        .main-im {  position: fixed;  right: 1px;  top: 350px;  z-index: 100;  width: 60px;  }
    </style>
</head>
<body class="hold-transition login-page">
<div id="bg">
    <div class="wrapper">
        <div class="login-box" style="width: 460px">
            <div class="login-logo">
                <img src="{if !empty($config['logo_big'])}{php echo tomedia($config['logo_big'])}{else}{$_W['siteroot']}addons/lywywl_ztb/resource/web/images/logo.png{/if}" width="200" height="50">
            </div>
            <div class="login-box-body">
                <p class="login-box-msg" id="show_validate_error">{$config['name']} V1.2.9 正式版 </p>
                <form action="{php echo $this->createWebAppUrl('resetpsd',array('act'=>'resetpsd'));}" id="admin_register" method="post">
                    <div class="form-group">
                        <input type="text" class="form-control" placeholder="手机号" name="model[mobile]" id="mobile" maxlength="11" datatype="m" nullmsg="请输入手机号码！" errormsg="请输入正确的手机号码！">
                    </div>
                    <div class="form-group has-feedback">
                        <input type="password" class="form-control" placeholder="新密码" name="model[password]" maxlength="16" datatype="*6-16" nullmsg="请输入登录密码！" errormsg="密码范围在6~16位之间！">
                    </div>
                    <div class="form-group has-feedback">
                        <input type="password" class="form-control" placeholder="请再次输入密码" name="model[password2]" maxlength="16" datatype="*" recheck="model[password]" nullmsg="请再输入一次密码！" errormsg="您两次输入的密码不一致！">
                    </div>
                    <div class="form-group">
                        <div class="input-group input-group-sm">
                            <input type="text" class="form-control" placeholder="请输入手机验证码" name="verifyCode" maxlength="6" datatype="n" nullmsg="请输入手机验证码！">
                            <span class="input-group-btn">
                      <button class="btn btn-info btn-flat" type="button" id="btnSendSmsCode">获取验证码</button>
                    </span>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-xs-6">
                            <input name="token" value="{$_W['token']}" type="hidden" />
                            <input type="hidden" name="submit" value="submit"/>
                            <button type="submit" class="btn btn-primary btn-block btn-flat"> 确认修改 </button>
                        </div>
                        <div class="col-xs-6">
                            <a class="btn btn-default btn-block btn-flat" href="{php echo $this->createWebAppUrl('login')}"> 返回登录 </a>
                        </div>
                    </div>
                    <div class="social-auth-links text-center">
                        <!--<p>- 忘记密码 -</p>-->
                        <a href="http://wpa.qq.com/msgrd?v=3&uin={$config['qq']}&site={$config['name']}&menu=yes" target="_blank" class="btn btn-block btn-social btn-primary btn-flat"><i class="fa fa-qq"></i><b>点击激活腾讯QQ 或 拨打电话 {$config['tel']}</b></a>
                    </div>
                    <!-- /.social-auth-links -->
                    <p class="text-sm text-center">技术支持：{$config['power']}</p>
                </form>
            </div>
        </div>
    </div>
    <footer class="login-main-footer text-center text-sm navbar-fixed-bottom">
        <p id="footerp">为了您在使用管理平台时获得最佳体验，请升级使用 IE8+ 或下载使用Chrome/Firefox浏览器。</p>
        <p>Powered by <b>{php echo $config['name']}</b> V1.2.5  © 2014-{php echo date('Y')} {if !empty($_W['setting']['copyright']['icp'])}备案号：<a href="http://www.miitbeian.gov.cn" target="_blank">{$_W['setting']['copyright']['icp']}</a>{/if}</p>
    </footer>
    <canvas></canvas>
    <canvas></canvas>
    <canvas></canvas>
</div>
<!-- 帮助中心 -->
{php include $this->template('common/service')}

<script>
    $(function () {
        //为formContent 添加验证事件
        $("#admin_register").Validform({
            tiptype: function (msg, o, cssctl) {
                var objtip = $("#show_validate_error");
                cssctl(objtip, o.type);
                objtip.text(msg);
            },
            ajaxPost: true,
            callback: function (data) {
                console.log(data);
                if (data.status == 0) {
                    $("#show_validate_error").removeClass("Validform_right");
                    $("#show_validate_error").addClass("Validform_checktip Validform_wrong");
                    $("#show_validate_error").text(data.msg);
                    return;
                }
                else {
                    $("#show_validate_error").removeClass("Validform_wrong");
                    $("#show_validate_error").addClass("Validform_checktip Validform_right");
                    $("#show_validate_error").text(data.msg);
                    if (data.url.length > 0) {
                        setTimeout(function () {
                            window.location.href = data.url;
                        }, 2000);
                    } else {
                        setTimeout(function () {
                            window.location.href = window.location.href;
                        }, 2000);
                    }
                }
            }
        });

        $("#btnSendSmsCode").click(function () {
            var mobile = $("#mobile");
            if (mobile.val() == "") {
                $("#show_validate_error").removeClass("Validform_right");
                $("#show_validate_error").addClass("Validform_checktip Validform_wrong");
                $("#show_validate_error").text("请输入手机号码!");
                mobile.focus();
                return;
            }
            if (!checkMobile(mobile.val())) {
                $("#show_validate_error").removeClass("Validform_right");
                $("#show_validate_error").addClass("Validform_checktip Validform_wrong");
                $("#show_validate_error").text("手机号码输入有误,请重新输入!");
                mobile.focus();
                return;
            }
            else {
                $(this).attr("disabled", true);
                var n = $(this).attr("time");
                if (n == null || parseInt(n) <= 0) {
                    $.ajax({
                        url: "{php echo $this->createWebAppUrl('resetpsd',array('act'=>'sendSmsCode'));}",
                        type: "post",
                        dataType: "json",
                        data: { "mobile": $("#mobile").val() },
                        success: function (result) {

                            if (result.status == 0) {
                                console.log(result);
                                $("#show_validate_error").removeClass("Validform_right");
                                $("#show_validate_error").addClass("Validform_checktip Validform_wrong");
                                $("#show_validate_error").text(result.msg);
                                $("#btnSendSmsCode").removeAttr("disabled");
                            } else {
                                $("#show_validate_error").removeClass("Validform_wrong");
                                $("#show_validate_error").addClass("Validform_checktip Validform_right");
                                $("#show_validate_error").text(result.msg);
                                SetTime(120);
                            }
                        }
                    });
                }
            }
        });


    });

    //短信发送计时
    function SetTime(n) {
        n--;
        var a = $("#btnSendSmsCode");
        if (n < 0) {
            $("#btnSendSmsCode").html("获取验证码");
            $("#btnSendSmsCode").removeAttr("disabled");
        } else {
            $("#btnSendSmsCode").attr("time", n).html(n + "秒重新获取");
            setTimeout("SetTime(" + n + ")", 1000);
        }
    };


    //验证手机号码
    function checkMobile(strMobile) {
        var myreg = /^[1][3,4,5,6,7,8,9][0-9]{9}$/;
        if (!myreg.test(strMobile)) {
            return false;
        } else {
            return true;
        }
    };

    //判断客户端浏览器类型 手机端隐藏底部提示
    var browser = {
        versions: function () {
            var u = navigator.userAgent, app = navigator.appVersion;
            return {//移动终端浏览器版本信息
                trident: u.indexOf('Trident') > -1, //IE内核
                presto: u.indexOf('Presto') > -1, //opera内核
                webKit: u.indexOf('AppleWebKit') > -1, //苹果、谷歌内核
                gecko: u.indexOf('Gecko') > -1 && u.indexOf('KHTML') == -1, //火狐内核
                mobile: !!u.match(/AppleWebKit.*Mobile.*/), //是否为移动终端
                ios: !!u.match(/\(i[^;]+;( U;)? CPU.+Mac OS X/), //ios终端
                android: u.indexOf('Android') > -1 || u.indexOf('Linux') > -1, //android终端或者uc浏览器
                iPhone: u.indexOf('iPhone') > -1 || u.indexOf('Mac') > -1, //是否为iPhone或者QQHD浏览器
                iPad: u.indexOf('iPad') > -1, //是否iPad
                webApp: u.indexOf('Safari') == -1 //是否web应该程序，没有头部与底部
            };
        }(),
        language: (navigator.browserLanguage || navigator.language).toLowerCase()
    };
    if (browser.versions.mobile == true || browser.versions.ios == true || browser.versions.android == true) {
        $("#footerp").hide();//隐藏
    }

    //背景特效
    (function ($) {
        var canvas = $('#bg').children('canvas'),
                background = canvas[0],
                foreground1 = canvas[1],
                foreground2 = canvas[2],
                config = {
                    circle: {
                        amount: 18,
                        layer: 3,
                        color: [97, 207, 198],
                        alpha: 0.3
                    },
                    line: {
                        amount: 12,
                        layer: 3,
                        color: [255, 255, 255],
                        alpha: 0.3
                    },
                    speed: 0.5,
                    angle: 20
                };

        if (background.getContext) {
            var bctx = background.getContext('2d'),
                    fctx1 = foreground1.getContext('2d'),
                    fctx2 = foreground2.getContext('2d'),
                    M = window.Math, // Cached Math
                    degree = config.angle / 360 * M.PI * 2,
                    circles = [],
                    lines = [],
                    wWidth, wHeight, timer;

            requestAnimationFrame = window.requestAnimationFrame ||
                    window.mozRequestAnimationFrame ||
                    window.webkitRequestAnimationFrame ||
                    window.msRequestAnimationFrame ||
                    window.oRequestAnimationFrame ||
                    function (callback, element) { setTimeout(callback, 1000 / 60); };

            cancelAnimationFrame = window.cancelAnimationFrame ||
                    window.mozCancelAnimationFrame ||
                    window.webkitCancelAnimationFrame ||
                    window.msCancelAnimationFrame ||
                    window.oCancelAnimationFrame ||
                    clearTimeout;

            var setCanvasHeight = function () {
                wWidth = $(window).width();
                wHeight = $(window).height(),

                        canvas.each(function () {
                            this.width = wWidth;
                            this.height = wHeight;
                        });
            };

            var drawCircle = function (x, y, radius, color, alpha) {
                var gradient = fctx1.createRadialGradient(x, y, radius, x, y, 0);
                gradient.addColorStop(0, 'rgba(' + color[0] + ',' + color[1] + ',' + color[2] + ',' + alpha + ')');
                gradient.addColorStop(1, 'rgba(' + color[0] + ',' + color[1] + ',' + color[2] + ',' + (alpha - 0.1) + ')');

                fctx1.beginPath();
                fctx1.arc(x, y, radius, 0, M.PI * 2, true);
                fctx1.fillStyle = gradient;
                fctx1.fill();
            };

            var drawLine = function (x, y, width, color, alpha) {
                var endX = x + M.sin(degree) * width,
                        endY = y - M.cos(degree) * width,
                        gradient = fctx2.createLinearGradient(x, y, endX, endY);
                gradient.addColorStop(0, 'rgba(' + color[0] + ',' + color[1] + ',' + color[2] + ',' + alpha + ')');
                gradient.addColorStop(1, 'rgba(' + color[0] + ',' + color[1] + ',' + color[2] + ',' + (alpha - 0.1) + ')');

                fctx2.beginPath();
                fctx2.moveTo(x, y);
                fctx2.lineTo(endX, endY);
                fctx2.lineWidth = 3;
                fctx2.lineCap = 'round';
                fctx2.strokeStyle = gradient;
                fctx2.stroke();
            };

            var drawBack = function () {
                bctx.clearRect(0, 0, wWidth, wHeight);

                var gradient = [];

                gradient[0] = bctx.createRadialGradient(wWidth * 0.3, wHeight * 0.1, 0, wWidth * 0.3, wHeight * 0.1, wWidth * 0.9);
                gradient[0].addColorStop(0, 'rgb(7, 110, 163)');
                gradient[0].addColorStop(1, 'transparent');

                bctx.translate(wWidth, 0);
                bctx.scale(-1, 1);
                bctx.beginPath();
                bctx.fillStyle = gradient[0];
                bctx.fillRect(0, 0, wWidth, wHeight);

                gradient[1] = bctx.createRadialGradient(wWidth * 0.1, wHeight * 0.1, 0, wWidth * 0.3, wHeight * 0.1, wWidth);
                gradient[1].addColorStop(0, 'rgb(0, 150, 240)');
                gradient[1].addColorStop(0.8, 'transparent');

                bctx.translate(wWidth, 0);
                bctx.scale(-1, 1);
                bctx.beginPath();
                bctx.fillStyle = gradient[1];
                bctx.fillRect(0, 0, wWidth, wHeight);

                gradient[2] = bctx.createRadialGradient(wWidth * 0.1, wHeight * 0.5, 0, wWidth * 0.1, wHeight * 0.5, wWidth * 0.5);
                gradient[2].addColorStop(0, 'rgb(40, 20, 105)');
                gradient[2].addColorStop(1, 'transparent');

                bctx.beginPath();
                bctx.fillStyle = gradient[2];
                bctx.fillRect(0, 0, wWidth, wHeight);
            };

            var animate = function () {
                var sin = M.sin(degree),
                        cos = M.cos(degree);

                if (config.circle.amount > 0 && config.circle.layer > 0) {
                    fctx1.clearRect(0, 0, wWidth, wHeight);
                    for (var i = 0, len = circles.length; i < len; i++) {
                        var item = circles[i],
                                x = item.x,
                                y = item.y,
                                radius = item.radius,
                                speed = item.speed;

                        if (x > wWidth + radius) {
                            x = -radius;
                        } else if (x < -radius) {
                            x = wWidth + radius
                        } else {
                            x += sin * speed;
                        }

                        if (y > wHeight + radius) {
                            y = -radius;
                        } else if (y < -radius) {
                            y = wHeight + radius;
                        } else {
                            y -= cos * speed;
                        }

                        item.x = x;
                        item.y = y;
                        drawCircle(x, y, radius, item.color, item.alpha);
                    }
                }

                if (config.line.amount > 0 && config.line.layer > 0) {
                    fctx2.clearRect(0, 0, wWidth, wHeight);
                    for (var j = 0, len = lines.length; j < len; j++) {
                        var item = lines[j],
                                x = item.x,
                                y = item.y,
                                width = item.width,
                                speed = item.speed;

                        if (x > wWidth + width * sin) {
                            x = -width * sin;
                        } else if (x < -width * sin) {
                            x = wWidth + width * sin;
                        } else {
                            x += sin * speed;
                        }

                        if (y > wHeight + width * cos) {
                            y = -width * cos;
                        } else if (y < -width * cos) {
                            y = wHeight + width * cos;
                        } else {
                            y -= cos * speed;
                        }

                        item.x = x;
                        item.y = y;
                        drawLine(x, y, width, item.color, item.alpha);
                    }
                }

                timer = requestAnimationFrame(animate);
            };

            var createItem = function () {
                circles = [];
                lines = [];

                if (config.circle.amount > 0 && config.circle.layer > 0) {
                    for (var i = 0; i < config.circle.amount / config.circle.layer; i++) {
                        for (var j = 0; j < config.circle.layer; j++) {
                            circles.push({
                                x: M.random() * wWidth,
                                y: M.random() * wHeight,
                                radius: M.random() * (20 + j * 5) + (20 + j * 5),
                                color: config.circle.color,
                                alpha: M.random() * 0.2 + (config.circle.alpha - j * 0.1),
                                speed: config.speed * (1 + j * 0.5)
                            });
                        }
                    }
                }

                if (config.line.amount > 0 && config.line.layer > 0) {
                    for (var m = 0; m < config.line.amount / config.line.layer; m++) {
                        for (var n = 0; n < config.line.layer; n++) {
                            lines.push({
                                x: M.random() * wWidth,
                                y: M.random() * wHeight,
                                width: M.random() * (20 + n * 5) + (20 + n * 5),
                                color: config.line.color,
                                alpha: M.random() * 0.2 + (config.line.alpha - n * 0.1),
                                speed: config.speed * (1 + n * 0.5)
                            });
                        }
                    }
                }

                cancelAnimationFrame(timer);
                timer = requestAnimationFrame(animate);
                drawBack();
            };

            $(document).ready(function () {
                setCanvasHeight();
                createItem();
            });
            $(window).resize(function () {
                setCanvasHeight();
                createItem();
            });
        }
    })(jQuery);
</script>
</body>
</html>
