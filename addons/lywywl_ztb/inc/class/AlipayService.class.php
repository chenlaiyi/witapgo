<?php
 class AlipayService { protected $appId; protected $returnUrl; protected $notifyUrl; protected $charset; protected $rsaPrivateKey; protected $totalFee; protected $outTradeNo; protected $orderName; protected $alipayPublicKey; public function __construct($alipayPublicKey = '') { $this->charset = "\165\x74\146\x38"; $this->alipayPublicKey = $alipayPublicKey; } public function setAppid($appid) { $this->appId = $appid; } public function setReturnUrl($returnUrl) { $this->returnUrl = $returnUrl; } public function setNotifyUrl($notifyUrl) { $this->notifyUrl = $notifyUrl; } public function setRsaPrivateKey($saPrivateKey) { $this->rsaPrivateKey = $saPrivateKey; } public function setTotalFee($payAmount) { $this->totalFee = $payAmount; } public function setOutTradeNo($outTradeNo) { $this->outTradeNo = $outTradeNo; } public function setOrderName($orderName) { $this->orderName = $orderName; } public function doPay() { goto TzrIl; OURRz: return $this->buildRequestForm($commonConfigs); goto xPOK5; vwNXX: $commonConfigs["\x73\x69\x67\x6e"] = $this->generateSign($commonConfigs, $commonConfigs["\163\x69\147\x6e\x5f\164\171\160\x65"]); goto OURRz; ROeNG: $commonConfigs = array("\x61\x70\160\137\151\x64" => $this->appId, "\x6d\x65\164\x68\157\x64" => "\x61\x6c\x69\160\x61\x79\x2e\x74\162\x61\144\145\x2e\x70\141\147\x65\x2e\160\141\171", "\x66\x6f\162\155\141\x74" => "\x4a\123\x4f\116", "\162\x65\164\x75\162\x6e\x5f\x75\162\154" => $this->returnUrl, "\143\150\x61\x72\x73\x65\164" => $this->charset, "\163\151\x67\156\137\x74\171\160\145" => "\122\x53\x41\62", "\x74\x69\155\145\x73\x74\141\x6d\x70" => date("\131\55\x6d\55\x64\x20\110\x3a\151\72\163"), "\166\x65\162\x73\x69\x6f\156" => "\x31\x2e\60", "\156\x6f\164\151\146\171\137\x75\x72\154" => $this->notifyUrl, "\x62\x69\172\137\x63\x6f\x6e\164\x65\x6e\164" => json_encode($requestConfigs)); goto vwNXX; TzrIl: $requestConfigs = array("\157\165\164\x5f\164\x72\141\x64\x65\x5f\156\157" => $this->outTradeNo, "\160\x72\157\x64\165\x63\164\x5f\x63\x6f\x64\145" => "\x46\x41\123\x54\137\111\x4e\x53\x54\101\116\x54\137\x54\x52\x41\x44\105\x5f\x50\101\x59", "\x74\157\164\x61\154\137\x61\155\x6f\165\x6e\164" => $this->totalFee, "\163\x75\142\x6a\145\143\164" => $this->orderName); goto ROeNG; xPOK5: } protected function buildRequestForm($para_temp) { goto BX2hL; nDidG: hRXmy: goto VjDfZ; cToqI: return $sHtml; goto hbYSa; CQHBb: $val = str_replace("\x27", "\x26\x61\x70\x6f\163\x3b", $val); goto NBqWv; VjDfZ: goto MMOdL; goto b_3j4; Cq1bm: $sHtml = $sHtml . "\x3c\151\x6e\160\165\164\x20\164\x79\x70\x65\75\x27\163\x75\x62\x6d\151\x74\x27\x20\x76\141\x6c\165\145\x3d\x27\157\x6b\47\40\x73\164\171\x6c\x65\x3d\x27\144\x69\163\160\x6c\141\171\x3a\x6e\157\x6e\145\73\47\47\76\74\x2f\x66\157\x72\155\x3e"; goto eO3Nj; eO3Nj: $sHtml = $sHtml . "\74\163\143\162\x69\160\x74\x3e\144\x6f\x63\165\x6d\145\x6e\164\x2e\x66\x6f\x72\x6d\x73\133\x27\x61\x6c\x69\160\x61\x79\163\x75\142\155\151\x74\47\x5d\x2e\163\x75\142\x6d\x69\164\50\51\x3b\74\x2f\163\143\x72\151\x70\164\76"; goto cToqI; FqphM: if (!(false === $this->checkEmpty($val))) { goto hRXmy; } goto CQHBb; BX2hL: $sHtml = "\346\255\xa3\345\x9c\xa8\xe8\267\263\350\275\xac\xe8\207\263\346\x94\xaf\xe4\xbb\x98\351\241\xb5\351\x9d\242\56\x2e\x2e\74\146\157\162\x6d\40\151\144\75\47\x61\154\x69\160\x61\171\x73\x75\142\155\151\x74\47\40\156\x61\155\145\75\x27\x61\154\151\160\141\x79\163\x75\142\155\x69\x74\x27\40\141\x63\164\151\157\x6e\75\47\150\x74\x74\x70\163\72\x2f\x2f\x6f\x70\145\156\x61\x70\151\x2e\x61\154\151\160\x61\171\x2e\x63\157\155\57\147\x61\164\145\167\x61\x79\56\144\157\x3f\x63\150\141\x72\x73\x65\164\x3d" . $this->charset . "\x27\40\155\x65\x74\150\157\x64\x3d\x27\120\117\x53\124\x27\x3e"; goto cXOzk; b_3j4: fQHRv: goto Cq1bm; VZI8D: if (!(list($key, $val) = each($para_temp))) { goto fQHRv; } goto FqphM; cXOzk: MMOdL: goto VZI8D; NBqWv: $sHtml .= "\x3c\x69\x6e\160\165\164\40\164\171\x70\x65\x3d\x27\x68\x69\144\x64\145\156\47\x20\x6e\x61\155\x65\75\x27" . $key . "\47\x20\166\x61\x6c\165\x65\75\47" . $val . "\47\57\76"; goto nDidG; hbYSa: } public function generateSign($params, $signType = "\122\123\x41") { return $this->sign($this->getSignContent($params), $signType); } protected function sign($data, $signType = "\122\x53\x41") { goto Cfv5X; pK3a9: if ("\122\123\101\62" == $signType) { goto DdWlg; } goto aG3gi; cx3S6: goto uW9Q6; goto yv0bQ; Cfv5X: $priKey = $this->rsaPrivateKey; goto m2k8B; Mm2p2: return $sign; goto WP_oy; HV_Qc: openssl_sign($data, $sign, $res, version_compare(PHP_VERSION, "\x35\x2e\64\x2e\60", "\74") ? SHA256 : OPENSSL_ALGO_SHA256); goto GKn6D; aG3gi: openssl_sign($data, $sign, $res); goto cx3S6; OZ6nZ: $sign = base64_encode($sign); goto Mm2p2; m2k8B: $res = "\55\55\55\x2d\55\x42\x45\107\x49\x4e\40\122\123\x41\x20\120\x52\111\x56\101\124\105\40\x4b\105\131\x2d\x2d\55\x2d\55\12" . wordwrap($priKey, 64, "\xa", true) . "\12\x2d\55\x2d\55\55\x45\x4e\104\40\x52\123\x41\40\120\122\x49\x56\x41\124\x45\40\x4b\105\131\x2d\55\x2d\x2d\55"; goto ACDBJ; ACDBJ: $res or die("\xe6\x82\xa8\xe4\275\277\347\224\250\xe7\232\204\347\xa7\x81\351\222\245\346\xa0\xbc\xe5\274\x8f\xe9\x94\x99\xe8\xaf\257\357\xbc\214\350\257\267\346\xa3\x80\346\x9f\245\x52\123\x41\xe7\247\201\xe9\x92\245\351\x85\215\xe7\275\256"); goto pK3a9; yv0bQ: DdWlg: goto HV_Qc; GKn6D: uW9Q6: goto OZ6nZ; WP_oy: } public function rsaCheck($params) { goto L4Wfs; EoU74: unset($params["\163\151\147\156"]); goto vQ_Zz; vQ_Zz: return $this->verify($this->getSignContent($params), $sign, $signType); goto S2aOr; R3THf: unset($params["\163\x69\147\x6e\137\x74\171\160\x65"]); goto EoU74; L4Wfs: $sign = $params["\x73\x69\147\x6e"]; goto UoFyt; UoFyt: $signType = $params["\163\151\147\156\137\164\171\160\x65"]; goto R3THf; S2aOr: } function verify($data, $sign, $signType = "\x52\x53\101") { goto eqv_B; g0ZNK: $result = (bool) openssl_verify($data, base64_decode($sign), $res, version_compare(PHP_VERSION, "\x35\56\64\56\x30", "\74") ? SHA256 : OPENSSL_ALGO_SHA256); goto uEq5z; uEq5z: eucjd: goto X3T8E; zT_CA: if ("\x52\123\101\62" == $signType) { goto lSv8D; } goto DjbE1; FYGMg: goto eucjd; goto L7aIe; X3T8E: return $result; goto ojOCb; L7aIe: lSv8D: goto g0ZNK; G25gg: $res = "\55\x2d\x2d\x2d\55\102\x45\x47\111\x4e\40\120\125\102\x4c\111\103\x20\x4b\x45\x59\55\x2d\55\55\55\xa" . wordwrap($pubKey, 64, "\12", true) . "\12\x2d\55\x2d\x2d\x2d\105\x4e\104\40\120\x55\x42\114\111\x43\40\x4b\x45\x59\x2d\x2d\x2d\55\55"; goto qUIiS; qUIiS: $res or die("\346\x94\257\344\xbb\230\xe5\xae\x9d\x52\123\101\345\x85\254\xe9\x92\245\351\x94\x99\350\xaf\xaf\343\x80\202\xe8\xaf\267\xe6\xa3\200\xe6\x9f\xa5\345\205\254\xe9\222\245\346\226\207\344\273\266\346\xa0\274\xe5\274\217\346\230\257\345\220\246\xe6\255\243\347\241\xae"); goto zT_CA; DjbE1: $result = (bool) openssl_verify($data, base64_decode($sign), $res); goto FYGMg; eqv_B: $pubKey = $this->alipayPublicKey; goto G25gg; ojOCb: } protected function checkEmpty($value) { goto t_alw; zVcVr: return true; goto LLGAg; DajSR: QK0XQ: goto z915P; LLGAg: JnHew: goto XibJi; PdfnR: jrjW2: goto F1mqV; PWEbB: return true; goto PdfnR; XibJi: if (!(trim($value) === '')) { goto jrjW2; } goto PWEbB; F1mqV: return false; goto jVIOW; t_alw: if (isset($value)) { goto QK0XQ; } goto vyEFi; z915P: if (!($value === null)) { goto JnHew; } goto zVcVr; vyEFi: return true; goto DajSR; jVIOW: } public function getSignContent($params) { goto dqiVX; z2bpD: $i = 0; goto V0IKn; dqiVX: ksort($params); goto nF62L; VKHVZ: unset($k, $v); goto OTPM2; OTPM2: return $stringToBeSigned; goto RNRfd; I02ER: ljKCF: goto VKHVZ; nF62L: $stringToBeSigned = ''; goto z2bpD; V0IKn: foreach ($params as $k => $v) { goto LtnCq; vMmmx: $i++; goto wdxeM; t88rE: if ($i == 0) { goto IOkZ4; } goto RK9jw; J_osm: BNS_U: goto DQUF2; LtnCq: if (!(false === $this->checkEmpty($v) && "\100" != substr($v, 0, 1))) { goto tBLb3; } goto GYsg8; GYsg8: $v = $this->characet($v, $this->charset); goto t88rE; fbr_q: $stringToBeSigned .= "{$k}" . "\x3d" . "{$v}"; goto gM0cx; PuH3w: goto JWr0B; goto NZbUT; NZbUT: IOkZ4: goto fbr_q; wdxeM: tBLb3: goto J_osm; gM0cx: JWr0B: goto vMmmx; RK9jw: $stringToBeSigned .= "\x26" . "{$k}" . "\x3d" . "{$v}"; goto PuH3w; DQUF2: } goto I02ER; RNRfd: } function characet($data, $targetCharset) { goto Ves4p; xtCWq: return $data; goto dOUHq; ccYT7: $fileType = $this->charset; goto RPO50; RPO50: if (!(strcasecmp($fileType, $targetCharset) != 0)) { goto wmlCo; } goto nBtEX; mQy5E: xIDMX: goto xtCWq; Ves4p: if (empty($data)) { goto xIDMX; } goto ccYT7; nBtEX: $data = mb_convert_encoding($data, $targetCharset, $fileType); goto fgjdg; fgjdg: wmlCo: goto mQy5E; dOUHq: } }
