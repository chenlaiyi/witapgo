<?php
 goto Pj1vY; gwZhA: define("BEST_BIAOQIAN", "messikefu_biaoqian"); goto CfrWl; r7qeo: define("BEST_GROUPMEMBER", "messikefu_groupmember"); goto CHj2s; t5zsR: define("BEST_ADV", "messikefu_adv"); goto tzDWS; iRzlZ: define("ROOT_PATH", IA_ROOT . "/addons/cy163_customerservice/"); goto LXl9M; pcw25: define("BEST_DOMAIN", "http://we7.qiumipai.com/domain.php"); goto r7qeo; I_CjE: define("BEST_KEFUANDGROUP", "messikefu_kefuandgroup"); goto Sp4yG; mZucS: define("STATIC_ROOT_P", "../addons/cy163_customerservice_plugin_p/static"); goto cuPKL; YEMX1: define("BEST_XCXCSERVICE", "messikefu_xcxcservice"); goto KmPm9; LXl9M: define("MD_ROOT", "../addons/cy163_customerservice/"); goto JuLKP; CDbZN: define("BEST_GROUPVOICEDU", "messikefu_groupvoicedu"); goto Ezkb0; hV8Qd: define("BEST_WENZHANG", "messikefu_wenzhang"); goto BLnJN; JuLKP: define("STATIC_ROOT", "../addons/cy163_customerservice/static"); goto mZucS; CfrWl: define("BEST_GROUP", "messikefu_group"); goto pcw25; cdTEa: define("BEST_XCXCHAT", "messikefu_xcxchat"); goto Wwn9w; zaulZ: define("BEST_CSERVICE", "messikefu_cservice"); goto RJ1jD; Sp4yG: define("BEST_PINGJIA", "messikefu_pingjia"); goto hV8Qd; yIVoP: define("BEST_FANSKEFU", "messikefu_fanskefu"); goto t5zsR; RJ1jD: define("BEST_CSERVICEGROUP", "messikefu_cservicegroup"); goto gwZhA; CHj2s: define("BEST_GROUPCONTENT", "messikefu_groupchat"); goto yIVoP; KmPm9: define("BEST_XCXFANSKEFU", "messikefu_xcxfanskefu"); goto cdTEa; tzDWS: define("BEST_SANFANSKEFU", "messikefu_sanfanskefu"); goto olOdT; Pj1vY: defined("IN_IA") or exit("Access Denied"); goto iRzlZ; soz6p: define("BEST_LYFIELD", "messikefu_lyfield"); goto Kp_IM; Wwn9w: define("BEST_TISHI", "1%e3%80%81%e5%b0%8f%e7%a8%8b%e5%ba%8f%e5%ae%a2%e6%9c%8d%e5%8a%9f%e8%83%bd%e9%a1%bb%e6%8e%88%e6%9d%83%e6%89%8d%e8%83%bd%e4%bd%bf%e7%94%a8%ef%bc%8c%e8%af%b7%e8%81%94%e7%b3%bb%e8%b4%9f%e8%b4%a3%e4%ba%ba%e5%a4%84%e7%90%86%ef%bc%81%ef%bc%81%ef%bc%81\r\n2%e3%80%81%e8%af%b7%e9%80%89%e6%8b%a9%e4%bb%bb%e6%84%8f%e5%85%ac%e4%bc%97%e5%8f%b7%e5%90%8e%e5%8f%b0%e6%93%8d%e4%bd%9c%e5%b0%8f%e7%a8%8b%e5%ba%8f%e5%ae%a2%e6%9c%8d%e5%8a%9f%e8%83%bd%ef%bc%81%ef%bc%81%ef%bc%81"); goto uWi0P; BLnJN: define("BEST_KEFUANDCJWT", "messikefu_kefuandcjwt"); goto uhJgD; uWi0P: define("BEST_XCXAUTO", "messikefu_xcxauto"); goto kRTJo; Ezkb0: define("BEST_KUAIJIE", "messikefu_kuaijie"); goto kHriW; kHriW: define("BEST_LIUYAN", "messikefu_liuyan"); goto soz6p; uhJgD: define("BEST_ZIDONGHUIFU", "messikefu_zdhf"); goto PtA9O; kRTJo: define("BEST_ZHUIZONG", "messikefu_zhuizong"); goto CDbZN; olOdT: define("BEST_SANCHAT", "messikefu_sanchat"); goto I_CjE; cSUoB: define("BEST_CHAT", "messikefu_chat"); goto zaulZ; PtA9O: define("BEST_XCX", "messikefu_xcx"); goto YEMX1; cuPKL: define("NEWSTATIC_ROOT", "../addons/cy163_customerservice/newstatic"); goto cSUoB; Kp_IM: class Cy163_customerserviceModuleSite extends WeModuleSite { public function __construct() { } public function doMobileShenqingqun() { goto xKmI9; xKmI9: global $_W, $_GPC; goto g0hE0; dydSM: include $this->template("error"); goto C5n77; qOct1: exit; goto VCqeh; VCqeh: gwOgG: goto ZxIuH; Vt2hs: $data["nickname"] = $iscservice["name"]; goto WQWOF; ZxIuH: $iscservice = pdo_fetch("SELECT * FROM " . tablename(BEST_CSERVICE) . " WHERE weid = {$_W["uniacid"]} AND ctype = 1 AND content = '{$_W["fans"]["from_user"]}'"); goto CHxC3; IA8qp: include $this->template("error"); goto TdjXf; tXeH9: goto uKdfb; goto oVE_h; I38XW: JsoQ7: goto rkIDQ; LIBBL: $data["nickname"] = $info["nickname"]; goto vbo5r; IvKXb: $data["nickname"] = $fan["nickname"]; goto tXeH9; vK5cq: $message = "请在微信浏览器中打开！"; goto dydSM; gySjV: include $this->template("error"); goto AhHuX; hn4mk: $hasshenqing = pdo_fetch("SELECT id FROM " . tablename(BEST_GROUPMEMBER) . " WHERE weid = {$_W["uniacid"]} AND openid = '{$_W["fans"]["from_user"]}' AND groupid = {$groupid}"); goto wEeWq; NMPeN: BDpZV: goto sIE94; y01o3: proBx: goto NEr99; FVinS: $hasgroup = pdo_fetch("SELECT * FROM " . tablename(BEST_GROUP) . " WHERE weid = {$_W["uniacid"]} AND id = {$groupid}"); goto dc3_0; rURBA: $data["avatar"] = $fan["headimgurl"]; goto IvKXb; Tq9j6: $message = "参数传输错误！"; goto IA8qp; Kxwgj: if (!($hasgroup["isshenhe"] == 0)) { goto BDpZV; } goto w1T_a; AqGDc: if (!($hasgroup["maxnum"] != 0)) { goto sy031; } goto s8pKq; JACJe: $message = "该群聊人数已满！"; goto gySjV; haYYd: $this->sendtplmsg($senddata); goto NMPeN; lmwu0: $message = "不存在该群聊！"; goto hHzlZ; FacLL: exit; goto JS6wL; hsw0z: $data["avatar"] = $info["headimgurl"]; goto LIBBL; GQgRU: sy031: goto hn4mk; ewgAU: if (!empty($groupid)) { goto dtKhg; } goto Tq9j6; oVE_h: zSKBj: goto hsw0z; Sz0xE: if (!($ingroupnum >= $hasgroup["maxnum"])) { goto i0D0t; } goto JACJe; SYrzl: dtKhg: goto FVinS; iGBMx: $data["status"] = 1; goto I38XW; nh4VP: $data["groupid"] = $groupid; goto mvsoT; cx1W7: goto rKRT8; goto d3WSB; hHzlZ: include $this->template("error"); goto FacLL; U01Z5: $info = $account_api->fansQueryInfo($_W["fans"]["from_user"]); goto V1TQc; svpWk: $account_api = WeAccount::create(); goto U01Z5; TdjXf: exit; goto SYrzl; s8pKq: $ingroupnum = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename(BEST_GROUPMEMBER) . " WHERE weid = {$_W["uniacid"]} AND groupid = {$groupid}"); goto Sz0xE; z0PCX: include $this->template("shenqingqun"); goto NkU9P; plwGN: $data["type"] = 1; goto cx1W7; d3WSB: Geht4: goto Vt2hs; NJ0hb: $message = "您已申请加入该群聊！"; goto MgrNI; WQWOF: $data["avatar"] = tomedia($iscservice["thumb"]); goto VCtPA; rkIDQ: if (!($hasgroup["autotx"] == 1)) { goto proBx; } goto IICB9; vySIs: i0D0t: goto GQgRU; mvsoT: $data["weid"] = $_W["uniacid"]; goto a7lHl; PzZLB: $groupid = intval($_GPC["groupid"]); goto ewgAU; MgrNI: include $this->template("error"); goto qOct1; dc3_0: if (!empty($hasgroup)) { goto vw5TI; } goto lmwu0; a7lHl: $data["openid"] = $_W["fans"]["from_user"]; goto oMS2Z; sIE94: $message = "提交申请成功！"; goto z0PCX; VCtPA: $data["type"] = 2; goto i3Ncr; w1T_a: $senddata = array("openid" => $hasgroup["admin"], "url" => $this->gettpldomain() . "app/" . str_replace("./", '', $this->createMobileUrl("guanligroup", array("groupid" => $groupid))), "first" => $data["nickname"] . "申请加入" . $hasgroup["groupname"] . "！", "keyword1" => $data["nickname"]); goto haYYd; IICB9: $data["txkaiguan"] = 1; goto y01o3; oMS2Z: if (!($hasgroup["isshenhe"] == 1)) { goto JsoQ7; } goto iGBMx; AhHuX: exit; goto vySIs; NEr99: pdo_insert(BEST_GROUPMEMBER, $data); goto Kxwgj; cloRD: $fan = mc_oauth_userinfo(); goto rURBA; CHxC3: if (!empty($iscservice)) { goto Geht4; } goto svpWk; JS6wL: vw5TI: goto AqGDc; i3Ncr: rKRT8: goto nh4VP; V1TQc: if ($info["subscribe"] == 1) { goto zSKBj; } goto cloRD; wEeWq: if (empty($hasshenqing)) { goto gwOgG; } goto NJ0hb; g0hE0: if (!empty($_W["fans"]["from_user"])) { goto iwcg6; } goto vK5cq; C5n77: exit; goto NsxU5; NsxU5: iwcg6: goto PzZLB; vbo5r: uKdfb: goto plwGN; NkU9P: } public function sendtplmsg($senddata) { goto QIlYf; WS55r: $row["title"] = urlencode("新消息提醒"); goto Av8m7; e5TLl: $send["touser"] = $senddata["openid"]; goto zmJnw; lRnvB: i65hq: goto dFAlW; zmJnw: $send["msgtype"] = "news"; goto odJnS; ytkiF: aliiY: goto lRnvB; yQycZ: $account_api = WeAccount::create(); goto aKRO8; QIlYf: global $_GPC, $_W; goto sfadN; sfadN: if (!($this->module["config"]["istplon"] == 1)) { goto i65hq; } goto x2F3i; aKRO8: $account_api->sendTplNotice($senddata["openid"], $this->module["config"]["tpl_kefu"], $postdata, $senddata["url"], "#980000"); goto ytkiF; H_D9V: $news[] = $row; goto e5TLl; ZwtsW: goto aliiY; goto mewmp; Av8m7: $senddata["first"] = "提示！你有新的消息"; goto BrjTX; odJnS: $send["news"]["articles"] = $news; goto qkUPN; iXdse: $row = array(); goto WS55r; x2F3i: if ($this->module["config"]["tpl_kefu"] != '' && $senddata["wherefrom"] != 1) { goto ajUYl; } goto iXdse; qkUPN: $account_api = WeAccount::create(); goto fZYun; MvheQ: $postdata = array("keyword1" => array("value" => $senddata["keyword1"], "color" => "#ff510"), "keyword2" => array("value" => date("Y-m-d H:i:s", TIMESTAMP), "color" => "#ff510"), "remark" => array("value" => $senddata["first"], "color" => "#0000CD")); goto yQycZ; BrjTX: $row["description"] = urlencode($senddata["first"]); goto wUV_u; wUV_u: $row["picurl"] = $_W["siteroot"] . "/addons/cy163_customerservice/static/tuwen.jpg"; goto QvQQd; QvQQd: $row["url"] = $senddata["url"]; goto H_D9V; mewmp: ajUYl: goto MvheQ; fZYun: $account_api->sendCustomNotice($send); goto ZwtsW; dFAlW: } public function guolv($content) { goto aFV4P; mvAai: Z1VhB: goto NwjHi; xnsDB: C6BEg: goto mvAai; B9wno: $sensitivewordarr = explode("|", $this->module["config"]["mingan"]); goto C9fS3; KgIHq: return $content; goto eDmvO; NwjHi: $content = nl2br($content); goto KgIHq; aFV4P: if (empty($this->module["config"]["mingan"])) { goto Z1VhB; } goto B9wno; C9fS3: foreach ($sensitivewordarr as $k => $v) { goto e0ESM; pA_03: ee91x: goto ROrdE; e0ESM: if (empty($v)) { goto OnmiW; } goto vVbGS; nlvTt: OnmiW: goto pA_03; vVbGS: $content = str_replace($v, "***", $content); goto nlvTt; ROrdE: } goto xnsDB; eDmvO: } public function doMobileQdadmin() { include_once ROOT_PATH . "inc/mobile/qdadmin.php"; } public function doMobileXcxqdadmin() { include_once ROOT_PATH . "inc/mobile/xcxqdadmin.php"; } public function doMobileGroupcenter() { goto ZXuJ8; zzpgT: exit; goto vxWg5; cnq3Y: WlRF0: goto j31uq; DvwwC: echo json_encode($resarr); goto eOIBc; nIQZx: sduZ6: goto xEWd5; v06qm: bH9d5: goto cfQ1w; mkZxg: goto WlRF0; goto HeI3Q; wo6uL: if (!empty($qunname)) { goto bH9d5; } goto zNfTZ; wjVsH: ILzio: goto i0ecy; lOE4R: $resarr["error"] = 1; goto k9M0Q; uj6gp: echo json_encode($resarr); goto RMumT; OpZFA: $iscservice = pdo_fetch("SELECT id FROM " . tablename(BEST_CSERVICE) . " WHERE weid = {$_W["uniacid"]} AND content = '{$_W["fans"]["from_user"]}' AND ctype = 1"); goto ag9eD; SAffK: $resarr["msg"] = "没有这个群聊！"; goto YPZvG; ag9eD: if ($this->module["config"]["groupshow"] == 0) { goto O4iXU; } goto q_vPY; KYpTp: $resarr["html"] = "<div class=\"item flex\">\r\n\t\t\t\t\t\t\t\t\t\t<img src=\"" . tomedia($group["thumb"]) . "\">\r\n\t\t\t\t\t\t\t\t\t\t<a href=\"" . $this->createMobileUrl("groupchatdetail", array("groupid" => $group["id"])) . "\" style=\"flex:1;color:#666;\">\r\n\t\t\t\t\t\t\t\t\t\t\t<div class=\"text textellipsis1\">" . $group["groupname"] . "</div>\r\n\t\t\t\t\t\t\t\t\t\t</a>\r\n\t\t\t\t\t\t\t\t\t\t" . $groupbtn . "\r\n\t\t\t\t\t\t\t\t\t</div>"; goto DvwwC; QF9eV: goto ILzio; goto OhlAb; RMumT: exit; goto v06qm; g0VtV: $qunname = trim($_GPC["qunname"]); goto wo6uL; dfwm0: include $this->template("groupcenter"); goto QF9eV; j31uq: $resarr["error"] = 0; goto KYpTp; HeI3Q: xMs1I: goto UyjTd; UyjTd: $groupbtn = "<div class=\"buttons\"><a href=\"" . $this->createMobileUrl("guanligroup", array("groupid" => $group["id"])) . "\">管理群</a></div>"; goto cnq3Y; OhlAb: QWTyp: goto fS4Lf; no2ta: O4iXU: goto MvvB8; q_vPY: $groupmember = pdo_fetchall("SELECT groupid FROM " . tablename(BEST_GROUPMEMBER) . " WHERE weid = {$_W["uniacid"]} AND openid = '{$_W["fans"]["from_user"]}'"); goto enf5P; BU6S5: $message = "请在微信浏览器中打开！"; goto mhljP; cD7gY: $this->module["config"]["shareurl"] = $_W["siteroot"] . "app/" . str_replace("./", '', $this->createMobileUrl("groupcenter")); goto dfwm0; zNfTZ: $resarr["error"] = 1; goto LfnKj; fS4Lf: if (!empty($_W["fans"]["from_user"])) { goto ZHtKm; } goto lOE4R; ZXuJ8: global $_GPC, $_W; goto PFyjZ; bhZY9: if ($op == "search") { goto QWTyp; } goto g23Tw; Vorup: if (empty($group)) { goto gnFs2; } goto TH5CH; oLrEx: Q2dIs: goto cD7gY; k9M0Q: $resarr["msg"] = "请在微信浏览器中打开！"; goto DNKLZ; j0Z0d: $resarr["error"] = 1; goto SAffK; eOIBc: exit; goto UdOtQ; U1xE6: gnFs2: goto j0Z0d; LfnKj: $resarr["msg"] = "请输入群名称查询！"; goto uj6gp; flie9: exit; goto PCRCO; vxWg5: E3N0U: goto OpZFA; cfQ1w: $group = pdo_fetch("SELECT * FROM " . tablename(BEST_GROUP) . " WHERE groupname like '%{$qunname}%' AND weid = {$_W["uniacid"]}"); goto Vorup; g23Tw: if (!empty($_W["fans"]["from_user"])) { goto E3N0U; } goto BU6S5; A0NWx: ZHtKm: goto g0VtV; UdOtQ: goto x9_eh; goto U1xE6; enf5P: $groupidarr = array(); goto sZuNF; MvvB8: $grouplist = pdo_fetchall("SELECT * FROM " . tablename(BEST_GROUP) . " WHERE weid = {$_W["uniacid"]} ORDER BY time DESC"); goto oLrEx; PCRCO: x9_eh: goto wjVsH; DNKLZ: echo json_encode($resarr); goto RC4kT; r3e9U: goto Q2dIs; goto no2ta; sZuNF: foreach ($groupmember as $k => $v) { $groupidarr[] = $v["groupid"]; lWXQd: } goto nIQZx; mhljP: include $this->template("error"); goto zzpgT; TH5CH: if ($group["admin"] == $_W["fans"]["from_user"]) { goto xMs1I; } goto Qiazt; xEWd5: $grouplist = pdo_fetchall("SELECT * FROM " . tablename(BEST_GROUP) . " WHERE weid = {$_W["uniacid"]} AND id in (" . implode(",", $groupidarr) . ") ORDER BY time DESC"); goto r3e9U; YPZvG: echo json_encode($resarr); goto flie9; Qiazt: $groupbtn = ''; goto mkZxg; RC4kT: exit; goto A0NWx; PFyjZ: $op = trim($_GPC["op"]); goto bhZY9; i0ecy: } public function doMobileGuanligroup() { goto jJuWp; MIPKq: sZPgT: goto PqM6n; KuLZM: ZI7yx: goto j9whf; JnBye: echo json_encode($resarr); goto WhYnN; Th60M: $groupmemberlist = pdo_fetchall("SELECT * FROM " . tablename(BEST_GROUPMEMBER) . " WHERE weid = {$_W["uniacid"]} AND groupid = {$groupid} AND openid != '{$_W["fans"]["from_user"]}' AND isdel = 0 ORDER BY status ASC,id DESC"); goto FDA8Y; zkhXq: uCoc4: goto WX94v; N3Pz0: include $this->template("error"); goto Jz8iP; w7Y9t: $this->sendtplmsg($senddata); goto ERZ5y; pTYK2: $resarr["msg"] = "操作成功！"; goto JnBye; dHp_0: $groupmemberlist = pdo_fetchall("SELECT * FROM " . tablename(BEST_GROUPMEMBER) . " WHERE weid = {$_W["uniacid"]} AND groupid = {$groupid} AND openid != '{$_W["fans"]["from_user"]}' AND isdel = 0 ORDER BY status ASC,id DESC"); goto ZNbwK; ULyEG: exit; goto fYWy7; jvQRS: $groupid = intval($_GPC["groupid"]); goto YPPt4; vj_YO: goto mDopC; goto MIPKq; Ge_en: if ($op == "shenhe") { goto sZPgT; } goto KEAZo; FWjo3: $id = intval($_GPC["memberid"]); goto tafJ1; vXeXp: dK2Ow: goto jvQRS; JmnTI: $id = intval($_GPC["memberid"]); goto atl4z; PqM6n: $groupid = intval($_GPC["groupid"]); goto FWjo3; bqtV2: goto mDopC; goto vKCDa; tTFuv: exit; goto vXeXp; LQC2w: mMe2s: goto n9lEF; snGGk: $id = intval($_GPC["memberid"]); goto XShUR; Dor_3: exit; goto kHekE; KEAZo: if ($op == "jiechu") { goto my0yD; } goto KfKMZ; atl4z: $groupmember = pdo_fetch("SELECT openid,isjin FROM " . tablename(BEST_GROUPMEMBER) . " WHERE id = {$id}"); goto yEAFr; rnqfS: echo json_encode($resarr); goto J64aH; iApfq: echo json_encode($resarr); goto nKa04; V_Gnk: XC85P: goto PWAdv; pgeDn: $resarr["msg"] = "操作成功！"; goto bDZnD; i8Y1e: if ($op == "alljie") { goto ZI7yx; } goto Q3eQs; Lx0zl: $message = "请在微信浏览器中打开！"; goto oAgLa; UlteY: $resarr["msg"] = "操作成功！"; goto PsU8v; ERZ5y: $resarr["error"] = 0; goto UlteY; Cc9B_: include $this->template("guanligroup"); goto bqtV2; yEAFr: pdo_update(BEST_GROUPMEMBER, array("isjin" => 0), array("id" => $id)); goto G4yyB; oAgLa: include $this->template("error"); goto tTFuv; o1MwG: mDopC: goto Mc9Kd; ZNbwK: foreach ($groupmemberlist as $k => $v) { pdo_update(BEST_GROUPMEMBER, array("isjin" => 0), array("id" => $v["id"])); FZgDh: } goto Xdu3S; mK7qy: if ($op == '') { goto pesOC; } goto NI6Ng; VhmKh: goto mDopC; goto V_Gnk; b_2Lw: if (!empty($groupmember)) { goto C1qEf; } goto Sva9j; Xdu3S: Pbow1: goto vMHMs; tafJ1: $groupmember = pdo_fetch("SELECT openid FROM " . tablename(BEST_GROUPMEMBER) . " WHERE id = {$id}"); goto m2u1t; m2u1t: pdo_update(BEST_GROUPMEMBER, array("status" => 1, "intime" => TIMESTAMP), array("id" => $id)); goto Qm85W; KLG51: $message = "你不是管理员，不能管理该群聊！"; goto N3Pz0; Cre2g: exit; goto vj_YO; mJgJi: goto mDopC; goto LQC2w; n9lEF: $groupid = intval($_GPC["groupid"]); goto Th60M; dY9_m: $resarr["error"] = 0; goto a8VMS; NeOGj: pdo_update(BEST_GROUPMEMBER, array("isjin" => 1), array("id" => $id)); goto m31uO; PWAdv: $groupid = intval($_GPC["groupid"]); goto UmuR5; UmuR5: $id = intval($_GPC["memberid"]); goto O7yDa; KfKMZ: if ($op == "jinyan") { goto XC85P; } goto ir6nS; Jz8iP: exit; goto JCFxB; jJuWp: global $_GPC, $_W; goto NwCuD; a8VMS: $resarr["msg"] = "操作成功！"; goto I8Qu0; J64aH: exit; goto mJgJi; YPPt4: $isgroupadmin = pdo_fetch("SELECT * FROM " . tablename(BEST_GROUP) . " WHERE weid = {$_W["uniacid"]} AND id = {$groupid} AND admin = '{$_W["fans"]["from_user"]}'"); goto Ykazh; PsU8v: echo json_encode($resarr); goto Dor_3; Qm85W: $senddata = array("openid" => $groupmember["openid"], "url" => $this->gettpldomain() . "app/" . str_replace("./", '', $this->createMobileUrl("groupchatdetail", array("groupid" => $groupid))), "first" => "入群提醒", "keyword1" => "您已被审核进群"); goto w7Y9t; ZbgbP: my0yD: goto Udx8j; Sva9j: $resarr["error"] = 1; goto hpGXN; JCFxB: Rnf5Z: goto RZDqu; Q3eQs: goto mDopC; goto QHNfQ; vMHMs: $resarr["error"] = 0; goto pgeDn; fYWy7: C1qEf: goto TEOPU; hpGXN: $resarr["msg"] = "不存在该用户记录！"; goto ZL0W1; NI6Ng: if ($op == "del") { goto Mubh9; } goto Ge_en; UNwXS: $resarr["msg"] = "操作成功！"; goto iApfq; ir6nS: if ($op == "alljin") { goto mMe2s; } goto i8Y1e; I8Qu0: echo json_encode($resarr); goto Cre2g; WhYnN: exit; goto GJs2U; NwCuD: if (!empty($_W["fans"]["from_user"])) { goto dK2Ow; } goto Lx0zl; QHNfQ: pesOC: goto NAEhx; yzVVw: exit; goto o1MwG; TMOeZ: $resarr["msg"] = "操作成功！"; goto rnqfS; FDA8Y: foreach ($groupmemberlist as $k => $v) { pdo_update(BEST_GROUPMEMBER, array("isjin" => 1), array("id" => $v["id"])); MKMfq: } goto zkhXq; bDZnD: echo json_encode($resarr); goto yzVVw; NAEhx: $groupmemberlist = pdo_fetchall("SELECT * FROM " . tablename(BEST_GROUPMEMBER) . " WHERE weid = {$_W["uniacid"]} AND groupid = {$groupid} AND openid != '{$_W["fans"]["from_user"]}' AND isdel = 0 ORDER BY status ASC,id DESC"); goto Cc9B_; Ykazh: if (!empty($isgroupadmin)) { goto Rnf5Z; } goto KLG51; j9whf: $groupid = intval($_GPC["groupid"]); goto dHp_0; WX94v: $resarr["error"] = 0; goto pTYK2; m31uO: $resarr["error"] = 0; goto TMOeZ; GJs2U: goto mDopC; goto KuLZM; XShUR: $groupmember = pdo_fetch("SELECT openid FROM " . tablename(BEST_GROUPMEMBER) . " WHERE id = {$id} AND isdel = 0"); goto b_2Lw; kHekE: goto mDopC; goto ZbgbP; Udx8j: $groupid = intval($_GPC["groupid"]); goto JmnTI; UwLti: $groupid = intval($_GPC["groupid"]); goto snGGk; nKa04: exit; goto VhmKh; RZDqu: $op = trim($_GPC["op"]); goto mK7qy; vKCDa: Mubh9: goto UwLti; ZL0W1: echo json_encode($resarr); goto ULyEG; G4yyB: $resarr["error"] = 0; goto UNwXS; O7yDa: $groupmember = pdo_fetch("SELECT openid,isjin FROM " . tablename(BEST_GROUPMEMBER) . " WHERE id = {$id}"); goto NeOGj; TEOPU: pdo_update(BEST_GROUPMEMBER, array("isdel" => 1), array("groupid" => $groupid, "openid" => $groupmember["openid"])); goto dY9_m; Mc9Kd: } public function doMobileGrouptongzhi() { goto GKWak; xAJiQ: $resArr["msg"] = "你不属于该群聊！"; goto qPAqp; GKWak: global $_GPC, $_W; goto egYz6; qCJaZ: $data["txkaiguan"] = $type; goto jkZ0X; RsW0K: echo json_encode($resArr); goto Zo0kP; Zo0kP: exit; goto kUFZ2; jkZ0X: pdo_update(BEST_GROUPMEMBER, $data, array("id" => $id)); goto kWwjj; qPAqp: echo json_encode($resArr); goto f7GZn; CTQou: Rbctk: goto qCJaZ; egYz6: $id = intval($_GPC["id"]); goto hEc3d; aSUwv: $resArr["error"] = 1; goto xAJiQ; maHgn: $resArr["msg"] = "操作成功！"; goto RsW0K; f7GZn: exit; goto CTQou; gOMla: if (!empty($isin)) { goto Rbctk; } goto aSUwv; kWwjj: $resArr["error"] = 1; goto maHgn; boRYl: $isin = pdo_fetch("SELECT * FROM " . tablename(BEST_GROUPMEMBER) . " WHERE weid = {$_W["uniacid"]} AND openid = '{$_W["fans"]["from_user"]}' AND id = {$id} AND status = 1"); goto gOMla; hEc3d: $type = intval($_GPC["type"]); goto boRYl; kUFZ2: } public function doMobileGroupchatdetail() { goto FLX_h; FLX_h: global $_GPC, $_W; goto sfcpL; MUusA: $quickcon = empty($group["quickcon"]) ? '' : explode("|", $group["quickcon"]); goto lpi06; t7R20: $this->sendtplmsg($senddata); goto OnPKB; PzRn_: if (!($group["isguanzhu"] == 1 && $_W["fans"]["follow"] == 0)) { goto hFsxJ; } goto lYxrf; cluMj: exit; goto bOr1b; r0CWr: hFsxJ: goto qQ1DG; S2Pt3: exit; goto o95ue; wuwHe: $data["type"] = 1; goto GLksF; rRDEz: $total = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename(BEST_GROUPCONTENT) . " WHERE groupid = {$groupid} AND weid = {$_W["uniacid"]} AND time >= {$isin["intime"]}"); goto fcPtX; lYxrf: $gzhqrcode = tomedia($this->module["config"]["followqrcode"]); goto TVCbE; voJgJ: hD3yW: goto f9x00; N9U1J: foreach ($array2[0] as $kk => $vv) { goto sli3b; sli3b: if (empty($vv)) { goto l8g83; } goto HGSiG; f8ana: $group["autoreply"] = str_replace($vv, "<a href='" . $vvurl . "'>" . $vv . "</a>", $group["autoreply"]); goto GMzW7; HGSiG: $vvurl = strstr($vv, "http") ? $vv : "http://" . $vv; goto f8ana; GMzW7: l8g83: goto na3ca; na3ca: F6XeH: goto xQ7t0; xQ7t0: } goto A7831; JBhES: $timestamp = TIMESTAMP; goto MUusA; nNHQl: goto SSe6q; goto GI_pZ; sfcpL: if (!empty($_W["fans"]["from_user"])) { goto CRHw2; } goto Ttjod; O4f1D: include $this->template("groupdetail"); goto UtFJb; gCAVN: $allpage = ceil($total / $psize) + 1; goto GgM3n; jX0r5: $data["groupid"] = $groupid; goto l4A7v; FeEBS: ufx7F: goto O4f1D; NwGHd: foreach ($groupcontent as $k => $v) { goto qIEAW; UloNI: $groupcontent[$k]["hasgroupvoicedu"] = 1; goto SCH0N; GYyW9: $groupcontent[$k]["content"] = $this->guolv($groupcontent[$k]["content"]); goto RxnW3; a4CLJ: gZpFX: goto i3ECo; oir8x: KPKhR: goto rqzd1; aJB4p: if ($donetime >= 24 * 3600 * 3) { goto qKZQg; } goto XLgPk; fSfDa: $groupcontent[$k]["class"] = "left"; goto rRYth; fe7jb: $chatcontime = $v["time"]; goto wubdJ; wubdJ: $groupcontent[$k]["content"] = preg_replace("/\\xEE[\\x80-\\xBF][\\x80-\\xBF]|\\xEF[\\x81-\\x83][\\x80-\\xBF]/", "[无法识别字符]", $v["content"]); goto GYyW9; XLgPk: $hasgroupvoicedu = pdo_fetch("SELECT id FROM " . tablename(BEST_GROUPVOICEDU) . " WHERE weid = {$_W["uniacid"]} AND openid = '{$_W["fans"]["from_user"]}' AND groupid = {$groupid} AND gchatid = {$v["id"]}"); goto Jsg5_; rqzd1: zrcZB: goto WveD9; RbSUV: qKZQg: goto Eng7Q; fzTIJ: A3azg: goto hBPAI; bWn8I: goto wuecA; goto a4CLJ; Jsg5_: if (empty($hasgroupvoicedu)) { goto qJ2Ml; } goto UloNI; Sq6cg: $groupcontent[$k]["class"] = "right"; goto LJJUb; Q4YKW: wuecA: goto lMvH0; ViVCm: if (!(!empty($array2[0]) && ($v["type"] == 1 || $v["type"] == 2))) { goto zrcZB; } goto WLu7X; RxnW3: $regex = "@(?i)\\b((?:[a-z][\\w-]+:(?:/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?«»“”‘’]))@"; goto s90nx; SnZkL: b5N0H: goto HSHmo; Eng7Q: unset($groupcontent[$k]); goto SnZkL; SCLtd: $donetime = $timestamp - $v["time"]; goto aJB4p; WLu7X: foreach ($array2[0] as $kk => $vv) { goto rK4cr; yh7Rr: $vvurl = strstr($vv, "http") ? $vv : "http://" . $vv; goto W6hHb; W6hHb: $groupcontent[$k]["content"] = str_replace($vv, "<a href='" . $vvurl . "'>" . $vv . "</a>", $groupcontent[$k]["content"]); goto zzpP2; rK4cr: if (empty($vv)) { goto LXhoa; } goto yh7Rr; wtGoE: IHUFy: goto EVG5P; zzpP2: LXhoa: goto wtGoE; EVG5P: } goto oir8x; qIEAW: if ($v["time"] - $chatcontime > 7200) { goto gZpFX; } goto U0CQe; WveD9: if (!($v["type"] == 5)) { goto SeewG; } goto SCLtd; rRYth: aeY7D: goto fe7jb; LJJUb: goto aeY7D; goto MjFBc; s90nx: preg_match_all($regex, $groupcontent[$k]["content"], $array2); goto ViVCm; HSHmo: SeewG: goto fzTIJ; lMvH0: if ($v["openid"] != $_W["fans"]["from_user"]) { goto rWcju; } goto Sq6cg; o1j6K: goto b5N0H; goto RbSUV; MjFBc: rWcju: goto fSfDa; U0CQe: $groupcontent[$k]["time"] = ''; goto bWn8I; SCH0N: qJ2Ml: goto o1j6K; i3ECo: $groupcontent[$k]["time"] = $v["time"]; goto Q4YKW; hBPAI: } goto FeEBS; GnzKu: goto ihY1t; goto aG0de; zfhcC: include $this->template("error"); goto IbAVE; iq7yZ: $group = pdo_fetch("SELECT * FROM " . tablename(BEST_GROUP) . " WHERE id = {$groupid}"); goto syfsp; Ttjod: $message = "请在微信浏览器中打开！"; goto Xg0MD; qQ1DG: if (!($group["maxnum"] != 0)) { goto zAH5q; } goto JcH9U; GgM3n: $nowjl = $total - $pindex * $psize; goto OBrS6; OnPKB: $message = $group["groupname"] . "必须审核才能入群，您已提交申请，请等待审核！"; goto YcY9l; mzMQr: $data["intime"] = TIMESTAMP; goto VsH2h; Tft20: $senddata = array("openid" => $group["admin"], "url" => $this->gettpldomain() . "app/" . str_replace("./", '', $this->createMobileUrl("guanligroup", array("groupid" => $groupid))), "first" => $data["nickname"] . "申请加入" . $group["groupname"] . "！", "keyword1" => $data["nickname"]); goto t7R20; PV6Mb: UBY_h: goto GnzKu; oUql4: YCZuo: goto Mxtru; It4lq: exit; goto j_G9A; qoeje: $isin = pdo_fetch("SELECT id,intime,avatar,nickname,txkaiguan FROM " . tablename(BEST_GROUPMEMBER) . " WHERE weid = {$_W["uniacid"]} AND openid = '{$_W["fans"]["from_user"]}' AND groupid = {$groupid} AND status = 1 AND isdel = 0"); goto PV6Mb; I6KBx: include $this->template("error"); goto WmOpS; CLdt4: $data["avatar"] = tomedia($iscservice["thumb"]); goto s6ndJ; j_G9A: R42TN: goto NvlJL; D7vkb: $data["nickname"] = $iscservice["name"]; goto CLdt4; QM37n: $message = "不存在" . $group["groupname"] . "！"; goto AEXZv; P3NLN: VAnoK: goto E66R6; OYQ7j: $data["avatar"] = $info["headimgurl"]; goto eL3PJ; rqiI0: if ($group["isshenhe"] == 1) { goto m96wU; } goto bdmZM; hXjUO: $data["txkaiguan"] = 1; goto mmOB3; IbAVE: exit; goto Rl4Ky; E66R6: $allmember = substr($allmember, 0, -1); goto JBhES; IVjo4: X4LMl: goto D7vkb; VsH2h: pdo_insert(BEST_GROUPMEMBER, $data); goto qoeje; OBrS6: if (!($nowjl < 0)) { goto YCZuo; } goto F9Ly1; OlP1l: $message = $group["groupname"] . "人数已满！"; goto ONW8H; Oce8g: $psize = 10; goto gCAVN; XqfyK: $account_api = WeAccount::create(); goto GfS1a; eL3PJ: $data["nickname"] = $info["nickname"]; goto vwKJw; K6RlJ: $data["openid"] = $_W["fans"]["from_user"]; goto x53nr; cM1Jg: $regex = "@(?i)\\b((?:[a-z][\\w-]+:(?:/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?«»“”‘’]))@"; goto X7ySQ; WmOpS: exit; goto r0CWr; wHynh: $data["avatar"] = $fan["headimgurl"]; goto oNOOU; GLksF: goto kLAai; goto IVjo4; GfS1a: $info = $account_api->fansQueryInfo($_W["fans"]["from_user"]); goto cL0rJ; NvlJL: zAH5q: goto WtiZB; q573v: $groupid = intval($_GPC["groupid"]); goto iq7yZ; NRp76: $chatcontime = 0; goto NwGHd; bdmZM: pdo_insert(BEST_GROUPMEMBER, $data); goto Tft20; AEXZv: include $this->template("error"); goto H3Ad7; zDcVM: $hasshenqing = pdo_fetch("SELECT * FROM " . tablename(BEST_GROUPMEMBER) . " WHERE weid = {$_W["uniacid"]} AND openid = '{$_W["fans"]["from_user"]}' AND status = 0 AND groupid = {$groupid} AND isdel = 0"); goto vUdZ1; UvsO1: $data["status"] = 1; goto mzMQr; Xg0MD: include $this->template("error"); goto cluMj; lpi06: if (!$group["autoreply"]) { goto YN8ty; } goto cM1Jg; oEUQt: dXZsd: goto UmolK; aG0de: DSPcK: goto e5B06; di9UB: if (!($ingroupnum >= $group["maxnum"])) { goto R42TN; } goto OlP1l; hahOP: $allmember = ''; goto Vjpz3; vUdZ1: if (!empty($hasshenqing)) { goto DSPcK; } goto d4XLN; vwKJw: SSe6q: goto wuwHe; GI_pZ: sByX4: goto OYQ7j; YcY9l: include $this->template("error"); goto S2Pt3; H3Ad7: exit; goto oEUQt; oNOOU: $data["nickname"] = $fan["nickname"]; goto nNHQl; TVCbE: $message = "识别二维码，进群交流！"; goto I6KBx; cL0rJ: if ($info["subscribe"] == 1) { goto sByX4; } goto yCknm; e5B06: $message = $group["groupname"] . "须审核才能入群，您已提交申请，请等待审核！"; goto zfhcC; fcPtX: $page = intval($_GPC["page"]); goto soVcd; Rl4Ky: ihY1t: goto ExB03; xM7g_: if (empty($array2[0])) { goto hD3yW; } goto N9U1J; sIP2t: $allmemberlist = pdo_fetchall("SELECT openid FROM " . tablename(BEST_GROUPMEMBER) . " WHERE groupid = {$groupid} AND openid != '{$_W["fans"]["from_user"]}' AND status = 1 AND isdel = 0"); goto cm66F; UUa86: if (!empty($iscservice)) { goto X4LMl; } goto XqfyK; ExB03: cEuqK: goto sIP2t; f9x00: YN8ty: goto rRDEz; d4XLN: pdo_delete(BEST_GROUPMEMBER, array("groupid" => $groupid, "openid" => $_W["fans"]["from_user"])); goto PzRn_; F9Ly1: $nowjl = 0; goto oUql4; o95ue: goto UBY_h; goto UKN_V; x53nr: if (!($group["autotx"] == 1)) { goto H5wIr; } goto hXjUO; UKN_V: m96wU: goto UvsO1; Mxtru: $groupcontent = pdo_fetchall("SELECT * FROM " . tablename(BEST_GROUPCONTENT) . " WHERE weid = {$_W["uniacid"]} AND groupid = {$groupid} AND time >= {$isin["intime"]} ORDER BY time ASC LIMIT " . $nowjl . "," . $psize); goto NRp76; UmolK: $isin = pdo_fetch("SELECT * FROM " . tablename(BEST_GROUPMEMBER) . " WHERE weid = {$_W["uniacid"]} AND openid = '{$_W["fans"]["from_user"]}' AND groupid = {$groupid} AND status = 1 AND isdel = 0"); goto uQNl9; A7831: ebzcZ: goto voJgJ; uQNl9: if (!empty($isin)) { goto cEuqK; } goto zDcVM; s6ndJ: $data["type"] = 2; goto bWmVh; mmOB3: H5wIr: goto rqiI0; WtiZB: $iscservice = pdo_fetch("SELECT * FROM " . tablename(BEST_CSERVICE) . " WHERE weid = {$_W["uniacid"]} AND ctype = 1 AND content = '{$_W["fans"]["from_user"]}'"); goto UUa86; soVcd: $pindex = max(1, $page); goto Oce8g; yCknm: $fan = mc_oauth_userinfo(); goto wHynh; bWmVh: kLAai: goto jX0r5; Vjpz3: foreach ($allmemberlist as $k => $v) { $allmember .= $v["openid"] . $groupid . "|"; HyHlD: } goto P3NLN; JcH9U: $ingroupnum = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename(BEST_GROUPMEMBER) . " WHERE weid = {$_W["uniacid"]} AND groupid = {$groupid} AND isdel = 0"); goto di9UB; ONW8H: include $this->template("error"); goto It4lq; cm66F: $allpeople = count($allmemberlist); goto hahOP; X7ySQ: preg_match_all($regex, $group["autoreply"], $array2); goto xM7g_; l4A7v: $data["weid"] = $_W["uniacid"]; goto K6RlJ; syfsp: if (!empty($group)) { goto dXZsd; } goto QM37n; bOr1b: CRHw2: goto q573v; UtFJb: } public function doMobileQunmember() { goto SSJY1; G2aJr: $openid = $_W["fans"]["from_user"]; goto Ne9qs; Ne9qs: $groupid = intval($_GPC["groupid"]); goto Gqht3; g5gcr: kV3oQ: goto G2aJr; Nus8W: if (!empty($_W["fans"]["from_user"])) { goto kV3oQ; } goto kBod0; bU6M2: $memberlist = pdo_fetchall("SELECT * FROM " . tablename(BEST_GROUPMEMBER) . " WHERE groupid = {$groupid} AND weid = {$_W["uniacid"]} AND status = 1 AND isdel = 0"); goto GV4AM; GV4AM: $num = count($memberlist); goto i8fMu; Gqht3: $group = pdo_fetch("SELECT * FROM " . tablename(BEST_GROUP) . " WHERE id = {$groupid}"); goto bU6M2; ILaA4: include $this->template("error"); goto Us_20; Us_20: exit; goto g5gcr; SSJY1: global $_W, $_GPC; goto Nus8W; i8fMu: include $this->template("qunmember"); goto FhoWM; kBod0: $message = "请在微信浏览器中打开！"; goto ILaA4; FhoWM: } public function doMobileDugroupvoice() { goto fmEDE; Xcc1Y: exit; goto Dhi1j; mjC7R: if (!empty($hasgroupvoicedu)) { goto Fg1jW; } goto E5Yt5; ZPSuu: pdo_insert(BEST_GROUPVOICEDU, $data); goto fM9mQ; FJHFl: $hasgroupvoicedu = pdo_fetch("SELECT id FROM " . tablename(BEST_GROUPVOICEDU) . " WHERE weid = {$_W["uniacid"]} AND openid = '{$openid}' AND groupid = {$groupid} AND gchatid = {$groupchat["id"]}"); goto LSpJP; fM9mQ: Fg1jW: goto SD3Ka; smcGS: $resArr["error"] = 0; goto VbPD0; Cvoix: if (!empty($groupchat)) { goto t2AHn; } goto cCQb_; bRvPe: $nextvoicecon = empty($nextvoice) ? '' : $nextvoice["content"]; goto smcGS; mxbRz: $nextvoice = pdo_fetch("SELECT content FROM " . tablename(BEST_GROUPCONTENT) . " WHERE weid = {$_W["uniacid"]} AND openid != '{$openid}' AND groupid = {$groupid} AND time > {$donetime} AND time > {$groupchat["time"]} AND type = 5 ORDER BY time ASC"); goto bRvPe; WskvP: $openid = $_W["fans"]["from_user"]; goto XCYm2; LSpJP: $nowtime = TIMESTAMP; goto mjC7R; f7p4C: echo json_encode($resArr); goto Xcc1Y; VbPD0: $resArr["content"] = $nextvoicecon; goto s0NGH; b6QXn: $chatcon = trim($_GPC["gchatcon"]); goto XKPZe; tPDw6: echo json_encode($resArr); goto VgIag; XCYm2: $groupid = intval($_GPC["groupid"]); goto b6QXn; Hzkc1: t2AHn: goto FJHFl; XKPZe: $groupchat = pdo_fetch("SELECT id,time FROM " . tablename(BEST_GROUPCONTENT) . " WHERE weid = {$_W["uniacid"]} AND content = '{$chatcon}' AND type = 5"); goto Cvoix; SD3Ka: $donetime = $nowtime - 24 * 3600 * 3; goto mxbRz; VgIag: exit; goto Hzkc1; s0NGH: $resArr["message"] = "读取语音成功！"; goto f7p4C; CURRj: $resArr["message"] = "暂无这条群聊语音！"; goto tPDw6; fmEDE: global $_W, $_GPC; goto WskvP; E5Yt5: $data = array("weid" => $_W["uniacid"], "groupid" => $groupid, "gchatid" => $groupchat["id"], "openid" => $openid, "content" => $chatcon, "time" => $nowtime); goto ZPSuu; cCQb_: $resArr["error"] = 1; goto CURRj; Dhi1j: } public function doMobileGroupchatajax() { goto BnnCV; J5Kdl: $allpage = ceil($total / $psize) + 1; goto NnzRb; TW_Jv: mNLgF: goto yuxuL; Aln8w: exit; goto vtjc2; Qi1H9: sTX0_: goto wKbLb; hHI91: foreach ($groupcontent as $k => $v) { goto MQw9m; IJUX2: $groupcontent[$k]["content"] = preg_replace("/\\xEE[\\x80-\\xBF][\\x80-\\xBF]|\\xEF[\\x81-\\x83][\\x80-\\xBF]/", "[无法识别字符]", $v["content"]); goto q9GKX; u2VjT: H2tg4: goto IC_R8; FwmmM: unset($groupcontent[$k]); goto t756r; hvvwO: if (!($v["type"] == 5)) { goto zAT3L; } goto ooGw7; mNyfN: foreach ($array2[0] as $kk => $vv) { goto aCMsZ; vlEtx: $vvurl = strstr($vv, "http") ? $vv : "http://" . $vv; goto BnUcO; aCMsZ: if (empty($vv)) { goto t6VOW; } goto vlEtx; oygH2: CpWPv: goto ovhDX; fDeAM: t6VOW: goto oygH2; BnUcO: $groupcontent[$k]["content"] = str_replace($vv, "<a href='" . $vvurl . "'>" . $vv . "</a>", $groupcontent[$k]["content"]); goto fDeAM; ovhDX: } goto ysf1a; FryxU: preg_match_all($regex, $groupcontent[$k]["content"], $array2); goto L1HtF; A4LoU: if (!($donetime >= 24 * 3600 * 3)) { goto ezWAV; } goto FwmmM; DJbvn: zAT3L: goto u2VjT; tzfex: IKvlL: goto KXbYw; ooGw7: $donetime = $timestamp - $v["time"]; goto A4LoU; q9GKX: $groupcontent[$k]["content"] = $this->guolv($groupcontent[$k]["content"]); goto g0kXs; KXbYw: $groupcontent[$k]["time"] = $v["time"]; goto D8cJV; D8cJV: zCv0k: goto hYalJ; ysf1a: hOunH: goto ZecVc; MQw9m: if ($v["time"] - $chatcontime > 7200) { goto IKvlL; } goto AaAMy; g0kXs: $regex = "@(?i)\\b((?:[a-z][\\w-]+:(?:/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?«»“”‘’]))@"; goto FryxU; t756r: ezWAV: goto DJbvn; hYalJ: $chatcontime = $v["time"]; goto IJUX2; AaAMy: $groupcontent[$k]["time"] = ''; goto G94tk; G94tk: goto zCv0k; goto tzfex; ZecVc: pjmrk: goto hvvwO; L1HtF: if (!(!empty($array2[0]) && ($v["type"] == 1 || $v["type"] == 2))) { goto pjmrk; } goto mNyfN; IC_R8: } goto wPxTa; wPxTa: QAuAz: goto JYM7t; MVZEK: rDOmA: goto VU6UF; yuxuL: if ($total > $pindex * $psize) { goto sTX0_; } goto sFoXt; nyzaa: $isin = pdo_fetch("SELECT * FROM " . tablename(BEST_GROUPMEMBER) . " WHERE weid = {$_W["uniacid"]} AND openid = '{$openid}' AND groupid = {$groupid} AND status = 1 AND isdel = 0"); goto yOYxi; CkEhj: $nowjl = 0; goto TW_Jv; kv_d0: $groupcontent = pdo_fetchall("SELECT * FROM " . tablename(BEST_GROUPCONTENT) . " WHERE weid = {$_W["uniacid"]} AND groupid = {$groupid} AND time >= {$isin["intime"]} ORDER BY time ASC LIMIT " . $nowjl . "," . $tolimit); goto zdQ4x; EzHcG: $pindex = max(1, $page); goto SOGxw; upDwn: $openid = $_W["fans"]["from_user"]; goto MFXRN; q41w9: thRFV: goto kv_d0; sFoXt: $tolimit = $psize - ($pindex * $psize - $total); goto Ed0c4; wKbLb: $tolimit = $psize; goto q41w9; zdQ4x: $chatcontime = 0; goto hHI91; PqkIz: if (!($nowjl < 0)) { goto mNLgF; } goto CkEhj; NnzRb: $nowjl = $total - $pindex * $psize; goto PqkIz; MFXRN: $groupid = intval($_GPC["groupid"]); goto nyzaa; yOYxi: $total = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename(BEST_GROUPCONTENT) . " WHERE groupid = {$groupid} AND weid = {$_W["uniacid"]} AND time >= {$isin["intime"]}"); goto CQGXj; SOGxw: $psize = 10; goto J5Kdl; VU6UF: echo $html; goto Aln8w; Ed0c4: goto thRFV; goto Qi1H9; BnnCV: global $_W, $_GPC; goto upDwn; CQGXj: $page = intval($_GPC["page"]); goto EzHcG; pUbY6: foreach ($groupcontent as $k => $v) { goto nbHpa; ATqIO: if ($v["hasyuyindu"] == 0 && $openid == $v["toopenid"]) { goto MI00I; } goto T0_Ap; ew9JA: sT2HN: goto Z3I6p; GJFhv: $conhtml = "<div class=\"groupnickname n-left\">" . $v["nickname"] . "</div><div class=\"con flex1 flex\" style=\"margin-top:0.4rem;\">"; goto VvB3u; jVV3z: goto RIRJa; goto fcBYo; tsV5M: bk9XR: goto GQB0u; T0_Ap: $weidu = ''; goto pf01c; zS4hU: RIRJa: goto kXFI3; nbHpa: $htmltime = !empty($v["time"]) ? "<div class=\"time text-c\">" . date("Y-m-d H:i:s", $v["time"]) . "</div>" : ''; goto hrDWp; Ztq6j: $chatconhtml = "<div class=\"concon\">" . $v["content"] . "</div>"; goto gMoJ9; GQB0u: $chatconhtml = "<div class=\"concon voiceplay flex\">\r\n\t\t\t\t\t\t\t\t\t<img src=\"" . NEWSTATIC_ROOT . "/icon/voice2.png\" class=\"voice2\" />\r\n\t\t\t\t\t\t\t\t\t" . $weidu . "\r\n\t\t\t\t\t\t\t\t\t<div class=\"flex1\"></div>\r\n\t\t\t\t\t\t\t\t</div>"; goto zS4hU; fcBYo: GfIYX: goto ATqIO; VvB3u: J7KoM: goto c6x20; fq5V7: if ($v["type"] == 5) { goto GfIYX; } goto Ztq6j; hrDWp: if ($v["openid"] != $openid) { goto illUa; } goto Nul8S; Z3I6p: $chatconhtml = "<div class=\"concon\"><img src=\"" . $v["content"] . "\" class=\"sssbbb\" /></div>"; goto jVV3z; Uto4f: $conhtml = "<div class=\"con flex1 flex\">"; goto Pfij8; GX9EO: $class = "left"; goto GJFhv; Nul8S: $class = "right"; goto Uto4f; pf01c: goto bk9XR; goto yBi8T; c6x20: if ($v["type"] == 3 || $v["type"] == 4) { goto sT2HN; } goto fq5V7; kXFI3: $html .= $htmltime . "<div class=\"" . $class . " flex\">\r\n\t\t\t\t\t\t\t\t\t<img src=\"" . $v["avatar"] . "\" class=\"avatar\" />\r\n\t\t\t\t\t\t\t\t\t" . $conhtml . "\r\n\t\t\t\t\t\t\t\t\t\t<div class=\"triangle-" . $class . "\"></div>\r\n\t\t\t\t\t\t\t\t\t\t" . $chatconhtml . "\r\n\t\t\t\t\t\t\t\t\t\t<div class=\"flex1\"></div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>"; goto FNrTz; FNrTz: m628U: goto mlKA0; RspB2: $weidu = "<span class=\"weidu\">未读</span>"; goto tsV5M; yBi8T: MI00I: goto RspB2; gMoJ9: goto RIRJa; goto ew9JA; Pfij8: goto J7KoM; goto M90yH; M90yH: illUa: goto GX9EO; mlKA0: } goto MVZEK; JYM7t: $html = ''; goto pUbY6; vtjc2: } public function doMobileTuichuqun() { goto cFwyd; B3of6: pdo_update(BEST_GROUPMEMBER, $datag, array("weid" => $_W["uniacid"], "groupid" => $groupid, "openid" => $openid)); goto S01lg; sB5ya: $resArr["msg"] = "您不是群成员！"; goto eijDq; UFh_J: owWBH: goto Ozj33; ThKZ5: $resArr["msg"] = "退出成功！"; goto k3fZx; i0n9Z: $resArr["error"] = 1; goto ThKZ5; khTpI: exit; goto K8Hlm; TGGZB: if (!empty($has)) { goto owWBH; } goto Q_6_8; cFwyd: global $_GPC, $_W; goto oJiji; Nh5sp: $group = pdo_fetch("SELECT groupname,admin FROM " . tablename(BEST_GROUP) . " WHERE weid = {$_W["uniacid"]} AND id = {$groupid}"); goto rPt5V; Q_6_8: $resArr["error"] = 1; goto sB5ya; CW2QY: $res = $acc->sendCustomNotice($send); goto i0n9Z; k3fZx: echo json_encode($resArr); goto w6qlG; falk5: echo json_encode($resArr); goto khTpI; cofiG: exit; goto UFh_J; rPt5V: if (!($group["admin"] == $openid)) { goto Kps2U; } goto uWkJl; bR_lZ: $send["touser"] = $group["admin"]; goto TI8Bc; uWkJl: $resArr["error"] = 1; goto nlpq9; yZTE3: Kps2U: goto QyMD1; w6qlG: exit; goto Bvql2; OFiga: exit; goto yZTE3; S01lg: $concon = $has["nickname"] . "退出了" . $group["groupname"] . "！"; goto bR_lZ; oJiji: $groupid = intval($_GPC["groupid"]); goto fYQjS; PKHvZ: if (!($groupid == 0 || $openid == '')) { goto r5eho; } goto KfLCj; eijDq: echo json_encode($resArr); goto cofiG; K8Hlm: r5eho: goto Nh5sp; Ozj33: $datag["isdel"] = 1; goto B3of6; PXijf: $acc = WeAccount::create($_W["uniacid"]); goto CW2QY; QyMD1: $has = pdo_fetch("SELECT id,nickname FROM " . tablename(BEST_GROUPMEMBER) . " WHERE weid = {$_W["uniacid"]} AND groupid = {$groupid} AND openid = '{$openid}'"); goto TGGZB; LyhzF: $send["text"] = array("content" => urlencode($concon)); goto PXijf; nlpq9: $resArr["msg"] = "管理员不能退群！"; goto ZxsEE; ZxsEE: echo json_encode($resArr); goto OFiga; KfLCj: $resArr["error"] = 1; goto i18gM; fYQjS: $openid = $_W["fans"]["from_user"]; goto PKHvZ; i18gM: $resArr["msg"] = "参数传输错误！"; goto falk5; TI8Bc: $send["msgtype"] = "text"; goto LyhzF; Bvql2: } public function doWebAdv() { include_once ROOT_PATH . "inc/web/adv.php"; } public function doWebKehu() { include_once ROOT_PATH . "inc/web/kehu.php"; } public function doWebZaixian() { include_once ROOT_PATH . "inc/web/zaixian.php"; } public function doWebCjwt() { include_once ROOT_PATH . "inc/web/cjwt.php"; } public function doWebZdhf() { include_once ROOT_PATH . "inc/web/zdhf.php"; } public function doWebTongji() { include_once ROOT_PATH . "inc/web/tongji.php"; } public function doWebXcx() { include_once ROOT_PATH . "inc/web/xcx.php"; } public function doWebXcxcservice() { include_once ROOT_PATH . "inc/web/xcxcservice.php"; } public function checkSignature($xcx, $echostr) { goto RmpHz; ymb0j: pdo_update(BEST_XCX, array("status" => 1), array("id" => $xcx["id"])); goto GBQb8; SkFlc: $tmpStr = implode($tmpArr); goto Ipwva; GBQb8: echo $echostr; goto IDCs7; LdD6m: PoJq1: goto ymb0j; Do8BK: $timestamp = $_GET["timestamp"]; goto TgUp4; oS8s9: exit; goto GIaLw; mEfMR: echo false; goto oS8s9; L2FOu: sort($tmpArr, SORT_STRING); goto SkFlc; IDCs7: exit; goto DmCrR; U_g8w: if ($tmpStr == $signature) { goto PoJq1; } goto Br0Ft; GIaLw: goto VROnO; goto LdD6m; Ipwva: $tmpStr = sha1($tmpStr); goto U_g8w; DmCrR: VROnO: goto nJJNz; TgUp4: $nonce = $_GET["nonce"]; goto bMyvo; RmpHz: $token = $xcx["token"]; goto ZOHQz; Br0Ft: pdo_update(BEST_XCX, array("status" => 2), array("id" => $xcx["id"])); goto mEfMR; bMyvo: $tmpArr = array($token, $timestamp, $nonce); goto L2FOu; ZOHQz: $signature = $_GET["signature"]; goto Do8BK; nJJNz: } public function doMobileXcxjt() { goto zglJJ; pJAr9: b2r9d: goto fmDAS; SjJSg: zSEqv: goto rvb20; fmDAS: $this->checkSignature($xcx, $_GET["echostr"]); goto SjJSg; Q1ChL: goto zSEqv; goto pJAr9; zglJJ: global $_GPC, $_W; goto zKuUz; YyV5J: if (isset($_GET["echostr"])) { goto b2r9d; } goto BV6VQ; BV6VQ: $this->responseMsg(); goto Q1ChL; zKuUz: $xcxid = intval($_GPC["id"]); goto qYUIB; qYUIB: $xcx = pdo_fetch("SELECT * FROM " . tablename(BEST_XCX) . " WHERE id = {$xcxid}"); goto YyV5J; rvb20: } public function testwri($txt) { goto TzgIM; TzgIM: $myfile = fopen("xcx.txt", "w") or die("Unable to open file!"); goto BCoxX; BCoxX: fwrite($myfile, $txt); goto ZRmEO; ZRmEO: fclose($myfile); goto haUMs; haUMs: } public function responseMsg() { goto GOeuM; qCKf7: goto B15HI; goto CcIDl; oVG1Q: $this->addxcxchat($postArr); goto pQhd1; rHSzx: p0DXE: goto YC_c9; Rt4Ja: if (!empty($postArr["MsgType"]) && $postArr["MsgType"] == "text") { goto evrwP; } goto cjz8I; kAICo: if ($postArr["MsgType"] == "event" && $postArr["Event"] == "user_enter_tempsession") { goto rvezF; } goto FFoJJ; GbXjM: $this->addxcxfanskefu($postArr); goto rHSzx; fWj7x: $this->addxcxchat($postArr); goto QzcD7; Z7t_a: echo "success"; goto b2d1O; pQhd1: goto p0DXE; goto qIaqC; Q55xy: DSjhI: goto oVG1Q; YOc7k: $postArr = json_decode($postStr, true); goto Rt4Ja; cjz8I: if (!empty($postArr["MsgType"]) && $postArr["MsgType"] == "image") { goto DSjhI; } goto kAICo; WOK_I: if (!empty($postStr) && is_string($postStr)) { goto apfKI; } goto Z7t_a; qIaqC: rvezF: goto GbXjM; GOeuM: $postStr = file_get_contents("php://input"); goto WOK_I; QzcD7: goto p0DXE; goto Q55xy; O47Ug: evrwP: goto fWj7x; CcIDl: apfKI: goto YOc7k; K6gBj: goto p0DXE; goto O47Ug; b2d1O: exit; goto qCKf7; YC_c9: B15HI: goto VaOki; FFoJJ: exit("aaa"); goto K6gBj; VaOki: } public function addxcxchat($postArr) { goto kDdIl; ei9e2: $content = emoji_unified_to_html($content); goto kdFFM; g97Nj: $newavatar = $has["fansavatar"]; goto h15EI; r4X5o: $data["content"] = $picres; goto PoMkA; nlXXF: $datachat["url"] = $hasauto["url"]; goto vUJsF; BELLq: $content = emoji_docomo_to_unified($postArr["Content"]); goto ei9e2; exvRA: if (!($postArr["MsgType"] == "image")) { goto yrYRi; } goto aQ3g6; oPJ0r: if (empty($hasauto)) { goto j2fcX; } goto KXdP7; Q2x14: $data["msgtype"] = $postArr["MsgType"]; goto cGeA8; ryfxu: $dataup["lasttime"] = $postArr["CreateTime"]; goto cYaiP; tNWPa: $data["toopenid"] = $kefuopenid; goto Q2x14; xlN0h: $data["weid"] = $_W["uniacid"]; goto Yeln0; Uimuq: OhLUD: goto kc3kD; kf2M0: $dataup["notread"] = $has["notread"] + 1; goto ryfxu; h5vMv: goto WlOCT; goto Lug1Y; ewqSf: NRAHf: goto exvRA; vODx9: goto HoVZG; goto ttohR; dD3tk: $datachat["weid"] = $_W["uniacid"]; goto mZZ6b; zRanv: $this->addxcxchat2($fansopenid, "没有匹配到客服哦~~", "text", $xcx["gh_id"]); goto vODx9; RbJcK: include_once ROOT_PATH . "emoji/emoji.php"; goto B2zgy; jWr2C: $newnickname = "[" . $xcx["name"] . "]" . $has["fansnickname"]; goto g97Nj; wWBd_: if (!($hasauto["msgtype"] == "link")) { goto OhLUD; } goto YfRrv; yjPpu: $data["mediaId"] = $postArr["MediaId"]; goto SNUYW; tgdd8: $chatcontent = $hasauto["title"]; goto wGPq2; mNhBn: $addres = $this->addxcxchat2($has["fansopenid"], $hasauto["thumb"], $hasauto["msgtype"], $has["gh_id"]); goto s0csu; KXdP7: if (!($hasauto["msgtype"] == "text")) { goto IdNcd; } goto tgdd8; zHmUb: $datachat["gh_id"] = $has["gh_id"]; goto zJMLc; JNfH1: $chatcontent = $hasauto["thumb"] = tomedia($hasauto["thumb"]); goto mNhBn; fiKUf: pdo_insert(BEST_XCXCHAT, $data); goto kf2M0; KAVkL: $post_url = "https://socket.qiumipai.com:2121/?type=xcxpublish&to=" . $has["kefuopenid"] . "&notread=" . $notread . "&newavatar=" . $newavatar . "&content=" . $data["content"] . "&msgtype=" . $data["msgtype"] . "&toopenid=" . $has["fansopenid"] . "&fkid=" . $has["id"] . "&newnickname=" . $newnickname; goto cDDbX; lrfYp: $has = pdo_fetch("SELECT * FROM " . tablename(BEST_XCXFANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND fansopenid = '{$fansopenid}' AND nowkefu = 1 AND gh_id = '{$gh_id}'"); goto LhuYN; YzsrI: $datachat["title"] = $hasauto["title"]; goto PUr4e; TBa6c: ihttp_request($post_url); goto fpn6J; or9mF: if (!($postArr["MsgType"] == "text")) { goto NRAHf; } goto BELLq; k3h1w: $datachat["content"] = $chatcontent; goto h5vMv; nHKk3: $zdconlink["url"] = $hasauto["url"]; goto Gno52; Hyrer: goto xTHEW; goto ufO4s; U4AlT: $datachat["openid"] = $has["kefuopenid"]; goto Y93IT; lUeAF: $hasauto = pdo_fetch("SELECT * FROM " . tablename(BEST_XCXAUTO) . " WHERE weid = {$_W["uniacid"]} AND kfid = {$cservice["id"]} AND iszdhf = 1 AND zdhftype = 0 AND INSTR('{$data["content"]}',zdhftitle)"); goto ZMJaa; Y93IT: $datachat["toopenid"] = $has["fansopenid"]; goto zHmUb; aQ3g6: $picres = $this->xcximgsave($postArr["PicUrl"]); goto e1pJM; sUTyb: $data["time"] = $postArr["CreateTime"]; goto p5PKg; DRv2f: $data["openid"] = $fansopenid; goto tNWPa; cYaiP: $dataup["msgtype"] = $postArr["MsgType"]; goto UfBe4; PoMkA: xTHEW: goto yjPpu; Lug1Y: yHEAT: goto YzsrI; Xq2Wj: $kefuopenid = $cservice["content"]; goto d1K53; s49RU: $zdconlink["description"] = $hasauto["description"]; goto nHKk3; ttohR: Kt_rl: goto or9mF; uGLhp: IdNcd: goto OCGYP; YfRrv: $zdconlink["title"] = $hasauto["title"]; goto s49RU; GrTnr: $fansopenid = $postArr["FromUserName"]; goto a0Ath; Yeln0: $data["fkid"] = $has["id"]; goto DRv2f; zJMLc: $datachat["time"] = $addres["time"]; goto dD3tk; ufO4s: NGMZR: goto r4X5o; cDDbX: load()->func("communication"); goto TBa6c; mZZ6b: $datachat["fkid"] = $has["id"]; goto D_Aas; Gno52: $zdconlink["thumb_url"] = tomedia($hasauto["thumb_url"]); goto TepkI; D_Aas: $datachat["msgtype"] = $hasauto["msgtype"]; goto xHPv8; TepkI: $addres = $this->addxcxchat2($has["fansopenid"], $zdconlink, $hasauto["msgtype"], $has["gh_id"]); goto Uimuq; d1K53: if (!empty($has)) { goto Kt_rl; } goto zRanv; OCGYP: if (!($hasauto["msgtype"] == "image")) { goto lcxhU; } goto JNfH1; wGPq2: $addres = $this->addxcxchat2($has["fansopenid"], $hasauto["title"], $hasauto["msgtype"], $has["gh_id"]); goto uGLhp; cGeA8: $data["gh_id"] = $gh_id; goto sUTyb; mPLbh: l9d8g: goto lC9Dm; C8BBJ: if (!empty($hasauto)) { goto G78s0; } goto lUeAF; FoidM: $hasauto = pdo_fetch("SELECT * FROM " . tablename(BEST_XCXAUTO) . " WHERE weid = {$_W["uniacid"]} AND kfid = {$cservice["id"]} AND iszdhf = 1 AND zdhftype = 1 AND zdhftitle = '{$data["content"]}'"); goto C8BBJ; h15EI: $notread = $has["notread"] + 1; goto KAVkL; NEHes: $data["content"] = $postArr["PicUrl"]; goto Hyrer; fpn6J: $this->xcxtzkefu($kefuopenid, $has["lasttime"], $has["id"], $dataup["lastcon"], $xcx["name"], $has["fansnickname"]); goto R5KRZ; SEC_d: WlOCT: goto U4AlT; kdFFM: $data["content"] = $content; goto mq2xs; vUJsF: $datachat["thumb_url"] = tomedia($hasauto["thumb_url"]); goto SEC_d; UfBe4: pdo_update(BEST_XCXFANSKEFU, $dataup, array("id" => $has["id"])); goto FoidM; e1pJM: if ($picres != '') { goto NGMZR; } goto NEHes; PUr4e: $datachat["description"] = $hasauto["description"]; goto nlXXF; kDdIl: global $_GPC, $_W; goto RbJcK; R5KRZ: HoVZG: goto Hopiu; lC9Dm: j2fcX: goto jWr2C; LhuYN: $cservice = pdo_fetch("SELECT * FROM " . tablename(BEST_XCXCSERVICE) . " WHERE weid = {$_W["uniacid"]} AND content = '{$has["kefuopenid"]}' AND xcxid = {$xcx["id"]}"); goto Xq2Wj; kc3kD: if (!($addres["errcode"] == "0")) { goto l9d8g; } goto a510F; B2zgy: $xcx = pdo_fetch("SELECT * FROM " . tablename(BEST_XCX) . " WHERE uniacid = {$_W["uniacid"]} AND gh_id = '{$postArr["ToUserName"]}'"); goto GrTnr; p5PKg: $data["msgid"] = $postArr["MsgId"]; goto fiKUf; SNUYW: $dataup["lastcon"] = "[图片消息]"; goto Q8qEs; xHPv8: pdo_insert(BEST_XCXCHAT, $datachat); goto mPLbh; s0csu: lcxhU: goto wWBd_; mq2xs: $dataup["lastcon"] = preg_replace("/\\xEE[\\x80-\\xBF][\\x80-\\xBF]|\\xEF[\\x81-\\x83][\\x80-\\xBF]/", "[无法识别字符]", $postArr["Content"]); goto ewqSf; Q8qEs: yrYRi: goto xlN0h; ZMJaa: G78s0: goto oPJ0r; a0Ath: $gh_id = $postArr["ToUserName"]; goto lrfYp; a510F: if ($hasauto["msgtype"] == "link") { goto yHEAT; } goto k3h1w; Hopiu: } public function xcximgsave($picUrl) { goto VtLTK; Cc7SY: return 0; goto lkArK; FIKzy: if ($this->module["config"]["isqiniu"] == 3) { goto RMiCV; } goto RZPem; Tr1w8: return $this->module["config"]["qiniuurl"] . "/" . $randimgurl; goto INfMw; jQckE: exit; goto s4BrX; Iqfiq: fclose($fp); goto dL4jK; U2Klx: curl_close($ch); goto Iqfiq; T4umd: l6Ctm: goto ry_Z3; gTnTC: bzNz7: goto UZ1Q6; RZPem: goto qfSpt; goto VxQTl; INfMw: exit; goto Gb5tb; kS9Mq: mkdir($updir, 0777, true); goto C4G0C; PPiO6: exit; goto rPSAk; BYy1i: if (!($img_info[0] > 1200)) { goto qFxH6; } goto h3aeA; dL4jK: if (file_exists($targetName)) { goto YZcnj; } goto mFTYa; ry_Z3: goto qfSpt; goto bwexH; Glhjj: return tomedia($randimgurl); goto z53UF; s4BrX: goto ENT9h; goto IDqi1; Y_BKx: $remotestatus = file_remote_upload($randimgurl, true); goto ZyvO1; sR_Yx: YZcnj: goto NuTg3; bgKOb: return tomedia($randimgurl); goto jQckE; ODXfF: $ch = curl_init($picUrl); goto Ws02n; BBk5k: if (is_error($remotestatus)) { goto R98AA; } goto Tr1w8; ZyvO1: if (is_error($remotestatus)) { goto R0YVR; } goto bgKOb; x2EfO: $updir = "../attachment/images/" . $_W["uniacid"] . "/" . date("Y", time()) . "/" . date("m", time()) . "/"; goto oktmH; svFHj: $targetName = "../attachment/" . $randimgurl; goto ODXfF; ZCwDj: if ($this->module["config"]["isqiniu"] == 1) { goto cy7ow; } goto FIKzy; Gb5tb: goto l6Ctm; goto gfDsp; rPSAk: ENT9h: goto gTnTC; Vvphe: return 0; goto PPiO6; mFTYa: return 0; goto smMM9; lIMP1: if (empty($_W["setting"]["remote"]["type"])) { goto bzNz7; } goto WwVJN; z53UF: exit; goto MC1Q2; C4G0C: frS14: goto v27np; VxQTl: cy7ow: goto KOcLP; QjQUY: curl_setopt($ch, CURLOPT_FILE, $fp); goto LRZj0; smMM9: exit; goto jsbyT; UZ1Q6: qfSpt: goto Glhjj; VtLTK: global $_W, $_GPC; goto x2EfO; bwexH: RMiCV: goto lIMP1; hG4xz: qFxH6: goto ZCwDj; gfDsp: R98AA: goto Cc7SY; jsbyT: goto P5siD; goto sR_Yx; Ws02n: $fp = fopen($targetName, "wb"); goto QjQUY; KOcLP: $remotestatus = $this->doQiuniu($randimgurl, true); goto BBk5k; MC1Q2: P5siD: goto YggYm; IDqi1: R0YVR: goto Vvphe; h3aeA: $this->mkThumbnail($targetName, 1200, null, $targetName); goto hG4xz; v27np: $randimgurl = "images/" . $_W["uniacid"] . "/" . date("Y", time()) . "/" . date("m", time()) . "/" . date("YmdHis") . rand(1000, 9999) . ".jpg"; goto svFHj; LRZj0: curl_setopt($ch, CURLOPT_HEADER, 0); goto ko7jP; oktmH: if (file_exists($updir)) { goto frS14; } goto kS9Mq; NuTg3: $img_info = getimagesize($targetName); goto BYy1i; WwVJN: load()->func("file"); goto Y_BKx; ko7jP: curl_exec($ch); goto U2Klx; lkArK: exit; goto T4umd; YggYm: } public function doMobileServicechatajaxxcx() { goto VFNnV; LKHmp: $timestamp = TIMESTAMP; goto Ai3Ts; Cs5f9: $nowjl = 0; goto lbfk8; VFNnV: global $_W, $_GPC; goto hmNKY; oMowA: WKtHO: goto yuRc7; VvZdF: if (!($nowjl < 0)) { goto AJ0Xt; } goto Cs5f9; rANqr: $nowjl = $total - $pindex * $psize; goto VvZdF; zdZ2C: $fkarr = array(); goto TMlNc; b_Q28: foreach ($chatcon as $k => $v) { goto KLZpe; asKQv: p3YOj: goto hhH45; GkhC0: WC22H: goto Xou5_; e_YvR: It7uo: goto tbIMd; Xou5_: if (!($v["msgtype"] == "text")) { goto FJGFK; } goto qmJQc; IORNf: $chatconhtml = "<div class=\"concon\"><img src=\"" . $v["content"] . "\" class=\"sssbbb\" /></div>"; goto UOtUI; qmJQc: $chatconhtml = "<div class=\"concon\">" . $v["content"] . "</div>"; goto dXZvD; TsaoA: $html .= "<div class=\"right flex\">\r\n\t\t\t\t\t\t\t<img src=\"" . $v["kefuavatar"] . "\" class=\"avatar\" />\r\n\t\t\t\t\t\t\t<div class=\"con flex flex1\">\r\n\t\t\t\t\t\t\t\t<div class=\"triangle-right\"></div>\r\n\t\t\t\t\t\t\t\t" . $chatconhtml . "\r\n\t\t\t\t\t\t\t\t<div class=\"flex1\"></div>\r\n\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t</div>"; goto uwBgA; hhH45: if (!($v["msgtype"] == "link")) { goto TXJjz; } goto ng81Y; ng81Y: $chatconhtml = "<div class=\"concon\">\r\n\t\t\t\t\t\t\t\t\t\t<a href=\"" . $v["url"] . "\">\r\n\t\t\t\t\t\t\t\t\t\t<div class=\"tuwen\">\r\n\t\t\t\t\t\t\t\t\t\t\t<div class=\"tuwen-title\">" . $v["title"] . "</div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div class=\"tuwen-bottom flex\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t<div class=\"tuwen-des\">" . $v["description"] . "</div>\r\n\t\t\t\t\t\t\t\t\t\t\t\t<img src=\"" . $v["thumb_url"] . "\" class=\"tuwen-img\" />\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t</a>\r\n\t\t\t\t\t\t\t\t\t</div>"; goto vhGrK; sYSWD: J7kxR: goto e_YvR; uwBgA: goto J7kxR; goto I41_s; KLZpe: $htmltime = !empty($v["time"]) ? "<div class=\"time text-c\">" . date("Y-m-d H:i:s", $v["time"]) . "</div>" : ''; goto DEmmM; vhGrK: TXJjz: goto TsaoA; zPWGa: $html .= $htmltime . "<div class=\"left flex\">\r\n\t\t\t\t\t\t\t\t\t\t<img src=\"" . $iimmgg . "\" class=\"avatar\" />\r\n\t\t\t\t\t\t\t\t\t\t<div class=\"con flex flex1\">\r\n\t\t\t\t\t\t\t\t\t\t\t<div class=\"triangle-left\"></div>\r\n\t\t\t\t\t\t\t\t\t\t\t" . $chatconhtml . "\r\n\t\t\t\t\t\t\t\t\t\t\t<div class=\"flex1\"></div>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</div>"; goto sYSWD; dXZvD: FJGFK: goto DFvt5; UOtUI: eoK6u: goto xA9DH; DFvt5: $iimmgg = $hasfanskefu["fansavatar"] != '' ? $hasfanskefu["fansavatar"] : "../addons/cy163_customerservice/static/xcx.png"; goto zPWGa; IsgrN: $chatconhtml = "<div class=\"concon\">" . $v["content"] . "</div>"; goto asKQv; ZWCjb: if (!($v["msgtype"] == "image")) { goto WC22H; } goto N8HQZ; N8HQZ: $chatconhtml = "<div class=\"concon\"><img src=\"" . $v["content"] . "\" class=\"sssbbb\" /></div>"; goto GkhC0; DEmmM: if ($v["openid"] == $hasfanskefu["fansopenid"]) { goto qkCEM; } goto LFPMJ; LFPMJ: if (!($v["msgtype"] == "image")) { goto eoK6u; } goto IORNf; I41_s: qkCEM: goto ZWCjb; xA9DH: if (!($v["msgtype"] == "text")) { goto p3YOj; } goto IsgrN; tbIMd: } goto COBc0; TMlNc: foreach ($fkidlist as $k => $v) { $fkarr[] = $v["id"]; dmEln: } goto iLvkT; UMfwG: $total = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename(BEST_XCXCHAT) . " WHERE fkid in (" . implode(",", $fkarr) . ")"); goto L3Whf; jypeR: $chatcon = pdo_fetchall("SELECT * FROM " . tablename(BEST_XCXCHAT) . " WHERE fkid in (" . implode(",", $fkarr) . ") ORDER BY time ASC LIMIT " . $nowjl . "," . $tolimit); goto LKHmp; Ai3Ts: $chatcontime = 0; goto liaCn; fiZ4u: goto bjBXu; goto AIJ3t; cbjou: $tolimit = $psize; goto oi8Il; l20xQ: $fkidlist = pdo_fetchall("SELECT id FROM " . tablename(BEST_XCXFANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND fansopenid = '{$hasfanskefu["fansopenid"]}' AND gh_id = '{$hasfanskefu["gh_id"]}'"); goto zdZ2C; L3Whf: $page = intval($_GPC["page"]); goto cL6bm; NMR_e: $hasfanskefu = pdo_fetch("SELECT * FROM " . tablename(BEST_XCXFANSKEFU) . " WHERE id = {$fkid}"); goto l20xQ; awnk1: echo $html; goto JegwV; oi8Il: bjBXu: goto jypeR; hmNKY: $fkid = intval($_GPC["fkid"]); goto NMR_e; JegwV: exit; goto OfInF; YXZtN: if ($total > $pindex * $psize) { goto qdRHC; } goto UbUSV; yuRc7: $html = ''; goto b_Q28; cL6bm: $pindex = max(1, $page); goto qT9H3; lbfk8: AJ0Xt: goto YXZtN; qT9H3: $psize = 10; goto HXzpH; HXzpH: $allpage = ceil($total / $psize) + 1; goto rANqr; UbUSV: $tolimit = $psize - ($pindex * $psize - $total); goto fiZ4u; COBc0: fVDm1: goto awnk1; iLvkT: qja9m: goto UMfwG; AIJ3t: qdRHC: goto cbjou; liaCn: foreach ($chatcon as $k => $v) { goto DWj2Q; VP04J: if ($v["time"] - $chatcontime > 7200) { goto V70rF; } goto WGa6y; YfuOr: QpTf_: goto Grkub; e08ub: $chatcon[$k]["kefuavatar"] = $newfk["kefuavatar"]; goto fjom1; dtxY8: V70rF: goto sSvcQ; UtGe6: goto QpTf_; goto dtxY8; sSvcQ: $chatcon[$k]["time"] = $v["time"]; goto YfuOr; DWj2Q: if (!($v["openid"] != $hasfanskefu["fansopenid"])) { goto bTuhq; } goto DNzMV; Grkub: XD1Rk: goto RU04X; DNzMV: $newfk = pdo_fetch("SELECT kefuavatar FROM " . tablename(BEST_XCXFANSKEFU) . " WHERE id = {$v["fkid"]}"); goto e08ub; fjom1: bTuhq: goto VP04J; WGa6y: $chatcon[$k]["time"] = ''; goto UtGe6; RU04X: } goto oMowA; OfInF: } public function doMobileMychatxcx() { goto VYZr0; QIeRr: echo json_encode($resArr, true); goto tr9wr; jh4st: kPSQK: goto T244O; bS2R6: if ($operation == "display") { goto Wkls2; } goto efd9X; dhWXi: echo $html; goto SlTAk; ynVe8: foreach ($chatlist as $kk => $vv) { goto nZz3M; IezFO: BGBxd: goto M6Oom; M6Oom: $con = preg_replace("/\\xEE[\\x80-\\xBF][\\x80-\\xBF]|\\xEF[\\x81-\\x83][\\x80-\\xBF]/", "[无法识别字符]", $vv["lastcon"]); goto bJGI0; SrFxe: $html .= "<div class=\"item flex textellipsis1 fkid" . $vv["id"] . "\">\r\n\t\t\t\t\t\t\t\t<a href=\"" . $this->createMobileUrl("xcxchat", array("fkid" => $vv["id"], "ssopenid" => $openid)) . "\" class=\"flex tohref textellipsis1 flex1\">\r\n\t\t\t\t\t\t\t\t\t<img src=\"" . $avatar . "\">" . $mychatbadge . "\r\n\t\t\t\t\t\t\t\t\t<div class=\"text textellipsis1 flex1\">\r\n\t\t\t\t\t\t\t\t\t\t<div class=\"name textellipsis1\">" . $vv["fansnickname"] . "</div>\r\n\t\t\t\t\t\t\t\t\t\t<div class=\"lastmsg textellipsis1\">" . $con . "</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</a>\r\n\t\t\t\t\t\t\t\t<div class=\"timedo\">\r\n\t\t\t\t\t\t\t\t\t<div class=\"time\">" . $this->getChatTimeStr($vv["lasttime"]) . "</div>\r\n\t\t\t\t\t\t\t\t\t<div class=\"dodel\" data-fkid=\"" . $vv["id"] . "\">删除</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</div>"; goto dEELj; JKFcF: goto h44Oc; goto IezFO; bJGI0: h44Oc: goto RwKD6; IvfIc: $mychatbadge = $vv["notread"] > 0 ? "<span class=\"mychatbadge\">" . $vv["notread"] . "</span>" : ''; goto SrFxe; RwKD6: $avatar = $vv["fansavatar"] != '' ? $vv["fansavatar"] : MD_ROOT . "static/xcx.png"; goto IvfIc; T140I: $con = "<span style=\"color:#900;\">[图片消息]</span>"; goto JKFcF; nZz3M: if ($vv["msgtype"] == "text") { goto BGBxd; } goto T140I; dEELj: wFGo8: goto enme6; enme6: } goto EKfRW; hk9Pv: include $this->template("mychatxcx"); goto UNmuI; KhG6k: pdo_delete(BEST_XCXFANSKEFU, array("id" => $fkid)); goto us_ga; w3hil: goto QgftZ; goto kX2Bn; XZazL: $openid = $ssopenid; goto yfZnp; IZQU0: $page = intval($_GPC["page"]); goto wxeb6; ifa60: $allwei = empty($allwei) ? 0 : $allwei; goto hk9Pv; N5BOg: YTQZy: goto P0i0k; Ij305: $chatlist = pdo_fetchall("SELECT * FROM " . tablename(BEST_XCXFANSKEFU) . " WHERE kefuopenid = '{$openid}' AND lastcon != '' ORDER BY notread DESC,lasttime DESC LIMIT " . ($pindex - 1) * $psize . "," . $psize); goto sRpxC; wxeb6: $pindex = max(1, $page); goto Ij305; us_ga: $resArr["error"] = 0; goto biuHA; NYjXM: if (!($isajax == 1)) { goto YTQZy; } goto gylv2; UNmuI: goto QgftZ; goto jh4st; YPw7s: $ssopenid = $_GPC["ssopenid"]; goto e7gmf; Dt_LM: $isajax = intval($_GPC["isajax"]); goto NYjXM; kX2Bn: Wkls2: goto Z_K_O; T244O: $fkid = intval($_GPC["fkid"]); goto g40Dn; yfZnp: iLiaf: goto nNyoE; SlTAk: exit; goto N5BOg; g40Dn: pdo_delete(BEST_XCXCHAT, array("fkid" => $fkid)); goto KhG6k; VWHeu: $allpage = ceil($total / $psize) + 1; goto IZQU0; e7gmf: if (!($ssopenid != '' && empty($openid))) { goto iLiaf; } goto XZazL; biuHA: $resArr["message"] = "恭喜您，删除聊天记录成功！"; goto QIeRr; JMkoY: $total = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename(BEST_XCXFANSKEFU) . " WHERE kefuopenid = '{$openid}' AND lastcon != ''"); goto VWHeu; sRpxC: foreach ($chatlist as $kk => $vv) { goto PygPB; lgKdo: $biaoqian = pdo_fetch("SELECT name FROM " . tablename(BEST_BIAOQIAN) . " WHERE kefuopenid = '{$vv["kefuopenid"]}' AND fensiopenid = '{$vv["fansopenid"]}'"); goto YHxjw; cy6XA: goto VxJS5; goto Hoy8c; ujMNJ: if (!empty($biaoqian)) { goto QcbbK; } goto B8kDI; n1sPv: VxJS5: goto fnSY1; Hoy8c: QcbbK: goto vJlu9; vJlu9: $chatlist[$kk]["fansnickname"] = "[" . $xcxres["name"] . "][" . $biaoqian["name"] . "]" . $vv["fansnickname"]; goto n1sPv; YHxjw: $vv["fansnickname"] = $vv["fansnickname"] == '' ? "用户" : $vv["fansnickname"]; goto ujMNJ; PygPB: $xcxres = pdo_fetch("SELECT name FROM " . tablename(BEST_XCX) . " WHERE gh_id = '{$vv["gh_id"]}'"); goto lgKdo; B8kDI: $chatlist[$kk]["fansnickname"] = "[" . $xcxres["name"] . "]" . $vv["fansnickname"]; goto cy6XA; fnSY1: ui5YX: goto MR7GE; MR7GE: } goto nioHP; gylv2: $html = ''; goto ynVe8; nNyoE: $operation = !empty($_GPC["op"]) ? $_GPC["op"] : "display"; goto bS2R6; efd9X: if ($operation == "delete") { goto kPSQK; } goto w3hil; Z_K_O: $psize = 20; goto JMkoY; EKfRW: KTfJO: goto dhWXi; Z6PdP: $openid = $_W["fans"]["from_user"]; goto YPw7s; tr9wr: exit; goto p0ONE; VYZr0: global $_W, $_GPC; goto Z6PdP; nioHP: wHjV9: goto Dt_LM; P0i0k: $allwei = pdo_fetchcolumn("SELECT SUM(notread) FROM " . tablename(BEST_XCXFANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND kefuopenid = '{$openid}'"); goto ifa60; p0ONE: QgftZ: goto sTgI2; sTgI2: } public function doMobileAjaxallwei() { goto T4ExT; s_xpP: $openid = $_W["fans"]["from_user"]; goto Uivli; Uivli: $allwei = pdo_fetchcolumn("SELECT SUM(notread) FROM " . tablename(BEST_XCXFANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND kefuopenid = '{$openid}'"); goto Odwg9; T4ExT: global $_GPC, $_W; goto s_xpP; Odwg9: echo $allwei = empty($allwei) ? 0 : $allwei; goto Uc3vD; Uc3vD: } public function getChatTimeStr($addTime) { goto hNmPp; mh8KK: $timeStr .= $addTime[5] . ":" . $addTime[6]; goto aiSMX; siC1W: bAy_M: goto n27d6; S8eq2: $timeStr .= "昨天 " . $addTime[5] . ":" . $addTime[6] . " "; goto JzZxf; wuaaR: $nowTime = explode(",", date("Y,n,j,w,a,h,i,y", $nowTime)); goto MEW1x; hNmPp: $nowTime = TIMESTAMP; goto NK04Z; NK04Z: if (!($addTime > $nowTime)) { goto bAy_M; } goto ExST5; Nljmv: C6fYb: goto f6Lh3; ExST5: return ''; goto siC1W; KqilL: $addTime = explode(",", date("Y,n,j,w,a,h,i,y", $addTime)); goto wuaaR; nMXO0: goto kVlZS; goto Vn1Ez; W_syA: if ($addTime[0] == $nowTime[0] && $addTime[1] == $nowTime[1] && $addTime[2] == $nowTime[2] - 1 || $addTime[0] == $nowTime[0] && $nowTime[1] - $addTime[1] == 1 && $dayPerMonthAddTime[$addTime[1]] == $addTime[2] && $nowTime[2] == 1 || $nowTime[0] - $addTime[0] == 1 && $addTime[1] == 12 && $addTime[2] == 31 && $nowTime[1] == 1 && $nowTime[2] == 1) { goto Q_R13; } goto FumLT; yiMWU: LE0zV: goto mh8KK; U5Pbr: $timeStr .= " 上午"; goto yiMWU; KELxz: if (!($addTime[4] == "pm")) { goto C6fYb; } goto gq1AQ; FumLT: if ($addTime[0] == $nowTime[0] && $addTime[1] == $nowTime[1] && $nowTime[2] - $addTime[2] < 7 || ($addTime[0] == $nowTime[0] && $nowTime[1] - $addTime[1] == 1 && $dayPerMonthAddTime[$addTime[1]] - $addTime[2] + $nowTime[2] < 7 || $nowTime[0] - $addTime[0] == 1 && $addTime[1] == 12 && $nowTime[1] == 1 && 31 - $addTime[2] + $nowTime[2] < 7)) { goto coJx5; } goto TtwKp; TtwKp: $timeStr .= $addTime[7] . "/" . $addTime[1] . "/" . $addTime[2]; goto yx8WV; rwZIt: if ($addTime[0] == $nowTime[0] && $addTime[1] == $nowTime[1] && $addTime[2] == $nowTime[2]) { goto et789; } goto W_syA; MEW1x: $dayPerMonthAddTime = $this->getDayPerMonth($addTime[0]); goto QwFQD; C9qdt: coJx5: goto oNkZV; vzP82: AK2y4: goto nMXO0; zdkuC: return $timeStr; goto S2X22; f6Lh3: goto LE0zV; goto cvSc7; n27d6: $timeStr = ''; goto KqilL; M1OmA: goto b4Gy2; goto VLdjl; aiSMX: b4Gy2: goto zdkuC; cvSc7: wrqeY: goto U5Pbr; Vn1Ez: Q_R13: goto S8eq2; QwFQD: $week = array(0 => "星期日", 1 => "星期一", 2 => "星期二", 3 => "星期三", 4 => "星期四", 5 => "星期五", 6 => "星期六"); goto rwZIt; yx8WV: goto AK2y4; goto C9qdt; ZtSnM: if ($addTime[4] == "am") { goto wrqeY; } goto KELxz; VLdjl: et789: goto ZtSnM; gq1AQ: $timeStr .= " 下午"; goto Nljmv; JzZxf: kVlZS: goto M1OmA; oNkZV: $timeStr .= $week[$addTime[3]]; goto vzP82; S2X22: } public function getDayPerMonth($year) { goto XUk4U; QoxCB: UP3La: goto yNdC6; yNdC6: return $arr; goto n2C49; XUk4U: $arr = array(1 => 31, 3 => 31, 4 => 30, 5 => 31, 6 => 30, 7 => 31, 8 => 31, 9 => 30, 10 => 31, 11 => 30, 12 => 31); goto yEOUX; yEOUX: if ($year % 4 == 0 && $year % 100 != 0 || $year % 400 == 0) { goto xa8xy; } goto LPB6Y; zT_RL: $arr[2] = 29; goto QoxCB; kiuS1: goto UP3La; goto OAMQg; OAMQg: xa8xy: goto zT_RL; LPB6Y: $arr[2] = 28; goto kiuS1; n2C49: } public function doMobileXcxchat() { goto NDoUf; rWWLf: c4mY3: goto Ob2NX; VwhWq: $psize = 10; goto EzK3j; HpLLY: $cservice = pdo_fetch("SELECT * FROM " . tablename(BEST_XCXCSERVICE) . " WHERE weid = {$_W["uniacid"]} AND content = '{$openid}'"); goto hNWoS; bX3IO: $openid = $ssopenid; goto yWmUQ; IkB0o: if (!($ssopenid != '' && empty($openid))) { goto fxHme; } goto bX3IO; urdq6: $chatcontime = 0; goto Nt5Fy; c1jP0: $nowjl = $total - $pindex * $psize; goto YWvBD; CfUuy: $pindex = max(1, $page); goto VwhWq; Pn0Iy: Dmii3: goto Afnlk; RIluL: $page = intval($_GPC["page"]); goto CfUuy; Z_nCE: cu0O1: goto Fb0oY; Sc72f: $fkidlist = pdo_fetchall("SELECT id FROM " . tablename(BEST_XCXFANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND fansopenid = '{$hasfanskefu["fansopenid"]}' AND gh_id = '{$hasfanskefu["gh_id"]}'"); goto m6jhA; Ob2NX: $chatcon = pdo_fetchall("SELECT * FROM " . tablename(BEST_XCXCHAT) . " WHERE fkid in (" . implode(",", $fkarr) . ") ORDER BY time ASC LIMIT " . $nowjl . "," . $psize); goto urdq6; gQ3Ww: $message = "请在微信浏览器中打开！"; goto OQg6V; NFS3W: $hasfanskefu = pdo_fetch("SELECT * FROM " . tablename(BEST_XCXFANSKEFU) . " WHERE id = {$fkid}"); goto BbTgR; lmkb2: foreach ($fkidlist as $k => $v) { $fkarr[] = $v["id"]; kBYjR: } goto Z_nCE; By7AY: exit; goto Yjemm; EzK3j: $allpage = ceil($total / $psize) + 1; goto c1jP0; Fb0oY: $total = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename(BEST_XCXCHAT) . " WHERE fkid in (" . implode(",", $fkarr) . ")"); goto RIluL; YWvBD: if (!($nowjl < 0)) { goto c4mY3; } goto flpCe; vb6VL: exit; goto KB_Vj; j2gxL: $othercservice = pdo_fetchall("SELECT * FROM " . tablename(BEST_XCXCSERVICE) . " WHERE weid = {$_W["uniacid"]} AND xcxid = {$cservice["xcxid"]} AND content != '{$openid}' ORDER BY displayorder ASC"); goto YyqZQ; w31v5: $ssopenid = $_GPC["ssopenid"]; goto IkB0o; S6EDW: pdo_update(BEST_XCXFANSKEFU, array("notread" => 0), array("id" => $hasfanskefu["id"])); goto XSlft; mK41k: $fkid = intval($_GPC["fkid"]); goto LxFVm; KB_Vj: r7icc: goto NFS3W; xrQCA: include $this->template("error"); goto vb6VL; BbTgR: $xcxres = pdo_fetch("SELECT * FROM " . tablename(BEST_XCX) . " WHERE gh_id = '{$hasfanskefu["gh_id"]}'"); goto Sc72f; B1O3q: if (!empty($openid)) { goto QyGL1; } goto gQ3Ww; Afnlk: $kefuauto = empty($cservice["kefuauto"]) ? '' : explode("|", $cservice["kefuauto"]); goto S6EDW; LmqbH: $message = "你不是客服身份，请联系管理员查看具体信息！"; goto xrQCA; hNWoS: if (!empty($cservice)) { goto r7icc; } goto LmqbH; Nt5Fy: foreach ($chatcon as $k => $v) { goto clFga; n23dE: $chatcon[$k]["time"] = ''; goto jz82y; Bhpp8: Pzfux: goto VrKkN; N2lgc: preg_match_all($regex, $chatcon[$k]["content"], $array2); goto yaJQY; yaJQY: if (!(!empty($array2[0]) && $v["msgtype"] == "text")) { goto cXtM_; } goto lxQaa; vKbT1: $chatcon[$k]["content"] = qqface_convert_html($chatcon[$k]["content"]); goto EChJi; UAfNf: $newfk = pdo_fetch("SELECT kefuavatar FROM " . tablename(BEST_XCXFANSKEFU) . " WHERE id = {$v["fkid"]}"); goto hRXa7; qQJ9_: cXtM_: goto C2PVa; EChJi: $chatcon[$k]["content"] = preg_replace("/\\xEE[\\x80-\\xBF][\\x80-\\xBF]|\\xEF[\\x81-\\x83][\\x80-\\xBF]/", "[无法识别字符]", $chatcon[$k]["content"]); goto LEWwi; jgrN7: bi1ml: goto qQJ9_; OSZ68: FyMuB: goto drTdG; LEWwi: $regex = "@(?i)\\b((?:[a-z][\\w-]+:(?:/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?«»“”‘’]))@"; goto N2lgc; H10fF: BjGb7: goto vKbT1; VrKkN: $chatcon[$k]["time"] = $v["time"]; goto H10fF; C2PVa: $chatcontime = $v["time"]; goto UOQ5b; lxQaa: foreach ($array2[0] as $kk => $vv) { goto TuxrK; vSKbx: OcqT3: goto EseZ9; vfqBw: $vvurl = strstr($vv, "http") ? $vv : "http://" . $vv; goto ERHcb; ojhvp: YwCkS: goto vSKbx; ERHcb: $chatcon[$k]["content"] = str_replace($vv, "<a href='" . $vvurl . "'>" . $vv . "</a>", $chatcon[$k]["content"]); goto ojhvp; TuxrK: if (!(!empty($vv) && strpos($vv, "https://res.wx.qq.com") === false)) { goto YwCkS; } goto vfqBw; EseZ9: } goto jgrN7; clFga: if (!($v["openid"] != $hasfanskefu["fansopenid"])) { goto FyMuB; } goto UAfNf; drTdG: if ($v["time"] - $chatcontime > 7200) { goto Pzfux; } goto n23dE; hRXa7: $chatcon[$k]["kefuavatar"] = $newfk["kefuavatar"]; goto OSZ68; jz82y: goto BjGb7; goto Bhpp8; UOQ5b: TFIug: goto bgKIg; bgKIg: } goto Pn0Iy; flpCe: $nowjl = 0; goto rWWLf; XSlft: $biaoqian = pdo_fetch("SELECT * FROM " . tablename(BEST_BIAOQIAN) . " WHERE kefuopenid = '{$openid}' AND fensiopenid = '{$hasfanskefu["fansopenid"]}'"); goto j2gxL; YyqZQ: include $this->template("newservicechatxcx"); goto LjSgD; OQg6V: include $this->template("error"); goto By7AY; LxFVm: $openid = $_W["fans"]["from_user"]; goto w31v5; yWmUQ: fxHme: goto B1O3q; Yjemm: QyGL1: goto HpLLY; NDoUf: global $_GPC, $_W; goto O4krz; m6jhA: $fkarr = array(); goto lmkb2; O4krz: include_once ROOT_PATH . "qqface.php"; goto mK41k; LjSgD: } public function doMobileAddchatxcx() { goto fDQ7q; ISS6q: $resArr["error"] = 1; goto tIIY0; Dk4pA: $data["gh_id"] = $fanskefu["gh_id"]; goto PzXAS; IMGjs: $data["openid"] = $fanskefu["kefuopenid"]; goto rrJT5; bxWMi: $resArr["error"] = 0; goto SpaUc; PzXAS: $data["time"] = $addres["time"]; goto dkJpw; GKMuI: $msgtype = "text"; goto cagN1; DKjRB: y3xgz: goto yC84Z; cRII7: $data["msgtype"] = $msgtype; goto t4Gp8; y_PFh: if (!($type == 3)) { goto z_YiR; } goto tuZPV; xoOF6: $addres = $this->addxcxchat2($fanskefu["fansopenid"], $chatcontent, $msgtype, $fanskefu["gh_id"], 1); goto T2HQB; oZyOY: BaZ7H: goto BaVNv; HlB9K: if (!($addres["errcode"] == "40001")) { goto ry0TT; } goto xoOF6; xchtT: $resArr["msg"] = $this->getwxerrormsg($addres); goto GENuB; GC1QK: goto zeWU8; goto oZyOY; iLTuS: if ($addres["errcode"] != "0") { goto dWWjK; } goto IMGjs; UfuGi: exit; goto DKjRB; loSeA: zeWU8: goto bxWMi; tJYUb: $resArr["content"] = "<div class=\"concon\"><img src=\"" . $chatcontent . "\" class=\"sssbbb\" /></div>"; goto GC1QK; yK6Bx: zMyN6: goto y_PFh; MgNbf: $resArr["error"] = 1; goto xchtT; dkJpw: $data["content"] = $chatcontent; goto mBqIa; WTayh: dWWjK: goto MgNbf; t2L5u: qgy3N: goto eUebt; H8zBU: $type = intval($_GPC["type"]); goto gHira; eUebt: $fanskefu = pdo_fetch("SELECT * FROM " . tablename(BEST_XCXFANSKEFU) . " WHERE id = {$fkid}"); goto u7MSJ; vyw36: $resArr["datetime"] = date("Y-m-d H:i:s", $data["time"]); goto yJeC9; Kbklz: exit; goto t2L5u; yJeC9: echo json_encode($resArr); goto IdrNm; fDQ7q: global $_W, $_GPC; goto oBilC; mBqIa: $data["weid"] = $_W["uniacid"]; goto ozD5P; cagN1: $dataup["lastcon"] = preg_replace("/\\xEE[\\x80-\\xBF][\\x80-\\xBF]|\\xEF[\\x81-\\x83][\\x80-\\xBF]/", "[无法识别字符]", $chatcontent); goto yK6Bx; GENuB: echo json_encode($resArr); goto UfuGi; IdrNm: exit; goto YrGGB; oBilC: $fkid = intval($_GPC["fkid"]); goto H8zBU; tIIY0: $resArr["msg"] = "请输入对话内容！"; goto Cw36P; gHira: $chatcontent = trim($_GPC["content"]); goto e2XMP; BaVNv: $resArr["content"] = "<div class=\"concon\">" . $chatcontent . "</div>"; goto loSeA; YrGGB: goto y3xgz; goto WTayh; rrJT5: $data["toopenid"] = $fanskefu["fansopenid"]; goto Dk4pA; u7MSJ: if (!($type == 2)) { goto zMyN6; } goto GKMuI; OzphH: $chatcontent = tomedia($chatcontent); goto Ovkab; SpaUc: $resArr["msg"] = ''; goto vyw36; ozD5P: $data["fkid"] = $fkid; goto cRII7; eSJlN: $addres = $this->addxcxchat2($fanskefu["fansopenid"], $chatcontent, $msgtype, $fanskefu["gh_id"]); goto HlB9K; DZmCF: z_YiR: goto eSJlN; t4Gp8: pdo_insert(BEST_XCXCHAT, $data); goto K1236; Ovkab: $dataup["lastcon"] = "[图片消息]"; goto DZmCF; T2HQB: ry0TT: goto iLTuS; e2XMP: if (!empty($chatcontent)) { goto qgy3N; } goto ISS6q; tuZPV: $msgtype = "image"; goto OzphH; K1236: $dataup["lasttime"] = $data["time"]; goto DbKzh; DbKzh: $dataup["msgtype"] = $msgtype; goto qZBrE; qZBrE: pdo_update(BEST_XCXFANSKEFU, $dataup, array("id" => $fkid)); goto dKuXX; Cw36P: echo json_encode($resArr); goto Kbklz; dKuXX: if ($type == 2) { goto BaZ7H; } goto tJYUb; yC84Z: } public function getwxerrormsg($addres) { goto CmE5c; AlJab: if ($addres["errcode"] == "40003") { goto GUQl3; } goto UnBpE; tP3kc: goto vrZRb; goto Ch147; CkAII: vrZRb: goto hzISq; il5bq: goto vrZRb; goto XjhPk; UnBpE: if ($addres["errcode"] == "40002") { goto LEXf0; } goto sugks; d84OI: pQPbS: goto wPfef; SaLv0: goto vrZRb; goto Oyry4; ZdQ8c: LEXf0: goto jOkNd; b8pnx: $errmsg = "API 功能未授权，请确认小程序已获得该接口！"; goto Nu0CQ; wC68v: PH8zg: goto h3yK0; h3yK0: $errmsg = "系统繁忙，此时请开发者稍候再试！"; goto CkAII; cba4x: goto vrZRb; goto wC68v; u01ga: GUQl3: goto KfgGM; Oyry4: WdKYN: goto Ml8bZ; Nu0CQ: goto vrZRb; goto d84OI; hzISq: return $errmsg; goto gdJ1J; qsFL3: goto vrZRb; goto ZdQ8c; jOkNd: $errmsg = "不合法的凭证类型！"; goto tP3kc; Ml8bZ: $errmsg = "客服接口下行条数超过上限！"; goto il5bq; KfgGM: $errmsg = "不合法的 OpenID，请开发者确认 OpenID 是否是其他小程序的 OpenID！"; goto qsFL3; DJ3rU: $errmsg = "获取 access_token 时 AppSecret 错误，或者 access_token 无效。请开发者认真比对 AppSecret 的正确性，或查看是否正在为恰当的小程序调用接口！"; goto cba4x; sugks: if ($addres["errcode"] == "40001") { goto VVwy_; } goto H5ptl; Ch147: VVwy_: goto DJ3rU; XjhPk: AxIaL: goto b8pnx; Ywmoe: if ($addres["errcode"] == "45015") { goto pQPbS; } goto AlJab; zzEcB: if ($addres["errcode"] == "48001") { goto AxIaL; } goto Ywmoe; sHkM2: goto vrZRb; goto u01ga; oKi7P: $errmsg = $addres["errmsg"]; goto SaLv0; H5ptl: if ($addres["errcode"] == "-1") { goto PH8zg; } goto oKi7P; CmE5c: if ($addres["errcode"] == "45047") { goto WdKYN; } goto zzEcB; wPfef: $errmsg = "回复时间超过限制！"; goto sHkM2; gdJ1J: } public function xcxtzkefu($openid, $lasttime, $fkid, $content, $xcxname, $fansnickname) { goto si_2C; B888u: dT8kH: goto U4uHc; XgOjO: $senddata = array("openid" => $openid, "url" => $this->gettpldomain() . "app/" . str_replace("./", '', $this->createMobileUrl("xcxchat", array("fkid" => $fkid, "ssopenid" => $openid))), "first" => $xcxname . "[小程序]的用户" . $fansnickname . "向你发起了咨询！", "keyword1" => $xcxname . "[小程序]的用户" . $fansnickname); goto AbDpR; AbDpR: $this->sendtplmsg($senddata); goto B888u; gbHx0: $guotime = TIMESTAMP - $lasttime; goto TrWth; TrWth: if (!($guotime > $this->module["config"]["kefutplminute"])) { goto dT8kH; } goto XgOjO; si_2C: global $_GPC, $_W; goto gbHx0; U4uHc: } public function addxcxchat2($touser, $content, $msgtype, $gh_id, $isnewtoken = 0) { goto uVjuZ; JwHv9: $kefutokehures = json_decode($kefutokehures, true); goto GXovi; ktGao: if (!($msgtype == "link")) { goto uKtC4; } goto hUB10; H6vhW: $dataup["access_token"] = $access_token; goto Uk9q9; AEXnY: return $kefutokehures; goto a4X2H; Uk9q9: $dataup["guoqitime"] = $nowtime + 3600; goto Uaoa7; q9RUd: PysXT: goto xuHGi; CTgzw: exit; goto q9RUd; geOBE: file_put_contents("../addons/cy163_customerservice/" . $fileName, $source); goto yd_T9; yd_T9: $imgurl = "https://api.weixin.qq.com/cgi-bin/media/upload?access_token=" . $access_token . "&type=image"; goto VJQY_; A4cLH: if (!($msgtype == "text")) { goto UzItW; } goto WLIpV; WLIpV: $data = array("touser" => $touser, "msgtype" => "text", "text" => array("content" => $content)); goto da49T; vnmEF: t6qTY: goto H6vhW; VxEQt: unlink("../addons/cy163_customerservice/" . $fileName); goto UCyve; UCyve: $data = array("touser" => $touser, "msgtype" => "image", "image" => array("media_id" => $imgres["media_id"])); goto paPDu; oY6li: $resArr["msg"] = "获取AccessToken失败！"; goto dtEBv; paPDu: gy8E9: goto ktGao; qqN0d: OvX77: goto vfmDM; GXovi: $kefutokehures["time"] = $nowtime; goto AEXnY; VJQY_: $imgres = $this->curl_post2($imgurl, "../addons/cy163_customerservice/" . $fileName); goto VxEQt; XOIqC: goto OvX77; goto nLrEU; dtEBv: echo json_encode($resArr); goto CTgzw; nLrEU: yQ2xs: goto dJM12; fvuon: if ($xcx["guoqitime"] < TIMESTAMP) { goto yQ2xs; } goto UxtI8; H9zJr: $url = "https://api.weixin.qq.com/cgi-bin/message/custom/send?access_token=" . $access_token; goto Np0_3; MglRk: $resArr["msg"] = "获取AccessToken失败！"; goto cm3Vo; iOaHp: $source = file_get_contents($content); goto geOBE; ew9oi: $xcx = pdo_fetch("SELECT * FROM " . tablename(BEST_XCX) . " WHERE uniacid = {$_W["uniacid"]} AND gh_id = '{$gh_id}'"); goto W7gPC; eaTsa: zD7dQ: goto A4cLH; tEoRE: if (!($access_token == "error")) { goto PysXT; } goto LO4wQ; vfmDM: goto zD7dQ; goto YIeX5; EazWl: $dataup["guoqitime"] = $nowtime + 3600; goto UL1Lz; Uaoa7: pdo_update(BEST_XCX, $dataup, array("id" => $xcx["id"])); goto qqN0d; xuHGi: $dataup["access_token"] = $access_token; goto EazWl; UQhdB: $nowtime = TIMESTAMP; goto ew9oi; da49T: UzItW: goto jc6jo; VGBOI: if (!($access_token == "error")) { goto t6qTY; } goto mS8EL; xe80s: $fileName = time() . ".jpg"; goto iOaHp; LO4wQ: $resArr["error"] = 1; goto oY6li; mojep: exit; goto vnmEF; W7gPC: if ($isnewtoken == 1) { goto B3BH2; } goto fvuon; dJM12: $access_token = $this->get_xcx_accessToken($xcx["appid"], $xcx["secret"]); goto VGBOI; UL1Lz: pdo_update(BEST_XCX, $dataup, array("id" => $xcx["id"])); goto eaTsa; hUB10: $data = array("touser" => $touser, "msgtype" => "link", "link" => array("title" => $content["title"], "description" => $content["description"], "url" => $content["url"], "thumb_url" => $content["thumb_url"])); goto tWzxc; Wh2Ao: $kefutokehures = $this->curl_post($url, $json); goto JwHv9; uVjuZ: global $_GPC, $_W; goto UQhdB; mS8EL: $resArr["error"] = 1; goto MglRk; Np0_3: $json = json_encode($data, JSON_UNESCAPED_UNICODE); goto Wh2Ao; tWzxc: uKtC4: goto H9zJr; UxtI8: $access_token = $xcx["access_token"]; goto XOIqC; xJfGD: $access_token = $this->get_xcx_accessToken($xcx["appid"], $xcx["secret"]); goto tEoRE; jc6jo: if (!($msgtype == "image")) { goto gy8E9; } goto xe80s; cm3Vo: echo json_encode($resArr); goto mojep; YIeX5: B3BH2: goto xJfGD; a4X2H: } public function addxcxfanskefu($postArr) { goto Tw1Og; dBlQu: if (!empty($nowxcxfanskefu)) { goto tIrlQ; } goto IKSq1; ooROc: $nowhouradd = $nowhour + 1; goto zr8wp; etMeN: eTqBP: goto C0ish; riV4O: ajuV9: goto mQFsi; HreLs: $condition = "weid = {$_W["uniacid"]} AND xcxid = {$xcx["id"]} AND content = '{$nowxcxfanskefu["kefuopenid"]}'"; goto Pdmvf; GT2d9: goto mcBY6; goto LTw5a; DX0xV: $data["createtime"] = $postArr["CreateTime"]; goto F33xu; UAzxj: $fansavatar = $sessionformarr[2]; goto qT6Ia; gDy1u: $isnowfilter = !empty($nowkefu) ? 1 : 0; goto Cuyuc; t1w7i: $data["fansavatar"] = $fansavatar; goto xpJNy; Lr7Mf: $path = ROOT_PATH . "xcxerror.txt"; goto RUIKl; mVtBF: pdo_insert(BEST_XCXFANSKEFU, $data); goto DM5Ek; chrrn: $data["weid"] = $_W["uniacid"]; goto woDV_; b52X8: $gh_id = $postArr["ToUserName"]; goto ohMng; FbMky: $cservice = pdo_fetchall("SELECT * FROM " . tablename(BEST_XCXCSERVICE) . " WHERE " . $condition . " ORDER BY gzhqzval ASC LIMIT 1"); goto D58Df; KArMf: $data["msgtype"] = $postArr["Event"]; goto sIG6a; b4uOL: $fansavatar = $sessionformarr["avatarUrl"]; goto KVVgQ; M0nbX: $pjval = intval($allqzvals / $allqznum); goto ZHvP3; ZHvP3: $condition .= " AND gzhqzval <= {$pjval}"; goto Jh7Ir; ohMng: $xcx = pdo_fetch("SELECT * FROM " . tablename(BEST_XCX) . " WHERE uniacid = {$_W["uniacid"]} AND gh_id = '{$gh_id}'"); goto a7cL3; FUkzO: if (!($zhouji == "4")) { goto VV45G; } goto Imkvn; h5OQG: if (!($zhouji == "5")) { goto NoR_c; } goto Ce6OU; a7cL3: $sessionform = $postArr["SessionFrom"]; goto A6SfK; TNkW6: CdP5f: goto HmiK7; j6F5t: pdo_update(BEST_XCXCSERVICE, $dataqz, array("id" => $cservice["id"])); goto pOgtY; LASSl: if (!($isfromnow == 0)) { goto UxaSS; } goto xOoxr; alDPe: $has = pdo_fetch("SELECT * FROM " . tablename(BEST_XCXFANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND kefuopenid = '{$kefuopenid}' AND fansopenid = '{$fansopenid}' AND gh_id = '{$gh_id}'"); goto KSgIB; KVVgQ: $jhtext = $sessionformarr["shop_id"]; goto fzclF; zr8wp: $condition .= " AND (\r\n\t\t\t\t(lingjie = 0 AND endhour >= {$nowhouradd} AND starthour <= {$nowhour}) OR \r\n\t\t\t\t(lingjie = 1 AND (starthour < {$nowhouradd} OR endhour > {$nowhour}))\r\n\t\t\t)"; goto LBU5t; ZKVEB: goto CdP5f; goto etMeN; Sq6lq: $nowhour = intval(date("H", TIMESTAMP)); goto ooROc; UQCY_: MNG9y: goto HRdln; LuGdL: $dataup["fansnickname"] = $fansnickname; goto Z0YoT; ovRw5: GRvHE: goto GSzWY; tEasK: $condition = "weid = {$_W["uniacid"]} AND xcxid = {$xcx["id"]} AND jhtext = '{$jhtext}'"; goto eIZgp; qT6Ia: $jhtext = $sessionformarr[0]; goto tKfkB; Pdmvf: NgJvP: goto FbMky; jaGQx: $condition .= " AND ((day2 = 1 AND isxingqi = 1) OR isxingqi = 0)"; goto riV4O; KSgIB: if (empty($has)) { goto usbmi; } goto j27YJ; Bn6Yg: $data["kefuavatar"] = tomedia($cservice["thumb"]); goto sMOmJ; NLkH8: $xcx_err = "客户Openid:" . $fansopenid . "。小程序名称:" . $xcx["name"] . "。触发聚合内容:" . $jhtext . "。" . date("Y/m/d H:i:s", TIMESTAMP) . "。" . PHP_EOL; goto Lr7Mf; YNQIt: if (!($cservice["autoreply"] != '' && $fanskefu["lastcon"] != '')) { goto gIcoU; } goto AV2s5; eIZgp: $isfromnow = 0; goto Sq6lq; LTw5a: IbJLM: goto c2dAp; rLQVn: $nowkefu = pdo_fetch("SELECT * FROM " . tablename(BEST_XCXCSERVICE) . " WHERE weid = {$_W["uniacid"]} AND xcxid = {$xcx["id"]} AND concont = '{$nowxcxfanskefu["kefuopenid"]}'"); goto gDy1u; LBU5t: $zhouji = date("w"); goto Y5hkE; Y5hkE: if (!($zhouji == "1")) { goto zPayu; } goto xj_NT; Ce6OU: $condition .= " AND ((day5 = 1 AND isxingqi = 1) OR isxingqi = 0)"; goto X0v2m; c2dAp: pdo_update(BEST_XCXFANSKEFU, array("nowkefu" => 0), array("fansopenid" => $fansopenid, "gh_id" => $gh_id)); goto LASSl; lqGnb: $kefuopenid = $cservice["content"]; goto alDPe; HRdln: if (!($zhouji == "0")) { goto GRvHE; } goto LmM1i; aJ2rb: mcBY6: goto aP4Qx; GSzWY: $allqzvals = pdo_fetchcolumn("SELECT SUM(gzhqzval) FROM " . tablename(BEST_XCXCSERVICE) . " WHERE " . $condition); goto jR02e; LmM1i: $condition .= " AND ((day7 = 1 AND isxingqi = 1) OR isxingqi = 0)"; goto ovRw5; sMOmJ: $data["kefunickname"] = $cservice["name"]; goto KArMf; y0phv: if (!($zhouji == "2")) { goto ajuV9; } goto jaGQx; BICbd: $sessionformarr = json_decode($sessionform, true); goto cjidO; J8gMA: $fanskefu = pdo_fetch("SELECT * FROM " . tablename(BEST_XCXFANSKEFU) . " WHERE kefuopenid = '{$kefuopenid}' AND fansopenid = '{$fansopenid}'"); goto YNQIt; tKfkB: $jhtext = $jhtext == 0 ? '' : $jhtext; goto TNkW6; tmudQ: usbmi: goto chrrn; X0v2m: NoR_c: goto mPSVM; Tw1Og: global $_GPC, $_W; goto Bo6xO; FXPJP: if (!empty($cservice)) { goto IbJLM; } goto NLkH8; eV_QF: goto i040S; goto tmudQ; xj_NT: $condition .= " AND ((day1 = 1 AND isxingqi = 1) OR isxingqi = 0)"; goto mxrYc; tzWU5: $isfromnow = 1; goto HreLs; sjHOx: $condition .= " AND ((day3 = 1 AND isxingqi = 1) OR isxingqi = 0)"; goto uEY2u; wBuCc: $data["fansnickname"] = $fansnickname; goto t1w7i; mxrYc: zPayu: goto y0phv; uEY2u: WA1vS: goto FUkzO; Bo6xO: $fansopenid = $postArr["FromUserName"]; goto b52X8; j27YJ: $dataup["nowkefu"] = 1; goto LuGdL; otYY7: tIrlQ: goto rLQVn; A6SfK: if ($xcx["btnsession"] == 0) { goto eTqBP; } goto BICbd; xMWhM: $condition .= " AND ((day6 = 1 AND isxingqi = 1) OR isxingqi = 0)"; goto UQCY_; mQFsi: if (!($zhouji == "3")) { goto WA1vS; } goto sjHOx; HmiK7: $nowxcxfanskefu = pdo_fetch("SELECT * FROM " . tablename(BEST_XCXFANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND nowkefu = 1 AND fansopenid = '{$fansopenid}' AND gh_id = '{$gh_id}'"); goto dBlQu; woDV_: $data["fansopenid"] = $fansopenid; goto wBuCc; mgc0x: if ($isnowfilter == 1) { goto G5ujy; } goto tEasK; xpJNy: $data["kefuopenid"] = $kefuopenid; goto Bn6Yg; sIG6a: $data["gh_id"] = $gh_id; goto DX0xV; Z0YoT: $dataup["fansavatar"] = $fansavatar; goto s8Cng; yhnGq: goto GHgDY; goto otYY7; s8Cng: pdo_update(BEST_XCXFANSKEFU, $dataup, array("id" => $has["id"])); goto eV_QF; F33xu: $data["sessionfrom"] = $postArr["SessionFrom"]; goto zplVt; cjidO: $fansnickname = $sessionformarr["nickName"]; goto b4uOL; DM5Ek: i040S: goto J8gMA; IKSq1: $isnowfilter = 0; goto yhnGq; Imkvn: $condition .= " AND ((day4 = 1 AND isxingqi = 1) OR isxingqi = 0)"; goto zQh2A; fzclF: $jhtext = $jhtext == 0 ? '' : $jhtext; goto ZKVEB; zQh2A: VV45G: goto h5OQG; jR02e: $allqznum = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename(BEST_XCXCSERVICE) . " WHERE " . $condition); goto M0nbX; ICkYt: $fansnickname = $sessionformarr[1]; goto UAzxj; Ww1uw: $this->addxcxchat2($fansopenid, "客服不在线哦~~", "text", $xcx["gh_id"]); goto GT2d9; vmNWL: G5ujy: goto tzWU5; Jh7Ir: goto NgJvP; goto vmNWL; C0ish: $sessionformarr = explode("-", $sessionform); goto ICkYt; D58Df: $cservice = $cservice[0]; goto FXPJP; xOoxr: $dataqz["gzhqzval"] = $cservice["gzhqzval"] + 1; goto j6F5t; YJqF6: gIcoU: goto aJ2rb; RUIKl: file_put_contents($path, $xcx_err, FILE_APPEND); goto Ww1uw; zplVt: $data["nowkefu"] = 1; goto mVtBF; mPSVM: if (!($zhouji == "6")) { goto MNG9y; } goto xMWhM; Cuyuc: GHgDY: goto mgc0x; pOgtY: UxaSS: goto lqGnb; AV2s5: $this->addxcxchat2($fanskefu["fansopenid"], $cservice["autoreply"], "text", $fanskefu["gh_id"]); goto YJqF6; aP4Qx: } public function doMobileFinishjdxcx() { goto IFM08; a5KDU: echo json_encode($resArr); goto EHKR0; H0LCo: pdo_update(BEST_XCXFANSKEFU, $dataupfk, array("id" => $fkid)); goto tGswM; rX470: $resArr["url"] = $this->createMobileUrl("mychatxcx", array("ssopenid" => $ssopenid)); goto XwxW1; dEV1X: $fkid = intval($_GPC["fkid"]); goto DXS5g; EHKR0: exit; goto IVBq5; dQUZF: $resArr["msg"] = "结束接待成功"; goto a5KDU; DXS5g: $dataupfk["nowkefu"] = 0; goto H0LCo; IFM08: global $_W, $_GPC; goto dEV1X; XwxW1: $resArr["error"] = 0; goto dQUZF; tGswM: $ssopenid = $_GPC["ssopenid"]; goto rX470; IVBq5: } public function get_xcx_accessToken($appid, $appsecret) { goto A1Q0t; TlHES: return $res["access_token"]; goto pbvC5; xMMXn: $result = $this->curl_get_https($url); goto cRA5d; A1Q0t: $url = "https://api.weixin.qq.com/cgi-bin/token?grant_type=client_credential&appid=" . $appid . "&secret=" . $appsecret; goto xMMXn; cRA5d: $res = json_decode($result, true); goto GTWfq; pbvC5: Iv1ax: goto gcnTc; dNO9O: AkT1T: goto TlHES; T0xyw: return "error"; goto WMyRa; GTWfq: if ($res) { goto AkT1T; } goto T0xyw; WMyRa: goto Iv1ax; goto dNO9O; gcnTc: } public function curl_get_https($url) { goto QxiPk; fn4fu: return $tmpInfo; goto ejEJh; kRv4z: curl_close($curl); goto fn4fu; Mxbm8: curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1); goto OrM1o; QxiPk: $curl = curl_init(); goto Kym57; OrM1o: curl_setopt($curl, CURLOPT_SSL_VERIFYPEER, false); goto aizxQ; f8Xg8: curl_setopt($curl, CURLOPT_HEADER, 0); goto Mxbm8; vHh71: $tmpInfo = curl_exec($curl); goto kRv4z; aizxQ: curl_setopt($curl, CURLOPT_SSL_VERIFYHOST, true); goto vHh71; Kym57: curl_setopt($curl, CURLOPT_URL, $url); goto f8Xg8; ejEJh: } public function curl_post($url, $data = array()) { goto T_uyw; O2fCq: curl_close($ch); goto CCYc6; W0RWr: Ny36b: goto pLrg8; x0t5z: if (curl_errno($ch)) { goto kBaOf; } goto O2fCq; Kj0uB: $rs = curl_exec($ch); goto x0t5z; dUBGZ: curl_setopt($ch, CURLOPT_POSTFIELDS, $data); goto YId3Q; Pf2HU: curl_setopt($ch, CURLOPT_SSL_VERIFYHOST, FALSE); goto CF8s5; pS0yj: return $s; goto W0RWr; yV_Wn: kBaOf: goto HdR3J; OkCd3: curl_setopt($ch, CURLOPT_FOLLOWLOCATION, 1); goto cQggT; CF8s5: if (empty($data)) { goto X35UC; } goto OxDTs; vwbnL: curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); goto OkCd3; YId3Q: X35UC: goto vwbnL; HdR3J: $s = "{\"success\": false,\"msg\":\"" . curl_error($ch) . "\" }"; goto pS0yj; T_uyw: $ch = curl_init(); goto Fwl8k; OxDTs: curl_setopt($ch, CURLOPT_POST, 1); goto dUBGZ; YaQy_: goto Ny36b; goto yV_Wn; yeXyw: curl_setopt($ch, CURLOPT_SSL_VERIFYPEER, FALSE); goto Pf2HU; CCYc6: return $rs; goto YaQy_; cQggT: curl_setopt($ch, CURLOPT_TIMEOUT, 20); goto Kj0uB; Fwl8k: curl_setopt($ch, CURLOPT_URL, $url); goto yeXyw; pLrg8: } public function curl_post2($url = "", $path = "") { goto tXJCs; GZcGf: curl_setopt($curl, CURLOPT_POSTFIELDS, $data); goto Ue0Gq; VkJf4: curl_setopt($curl, CURLOPT_USERAGENT, "TEST"); goto KmCKH; H8Bd_: $data = array("media" => "@" . $path); goto sebha; LqYYC: $data = array("media" => new CURLFile($path)); goto GEC49; zL8i9: curl_setopt($curl, CURLOPT_SAFE_UPLOAD, true); goto LqYYC; EBE1t: $res = json_decode($result, true); goto gHK14; sebha: goto HxNoq; goto H0Rbl; KmCKH: $result = curl_exec($curl); goto EBE1t; fcwic: curl_setopt($curl, CURLOPT_POST, 1); goto GZcGf; H0Rbl: lfA51: goto zL8i9; GEC49: HxNoq: goto uxZHW; Ue0Gq: curl_setopt($curl, CURLOPT_RETURNTRANSFER, 1); goto VkJf4; gHK14: return $res; goto HbneC; tXJCs: $curl = curl_init(); goto hAcl_; V9x4g: curl_setopt($curl, CURLOPT_SAFE_UPLOAD, false); goto H8Bd_; hAcl_: if (class_exists("CURLFile")) { goto lfA51; } goto V9x4g; uxZHW: curl_setopt($curl, CURLOPT_URL, $url); goto fcwic; HbneC: } public function checkmain($url) { goto wDVz6; H7XfR: $cando = 0; goto c76PL; t5lWr: $con = $this->get_url_content(BEST_DOMAIN); goto awZ6v; Sg1Li: if (in_array($url, $con)) { goto v3lB3; } goto H7XfR; M9TNP: return $cando; goto qUjQp; c76PL: goto MyTNV; goto T1nRe; T1nRe: v3lB3: goto v3JBF; v3JBF: $cando = 1; goto gCsxH; At5hh: if (!empty($ip)) { goto El7bY; } goto Sg1Li; cs3MS: if (in_array($url, $con) || in_array($ip, $con)) { goto SXQoY; } goto E1lP6; jHVHW: L9tsv: goto EfzVe; He1MP: $cando = 1; goto IB9jj; u0t0y: $cando = 0; goto sMtch; EfzVe: if (!($_W["account"]["type_name"] != "公众号" && $_W["account"]["type_name"] != "微信公众号")) { goto Is1ns; } goto u0t0y; sEkoI: SXQoY: goto He1MP; gCsxH: MyTNV: goto S6Vbo; T_wmK: $yzip = str_replace("https://", '', $url); goto x6FHU; XHRg3: $ip = gethostbyname($yzip); goto t5lWr; E1lP6: $cando = 0; goto yhAJX; sMtch: Is1ns: goto M9TNP; p6lCk: El7bY: goto cs3MS; pqDAg: $yzip = str_replace("/", '', $yzip); goto XHRg3; IB9jj: HU_vO: goto jHVHW; S6Vbo: goto L9tsv; goto p6lCk; wDVz6: global $_GPC, $_W; goto T_wmK; awZ6v: $con = json_decode($con, true); goto At5hh; yhAJX: goto HU_vO; goto sEkoI; x6FHU: $yzip = str_replace("http://", '', $yzip); goto pqDAg; qUjQp: } public function get_url_content($url) { goto L5453; FlQeE: return $file_contents; goto v5yPO; K0mpC: daz2M: goto FlQeE; hhDmU: $file_contents = file_get_contents($url); goto FUmpC; n_UJn: goto daz2M; goto YqsIl; qz30R: $is_auf = ini_get("allow_url_fopen") ? true : false; goto MarWz; FUmpC: mFTxc: goto n_UJn; RHAoN: curl_close($ch); goto K0mpC; cfdBs: curl_setopt($ch, CURLOPT_CONNECTTIMEOUT, $timeout); goto nAYV2; NZkTE: $timeout = 30; goto iyfrd; L5453: if (function_exists("curl_init")) { goto Gz0Pd; } goto qz30R; JvIUk: curl_setopt($ch, CURLOPT_RETURNTRANSFER, 1); goto cfdBs; MarWz: if (!$is_auf) { goto mFTxc; } goto hhDmU; QCRJJ: $ch = curl_init(); goto NZkTE; YqsIl: Gz0Pd: goto QCRJJ; iyfrd: curl_setopt($ch, CURLOPT_URL, $url); goto JvIUk; nAYV2: $file_contents = curl_exec($ch); goto RHAoN; v5yPO: } public function randCharNumber($length) { goto JqW6C; JqW6C: $str = "0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ"; goto ZqEWu; BtvCb: zGepU: goto rOC6Y; N5k35: WSVFu: goto XtQwl; rPfBk: goto zGepU; goto N5k35; XtQwl: return $tmp; goto Nykyq; oFLce: $i = 0; goto BtvCb; Yj4pJ: iFsD7: goto RI03P; vfVl6: $tmp .= $str[mt_rand(0, 61)]; goto Yj4pJ; rOC6Y: if (!($i < $length)) { goto WSVFu; } goto vfVl6; RI03P: $i++; goto rPfBk; ZqEWu: $tmp = ''; goto oFLce; Nykyq: } public function doWebYouhua() { goto l1cOD; JbBsC: $count = $count2 = 0; goto PBMGd; erV2P: $days = intval($_GPC["days"]); goto RHPoM; RHPoM: $days2 = intval($_GPC["days2"]); goto JbBsC; OXHXE: $list2 = pdo_fetchall("SELECT * FROM " . tablename(BEST_GROUPCONTENT) . " WHERE weid = {$_W["uniacid"]} AND time <= {$endtime2}"); goto rR_j6; EHqLz: $resArr["msg"] = "共删除" . $count . "条客服功能记录，" . $count2 . "条群聊功能记录。"; goto c5phn; l1cOD: global $_GPC, $_W; goto erV2P; qvOtX: $list = pdo_fetchall("SELECT * FROM " . tablename(BEST_CHAT) . " WHERE weid = {$_W["uniacid"]} AND time <= {$endtime}"); goto M572G; LzAl_: $count = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename(BEST_CHAT) . " WHERE weid = {$_W["uniacid"]} AND time <= {$endtime}"); goto qvOtX; NWF2n: WfHgr: goto rBBkN; rR_j6: foreach ($list2 as $k => $v) { goto i1L7M; bMGNs: $this->doQiuniudel($v["content"]); goto Xgrt7; i1L7M: if (!($v["type"] == 3)) { goto nbVBQ; } goto bMGNs; l06Ed: kIDXo: goto Pvh8t; UY2o3: pdo_delete(BEST_GROUPCONTENT, array("id" => $v["id"])); goto l06Ed; Xgrt7: nbVBQ: goto UY2o3; Pvh8t: } goto oCMIa; sYMhX: if (!($days2 > 0)) { goto eSKy0; } goto Zai89; fEkbL: exit; goto ilHw0; oCMIa: IW5bA: goto XNZI7; rBBkN: itSfU: goto sYMhX; n1AO0: $endtime = TIMESTAMP - $days * 24 * 3600; goto LzAl_; PBMGd: if (!($days > 0)) { goto itSfU; } goto n1AO0; c5phn: echo json_encode($resArr); goto fEkbL; M572G: foreach ($list as $k => $v) { goto I04nZ; hUnGg: ovL2T: goto coDqj; coDqj: pdo_delete(BEST_CHAT, array("id" => $v["id"])); goto VPhbH; VPhbH: WVSeS: goto MQ5DN; I04nZ: if (!($v["type"] != 1 && $v["type"] != 2)) { goto ovL2T; } goto NhxH_; NhxH_: $this->doQiuniudel($v["content"]); goto hUnGg; MQ5DN: } goto NWF2n; TFD1M: $count2 = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename(BEST_GROUPCONTENT) . " WHERE weid = {$_W["uniacid"]} AND time <= {$endtime2}"); goto OXHXE; XNZI7: eSKy0: goto EHqLz; Zai89: $endtime2 = TIMESTAMP - $days2 * 24 * 3600; goto TFD1M; ilHw0: } public function exportexcel($data = array(), $title = array(), $header, $footer, $filename = "report") { goto jXpmJ; j8Z26: header("Content-Disposition:attachment;filename=" . $filename . ".xls"); goto S06pK; jXpmJ: header("Content-type:application/octet-stream"); goto ZLSzF; ZLSzF: header("Accept-Ranges:bytes"); goto yr2Gh; E03b7: echo "\r\n"; goto sTmti; h9tVf: echo $footer; goto Fuhan; yr2Gh: header("Content-type:application/vnd.ms-excel"); goto j8Z26; r3iRx: $header = iconv("UTF-8", "GB2312", $header); goto skbUC; EAr3U: header("Expires: 0"); goto r3iRx; NR6U6: echo "\r\n\r\n"; goto h9tVf; skbUC: echo $header; goto fEwxh; X54sJ: TUrXr: goto QBJJE; QBJJE: echo implode("\n", $data); goto PajbW; BJ4Ho: v1Rcb: goto BIsQW; HxsVN: $title = implode("\t", $title); goto RFNk0; sTmti: $footer = iconv("UTF-8", "GB2312", $footer); goto NR6U6; BIsQW: if (empty($data)) { goto kkb4d; } goto IyrJV; PajbW: kkb4d: goto E03b7; fEwxh: if (empty($title)) { goto v1Rcb; } goto v2HPF; S06pK: header("Pragma: no-cache"); goto EAr3U; v2HPF: foreach ($title as $k => $v) { $title[$k] = iconv("UTF-8", "GB2312", $v); k22vz: } goto VKqhF; RFNk0: echo "{$title}\r\n"; goto BJ4Ho; IyrJV: foreach ($data as $key => $val) { goto gcbqm; WDub4: gafuF: goto biYS7; gcbqm: foreach ($val as $ck => $cv) { $data[$key][$ck] = iconv("UTF-8", "GB2312", $cv); bGubE: } goto WDub4; E_rR9: xn9oG: goto EcrTY; biYS7: $data[$key] = implode("\t", $data[$key]); goto E_rR9; EcrTY: } goto X54sJ; VKqhF: YF0F9: goto HxsVN; Fuhan: } public function doWebCservice() { include_once ROOT_PATH . "inc/web/cservice.php"; } public function doWebGroup() { include_once ROOT_PATH . "inc/web/group.php"; } public function mkdirs($dir, $mode = 0777) { goto HqQfy; CoGAg: return FALSE; goto iR84H; iR84H: M1wbi: goto z7h6A; z7h6A: return @mkdir($dir, $mode); goto o29Lp; pXA0S: if ($this->mkdirs(dirname($dir), $mode)) { goto M1wbi; } goto CoGAg; xW655: return TRUE; goto BxQJV; BxQJV: KEoz8: goto pXA0S; HqQfy: if (!(is_dir($dir) || @mkdir($dir, $mode))) { goto KEoz8; } goto xW655; o29Lp: } public function doWebCservicegroup() { goto dSt4m; UaO0K: ychp6: goto l4U6r; Lz4Zc: pdo_delete(BEST_CSERVICEGROUP, array("id" => $id)); goto mKvse; ioBSA: $keyword = trim($_GPC["keyword"]); goto EFqiq; cMibX: if (!empty($cservicegroup)) { goto CXhHC; } goto R8O0x; K9Y00: dtEa9: goto pt1HS; Bite2: lTeHV: goto BNIzS; E0JSO: message("抱歉，请输入客服组名称！"); goto RPrCn; iJ7CD: goto avAM0; goto UaO0K; YD7Zm: if (!empty($_GPC["name"])) { goto O1XIG; } goto E0JSO; fL2a2: ljUJ6: goto by6Rm; RPrCn: O1XIG: goto EJGj5; e301G: avAM0: goto YOqPX; Ix2Q8: goto avAM0; goto JIOXQ; l4U6r: $id = intval($_GPC["id"]); goto dbgPW; f5WFd: $condition .= " AND name like '%{$keyword}%'"; goto l20vN; jk3Gl: $operation = !empty($_GPC["op"]) ? $_GPC["op"] : "display"; goto mch78; gxqSg: if (!empty($id)) { goto LnCH2; } goto fdiF_; ue9ac: KorAF: goto bvS5x; RsnFW: include $this->template("web/cservicegroup"); goto iNW6E; dSt4m: global $_GPC, $_W; goto jk3Gl; iNW6E: goto avAM0; goto ue9ac; eld5K: bzBbb: goto jljp0; fdiF_: pdo_insert(BEST_CSERVICEGROUP, $data); goto CR6KS; UVQ1W: $cservicegrouplist = pdo_fetchall("SELECT * FROM " . tablename(BEST_CSERVICEGROUP) . " WHERE " . $condition . " ORDER BY displayorder ASC"); goto mZMzY; fQIPi: $othergroup = pdo_fetchall("SELECT * FROM " . tablename(BEST_CSERVICEGROUP) . " WHERE weid = {$_W["uniacid"]} AND id != {$id}"); goto JwAyk; by6Rm: message("操作成功！", $this->createWebUrl("cservicegroup", array("op" => "display")), "success"); goto eld5K; EFqiq: if (empty($keyword)) { goto hQ0jO; } goto f5WFd; EJGj5: $data = array("weid" => $_W["uniacid"], "name" => trim($_GPC["name"]), "typename" => trim($_GPC["typename"]), "thumb" => $_GPC["thumb"], "displayorder" => intval($_GPC["displayorder"]), "ishow" => intval($_GPC["ishow"]), "sanbs" => trim($_GPC["sanbs"]), "sanremark" => trim($_GPC["sanremark"]), "bsid" => intval($_GPC["bsid"]), "fid" => intval($_GPC["fid"]), "notext" => trim($_GPC["notext"])); goto gxqSg; F_cGC: foreach ($_GPC["displayorder"] as $id => $displayorder) { pdo_update(BEST_CSERVICEGROUP, array("displayorder" => $displayorder), array("id" => $id)); OceY0: } goto Bite2; m1hxn: pdo_update(BEST_CSERVICEGROUP, $data, array("id" => $id, "weid" => $_W["uniacid"])); goto fL2a2; pt1HS: $total = count($cservicegrouplist); goto RsnFW; R8O0x: message("抱歉，该客服组不存在或是已经被删除！", $this->createWebUrl("cservicegroup", array("op" => "display")), "error"); goto Qqpvs; mKvse: pdo_delete(BEST_KEFUANDGROUP, array("groupid" => $id)); goto a_Uh0; ai0wr: LnCH2: goto m1hxn; Tr3GN: $condition = "weid = {$_W["uniacid"]}"; goto ioBSA; kZsrv: if ($operation == "post") { goto KorAF; } goto AqUmH; BNIzS: message("客服组排序更新成功！", $this->createWebUrl("cservicegroup", array("op" => "display")), "success"); goto iyXii; dbgPW: $cservicegroup = pdo_fetch("SELECT id FROM " . tablename(BEST_CSERVICEGROUP) . " WHERE id = {$id}"); goto cMibX; jljp0: include $this->template("web/cservicegroup"); goto iJ7CD; Qqpvs: CXhHC: goto Lz4Zc; iyXii: HMff9: goto Tr3GN; bvS5x: $id = intval($_GPC["id"]); goto fQIPi; QaAzT: if (empty($_GPC["displayorder"])) { goto HMff9; } goto F_cGC; JwAyk: if (empty($id)) { goto Q5Suq; } goto QwtzU; mZMzY: foreach ($cservicegrouplist as $k => $v) { goto dAwDf; dAwDf: $cservicegrouplist[$k]["servicegroupurl"] = $_W["siteroot"] . "app/" . str_replace("./", '', $this->createMobileUrl("groupchat", array("id" => $v["id"]))); goto Kbu3D; aZW2P: ILIkH: goto Ckr2Z; Kbu3D: $cservicegrouplist[$k]["servicegroupurl2"] = $_W["siteroot"] . "app/" . str_replace("./", '', $this->createMobileUrl("groupchatzd", array("id" => $v["id"]))); goto aZW2P; Ckr2Z: } goto K9Y00; PxTXZ: Q5Suq: goto TEur2; mch78: if ($operation == "display") { goto WzSmb; } goto kZsrv; JIOXQ: WzSmb: goto QaAzT; AqUmH: if ($operation == "delete") { goto ychp6; } goto Ix2Q8; TEur2: if (!checksubmit("submit")) { goto bzBbb; } goto YD7Zm; l20vN: hQ0jO: goto UVQ1W; a_Uh0: message("删除客服组成功！", $this->createWebUrl("cservicegroup", array("op" => "display")), "success"); goto e301G; CR6KS: goto ljUJ6; goto ai0wr; QwtzU: $cservicegroup = pdo_fetch("SELECT * FROM " . tablename(BEST_CSERVICEGROUP) . " WHERE id = :id AND weid = :weid", array(":id" => $id, ":weid" => $_W["uniacid"])); goto PxTXZ; YOqPX: } public function doMobileKefucenter() { include_once ROOT_PATH . "inc/mobile/kefucenter.php"; } public function doMobileKefulogin() { include_once ROOT_PATH . "inc/mobile/kefulogin.php"; } public function doMobileSearchkefus() { include_once ROOT_PATH . "inc/mobile/searchkefus.php"; } public function kfisonline($cservice) { goto Hs5ZY; JFiRD: $isonline = false; goto dIz_U; GJZI3: lgwCH: goto OCOLL; GAWlh: lJEBV: goto P7r3V; P7r3V: if (!($cservice["isrealzx"] == 0)) { goto CPrOd; } goto JFiRD; rY1io: return $isonline; goto Wt7Gy; zqAdS: goto aJ8H5; goto Hsm7Z; gdZcj: $isonline = false; goto R1HxY; OCOLL: aJ8H5: goto u3nu4; R1HxY: yPMrp: goto zqAdS; DjKNL: $nowhour = intval(date("H", TIMESTAMP)); goto M6t9c; OI96Y: if ($cservice["iszx"] == 1) { goto lJEBV; } goto kDHng; M6t9c: if (!($nowhour + 1 > $cservice["endhour"] && $nowhour < $cservice["starthour"])) { goto lgwCH; } goto Nkrsn; Nkrsn: $isonline = false; goto GJZI3; kDHng: if ($cservice["lingjie"] == 1) { goto U1X68; } goto IZiMk; rwQSI: daLJq: goto rY1io; dIz_U: CPrOd: goto rwQSI; Hsm7Z: U1X68: goto DjKNL; WKaO4: if (!($nowhour < $cservice["starthour"] || $nowhour + 1 > $cservice["endhour"])) { goto yPMrp; } goto gdZcj; IZiMk: $nowhour = intval(date("H", TIMESTAMP)); goto WKaO4; u3nu4: goto daLJq; goto GAWlh; Hs5ZY: $isonline = true; goto OI96Y; Wt7Gy: } public function doMobileChosekefu() { goto nujek; oHYIA: $advlist = pdo_fetchall("SELECT * FROM " . tablename(BEST_ADV) . " WHERE weid = '{$_W["uniacid"]}' AND isdadi = 1 ORDER BY displayorder ASC"); goto dmiie; hnIRg: foreach ($cservicelist as $k => $v) { goto zVSnA; sq5no: goto iKD8v; goto JpzZ5; JpzZ5: Ab8FC: goto vEMOW; SX_Gw: QdYI8: goto Hp43x; h2rT5: iKD8v: goto SX_Gw; wE8Y9: weJoS: goto sq5no; I2EfA: unset($cservicelist[$k]); goto wE8Y9; AbJr1: if (!(!$isonline && $v["lyon"] == 0)) { goto weJoS; } goto I2EfA; ATlEi: if (!empty($kefuandgroup)) { goto Ab8FC; } goto CCrd6; CCrd6: $isonline = $this->kfisonline($v); goto AbJr1; zVSnA: $kefuandgroup = pdo_fetch("SELECT id FROM " . tablename(BEST_KEFUANDGROUP) . " WHERE kefuid = {$v["id"]}"); goto ATlEi; vEMOW: unset($cservicelist[$k]); goto h2rT5; Hp43x: } goto IYe8M; bCxw0: HQqzK: goto G1jpb; QbTUr: $condition = "weid = {$_W["uniacid"]}"; goto wqmv6; IYe8M: SfLn2: goto bKmeR; ioQLq: $mychatnum = empty($mychatnum) ? 0 : $mychatnum; goto l3KHG; xXPXt: include $this->template("chosekefu"); goto SG4j3; Tu5Le: $orderby = " ORDER BY rand()"; goto eZkw3; XnWM5: if (!($this->module["config"]["chosekefutem"] == 1 || $this->module["config"]["chosekefutem"] == 2)) { goto HQqzK; } goto OIxLo; SG4j3: uLA27: goto XnWM5; nujek: global $_W, $_GPC; goto NKcSt; Z_SiG: KrvWe: goto Tu5Le; eZkw3: zZ8ZU: goto DNVDz; KN4hE: $advlist = pdo_fetchall("SELECT * FROM " . tablename(BEST_ADV) . " WHERE weid = '{$_W["uniacid"]}' AND (endtime > {$nowtime} OR endtime = 0) AND groupid = 0 AND isdadi = 0 ORDER BY displayorder ASC"); goto mYqbe; aaiFj: $this->module["config"]["shareurl"] = $_W["siteroot"] . "app/" . str_replace("./", '', $this->createMobileUrl("chosekefu")); goto doMXK; NKcSt: $iscservice = pdo_fetch("SELECT id FROM " . tablename(BEST_CSERVICE) . " WHERE weid = {$_W["uniacid"]} AND content = '{$_W["fans"]["from_user"]}' AND ctype = 1"); goto F_yLV; doMXK: if (!($this->module["config"]["chosekefutem"] == 0)) { goto uLA27; } goto xXPXt; DNVDz: $cservicelist = pdo_fetchall("SELECT * FROM " . tablename(BEST_CSERVICE) . " WHERE " . $condition . $orderby); goto hnIRg; fZmyf: $orderby = " ORDER BY displayorder ASC"; goto Iq5D5; F_yLV: $nowtime = TIMESTAMP; goto KN4hE; mYqbe: if (!empty($advlist)) { goto BtG6e; } goto oHYIA; OIxLo: include $this->template("chosekefu2"); goto bCxw0; Iq5D5: goto zZ8ZU; goto Z_SiG; dmiie: BtG6e: goto QbTUr; bKmeR: $openid = $_W["fans"]["from_user"]; goto dZ1eQ; l3KHG: $cservicegrouplist = pdo_fetchall("SELECT * FROM " . tablename(BEST_CSERVICEGROUP) . " WHERE weid = {$_W["uniacid"]} AND ishow = 1 AND fid = 0 ORDER BY displayorder ASC"); goto aaiFj; dZ1eQ: $mychatnum = pdo_fetchcolumn("SELECT SUM(kefunotread) FROM " . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND fansopenid = '{$openid}' AND (kefulastcon != '' OR kefunotread > 0) AND fansdel = 0"); goto ioQLq; wqmv6: if ($this->module["config"]["suiji"] == 1) { goto KrvWe; } goto fZmyf; G1jpb: } public function doMobileSanchat() { include_once ROOT_PATH . "inc/mobile/sanchat.php"; } public function doMobileGroupchatzd() { goto VcgD1; ae06S: WqsJ6: goto gOGFY; bHRI9: $condition .= " AND ((day1 = 1 AND isxingqi = 1) OR isxingqi = 0)"; goto qvSso; VSg3w: $merch = intval($_GPC["merch"]); goto lEgA4; B1c2A: if (!empty($hasjd)) { goto FVMNE; } goto pup64; fYvFY: $condition3 = "weid = {$_W["uniacid"]} AND ctype = 1 AND id in (" . implode(",", $kefuids) . ")"; goto vgaT3; UWLdE: if (!($goodsid > 0 && pdo_tableexists("ewei_shop_goods"))) { goto ACJdo; } goto pbjAK; HpeK0: $toopenid = $hasjd["kefuopenid"]; goto ae06S; YVXBL: $condition .= " AND ((day6 = 1 AND isxingqi = 1) OR isxingqi = 0)"; goto wXmyx; KQ96O: FVMNE: goto HpeK0; FoPhs: if (empty($_COOKIE["kflatitude"])) { goto f1q9o; } goto vgrAX; Ec9mc: if (!($zhouji == "0")) { goto OIyGM; } goto BDVKF; LfT3v: $kefuandgroup = pdo_fetchall("SELECT kefuid FROM " . tablename(BEST_KEFUANDGROUP) . " WHERE weid = {$_W["uniacid"]} AND groupid = {$cservicegroup["id"]}"); goto MaBDv; Yfmo9: header("Location: " . $this->createMobileUrl("chat", array("toopenid" => $toopenid, "qudao" => $qudao, "goodsid" => $goodsid, "merch" => $merch))); goto NT13J; MaBDv: $kefuids = array(0); goto cYuj2; exjq4: $longitude = $_COOKIE["kflongitude"]; goto NDaAU; C3J36: f1q9o: goto cBw9m; exced: $kefuopenids = "("; goto aO7Zx; s2PGd: goto LgkZL; goto sRowB; VcgD1: global $_W, $_GPC; goto w3ewl; rm1MA: zC_6R: goto stv7a; w3ewl: if (empty($_W["fans"]["from_user"])) { goto Rr24e; } goto jyizA; MC_xE: exit; goto YKYu9; YKYu9: Ucu8E: goto P6qfd; ktqSb: $kefuopenids = "("; goto YaUFa; zgLi9: $goodsid = $this->getrrgid($_SERVER["HTTP_REFERER"]); goto RNcyy; sRowB: iUFrw: goto K1ZWB; oazcA: $latitude = $ipres["result"]["location"]["lat"] . random(4, 1); goto eQvKx; qfemW: if (!($zhouji == "2")) { goto DOb6s; } goto JJJ1V; Fp5JM: LgkZL: goto LfT3v; vhm4L: $condition .= " AND ((day3 = 1 AND isxingqi = 1) OR isxingqi = 0)"; goto s18JN; vgaT3: if (!($qudao == "renren" && $goodsid > 0)) { goto vOK0t; } goto WhdPj; gCEDL: vOK0t: goto gmH4I; gj012: PpOCK: goto R4p2b; fYKV3: $openid = md5($jiamistr); goto PLjnG; AczyU: $ipres = file_get_contents($ipurl); goto j3f9e; GJlfW: pRqBz: goto c1i3j; abeXi: $cservicelist2 = pdo_fetchall("SELECT * FROM " . tablename(BEST_CSERVICE) . " WHERE " . $condition2); goto rf3zt; gmH4I: $cservicelist = pdo_fetchall("SELECT * FROM " . tablename(BEST_CSERVICE) . " WHERE " . $condition); goto abeXi; eQvKx: $longitude = $ipres["result"]["location"]["lng"] . random(4, 1); goto QiHfN; jdNhx: $id = intval($_GPC["id"]); goto VvW3S; uvhWF: setcookie("kflongitude", $longitude, time() + 3600 * 24 * 7); goto x0UFS; Bqo2Q: goto Xq61E; goto azjPI; QiHfN: setcookie("kflatitude", $latitude, time() + 3600 * 24 * 7); goto uvhWF; jyizA: $openid = $_W["fans"]["from_user"]; goto Bqo2Q; S0fje: if (!$isrr) { goto PpOCK; } goto zgLi9; lEgA4: $isrr = strstr($_SERVER["HTTP_REFERER"], "r=goods.detail"); goto S0fje; n6BnH: goto WqsJ6; goto KQ96O; pbjAK: $goodsres = pdo_fetch("SELECT merchid FROM " . tablename("ewei_shop_goods") . " WHERE id = {$goodsid} AND uniacid = {$_W["uniacid"]}"); goto sFN_5; P3p6s: oTnkv: goto Wcidr; ZyT4k: $toopenid = $cservice["content"]; goto n6BnH; vgrAX: $latitude = $_COOKIE["kflatitude"]; goto exjq4; cuKJF: if (!($zhouji == "4")) { goto pRqBz; } goto devB7; Wcidr: $nowhour = intval(date("H", TIMESTAMP)); goto ki3ND; s1gEJ: MscRJ: goto rm1MA; MOB2m: include $this->template("error"); goto MC_xE; oAxmJ: foreach ($cservicelist2 as $k => $v) { $kefuopenids .= "'" . $v["content"] . "',"; a3M9S: } goto fhqcR; uZXki: goto zC_6R; goto CgS8a; wXmyx: qqFOa: goto Ec9mc; dSIxq: ACJdo: goto gj012; QBgQ0: $hasjd = pdo_fetch("SELECT kefuopenid FROM " . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND fansopenid = '{$openid}' AND kefuopenid in " . $kefuopenids . " AND nowjd > 0"); goto B1c2A; pGviM: exit; goto mNhS6; Z9eu8: include $this->template("error"); goto pGviM; PRQRI: if (!($zhouji == "6")) { goto qqFOa; } goto YVXBL; stv7a: $kefuopenids .= "'ddd')"; goto QBgQ0; eZ2GF: AVchv: goto oAxmJ; LYaZC: $cservicelist3 = pdo_fetchall("SELECT * FROM " . tablename(BEST_CSERVICE) . " WHERE " . $condition3); goto feoQq; CcVfB: $qudao = trim($_GPC["qudao"]); goto sbEYO; devB7: $condition .= " AND ((day4 = 1 AND isxingqi = 1) OR isxingqi = 0)"; goto GJlfW; c1i3j: if (!($zhouji == "5")) { goto cd3Ot; } goto hrowC; giDTh: $condition = "weid = {$_W["uniacid"]} AND ctype = 1 AND id in (" . implode(",", $kefuids) . ") AND iszx = 0 AND (\r\n\t\t\t(lingjie = 0 AND endhour >= {$nowhouradd} AND starthour <= {$nowhour}) OR \r\n\t\t\t(lingjie = 1 AND (starthour < {$nowhouradd} OR endhour > {$nowhour}))\r\n\t\t)"; goto K0yPo; h4dx0: $message = $cservicegroup["notext"] == '' ? "暂没有客服哦" : $cservicegroup["notext"]; goto Z9eu8; MACB1: QkBd0: goto Z42QI; EETna: OIyGM: goto WrU0C; NDaAU: goto dFCBC; goto C3J36; feoQq: if (!empty($cservicelist3)) { goto xy4vC; } goto h4dx0; fczC0: cd3Ot: goto PRQRI; uSiN2: $jiamistr = $this->get_lang() . $this->browse_info() . $this->get_os() . $latitude . $longitude; goto fYKV3; mNhS6: xy4vC: goto exced; ki3ND: $nowhouradd = $nowhour + 1; goto giDTh; s18JN: iEA5K: goto cuKJF; K0yPo: $zhouji = date("w"); goto wvlF5; RNcyy: $qudao = "renren"; goto UWLdE; f7FGt: $cservice = $cservice[0]; goto ZyT4k; VvW3S: $cservicegroup = pdo_fetch("SELECT * FROM " . tablename(BEST_CSERVICEGROUP) . " WHERE weid = {$_W["uniacid"]} AND id = {$id}"); goto s2PGd; YaUFa: foreach ($cservicelist as $k => $v) { $kefuopenids .= "'" . $v["content"] . "',"; uPYjo: } goto eZ2GF; qvSso: DAfww: goto qfemW; BDVKF: $condition .= " AND ((day7 = 1 AND isxingqi = 1) OR isxingqi = 0)"; goto EETna; CgS8a: bhZqR: goto LYaZC; j3f9e: $ipres = json_decode($ipres, true); goto oazcA; Z42QI: $message = $cservicegroup["notext"] == '' ? "暂没有客服哦" : $cservicegroup["notext"]; goto MOB2m; wvlF5: if (!($zhouji == "1")) { goto DAfww; } goto bHRI9; JJJ1V: $condition .= " AND ((day2 = 1 AND isxingqi = 1) OR isxingqi = 0)"; goto Q1C7o; R4p2b: if ($qudao == "renren" && $merch > 0) { goto iUFrw; } goto jdNhx; Rk0x0: $condition2 .= " AND (jhtext = '' OR jhtext = {$goodsid} OR jhtext = '{$goodsid}')"; goto x6vCR; sbEYO: $goodsid = intval($_GPC["goodsid"]); goto VSg3w; azjPI: Rr24e: goto FoPhs; x6vCR: $condition3 .= " AND (jhtext = '' OR jhtext = {$goodsid} OR jhtext = '{$goodsid}')"; goto gCEDL; Q1C7o: DOb6s: goto lt89u; PLjnG: Xq61E: goto CcVfB; aO7Zx: foreach ($cservicelist3 as $k => $v) { $kefuopenids .= "'" . $v["content"] . "',"; sLZ_R: } goto s1gEJ; K1ZWB: $cservicegroup = pdo_fetch("SELECT * FROM " . tablename(BEST_CSERVICEGROUP) . " WHERE weid = {$_W["uniacid"]} AND sanbs = '{$qudao}' AND bsid = {$merch}"); goto Fp5JM; x0UFS: dFCBC: goto uSiN2; cBw9m: $ipurl = "https://apis.map.qq.com/ws/location/v1/ip?ip=" . $_W["clientip"] . "&key=" . $this->module["config"]["mapkey"]; goto AczyU; NT13J: goto Ucu8E; goto MACB1; fhqcR: MwzdR: goto uZXki; lt89u: if (!($zhouji == "3")) { goto iEA5K; } goto vhm4L; WrU0C: $condition2 = "weid = {$_W["uniacid"]} AND ctype = 1 AND id in ( " . implode(",", $kefuids) . ") AND iszx = 1 AND isrealzx = 1"; goto fYvFY; rf3zt: if (empty($cservicelist) && empty($cservicelist2)) { goto bhZqR; } goto ktqSb; sFN_5: $merch = intval($goodsres["merchid"]); goto dSIxq; pup64: $cservice = pdo_fetchall("SELECT * FROM " . tablename(BEST_CSERVICE) . " WHERE weid = {$_W["uniacid"]} AND ctype = 1 AND content in " . $kefuopenids . " ORDER BY nowjdnum ASC LIMIT 1"); goto f7FGt; cYuj2: foreach ($kefuandgroup as $k => $v) { $kefuids[] = $v["kefuid"]; dihIy: } goto P3p6s; WhdPj: $condition .= " AND (jhtext = '' OR jhtext = {$goodsid} OR jhtext = '{$goodsid}')"; goto Rk0x0; hrowC: $condition .= " AND ((day5 = 1 AND isxingqi = 1) OR isxingqi = 0)"; goto fczC0; gOGFY: if (empty($toopenid)) { goto QkBd0; } goto Yfmo9; P6qfd: } public function convertUrlQuery($query) { goto NrXwN; NrXwN: $queryParts = explode("&", $query); goto Xmx2e; FzdhS: return $params; goto zjG8j; g_rsR: JewyO: goto FzdhS; rQzAb: foreach ($queryParts as $param) { goto ntEp7; hAaY0: $params[$item[0]] = $item[1]; goto Hql9e; ntEp7: $item = explode("=", $param); goto hAaY0; Hql9e: C5wiB: goto P1Hgu; P1Hgu: } goto g_rsR; Xmx2e: $params = array(); goto rQzAb; zjG8j: } public function getrrgid($url) { goto cyd1K; KqubA: $param_arr = $this->convertUrlQuery($url["query"]); goto zraps; cyd1K: $url = parse_url($url); goto KqubA; zraps: return intval($param_arr["id"]); goto I3CnO; I3CnO: } public function doMobileZjgroup() { goto PLd3P; Wrso0: $kefuandgroup = pdo_fetchall("SELECT kefuid FROM " . tablename(BEST_KEFUANDGROUP) . " WHERE weid = {$_W["uniacid"]} AND groupid = {$groupid}"); goto LNidk; jPHRx: $resArr["html"] = $html; goto DouID; yO0La: if ($groupid == 0) { goto Bkdty; } goto Wrso0; ZC1FQ: foreach ($othercservice as $k => $v) { goto iB95X; zOQT8: MEDOm: goto QX7V8; URJ9h: if (empty($kefuandgroup_zj)) { goto MEDOm; } goto FXOPr; FXOPr: unset($othercservice[$k]); goto zOQT8; iB95X: $kefuandgroup_zj = pdo_fetch("SELECT id FROM " . tablename(BEST_KEFUANDGROUP) . " WHERE kefuid = {$v["id"]}"); goto URJ9h; QX7V8: xXdPa: goto xWnu4; xWnu4: } goto pa_oB; PLd3P: global $_W, $_GPC; goto GOXZ6; T73c1: $orderby = " ORDER BY displayorder ASC"; goto UnDok; Xbg9r: HRp0f: goto FsJIN; pa_oB: n2wj4: goto Xbg9r; PPxBR: Bkdty: goto C4Dge; LNidk: $kefuids = array(0); goto Q56U_; zjPaH: $html .= "<div class=\"flex1\"></div>"; goto AEMyA; nh9Ig: $groupid = intval($_GPC["groupid"]); goto yO0La; C4Dge: $othercservice = pdo_fetchall("SELECT * FROM " . tablename(BEST_CSERVICE) . " WHERE weid = {$_W["uniacid"]} AND ctype = 1 AND content != '{$openid}' ORDER BY displayorder ASC"); goto ZC1FQ; GOXZ6: $openid = $_W["fans"]["from_user"]; goto nh9Ig; nSvJv: exit; goto selev; DouID: echo json_encode($resArr, true); goto nSvJv; Q56U_: foreach ($kefuandgroup as $k => $v) { $kefuids[] = $v["kefuid"]; bHIlN: } goto vQg9r; MrmiH: goto HRp0f; goto PPxBR; ZtoKU: $condition = "weid = {$_W["uniacid"]} AND content != '{$openid}' AND id in (" . implode(",", $kefuids) . ")"; goto T73c1; FsJIN: $html = ''; goto r48Rn; r48Rn: foreach ($othercservice as $k => $v) { $html .= "<div class=\"zj-item flex1\" data-con=\"" . $v["content"] . "\">\r\n\t\t\t\t<div class=\"zj-item-img\"><img src=\"" . tomedia($v["thumb"]) . "\" /></div>\r\n\t\t\t\t<div class=\"zj-item-name\">" . $v["name"] . "</div>\r\n\t\t\t</div>"; mEMqV: } goto sQL8W; sQL8W: bbixm: goto ZBUEr; UnDok: $othercservice = pdo_fetchall("SELECT * FROM " . tablename(BEST_CSERVICE) . " WHERE " . $condition . $orderby); goto MrmiH; AEMyA: Cn6WG: goto jPHRx; vQg9r: W4RA2: goto ZtoKU; ZBUEr: if (!($html != '')) { goto Cn6WG; } goto zjPaH; selev: } public function doMobileGroupchat() { goto DFnD5; XNQHq: $cservicelist = pdo_fetchall("SELECT * FROM " . tablename(BEST_CSERVICE) . " WHERE " . $condition . $orderby); goto SjBEw; Pnqv7: $openid = $_W["fans"]["from_user"]; goto Jzjel; BTwVW: sdKm7: goto RE4Bq; A4Z1G: aX6Dz: goto u0o2R; CBOSj: include $this->template("groupchat2"); goto clBLr; u0o2R: $orderby = " ORDER BY rand()"; goto OWvHm; abOq6: $condition = "weid = {$_W["uniacid"]} AND id in (" . implode(",", $kefuids) . ")"; goto yx0ar; WlQwj: $goodsid = intval($_GPC["goodsid"]); goto RvfJS; Brk6O: $qudao = "renren"; goto jIO2L; EuEXd: if ($qudao == "juhe") { goto wTRm0; } goto nkDp_; s1wqI: wTRm0: goto mwipN; hDUw6: CgIFE: goto XNQHq; mQ98g: $isrr = strstr($_SERVER["HTTP_REFERER"], "r=goods.detail"); goto qLpQh; clBLr: aEZaG: goto fSgs2; rgz5Q: $nowtime = TIMESTAMP; goto sXndA; S_Jj9: UrLQi: goto abOq6; uHQSK: if ($qudao == "renren" && $goodsid > 0 && pdo_tableexists("ewei_shop_goods")) { goto vmb12; } goto EuEXd; gMZUD: $kefuandgroup = pdo_fetchall("SELECT kefuid FROM " . tablename(BEST_KEFUANDGROUP) . " WHERE weid = {$_W["uniacid"]} AND groupid = {$cservicegroup["id"]}"); goto RSHjv; KJQnJ: if (!empty($advlist)) { goto GcM2i; } goto FCccf; KKICq: $cservicegroup = pdo_fetch("SELECT * FROM " . tablename(BEST_CSERVICEGROUP) . " WHERE sanbs = '{$qudao}' AND weid = {$_W["uniacid"]} AND bsid = {$jhmerid}"); goto PerrO; SjBEw: foreach ($cservicelist as $k => $v) { goto vgiEM; oETsA: bVyqc: goto V7EGC; vgiEM: $isonline = $this->kfisonline($v); goto cb4wI; ISn41: JJwz3: goto oETsA; YkTsn: unset($cservicelist[$k]); goto ISn41; cb4wI: if (!(!$isonline && $v["lyon"] == 0)) { goto JJwz3; } goto YkTsn; V7EGC: } goto HfLzy; qVhsW: goto WNuvg; goto s1wqI; CzFx_: vmb12: goto dKPp2; oLSVh: $this->module["config"]["shareurl"] = $_W["siteroot"] . "app/" . str_replace("./", '', $this->createMobileUrl("groupchat", array("id" => $id, "qudao" => $qudao, "goodsid" => $goodsid, "merch" => $merch))); goto Em02g; cdUe7: if (!($this->module["config"]["chosekefutem"] == 1 || $this->module["config"]["chosekefutem"] == 2)) { goto aEZaG; } goto CBOSj; NCkV6: $merch = intval($goodsres["merchid"]); goto BTwVW; Hm0Vj: $goodsid = $this->getrrgid($_SERVER["HTTP_REFERER"]); goto Brk6O; PerrO: WNuvg: goto rgz5Q; v7Lmv: $cservicegrouplist = pdo_fetchall("SELECT * FROM " . tablename(BEST_CSERVICEGROUP) . " WHERE weid = {$_W["uniacid"]} AND ishow = 1 AND fid = {$cservicegroup["id"]} ORDER BY displayorder ASC"); goto oLSVh; pNumn: QKa0S: goto cdUe7; RE4Bq: jcs_S: goto uHQSK; h7sg4: goto WNuvg; goto CzFx_; MqFLc: $goodsres = pdo_fetch("SELECT merchid FROM " . tablename("ewei_shop_goods") . " WHERE id = {$goodsid} AND uniacid = {$_W["uniacid"]}"); goto NCkV6; yx0ar: if ($this->module["config"]["suiji"] == 1) { goto aX6Dz; } goto QCMMY; ZbqQy: $condition .= " AND (jhtext = '' OR jhtext = {$goodsid} OR jhtext = '{$goodsid}')"; goto hDUw6; jIO2L: if (!($goodsid > 0 && pdo_tableexists("ewei_shop_goods"))) { goto sdKm7; } goto MqFLc; kQDwu: foreach ($kefuandgroup as $k => $v) { $kefuids[] = $v["kefuid"]; w3A4P: } goto S_Jj9; OWvHm: LUwmF: goto vPsS4; RvfJS: $merch = intval($_GPC["merch"]); goto mQ98g; Jzjel: $id = intval($_GPC["id"]); goto XiEQ7; RSHjv: $kefuids = array(0); goto kQDwu; DFnD5: global $_W, $_GPC; goto Pnqv7; Em02g: if (!($this->module["config"]["chosekefutem"] == 0)) { goto QKa0S; } goto rUf2T; HfLzy: DiIBz: goto v7Lmv; FCccf: $advlist = pdo_fetchall("SELECT * FROM " . tablename(BEST_ADV) . " WHERE weid = '{$_W["uniacid"]}' AND isdadi = 1 ORDER BY displayorder ASC"); goto yDk9F; rUf2T: include $this->template("groupchat"); goto pNumn; XiEQ7: $qudao = trim($_GPC["qudao"]); goto WlQwj; nkDp_: $cservicegroup = pdo_fetch("SELECT * FROM " . tablename(BEST_CSERVICEGROUP) . " WHERE weid = {$_W["uniacid"]} AND id = {$id}"); goto h7sg4; QCMMY: $orderby = " ORDER BY displayorder ASC"; goto YRO53; vPsS4: if (!($qudao == "renren" && $goodsid > 0)) { goto CgIFE; } goto ZbqQy; mwipN: $jhmerid = intval($_GPC["jhmerid"]); goto KKICq; qLpQh: if (!$isrr) { goto jcs_S; } goto Hm0Vj; YRO53: goto LUwmF; goto A4Z1G; sXndA: $advlist = pdo_fetchall("SELECT * FROM " . tablename(BEST_ADV) . " WHERE weid = '{$_W["uniacid"]}' AND (endtime > {$nowtime} OR endtime = 0) AND groupid = {$id} AND isdadi = 0 ORDER BY displayorder ASC"); goto KJQnJ; dKPp2: $cservicegroup = pdo_fetch("SELECT * FROM " . tablename(BEST_CSERVICEGROUP) . " WHERE sanbs = '{$qudao}' AND weid = {$_W["uniacid"]} AND bsid = {$merch}"); goto qVhsW; yDk9F: GcM2i: goto gMZUD; fSgs2: } public function doMobileGetchatbigimg() { goto xbUNd; WHvte: echo json_encode($resArr); goto m41vZ; cqtu6: $resArr["index"] = $nowindex; goto WHvte; a_SnB: $nowindex = 0; goto cEhHJ; RUOVG: $imglistval = substr($imglistval, 0, -1); goto LpXHb; edHe_: $oneimg = pdo_fetch("SELECT id FROM " . tablename(BEST_CHAT) . " WHERE fkid = {$fkid} AND content = '{$con}' AND weid = {$_W["uniacid"]} AND (type = 3 OR type = 4)"); goto vOV9n; lSa9X: $resArr["message"] = ''; goto Gkgfg; gA42m: $resArr["message"] = $imglistval; goto cqtu6; RAGRw: $fkid = intval($_GPC["fkid"]); goto TkEPr; bas2A: $imglist = pdo_fetchall("SELECT * FROM " . tablename(BEST_CHAT) . " WHERE fkid = {$fkid} AND weid = {$_W["uniacid"]} AND (type = 3 OR type = 4) ORDER BY time ASC"); goto edHe_; LpXHb: $resArr["error"] = 0; goto gA42m; TkEPr: $con = trim($_GPC["con"]); goto bas2A; Gkgfg: echo json_encode($resArr); goto ix0rl; N2Pqw: YuFP3: goto UJtv3; G3Fg1: $resArr["error"] = 1; goto lSa9X; xbUNd: global $_W, $_GPC; goto RAGRw; m41vZ: exit; goto N2Pqw; NTNeO: $imglistval = ''; goto a_SnB; cEhHJ: foreach ($imglist as $k => $v) { goto nBQFS; nBQFS: if (!($v["id"] == $myid)) { goto rEMpf; } goto DwalN; gpI_d: rEMpf: goto Z2NNI; DwalN: $nowindex = $k; goto gpI_d; Z2NNI: $imglistval .= $v["content"] . ","; goto m_XPN; m_XPN: UuAQp: goto a5J3D; a5J3D: } goto uluGL; uluGL: BerRe: goto RUOVG; SogH_: goto YuFP3; goto iNdbT; ix0rl: exit; goto SogH_; hsVyF: if (!empty($imglist)) { goto fkMtY; } goto G3Fg1; iNdbT: fkMtY: goto NTNeO; vOV9n: $myid = $oneimg["id"]; goto hsVyF; UJtv3: } public function doMobileGetchatbigimgxcx() { goto vzXWB; KNxex: $resArr["error"] = 1; goto sbjhU; LVRm8: $con = trim($_GPC["con"]); goto fiTby; DW4Ni: exit; goto x8mEm; djbtY: exit; goto cyjoE; SNwA2: $fkid = intval($_GPC["fkid"]); goto LVRm8; cyjoE: ZhU4m: goto JPZTV; xsBZL: $resArr["message"] = $imglistval; goto nzC25; Uphw0: foreach ($imglist as $k => $v) { goto o6mG6; Vt4Hg: wnp0x: goto OlfV9; F_edA: $imglistval .= $v["content"] . ","; goto Vt4Hg; bZSwS: $nowindex = $k; goto Dp0Yv; Dp0Yv: HddL7: goto F_edA; o6mG6: if (!($v["id"] == $myid)) { goto HddL7; } goto bZSwS; OlfV9: } goto P9F3v; YmWiA: $resArr["error"] = 0; goto xsBZL; fiTby: $imglist = pdo_fetchall("SELECT * FROM " . tablename(BEST_XCXCHAT) . " WHERE fkid = {$fkid} AND weid = {$_W["uniacid"]} AND msgtype = 'image' ORDER BY time ASC"); goto sB95a; xi3aE: $imglistval = substr($imglistval, 0, -1); goto YmWiA; nzC25: $resArr["index"] = $nowindex; goto wPC92; P9F3v: BnGfJ: goto xi3aE; wPC92: echo json_encode($resArr); goto djbtY; FYXwP: if (!empty($imglist)) { goto ymdq3; } goto KNxex; sbjhU: $resArr["message"] = ''; goto DaRBE; sB95a: $oneimg = pdo_fetch("SELECT id FROM " . tablename(BEST_XCXCHAT) . " WHERE fkid = {$fkid} AND content = '{$con}' AND weid = {$_W["uniacid"]} AND msgtype = 'image'"); goto t6Gmh; vqi1N: ymdq3: goto q2GDK; vzXWB: global $_W, $_GPC; goto SNwA2; t6Gmh: $myid = $oneimg["id"]; goto FYXwP; x8mEm: goto ZhU4m; goto vqi1N; DaRBE: echo json_encode($resArr); goto DW4Ni; wNn0Q: $nowindex = 0; goto Uphw0; q2GDK: $imglistval = ''; goto wNn0Q; JPZTV: } public function doMobileGetgroupchatbigimg() { goto CShAW; smHeL: gQubt: goto MZBg5; Qxpdq: Vpnua: goto yDgig; uQJ0Y: $resArr["error"] = 1; goto EFdVg; sA4iQ: $nowindex = 0; goto uTg3s; JXkva: $imglist = pdo_fetchall("SELECT * FROM " . tablename(BEST_GROUPCONTENT) . " WHERE weid = {$_W["uniacid"]} AND groupid = {$groupid} AND type = 3 AND time >= {$myin["intime"]} ORDER BY time ASC"); goto OTnhF; KEMbz: exit; goto NkMWI; CShAW: global $_W, $_GPC; goto VBR7U; vYKpC: echo json_encode($resArr); goto KEMbz; uBOxq: $resArr["error"] = 0; goto n0Pzn; uTg3s: foreach ($imglist as $k => $v) { goto IvCv5; zhgkM: $imglistval .= $v["content"] . ","; goto C4MUQ; C4MUQ: itx1e: goto Lc7xE; WhUaN: $nowindex = $k; goto zoVFD; zoVFD: sxXtg: goto zhgkM; IvCv5: if (!($v["id"] == $myid)) { goto sxXtg; } goto WhUaN; Lc7xE: } goto smHeL; EFdVg: $resArr["message"] = ''; goto vYKpC; OTnhF: $con = trim($_GPC["con"]); goto mr5yd; GkUt2: if (!empty($imglist)) { goto XBzsf; } goto uQJ0Y; mr5yd: $oneimg = pdo_fetch("SELECT id FROM " . tablename(BEST_GROUPCONTENT) . " WHERE groupid = {$groupid} AND content = '{$con}' AND weid = {$_W["uniacid"]} AND type = 3"); goto UFwWt; NkMWI: goto Vpnua; goto JdGGY; B5ZK_: exit; goto Qxpdq; L1bMx: $resArr["index"] = $nowindex; goto hnL4y; n0Pzn: $resArr["message"] = $imglistval; goto L1bMx; UFwWt: $myid = $oneimg["id"]; goto GkUt2; JdGGY: XBzsf: goto QpTkM; hnL4y: echo json_encode($resArr); goto B5ZK_; QpTkM: $imglistval = ''; goto sA4iQ; MZBg5: $imglistval = substr($imglistval, 0, -1); goto uBOxq; Zn3Va: $myin = pdo_fetch("SELECT intime FROM " . tablename(BEST_GROUPMEMBER) . " WHERE groupid = {$groupid} AND openid = '{$_W["fans"]["from_user"]}'"); goto JXkva; VBR7U: $groupid = intval($_GPC["groupid"]); goto Zn3Va; yDgig: } public function doMobileGetsanchatbigimg() { goto f_lpZ; rE2mZ: GJQ3n: goto gZbSA; a7sDO: $nowindex = 0; goto e72ld; goLE7: gW_Kx: goto LHbEE; Bkdap: exit; goto xrYgE; qogQ3: exit; goto jYcFX; JepfY: echo json_encode($resArr); goto Bkdap; jYcFX: goto yegNd; goto goLE7; DpeRu: if (!empty($imglist)) { goto gW_Kx; } goto wmFYm; Ubgqo: $fkid2 = intval($_GPC["fkid2"]); goto j80Rj; wmFYm: $resArr["error"] = 1; goto hJDET; hJDET: $resArr["message"] = ''; goto ZBcp3; j80Rj: $myid = intval($_GPC["myid"]); goto FrG36; xrYgE: yegNd: goto L9y43; IR9If: $resArr["error"] = 0; goto HmhNh; OwAwp: $resArr["index"] = $nowindex; goto JepfY; f_lpZ: global $_W, $_GPC; goto lUWw7; e72ld: foreach ($imglist as $k => $v) { goto GdrMI; m1tLO: $imglistval .= $v["content"] . ","; goto StPgU; z955F: $nowindex = $k; goto w6YuJ; GdrMI: if (!($v["id"] == $myid)) { goto MC086; } goto z955F; w6YuJ: MC086: goto m1tLO; StPgU: tjYdI: goto fv9Sl; fv9Sl: } goto rE2mZ; LHbEE: $imglistval = ''; goto a7sDO; FrG36: $imglist = pdo_fetchall("SELECT * FROM " . tablename(BEST_SANCHAT) . " WHERE (sanfkid = {$fkid} OR sanfkid = {$fkid2}) AND weid = {$_W["uniacid"]} AND type = 2 ORDER BY time ASC"); goto DpeRu; gZbSA: $imglistval = substr($imglistval, 0, -1); goto IR9If; lUWw7: $fkid = intval($_GPC["fkid"]); goto Ubgqo; HmhNh: $resArr["message"] = $imglistval; goto OwAwp; ZBcp3: echo json_encode($resArr); goto qogQ3; L9y43: } public function doMobileWenzhangdetail() { goto cRob4; cRob4: global $_W, $_GPC; goto KDMQV; srilN: $message = "不存在该项目！"; goto cElDj; J2bAM: V0kyh: goto o5oBv; o5oBv: $wenzhang["des"] = htmlspecialchars_decode($wenzhang["des"]); goto gfVTb; gfVTb: include $this->template("wenzhangdetail"); goto dqJeF; emrjI: $wenzhang = pdo_fetch("SELECT * FROM " . tablename(BEST_WENZHANG) . " WHERE weid = {$_W["uniacid"]} AND id = {$id}"); goto zetRj; zetRj: if (!empty($wenzhang)) { goto V0kyh; } goto srilN; EX0Ug: exit; goto J2bAM; cElDj: include $this->template("error"); goto EX0Ug; KDMQV: $id = intval($_GPC["id"]); goto emrjI; dqJeF: } public function doMobileChat() { include_once ROOT_PATH . "inc/mobile/echat.php"; } public function doMobileLiuyan() { goto NTgjT; uKtJH: $resArr["error"] = 1; goto xKTW_; zpK5X: $resArr["error"] = 0; goto fi9nH; CuxR_: $resArr["error"] = 1; goto b0IUf; c3dlT: $openid = trim($_GPC["openid"]); goto kohXy; hYYeH: exit; goto jXhWE; Ip50W: $data["openid"] = $openid; goto d2Y3R; Ge9p5: W2jsI: goto hJbQo; sBmTB: exit; goto aa4SV; c5CSK: Zbtxh: goto qcEzc; hJbQo: $content = trim($_GPC["content"]); goto hE9Wp; BeYpR: echo json_encode($resArr); goto rbJrL; rbJrL: exit; goto QTGjz; fi9nH: $resArr["msg"] = "留言成功，请等待客服回复！"; goto Qbp_Y; DOSfd: echo json_encode($resArr); goto htzKI; NTgjT: global $_W, $_GPC; goto STqGt; RgRXe: $has = pdo_fetch("SELECT id FROM " . tablename(BEST_LIUYAN) . " WHERE weid = {$_W["uniacid"]} AND openid = '{$openid}' AND kefuopenid = '{$kefuopenid}' AND readstatus = 0"); goto OnouU; Qbp_Y: echo json_encode($resArr); goto sBmTB; d2Y3R: $data["time"] = TIMESTAMP; goto Cyn1h; ViULd: $resArr["error"] = 1; goto EBoDV; UDPpy: if (empty($fields)) { goto W2jsI; } goto V3HD4; xKTW_: $resArr["msg"] = "参数错误！"; goto BeYpR; V3HD4: $others = array(); goto XDKDL; UW1DC: xCVGW: goto cyNZi; RUN_R: $fields = pdo_fetchall("select * from " . tablename(BEST_LYFIELD) . " where openid='{$kefuopenid}' order by displayorder ASC"); goto UDPpy; lXS0g: echo json_encode($resArr); goto hYYeH; kohXy: if (!(empty($kefuopenid) || empty($openid))) { goto XhEJm; } goto uKtJH; X0bLm: pdo_insert(BEST_LIUYAN, $data); goto zpK5X; htzKI: exit; goto UW1DC; XDKDL: foreach ($fields as $k => $v) { goto tNouQ; w_wcd: $resArr["msg"] = $v["yushe"] . "！"; goto mMxqy; qGi0u: $others[$k]["name"] = $v["name"]; goto XewYv; tNouQ: if (!($v["isneed"] == 1 && $_GPC[$v["fname"]] == '')) { goto vB5jw; } goto bReWq; mMxqy: echo json_encode($resArr); goto JRlv8; mDg0q: $others[$k]["fname"] = $v["fname"]; goto qGi0u; bReWq: $resArr["error"] = 1; goto w_wcd; JRlv8: exit; goto hKWC2; y3vRm: eX_Dj: goto tWdWH; XewYv: $others[$k]["val"] = $_GPC[$v["fname"]]; goto y3vRm; hKWC2: vB5jw: goto mDg0q; tWdWH: } goto c5CSK; EBoDV: $resArr["msg"] = "请等待客服处理留言！"; goto DOSfd; QTGjz: XhEJm: goto RgRXe; OnouU: if (empty($has)) { goto xCVGW; } goto ViULd; jXhWE: PRncH: goto VxOvU; VxOvU: $data["content"] = $content; goto X0bLm; qcEzc: $data["autotext"] = serialize($others); goto Ge9p5; hE9Wp: if (!empty($content)) { goto PRncH; } goto CuxR_; STqGt: $kefuopenid = trim($_GPC["kefuopenid"]); goto c3dlT; cyNZi: $data["kefuopenid"] = $kefuopenid; goto Ip50W; Cyn1h: $data["weid"] = $_W["uniacid"]; goto RUN_R; b0IUf: $resArr["msg"] = "请填写您要咨询的问题！"; goto lXS0g; aa4SV: } public function updatenowjdnum() { goto tkQFw; sLvcU: fIoUE: goto rIDA7; tkQFw: global $_W, $_GPC; goto tW7Mt; Iv5g5: foreach ($cservicelist as $k => $v) { goto OoWXV; QOgw7: $nowjdnum = $nowjdnum < 0 ? 0 : $nowjdnum; goto fVBrI; fVBrI: $data["nowjdnum"] = $nowjdnum + $v["nowjdnumbasic"]; goto erCpe; KlA9X: if (empty($nowjdnum)) { goto RTyCK; } goto QOgw7; erCpe: pdo_update(BEST_CSERVICE, $data, array("id" => $v["id"])); goto ZFkr5; kPgvi: wiFpz: goto zngFV; OoWXV: $nowjdnum = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND nowjd > 0 AND kefuopenid = '{$v["content"]}'"); goto KlA9X; ZFkr5: RTyCK: goto kPgvi; zngFV: } goto sLvcU; tW7Mt: $cservicelist = pdo_fetchall("SELECT id,content,nowjdnumbasic FROM " . tablename(BEST_CSERVICE) . " WHERE weid = {$_W["uniacid"]} AND ctype = 1"); goto Iv5g5; rIDA7: } public function doMobileChatajax() { goto HV1Mw; gjMnV: ZL3zM: goto jCdgv; bU85P: $nowjl = $total - $pindex * $psize; goto teWde; fqBqJ: $page = intval($_GPC["page"]); goto ckA2E; teWde: if (!($nowjl < 0)) { goto Jl6fM; } goto xbQD7; aVnNO: if ($total > $pindex * $psize) { goto rSVPl; } goto TSv4d; lLeoH: $allpage = ceil($total / $psize) + 1; goto bU85P; TSv4d: $tolimit = $psize - ($pindex * $psize - $total); goto oCCBL; XOSRK: $tolimit = $psize; goto gjMnV; dAAN7: Lpzh8: goto GN1UO; M1vOn: rSVPl: goto XOSRK; oCCBL: goto ZL3zM; goto M1vOn; MD8xB: exit; goto jKSv1; GKD1G: echo $html; goto MD8xB; zXjJu: foreach ($chatcon as $k => $v) { goto yoGZS; sMvTK: C099e: goto FkDnI; N92o_: YdyFg: goto nrbYR; CD0R_: $avatar = $hasfanskefu["fansavatar"]; goto xBUzN; guf5W: goto q8CYZ; goto v2Tfa; xx5p8: $class = "right"; goto CD0R_; Z8jsg: if ($v["type"] == 7) { goto oPB1u; } goto NRj97; xBUzN: goto C099e; goto wLy6m; eAp_z: $chatconhtml = "<div class=\"concon voiceplay flex\" data-con=\"" . $chatcon[$k]["content"] . "\" data-id=\"" . $chatcon[$k]["id"] . "\">\r\n\t\t\t\t\t\t\t\t\t<img src=\"" . NEWSTATIC_ROOT . "/icon/voice2.png\" class=\"voice2\" />\r\n\t\t\t\t\t\t\t\t\t" . $weidu . "\r\n\t\t\t\t\t\t\t\t\t<div class=\"flex1\"></div>\r\n\t\t\t\t\t\t\t\t</div>"; goto aR425; da5hr: $weidu = ''; goto guf5W; Pu4B6: $avatar = $hasfanskefu["kefuavatar"]; goto sMvTK; AhBl0: goto B3kdv; goto F7VnH; sYvDL: B3kdv: goto cHgg4; dKxL0: $weidu = "<span class=\"weidu\">未读</span>"; goto EeuhR; ZzOFM: if ($v["hasyuyindu"] == 0 && $hasfanskefu["kefuopenid"] == $v["toopenid"]) { goto qGw0w; } goto da5hr; cHgg4: $html .= $htmltime . "<div class=\"" . $class . " flex\">\r\n\t\t\t\t\t\t\t\t\t<img src=\"" . $avatar . "\" class=\"avatar\" />\r\n\t\t\t\t\t\t\t\t\t<div class=\"con flex flex1\">\r\n\t\t\t\t\t\t\t\t\t\t<div class=\"triangle-" . $class . "\"></div>\r\n\t\t\t\t\t\t\t\t\t\t" . $chatconhtml . "\r\n\t\t\t\t\t\t\t\t\t\t<div class=\"flex1\"></div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>"; goto N92o_; mONca: $add_arr = explode(",", $v["content"]); goto ulwPP; MN48S: $chatconhtml = "<div class=\"concon\"><img src=\"" . $v["content"] . "\" class=\"sssbbb\" /></div>"; goto fHjmg; OGaxN: $class = "left"; goto Pu4B6; NRj97: $chatconhtml = "<div class=\"concon\">" . $v["content"] . "</div>"; goto AhBl0; F7VnH: RN5Nx: goto MN48S; v2Tfa: qGw0w: goto dKxL0; ulwPP: $chatconhtml = "<div class=\"concon toaddress flex\" data-lat=\"" . $add_arr[0] . "\" data-lng=\"" . $add_arr[1] . "\" data-name=\"" . $add_arr[2] . "\" data-address=\"" . $add_arr[3] . "\">\r\n\t\t\t\t\t\t\t\t<img src=\"" . NEWSTATIC_ROOT . "/icon/map.png\" class=\"map\" />\r\n\t\t\t\t\t\t\t\t<div class=\"mapadd\">" . $add_arr[3] . "</div>\r\n\t\t\t\t\t\t\t\t<div class=\"flex1\"></div>\r\n\t\t\t\t\t\t\t</div>"; goto sYvDL; AwTwo: if ($v["type"] == 5 || $v["type"] == 6) { goto MNkg0; } goto Z8jsg; lz0_E: if ($v["openid"] != $hasfanskefu["fansopenid"]) { goto wOpV4; } goto xx5p8; FkDnI: if ($v["type"] == 3 || $v["type"] == 4) { goto RN5Nx; } goto AwTwo; aR425: goto B3kdv; goto FExrN; EeuhR: q8CYZ: goto eAp_z; dVjEf: MNkg0: goto ZzOFM; wLy6m: wOpV4: goto OGaxN; FExrN: oPB1u: goto mONca; fHjmg: goto B3kdv; goto dVjEf; yoGZS: $htmltime = !empty($v["time"]) ? "<div class=\"time text-c\">" . date("Y-m-d H:i:s", $v["time"]) . "</div>" : ''; goto lz0_E; nrbYR: } goto wwc4e; Un87k: $hasfanskefu = pdo_fetch("SELECT * FROM " . tablename(BEST_FANSKEFU) . " WHERE id = {$fkid}"); goto yedTr; Moxu1: $psize = 10; goto lLeoH; HwpS0: $chatcontime = 0; goto yv1G7; yedTr: $total = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename(BEST_CHAT) . " WHERE fkid = {$fkid} AND weid = {$_W["uniacid"]} AND fansdel = 0"); goto fqBqJ; HV1Mw: global $_W, $_GPC; goto A152B; ckA2E: $pindex = max(1, $page); goto Moxu1; AXih1: Jl6fM: goto aVnNO; yv1G7: foreach ($chatcon as $k => $v) { goto mFBFa; WlGBv: PMdhl: goto TZIjX; IyhqD: $chatcon[$k]["content"] = $this->guolv($v["content"]); goto gn8Ia; TZIjX: $chatcon[$k]["time"] = $v["time"]; goto bqPBW; ECr1F: if (!(!empty($array2[0]) && ($v["type"] == 1 || $v["type"] == 2))) { goto cta61; } goto KOTi3; fvGW9: $chatcon[$k]["content"] = htmlspecialchars_decode($v["content"]); goto IFLYH; Ghk7M: HHYB6: goto fvGW9; b447l: preg_match_all($regex, $chatcon[$k]["content"], $array2); goto ECr1F; IFLYH: SY_BP: goto amedS; mFBFa: if ($v["time"] - $chatcontime > 7200) { goto PMdhl; } goto TW0xf; PvAFP: goto SY_BP; goto Ghk7M; amedS: cta61: goto kxg3v; gn8Ia: $chatcon[$k]["content"] = preg_replace("/\\xEE[\\x80-\\xBF][\\x80-\\xBF]|\\xEF[\\x81-\\x83][\\x80-\\xBF]/", "[无法识别字符]", $chatcon[$k]["content"]); goto koQEZ; XfxEO: goto yQb98; goto WlGBv; koQEZ: $regex = "@(?i)\\b((?:[a-z][\\w-]+:(?:/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?«»“”‘’]))@"; goto b447l; a7VRd: $chatcontime = $v["time"]; goto IyhqD; bqPBW: yQb98: goto a7VRd; KOTi3: if ($v["isjqr"] == 1 || $v["istuwen"] == 1) { goto HHYB6; } goto xNV7N; kxg3v: yzfLH: goto aJUvk; xNV7N: foreach ($array2[0] as $kk => $vv) { goto d4ayR; vKSDp: PlS0R: goto ARaIj; wsbA7: $vvurl = strstr($vv, "http") ? $vv : "http://" . $vv; goto Mb7sj; ARaIj: cUjp0: goto z7zui; Mb7sj: $chatcon[$k]["content"] = str_replace($vv, "<a href='" . $vvurl . "'>" . $vv . "</a>", $chatcon[$k]["content"]); goto vKSDp; d4ayR: if (empty($vv)) { goto PlS0R; } goto wsbA7; z7zui: } goto c9aLH; TW0xf: $chatcon[$k]["time"] = ''; goto XfxEO; c9aLH: iz2Pp: goto PvAFP; aJUvk: } goto dAAN7; GN1UO: $html = ''; goto zXjJu; jCdgv: $chatcon = pdo_fetchall("SELECT * FROM " . tablename(BEST_CHAT) . " WHERE fkid = {$fkid} AND weid = {$_W["uniacid"]} AND fansdel = 0 ORDER BY time ASC LIMIT " . $nowjl . "," . $tolimit); goto HwpS0; A152B: $fkid = intval($_GPC["fkid"]); goto Un87k; wwc4e: UFSYK: goto GKD1G; xbQD7: $nowjl = 0; goto AXih1; jKSv1: } public function doMobileAddbiaoqian() { goto nbhWF; Tl6Iu: $toopenid = trim($_GPC["toopenid"]); goto tYPtm; RC0Ry: if ($has) { goto smpHh; } goto tqcQN; QfWIT: GBQ_D: goto oSguu; IbVVL: $telphone = trim($_GPC["telphone"]); goto Tl6Iu; svYEL: $realname = trim($_GPC["realname"]); goto IbVVL; EhaDM: $data["name"] = $name; goto cKpgi; tUsYj: $ssopenid = $_GPC["ssopenid"]; goto NPCYS; YX2F8: smpHh: goto LsF0A; L0Eab: exit; goto jH0N8; IV2ni: $data["kefuopenid"] = $openid; goto xAzAn; tqcQN: $data["weid"] = $_W["uniacid"]; goto IV2ni; zKTHo: echo json_encode($resArr); goto Do1tk; cX6aO: echo json_encode($resArr); goto hsLr9; nbhWF: global $_W, $_GPC; goto AJrXO; B3OAH: if (!empty($openid)) { goto Ei83M; } goto NmUlA; cKpgi: $data["realname"] = $realname; goto runC2; Uzkvs: Ei83M: goto xFBlv; xAzAn: $data["fensiopenid"] = $toopenid; goto EhaDM; NmUlA: $resArr["error"] = 1; goto BghL_; z_lQh: $openid = $ssopenid; goto ohPFS; phjDk: pdo_insert(BEST_BIAOQIAN, $data); goto jHsmP; ohPFS: PEDPM: goto B3OAH; xFBlv: $name = trim($_GPC["content"]); goto Oz_2I; Oz_2I: if (!empty($name)) { goto ZPiSe; } goto FeHGF; oSguu: $resArr["error"] = 0; goto BKcnC; BKcnC: $resArr["msg"] = "恭喜你添加用户标签成功！"; goto cX6aO; LsF0A: pdo_update(BEST_BIAOQIAN, array("name" => $name, "realname" => $realname, "telphone" => $telphone), array("kefuopenid" => $openid, "fensiopenid" => $toopenid, "weid" => $_W["uniacid"])); goto QfWIT; AJrXO: $openid = $_W["fans"]["from_user"]; goto tUsYj; tYPtm: $has = pdo_fetch("SELECT * FROM " . tablename(BEST_BIAOQIAN) . " WHERE kefuopenid = '{$openid}' AND fensiopenid = '{$toopenid}' AND weid = {$_W["uniacid"]}"); goto RC0Ry; FeHGF: $resArr["error"] = 1; goto l8BmP; NPCYS: if (!($ssopenid != '' && empty($openid))) { goto PEDPM; } goto z_lQh; runC2: $data["telphone"] = $telphone; goto phjDk; rXLzY: echo json_encode($resArr); goto L0Eab; jHsmP: goto GBQ_D; goto YX2F8; hsLr9: exit; goto nzbhy; Do1tk: exit; goto Uzkvs; l8BmP: $resArr["msg"] = "请填写标签内容！"; goto rXLzY; jH0N8: ZPiSe: goto svYEL; BghL_: $resArr["msg"] = "未获取到您的客服信息！"; goto zKTHo; nzbhy: } public function doMobileAddpingjia() { goto Xibnd; i_42T: $has = pdo_fetch("SELECT * FROM " . tablename(BEST_PINGJIA) . " WHERE kefuopenid = '{$toopenid}' AND fensiopenid = '{$openid}' AND weid = {$_W["uniacid"]}"); goto u8zjF; lO4bz: $data["content"] = $_GPC["content"]; goto eumhA; xUpbn: if (!empty($openid)) { goto ItXe8; } goto zwD70; ihhDU: $data["content"] = $_GPC["content"]; goto A1ZIA; IUNpP: $data["kefuopenid"] = $toopenid; goto oUgmu; uxbrY: exit; goto I4IYf; lcgMd: goto lHXkj; goto hyXOx; elgcI: exit; goto UcTnl; Nq1Hr: echo json_encode($resArr); goto eUX_o; jjbHy: $resArr["error"] = 0; goto yx8wl; yx8wl: $resArr["msg"] = "恭喜你评价成功！"; goto alOIq; A1ZIA: $data["time"] = TIMESTAMP; goto LIid9; LIid9: pdo_update(BEST_PINGJIA, $data, array("kefuopenid" => $toopenid, "fensiopenid" => $openid, "weid" => $_W["uniacid"])); goto s1EQh; Xibnd: global $_W, $_GPC; goto vzW4M; xaHRd: ItXe8: goto BGoJt; s1EQh: lHXkj: goto jjbHy; TuXpS: $resArr["msg"] = "请在微信端评价！"; goto Nq1Hr; DV7my: $data["time"] = TIMESTAMP; goto lO4bz; oUgmu: $data["fensiopenid"] = $openid; goto DrcMP; WuLjD: $toopenid = trim($_GPC["toopenid"]); goto i_42T; bUqyC: $resArr["error"] = 1; goto Ofgm8; u8zjF: if ($has) { goto h09Xm; } goto FI7ZP; FI7ZP: $data["weid"] = $_W["uniacid"]; goto IUNpP; vzW4M: $openid = $_W["fans"]["from_user"]; goto xUpbn; Y3_e4: echo json_encode($resArr); goto uxbrY; zwD70: $resArr["error"] = 1; goto TuXpS; BGoJt: $pingtype = intval($_GPC["pingtype"]); goto fvUUa; eumhA: pdo_insert(BEST_PINGJIA, $data); goto lcgMd; ADX7J: $data["pingtype"] = $pingtype; goto ihhDU; DrcMP: $data["pingtype"] = $pingtype; goto DV7my; Ofgm8: $resArr["msg"] = "请选择评价类型！"; goto Y3_e4; hyXOx: h09Xm: goto ADX7J; alOIq: echo json_encode($resArr); goto elgcI; eUX_o: exit; goto xaHRd; fvUUa: if (!($pingtype <= 0)) { goto tRZaJ; } goto bUqyC; I4IYf: tRZaJ: goto WuLjD; UcTnl: } public function doMobileUpdatefans() { goto SlWAc; YOGOI: foreach ($fklast as $k => $v) { pdo_update(BEST_FANSKEFU, $dataup, array("id" => $v["id"])); RifHF: } goto GhADL; rn0Wm: goto dShPW; goto dOSR5; iIi4t: $access_token = $account_api->getAccessToken(); goto N9tsI; x0Mgm: $resArr["message"] = "粉丝未关注公众号，不能同步！"; goto rn0Wm; dOSR5: a_pWQ: goto HDeM7; wk92c: $resArr["error"] = 0; goto ACNno; DKJVO: $resArr["error"] = 1; goto x0Mgm; N9tsI: $url = "https://api.weixin.qq.com/cgi-bin/user/info?access_token=" . $access_token . "&openid=" . $toopenid . "&lang=zh_CN"; goto YG9Sy; HDeM7: $dataup["fansavatar"] = $response["headimgurl"]; goto YOGOI; ACNno: dShPW: goto VRrni; mohC_: if ($response["subscribe"] == 1) { goto a_pWQ; } goto DKJVO; VRrni: echo json_encode($resArr, true); goto rpelj; C0XDJ: $resArr["message"] = "更新成功！"; goto wk92c; YG9Sy: $response = ihttp_get($url); goto RqDC2; rpelj: exit; goto Bv8Tp; Huedt: $fklast = pdo_fetchall("SELECT * FROM " . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND fansopenid = '{$toopenid}'"); goto BT3Dh; RqDC2: $response = json_decode($response["content"], true); goto mohC_; SlWAc: global $_W, $_GPC; goto Dd5z2; Dd5z2: $toopenid = trim($_GPC["toopenid"]); goto Huedt; GhADL: qRvtU: goto C0XDJ; BT3Dh: $account_api = WeAccount::create(); goto iIi4t; Bv8Tp: } public function doMobileJcbd() { goto ivFGF; cMkhF: $resArr["msg"] = "不存在该记录！"; goto KiIVR; mFqvs: if (!empty($fanskefu)) { goto kZXGG; } goto m8aiH; ytyOc: echo json_encode($resArr, true); goto xioEw; hQf5F: pdo_update(BEST_FANSKEFU, $dataup, array("id" => $fkid)); goto GCeNI; kAqjt: $resArr["msg"] = "解除绑定成功！"; goto ytyOc; GCeNI: $resArr["error"] = 0; goto kAqjt; IG0XZ: $fanskefu = pdo_fetch("SELECT * FROM " . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND id = {$fkid}"); goto mFqvs; KiIVR: echo json_encode($resArr); goto Bq1CK; XB07l: $fkid = intval($_GPC["fkid"]); goto IG0XZ; oA98Z: kZXGG: goto vmb52; ivFGF: global $_W, $_GPC; goto XB07l; Bq1CK: exit; goto oA98Z; m8aiH: $resArr["error"] = 1; goto cMkhF; vmb52: $dataup["bdopenid"] = ''; goto hQf5F; xioEw: exit; goto jnfJo; jnfJo: } public function doMobileZhuanjie() { goto tBZyY; lOF1l: $wherefrom = $fromfanskefu["wherefrom"]; goto QsQ96; QsCus: $datachat["content"] = "已转接至" . $zhuanjiekefu["name"] . "为您继续提供服务！"; goto JWQDy; TRTdz: MbuAd: goto OjILP; HvCpr: $resArr["msg"] = "转接成功"; goto Vrlce; MuXb9: pdo_insert(BEST_FANSKEFU, $datafanskefu); goto G04Ez; kOi22: $resArr["error"] = 0; goto Fho2N; G04Ez: $fkid = pdo_insertid(); goto lOF1l; TOBRM: $datafanskefu["intime"] = TIMESTAMP; goto MuXb9; wxLU8: pdo_insert(BEST_CHAT, $datachat); goto p9kqN; V8oxp: $openid = $_W["fans"]["from_user"]; goto Hi93F; tBZyY: global $_W, $_GPC; goto V8oxp; nXsq4: pdo_update(BEST_FANSKEFU, array("nowjd" => 0), array("fansopenid" => $toopenid)); goto eBtVJ; BYRjL: $account_api = WeAccount::create(); goto HWrVd; BkXlo: $datafanskefu["fansavatar"] = empty($fansuser["headimgurl"]) ? tomedia($this->module["config"]["defaultavatar"]) : $fansuser["headimgurl"]; goto P2PQm; kQWcQ: $toopenid = trim($_GPC["toopenid"]); goto hgJlc; OjILP: $datafanskefu["fansavatar"] = tomedia($this->module["config"]["defaultavatar"]); goto iuThV; vEteq: $datachat["weid"] = $_W["uniacid"]; goto PVCWQ; V_Buk: if (empty($fansuser)) { goto MbuAd; } goto BkXlo; jjP5s: exit; goto mfMCC; x_xAp: pyc9M: goto APokN; SyMQX: $fansuser = $account_api->fansQueryInfo($toopenid); goto V_Buk; lYmhT: $datachat["toopenid"] = $toopenid; goto QsCus; BLzuG: $resArr["error"] = 1; goto cCWQ0; Qu8LV: $fromfanskefu = pdo_fetch("SELECT wherefrom FROM " . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND fansopenid = '{$toopenid}' AND kefuopenid = '{$openid}'"); goto oUCd4; SNJ8Y: $content = trim($_GPC["content"]); goto EM1M0; TnJzI: $senddata = array("openid" => $content, "url" => $this->gettpldomain() . "app/" . str_replace("./", '', $this->createMobileUrl("servicechat", array("toopenid" => $toopenid))), "first" => "客户:" . $fanskefu["fansnickname"] . "转接提醒！", "keyword1" => $zhuanjiekefu["name"], "wherefrom" => $wherefrom); goto gJ0CN; Q93Q2: $datachat["openid"] = $content; goto lYmhT; HWrVd: $account_api->sendCustomNotice($custom); goto nYqsq; qUxx9: goto Mheqr; goto bpo4G; QsQ96: $hasfanskefu = pdo_fetch("SELECT * FROM " . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND fansopenid = '{$toopenid}' AND kefuopenid = '{$content}'"); goto P2W0l; JWQDy: $datachat["nickname"] = $zhuanjiekefu["name"]; goto L9Pql; JnFqo: $custom = array("msgtype" => "text", "text" => array("content" => urlencode($datachat["content"])), "touser" => $toopenid); goto BYRjL; bEQ3i: exit; goto RH20l; b_4Eh: $datafanskefu["wherefrom"] = $fromfanskefu["wherefrom"]; goto aUBpO; hCaSq: Vj1Sg: goto kQWcQ; c9lAj: $resArr["error"] = 1; goto lor1U; LsyIM: dZSqL: goto Qu8LV; Hi93F: if (!empty($openid)) { goto Vj1Sg; } goto hXh5I; eBtVJ: pdo_update(BEST_FANSKEFU, array("nowjd" => 1), array("id" => $fkid)); goto vEteq; LQYGe: $datafanskefu["kefuopenid"] = $content; goto b_4Eh; boeAK: echo json_encode($resArr); goto jjP5s; JDCtN: echo json_encode($resArr); goto qsUj_; cVkfP: goto pyc9M; goto TRTdz; EM1M0: if (!empty($content)) { goto dZSqL; } goto BLzuG; qp3G6: $zhuanjiekefu = pdo_fetch("SELECT * FROM " . tablename(BEST_CSERVICE) . " WHERE weid = {$_W["uniacid"]} AND content = '{$content}'"); goto GQyJ1; qsUj_: exit; goto LsyIM; APokN: $datafanskefu["kefuavatar"] = tomedia($zhuanjiekefu["thumb"]); goto QN_Zi; iuThV: $datafanskefu["fansnickname"] = "匿名用户"; goto x_xAp; p9kqN: if (!($wherefrom == 1)) { goto vFp0H; } goto JnFqo; gJ0CN: $this->sendtplmsg($senddata); goto kOi22; WZVm9: $fkid = $hasfanskefu["id"]; goto RHogc; Vrlce: echo json_encode($resArr); goto bEQ3i; P2W0l: Mheqr: goto Rdgc6; PVCWQ: $datachat["fkid"] = $fkid; goto Q93Q2; aUBpO: $account_api = WeAccount::create(); goto SyMQX; HJDCN: $datafanskefu["fansopenid"] = $toopenid; goto LQYGe; mfMCC: KCW5v: goto SNJ8Y; Zk6LD: exit; goto hCaSq; QN_Zi: $datafanskefu["kefunickname"] = $zhuanjiekefu["name"]; goto TOBRM; hgJlc: if (!empty($toopenid)) { goto KCW5v; } goto c9lAj; P2PQm: $datafanskefu["fansnickname"] = empty($fansuser["nickname"]) ? "匿名用户" : $fansuser["nickname"]; goto cVkfP; lor1U: $resArr["msg"] = "获取用户数据失败！"; goto boeAK; Fho2N: $resArr["toopenid"] = $content; goto HvCpr; RHogc: $wherefrom = $hasfanskefu["wherefrom"]; goto qUxx9; IiOcU: $resArr["msg"] = "请在微信浏览器中打开！"; goto XH3l4; GQyJ1: if (empty($hasfanskefu)) { goto KOzoM; } goto WZVm9; cCWQ0: $resArr["msg"] = "请选择要转接的客服！"; goto JDCtN; REH2n: $datachat["type"] = 1; goto PVW0w; XH3l4: echo json_encode($resArr); goto Zk6LD; PVW0w: $datachat["time"] = TIMESTAMP; goto wxLU8; hXh5I: $resArr["error"] = 1; goto IiOcU; L9Pql: $datachat["avatar"] = tomedia($zhuanjiekefu["thumb"]); goto REH2n; bpo4G: KOzoM: goto zAWBI; nYqsq: vFp0H: goto TnJzI; Rdgc6: $fanskefu = pdo_fetch("SELECT * FROM " . tablename(BEST_FANSKEFU) . " WHERE id = {$fkid}"); goto nXsq4; zAWBI: $datafanskefu["weid"] = $_W["uniacid"]; goto HJDCN; oUCd4: $hasfanskefu = pdo_fetch("SELECT * FROM " . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND fansopenid = '{$toopenid}' AND kefuopenid = '{$content}'"); goto qp3G6; RH20l: } public function doMobileZhuanjiexcx() { goto g3MBp; HDrS7: goto K8axF; goto dqs1M; yC7Rf: echo json_encode($resArr); goto XuQQ5; zdruP: if (!empty($toopenid)) { goto hL05K; } goto QVggg; eWq1W: $toopenid = trim($_GPC["toopenid"]); goto zdruP; mLw2M: $hasfanskefu = pdo_fetch("SELECT * FROM " . tablename(BEST_XCXFANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND fansopenid = '{$toopenid}' AND kefuopenid = '{$content}'"); goto AGhWf; C1BJQ: n47_c: goto eWq1W; yf8ND: if (!empty($content)) { goto qzLqt; } goto XCh8Z; DmPRw: echo json_encode($resArr); goto MZrWP; wC4yP: $datafanskefu["nowkefu"] = 1; goto DXVIj; UQSbq: $fkid = pdo_insertid(); goto aTzn8; MZrWP: exit; goto C1BJQ; bdKbC: pdo_update(BEST_XCXFANSKEFU, array("nowkefu" => 0), array("id" => $hasfanskefu2["id"])); goto yAs9p; KtN5B: $datafanskefu["kefuavatar"] = tomedia($zhuanjiekefu["thumb"]); goto mPqKI; XuQQ5: exit; goto vbFrW; nZn93: $zhuanjiekefu = pdo_fetch("SELECT * FROM " . tablename(BEST_XCXCSERVICE) . " WHERE weid = {$_W["uniacid"]} AND content = '{$content}'"); goto cBlp1; i7_k2: $resArr["msg"] = "转接成功"; goto fNYnZ; Pcy83: $zjtxt = "您已被转接至" . $zhuanjiekefu["name"]; goto TcEN2; TcEN2: $this->addxcxchat2($toopenid, $zjtxt, "text", $gh_id); goto TgPHW; fNYnZ: echo json_encode($resArr); goto Fd_uN; cBlp1: if (empty($hasfanskefu)) { goto yjAtr; } goto uPFP6; HyuHO: $datafanskefu["kefuopenid"] = $content; goto E1YqI; U5Otj: $this->sendtplmsg($senddata); goto Pcy83; uPFP6: $fkid = $hasfanskefu["id"]; goto TnD8T; AGhWf: $hasfanskefu2 = pdo_fetch("SELECT * FROM " . tablename(BEST_XCXFANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND fansopenid = '{$toopenid}' AND kefuopenid = '{$openid}'"); goto nZn93; JJFoa: $resArr["fkid"] = $fkid; goto i7_k2; xGtSv: $resArr["toopenid"] = $content; goto JJFoa; DXVIj: pdo_insert(BEST_XCXFANSKEFU, $datafanskefu); goto UQSbq; Au7bw: $resArr["msg"] = "请在微信浏览器中打开！"; goto DmPRw; fR6vk: qzLqt: goto mLw2M; vbFrW: hL05K: goto xeS1j; nfwts: $datafanskefu["weid"] = $_W["uniacid"]; goto uOCiN; rgrT0: $datafanskefu["fansnickname"] = $hasfanskefu2["fansnickname"]; goto KtN5B; yAs9p: pdo_update(BEST_XCXFANSKEFU, array("nowkefu" => 1), array("id" => $fkid)); goto xXUjw; Y10Fu: $openid = $_W["fans"]["from_user"]; goto nsfao; TnD8T: $gh_id = $hasfanskefu["gh_id"]; goto HDrS7; mPqKI: $datafanskefu["kefunickname"] = $zhuanjiekefu["name"]; goto Vali3; dqs1M: yjAtr: goto nfwts; dqx62: $resArr["msg"] = "获取用户数据失败！"; goto yC7Rf; xXUjw: $senddata = array("openid" => $content, "url" => $this->gettpldomain() . "app/" . str_replace("./", '', $this->createMobileUrl("xcxchat", array("fkid" => $fkid))), "first" => "小程序客户转接提醒！", "keyword1" => $zhuanjiekefu["name"], "wherefrom" => 0); goto U5Otj; rQaNv: $resArr["msg"] = "请选择要转接的客服！"; goto hNDTf; XCh8Z: $resArr["error"] = 1; goto rQaNv; g3MBp: global $_W, $_GPC; goto Y10Fu; QVggg: $resArr["error"] = 1; goto dqx62; E1YqI: $datafanskefu["fansavatar"] = $hasfanskefu2["fansavatar"]; goto rgrT0; Fd_uN: exit; goto FnUnT; TgPHW: $resArr["error"] = 0; goto xGtSv; uOCiN: $datafanskefu["fansopenid"] = $toopenid; goto HyuHO; ynlW7: exit; goto fR6vk; hNDTf: echo json_encode($resArr); goto ynlW7; aTzn8: K8axF: goto bdKbC; Vali3: $datafanskefu["gh_id"] = $gh_id = $hasfanskefu2["gh_id"]; goto wC4yP; xeS1j: $content = trim($_GPC["content"]); goto yf8ND; fI9As: $resArr["error"] = 1; goto Au7bw; nsfao: if (!empty($openid)) { goto n47_c; } goto fI9As; FnUnT: } public function doMobileServicechat() { include_once ROOT_PATH . "inc/mobile/eservicechat.php"; } public function doMobileFinishjd() { goto Ykhyf; kluoF: $cservice = pdo_fetch("SELECT * FROM " . tablename(BEST_CSERVICE) . " WHERE weid = {$_W["uniacid"]} AND id = {$id}"); goto Mf72j; HdSQ5: $resArr["url"] = $this->createMobileUrl("kefucenter"); goto vdfbZ; Mf72j: $dataupkefu["nowfkid"] = 0; goto ORAch; lKekV: echo json_encode($resArr); goto idhQY; b__C2: pdo_update(BEST_CSERVICE, $dataupkefu, array("id" => $cservice["id"])); goto HdSQ5; XPPIC: $dataupfk["jdtime"] = 0; goto sIGYX; tphtZ: $dataupfk["nowjd"] = 0; goto XPPIC; vdfbZ: $resArr["error"] = 0; goto G2sYz; G2sYz: $resArr["msg"] = "结束会话成功"; goto lKekV; ORAch: $dataupkefu["nowjdnum"] = $cservice["nowjdnum"] - 1; goto b__C2; sIGYX: pdo_update(BEST_FANSKEFU, $dataupfk, array("id" => $fkid)); goto vZKM3; vZKM3: $id = intval($_GPC["id"]); goto kluoF; Ykhyf: global $_W, $_GPC; goto x5WCG; x5WCG: $fkid = intval($_GPC["fkid"]); goto tphtZ; idhQY: exit; goto NKhxa; NKhxa: } public function doMobileServicechatajax() { goto a7W9M; a7W9M: global $_W, $_GPC; goto eGnpa; BE3S2: if ($total > $pindex * $psize) { goto Abonn; } goto tHc5f; c1vgA: goto pc0Ep; goto xtxu1; KnAm3: $total = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename(BEST_CHAT) . " WHERE fkid = {$fkid} AND kefudel = 0"); goto puZ1_; moTkT: $html = ''; goto MXfXl; cCHZ0: $psize = 10; goto Coj2U; Xv7Ty: $nowjl = $total - $pindex * $psize; goto AwFoM; GHCRo: $hasfanskefu = pdo_fetch("SELECT * FROM " . tablename(BEST_FANSKEFU) . " WHERE id = {$fkid}"); goto KnAm3; gRFPo: nXpUC: goto ynpOs; TMFWR: bDsoH: goto BE3S2; Coj2U: $allpage = ceil($total / $psize) + 1; goto Xv7Ty; djp11: JOcty: goto moTkT; NwmTR: $chatcon = pdo_fetchall("SELECT * FROM " . tablename(BEST_CHAT) . " WHERE fkid = {$fkid} AND kefudel = 0 ORDER BY time ASC LIMIT " . $nowjl . "," . $tolimit); goto L2Bzk; SnfOy: exit; goto xSaKo; xtxu1: Abonn: goto Vo9gW; puZ1_: $page = intval($_GPC["page"]); goto CJpAZ; x0jm2: $nowjl = 0; goto TMFWR; Vo9gW: $tolimit = $psize; goto kyQve; AwFoM: if (!($nowjl < 0)) { goto bDsoH; } goto x0jm2; tHc5f: $tolimit = $psize - ($pindex * $psize - $total); goto c1vgA; CJpAZ: $pindex = max(1, $page); goto cCHZ0; ynpOs: echo $html; goto SnfOy; L2Bzk: $chatcontime = 0; goto j8eRT; eGnpa: $fkid = intval($_GPC["fkid"]); goto GHCRo; MXfXl: foreach ($chatcon as $k => $v) { goto acRxF; xXAWH: $chatconhtml = "<div class=\"concon\"><img src=\"" . $v["content"] . "\" class=\"sssbbb\" /></div>"; goto pcnWR; eKSn9: $add_arr = explode(",", $chatcon[$k]["content"]); goto M_hBP; fO0Zf: nrBPm: goto FLqYG; SsqmA: if ($v["type"] == 5 || $v["type"] == 6) { goto nHQVl; } goto IiVq5; acRxF: $htmltime = !empty($v["time"]) ? "<div class=\"time text-c\">" . date("Y-m-d H:i:s", $v["time"]) . "</div>" : ''; goto EwG3g; jLUTW: YAHoy: goto GYQNp; qRH5q: $avatar = $hasfanskefu["kefuavatar"]; goto eGfIr; ZnlsX: $html .= $htmltime . "<div class=\"" . $class . " flex\">\r\n\t\t\t\t\t\t\t\t\t<img src=\"" . $avatar . "\" class=\"avatar\" />\r\n\t\t\t\t\t\t\t\t\t<div class=\"con flex flex1\">\r\n\t\t\t\t\t\t\t\t\t\t<div class=\"triangle-" . $class . "\"></div>\r\n\t\t\t\t\t\t\t\t\t\t" . $chatconhtml . "\r\n\t\t\t\t\t\t\t\t\t\t<div class=\"flex1\"></div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>"; goto xzlrX; M_hBP: $chatconhtml = "<div class=\"concon toaddress flex\" data-lat=\"" . $add_arr[0] . "\" data-lng=\"" . $add_arr[1] . "\" data-name=\"" . $add_arr[2] . "\" data-address=\"" . $add_arr[3] . "\">\r\n\t\t\t\t\t\t\t\t<img src=\"" . NEWSTATIC_ROOT . "/icon/map.png\" class=\"map\" />\r\n\t\t\t\t\t\t\t\t<div class=\"mapadd\">" . $add_arr[3] . "</div>\r\n\t\t\t\t\t\t\t\t<div class=\"flex1\"></div>\r\n\t\t\t\t\t\t\t</div>"; goto ZHvQN; VaYON: if ($v["hasyuyindu"] == 0 && $hasfanskefu["kefuopenid"] == $v["toopenid"]) { goto ZrJSs; } goto BTPm7; H6etG: $chatconhtml = "<div class=\"concon\">" . $v["content"] . "</div>"; goto gu1F8; xzlrX: shfxg: goto gX500; uEMcf: if ($v["type"] == 3 || $v["type"] == 4) { goto d8_kH; } goto SsqmA; IiVq5: if ($v["type"] == 7) { goto IOk2C; } goto H6etG; Jhqpk: IOk2C: goto eKSn9; EwG3g: if ($v["openid"] != $hasfanskefu["kefuopenid"]) { goto YAHoy; } goto c7dgp; Tq5Pv: ZrJSs: goto CsCFl; BTPm7: $weidu = ''; goto qZNY2; pcnWR: goto jCuhB; goto heeqG; gu1F8: goto jCuhB; goto kTYF5; c7dgp: $class = "right"; goto qRH5q; FLqYG: $chatconhtml = "<div class=\"concon voiceplay flex\" data-con=\"" . $chatcon[$k]["content"] . "\" data-id=\"" . $chatcon[$k]["id"] . "\">\r\n\t\t\t\t\t\t\t\t\t<img src=\"" . NEWSTATIC_ROOT . "/icon/voice2.png\" class=\"voice2\" />\r\n\t\t\t\t\t\t\t\t\t" . $weidu . "\r\n\t\t\t\t\t\t\t\t\t<div class=\"flex1\"></div>\r\n\t\t\t\t\t\t\t\t</div>"; goto lq7bq; lq7bq: goto jCuhB; goto Jhqpk; heeqG: nHQVl: goto VaYON; qZNY2: goto nrBPm; goto Tq5Pv; CsCFl: $weidu = "<span class=\"weidu\">未读</span>"; goto fO0Zf; eGfIr: goto N_lgd; goto jLUTW; xrzRO: N_lgd: goto uEMcf; kTYF5: d8_kH: goto xXAWH; ZHvQN: jCuhB: goto ZnlsX; dRyjX: $avatar = $hasfanskefu["fansavatar"]; goto xrzRO; GYQNp: $class = "left"; goto dRyjX; gX500: } goto gRFPo; j8eRT: foreach ($chatcon as $k => $v) { goto oYH1C; bg3jt: $chatcon[$k]["content"] = preg_replace("/\\xEE[\\x80-\\xBF][\\x80-\\xBF]|\\xEF[\\x81-\\x83][\\x80-\\xBF]/", "[无法识别字符]", $chatcon[$k]["content"]); goto Wpdke; Wpdke: $regex = "@(?i)\\b((?:[a-z][\\w-]+:(?:/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?«»“”‘’]))@"; goto m1vaE; jGoP0: wu5WL: goto HdgoO; qhezu: aFX_q: goto x29k9; mj1RP: if (!(!empty($array2[0]) && ($v["type"] == 1 || $v["type"] == 2))) { goto yjPbd; } goto pU9KE; x29k9: $chatcontime = $v["time"]; goto EeHHO; Ts_YR: $chatcon[$k]["time"] = ''; goto ctMUW; d0e8b: H6Yuh: goto YVlOd; HdgoO: goto Prbss; goto REs5O; bzZlF: foreach ($array2[0] as $kk => $vv) { goto AxJSU; hSDBC: $vvurl = strstr($vv, "http") ? $vv : "http://" . $vv; goto k91UX; AxJSU: if (empty($vv)) { goto ygHqC; } goto hSDBC; H4puG: ygHqC: goto ThpJY; k91UX: $chatcon[$k]["content"] = str_replace($vv, "<a href='" . $vvurl . "'>" . $vv . "</a>", $chatcon[$k]["content"]); goto H4puG; ThpJY: QHdRj: goto U806J; U806J: } goto jGoP0; EeHHO: $chatcon[$k]["content"] = $this->guolv($v["content"]); goto bg3jt; leLfm: w3q1J: goto DDlW0; REs5O: Kv2hA: goto cUxCC; oYH1C: if ($v["time"] - $chatcontime > 7200) { goto H6Yuh; } goto Ts_YR; YVlOd: $chatcon[$k]["time"] = $v["time"]; goto qhezu; pU9KE: if ($v["isjqr"] == 1 || $v["istuwen"] == 1) { goto Kv2hA; } goto bzZlF; cUxCC: $chatcon[$k]["content"] = htmlspecialchars_decode($v["content"]); goto gRIKB; rgPf1: yjPbd: goto leLfm; ctMUW: goto aFX_q; goto d0e8b; gRIKB: Prbss: goto rgPf1; m1vaE: preg_match_all($regex, $chatcon[$k]["content"], $array2); goto mj1RP; DDlW0: } goto djp11; kyQve: pc0Ep: goto NwmTR; xSaKo: } public function doMobilezhuizong() { include_once ROOT_PATH . "inc/mobile/zhuizong.php"; } public function doMobileAllshare() { goto oW627; G5Oy8: if (!empty($isingroup)) { goto raYUi; } goto KQYdo; bBEaQ: $allingroup = pdo_fetchall("SELECT groupid FROM " . tablename(BEST_KEFUANDGROUP) . " WHERE kefuid = {$cservice["id"]}"); goto R7aWy; C8cpe: include $this->template("error"); goto u2X6i; QS4NG: if ($this->module["config"]["sharetype"] == 0) { goto bOcGf; } goto bBEaQ; COTV_: bOcGf: goto n8c2p; n8c2p: $allfanskefu = pdo_fetchall("SELECT id FROM " . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND fansopenid = '{$toopenid}'"); goto jqL8q; esr8a: aqRgA: goto wv4dF; QxuTQ: CFwQw: goto XpXU4; wK9jk: $message = "暂未开通客户记录共享功能，如需要请联系管理员在基本设置中开启！"; goto oKZtP; d_9br: $groupcservicearr = substr($groupcservicearr, 0, -1) . ")"; goto btItV; uCnNJ: $groupcservice = pdo_fetchall("SELECT b.content FROM " . tablename(BEST_KEFUANDGROUP) . " as a," . tablename(BEST_CSERVICE) . " as b WHERE a.weid = {$_W["uniacid"]} AND a.groupid in (" . implode(",", $allingrouparr) . ") AND a.kefuid = b.id AND b.ctype = 1"); goto VKoOX; VKoOX: $groupcservicearr = "("; goto omZ2N; Odn1M: $fkids = substr($fkids, 0, -1) . ")"; goto TBcBM; Ftlpe: LeJKl: goto JBKQU; omZ2N: foreach ($groupcservice as $kk => $vv) { $groupcservicearr .= "'" . $vv["content"] . "',"; Q1F4y: } goto tiepY; btItV: $allfanskefu = pdo_fetchall("SELECT id FROM " . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND fansopenid = '{$toopenid}' AND kefuopenid in {$groupcservicearr}"); goto KQ7wR; CaK5y: $cservice = pdo_fetch("SELECT id,thumb FROM " . tablename(BEST_CSERVICE) . " WHERE weid = {$_W["uniacid"]} AND content = '{$openid}'"); goto qM0QQ; DBnm6: dH4bz: goto q20ns; ZNDew: ZOS5p: goto ifMw1; G5qDK: include_once ROOT_PATH . "qqface.php"; goto CvoC_; htzWw: exit; goto esr8a; oW627: global $_W, $_GPC; goto G5qDK; BIhNf: hu6dF: goto CaK5y; u2X6i: exit; goto BIhNf; J9qdd: $isingroup = pdo_fetch("SELECT id FROM " . tablename(BEST_KEFUANDGROUP) . " WHERE kefuid = {$cservice["id"]}"); goto G5Oy8; UNVWB: include $this->template("error"); goto uTJ6v; GBOoM: $chatcon = pdo_fetchall("SELECT * FROM " . tablename(BEST_CHAT) . " WHERE weid = {$_W["uniacid"]} AND fkid in {$fkids} AND kefudel = 0 AND fansdel = 0 ORDER BY time ASC"); goto Vtt_M; KQ7wR: $fkids = "("; goto rFziZ; qM0QQ: if (!empty($cservice)) { goto aqRgA; } goto NsIZ4; nmTiX: raYUi: goto QxuTQ; tiepY: hJQuL: goto d_9br; TGe01: QcuVP: goto uCnNJ; uTJ6v: exit; goto nmTiX; A7OZw: Z8M72: goto GBOoM; oKZtP: include $this->template("error"); goto jL0DA; ifMw1: $imglist = pdo_fetchall("SELECT * FROM " . tablename(BEST_CHAT) . " WHERE weid = {$_W["uniacid"]} AND fkid in {$fkids} AND (type = 3 OR type = 4) ORDER BY time DESC"); goto zgT8y; QIioo: foreach ($allfanskefu as $k => $v) { $fkids .= $v["id"] . ","; QhCor: } goto DBnm6; XmCia: if (!empty($openid)) { goto hu6dF; } goto dn4Wj; Vtt_M: $timestamp = TIMESTAMP; goto twWQP; JBKQU: if (!($this->module["config"]["sharetype"] == 1)) { goto CFwQw; } goto J9qdd; nZoX7: include $this->template("error"); goto htzWw; zgT8y: include $this->template("allshare"); goto BljBp; NsIZ4: $message = "您不是客服！"; goto nZoX7; R7aWy: $allingrouparr = array(); goto I8OcU; q20ns: $fkids = substr($fkids, 0, -1) . ")"; goto A7OZw; KQYdo: $message = "系统开启了客服组内共享功能，您不属于任何客服组！"; goto UNVWB; dn4Wj: $message = "请在微信浏览器中打开！"; goto C8cpe; rFziZ: foreach ($allfanskefu as $k => $v) { $fkids .= $v["id"] . ","; pWcXa: } goto aKOum; CvoC_: $openid = $_W["fans"]["from_user"]; goto XmCia; jL0DA: exit; goto Ftlpe; XpXU4: $toopenid = trim($_GPC["toopenid"]); goto QS4NG; twWQP: foreach ($chatcon as $k => $v) { goto yYixr; nSZbh: if (!($donetime >= 24 * 3600 * 3)) { goto dxfI7; } goto Kkbrw; NH641: if (!($v["type"] == 5 || $v["type"] == 6)) { goto bR2cA; } goto R3BWm; nWXdx: $chatcon[$k]["avatar"] = tomedia($cservice["thumb"]); goto H3Ntc; R3BWm: $donetime = $timestamp - $v["time"]; goto nSZbh; JDXMz: p_ydS: goto LlDKx; rPlsl: b3CEN: goto NH641; GgLqb: bR2cA: goto Pc32T; eubNi: EF6Ul: goto J0TVG; B8Er4: $chatcon[$k]["content"] = qqface_convert_html($chatcon[$k]["content"]); goto Dm5X2; VmroO: if (!(!empty($array2[0]) && ($v["type"] == 1 || $v["type"] == 2))) { goto b3CEN; } goto Cf2g5; b8dI5: preg_match_all($regex, $chatcon[$k]["content"], $array2); goto VmroO; Pc32T: tG61K: goto tYM29; xRri9: $chatcon[$k]["avatar"] = $v["avatar"]; goto qRYsE; yYixr: if ($v["openid"] != $openid) { goto Ux6LF; } goto kdbaP; bYBDM: foreach ($array2[0] as $kk => $vv) { goto zUmWS; Xfl3f: $vvurl = strstr($vv, "http") ? $vv : "http://" . $vv; goto PYvu8; zUmWS: if (!(!empty($vv) && strpos($vv, "https://res.wx.qq.com") === false)) { goto gpMPw; } goto Xfl3f; Ko4sf: gpMPw: goto u9McM; PYvu8: $chatcon[$k]["content"] = str_replace($vv, "<a href='" . $vvurl . "'>" . $vv . "</a>", $chatcon[$k]["content"]); goto Ko4sf; u9McM: vEfy8: goto kA2YE; kA2YE: } goto JDXMz; Kkbrw: unset($chatcon[$k]); goto Sbnzl; SJjC2: $chatcon[$k]["class"] = "left"; goto xRri9; Cf2g5: if ($v["isjqr"] == 1 || $v["istuwen"] == 1) { goto EF6Ul; } goto bYBDM; LlDKx: goto c7ied; goto eubNi; kdbaP: $chatcon[$k]["class"] = "right"; goto nWXdx; qRYsE: sf2cj: goto ff8le; Sbnzl: dxfI7: goto GgLqb; H3Ntc: goto sf2cj; goto o3mIy; Dm5X2: $chatcon[$k]["content"] = preg_replace("/\\xEE[\\x80-\\xBF][\\x80-\\xBF]|\\xEF[\\x81-\\x83][\\x80-\\xBF]/", "[无法识别字符]", $chatcon[$k]["content"]); goto ae1f5; J0TVG: $chatcon[$k]["content"] = htmlspecialchars_decode($v["content"]); goto DH2QR; ae1f5: $regex = "@(?i)\\b((?:[a-z][\\w-]+:(?:/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?«»“”‘’]))@"; goto b8dI5; DH2QR: c7ied: goto rPlsl; ff8le: $chatcon[$k]["content"] = $this->guolv($v["content"]); goto B8Er4; o3mIy: Ux6LF: goto SJjC2; tYM29: } goto ZNDew; I8OcU: foreach ($allingroup as $kk => $vv) { $allingrouparr[] = $vv["groupid"]; vqeBJ: } goto TGe01; wv4dF: if (!($this->module["config"]["issharemsg"] == 0)) { goto LeJKl; } goto wK9jk; TBcBM: goto Z8M72; goto COTV_; jqL8q: $fkids = "("; goto QIioo; aKOum: sj68T: goto Odn1M; BljBp: } public function doMobileAddgroupchat() { goto MQiE3; NGXHR: $data["nickname"] = $iscservice["name"]; goto N0Zml; w0EAx: echo json_encode($resArr); goto nm19w; fPGlz: echo json_encode($resArr); goto a8pOE; bkqLa: if (!($group["jinyan"] == 1 && $_W["fans"]["from_user"] != $group["admin"])) { goto Ib9x9; } goto cB1Xu; cB1Xu: $resArr["error"] = 1; goto HNkMt; z97Gp: $data["openid"] = $_W["fans"]["from_user"]; goto C31Ge; SEsmJ: $data["nickname"] = empty($_W["fans"]["tag"]["nickname"]) ? "匿名用户" : str_replace("'", "''", $_W["fans"]["tag"]["nickname"]); goto FRHqu; Swahm: $chatcontent = trim($_GPC["content"]); goto l__aN; UndLy: $resArr["error"] = 1; goto RraaW; K1PF3: $isgmember = pdo_fetch("SELECT id,isjin FROM " . tablename(BEST_GROUPMEMBER) . " WHERE weid = {$_W["uniacid"]} AND openid = '{$_W["fans"]["from_user"]}' AND groupid = {$groupid}"); goto nsYAj; CR7oo: $chatcontent = emoji_unified_to_html($chatcontent); goto z97Gp; jVNVU: ESxB3: goto X95r1; vrUXR: $data["avatar"] = empty($_W["fans"]["tag"]["avatar"]) ? tomedia($this->module["config"]["defaultavatar"]) : $_W["fans"]["tag"]["avatar"]; goto SEsmJ; acbNO: $data["time"] = TIMESTAMP; goto uxL0d; IWrqG: pdo_insert(BEST_GROUPCONTENT, $data); goto udhT5; AatrM: exit; goto SfafL; GjKe9: md3_5: goto AavR_; ZaqzX: $data["type"] = intval($_GPC["type"]); goto j9SfL; T28Hm: include_once ROOT_PATH . "emoji/emoji.php"; goto nUvNb; Ur1TF: goto ESxB3; goto bdjkD; b9Vz8: if (!($isgmember["isjin"] == 1 && $_W["fans"]["from_user"] != $group["admin"])) { goto c2UsJ; } goto R9lWF; UVAyc: $tplcon = "表情消息"; goto SOtV1; R9lWF: $resArr["error"] = 1; goto b0Alm; lc67l: Ib9x9: goto Swahm; nJA0i: $group = pdo_fetch("SELECT * FROM " . tablename(BEST_GROUP) . " WHERE weid = {$_W["uniacid"]} AND id = {$groupid}"); goto K1PF3; i_GbL: $allgroupmember = pdo_fetchall("SELECT * FROM " . tablename(BEST_GROUPMEMBER) . " WHERE weid = {$_W["uniacid"]} AND isdel = 0 AND groupid = {$data["groupid"]} AND openid != '{$data["openid"]}' AND status = 1 AND txkaiguan = 1"); goto PMpgp; SfafL: emtGC: goto T28Hm; cfil5: gR6Rn: goto b9Vz8; BcCbT: $resArr["msg"] = ''; goto uLk6g; nm19w: exit; goto cfil5; b0Alm: $resArr["msg"] = "您已被禁言！"; goto h4cri; qxpID: goto cUh_4; goto nr5ky; nUvNb: $groupid = intval($_GPC["groupid"]); goto nJA0i; Q7Gpi: $chatcontent = emoji_docomo_to_unified($chatcontent); goto CR7oo; QA_87: exit; goto lc67l; nr5ky: Ci_El: goto UVAyc; vdVLh: $resArr["msg"] = "请输入对话内容！"; goto fpBzY; CansW: mOHdt: goto t1E4I; Xu1fW: if (checksubmit("submit")) { goto emtGC; } goto AatrM; t1E4I: $data["avatar"] = tomedia($iscservice["thumb"]); goto NGXHR; uLk6g: $resArr["content"] = $this->doReplacecon($data["content"], $data["type"]); goto U5bCW; j9SfL: $iscservice = pdo_fetch("SELECT name,thumb FROM " . tablename(BEST_CSERVICE) . " WHERE weid = {$_W["uniacid"]} AND content = '{$data["openid"]}'"); goto Gur0_; sB7Zb: $resArr["avatar"] = $data["avatar"]; goto fPGlz; SOtV1: cUh_4: goto Ur1TF; BLgaG: V1qF_: goto jxesB; N0Zml: T09bF: goto IWrqG; RraaW: $resArr["msg"] = "您不是群成员！"; goto w0EAx; X95r1: $guotime = TIMESTAMP - $group["lasttime"]; goto D2M9o; MQiE3: global $_W, $_GPC; goto Xu1fW; gDojW: $resArr["nickname"] = $data["nickname"]; goto sB7Zb; Gur0_: if (!empty($iscservice)) { goto mOHdt; } goto vrUXR; JWhNk: rM32P: goto Q7Gpi; jxesB: pdo_update(BEST_GROUP, array("lasttime" => TIMESTAMP), array("id" => $data["groupid"])); goto vmcSQ; FRHqu: goto T09bF; goto CansW; eM2BR: exit; goto JWhNk; PMpgp: foreach ($allgroupmember as $k => $v) { goto Aqddv; CgJmp: $this->sendtplmsg($senddata); goto g_Io0; Aqddv: $senddata = array("openid" => $v["openid"], "url" => $this->gettpldomain() . "app/" . str_replace("./", '', $this->createMobileUrl("groupchatdetail", array("groupid" => $data["groupid"]))), "first" => $data["nickname"] . "在[" . $group["groupname"] . "]中发了新消息！", "keyword1" => $data["nickname"]); goto CgJmp; g_Io0: bJY3p: goto tEsNu; tEsNu: } goto d3zwy; U5bCW: $resArr["datetime"] = date("Y-m-d H:i:s", $data["time"]); goto gDojW; s90zN: $tplcon = $data["content"]; goto qxpID; udhT5: if ($data["type"] == 3) { goto KhMD8; } goto BC8u4; BC8u4: if ($data["type"] == 5) { goto md3_5; } goto RAUXw; C31Ge: $data["groupid"] = $groupid; goto acbNO; JUV9Z: c2UsJ: goto bkqLa; vmcSQ: $resArr["error"] = 0; goto BcCbT; bdjkD: KhMD8: goto Nz6AK; nV1OR: goto ESxB3; goto GjKe9; fpBzY: echo json_encode($resArr); goto eM2BR; uxL0d: $data["content"] = $chatcontent; goto zZMUq; D2M9o: if (!($this->module["config"]["isgrouptplon"] == 1 && $group["isfs"] == 1 && $guotime > $this->module["config"]["grouptplminute"])) { goto V1qF_; } goto i_GbL; zZMUq: $data["weid"] = $_W["uniacid"]; goto ZaqzX; l__aN: if (!empty($chatcontent)) { goto rM32P; } goto ROwtE; HNkMt: $resArr["msg"] = "该群只能管理员发言！"; goto zRUxW; nsYAj: if (!empty($isgmember)) { goto gR6Rn; } goto UndLy; Nz6AK: $tplcon = "图片消息"; goto nV1OR; RAUXw: if (strpos($data["content"], "span class=")) { goto Ci_El; } goto s90zN; KSTne: exit; goto JUV9Z; a8pOE: exit; goto uti9b; d3zwy: sHAaQ: goto BLgaG; zRUxW: echo json_encode($resArr); goto QA_87; ROwtE: $resArr["error"] = 1; goto vdVLh; h4cri: echo json_encode($resArr); goto KSTne; AavR_: $tplcon = "语音消息"; goto jVNVU; uti9b: } public function doMobileXiaxian() { goto Wizsg; mmNjq: if (!($type == "kefu")) { goto Pegqh; } goto c0WKL; Wizsg: global $_W, $_GPC; goto kmyFa; c0WKL: $data["kfzx"] = 0; goto Lzv_v; sz1rD: $data["kefunotread"] = 0; goto Gn9Sb; FVNzj: $data["fszx"] = 0; goto sz1rD; Lzv_v: $data["notread"] = 0; goto gbW42; gbW42: pdo_update(BEST_FANSKEFU, $data, array("id" => $fkid)); goto OCSOH; Gn9Sb: pdo_update(BEST_FANSKEFU, $data, array("id" => $fkid)); goto szLt4; iSSkz: $type = trim($_GPC["type"]); goto Gt1cN; szLt4: y_LdT: goto mmNjq; Gt1cN: if (!($type == "fans")) { goto y_LdT; } goto FVNzj; kmyFa: $fkid = intval($_GPC["fkid"]); goto iSSkz; OCSOH: Pegqh: goto sMOLe; sMOLe: } public function doMobileShangxian() { goto N1SEL; R3Oby: IP0wJ: goto X5jat; Y0SBy: G6Skv: goto Vuurg; M0U8R: $fkid = intval($_GPC["fkid"]); goto LQVMh; N0j2o: $data["kfzx"] = 1; goto v5PO_; LQVMh: $type = trim($_GPC["type"]); goto XANg2; Vuurg: if (!($type == "kefu")) { goto IP0wJ; } goto N0j2o; cIbdz: pdo_update(BEST_FANSKEFU, $data, array("id" => $fkid)); goto Y0SBy; dKgpo: $data["fszx"] = 1; goto JdDVt; v5PO_: $data["notread"] = 0; goto iHUtp; iHUtp: pdo_update(BEST_FANSKEFU, $data, array("id" => $fkid)); goto R3Oby; N1SEL: global $_W, $_GPC; goto M0U8R; XANg2: if (!($type == "fans")) { goto G6Skv; } goto dKgpo; JdDVt: $data["kefunotread"] = 0; goto cIbdz; X5jat: } public function gettpldomain() { global $_W, $_GPC; return $this->module["config"]["tpldomain"] != '' ? $this->module["config"]["tpldomain"] : $_W["siteroot"]; } public function doMobileAddchat() { goto i5vJp; CQk7T: $resArr["error"] = 1; goto CCy2A; kluZp: $dataup_fanskefu["fansdel"] = 0; goto Y3kG_; dKSbh: hhcYA: goto Em7SQ; M9XoX: $resArr["msg"] = $notonlinemsg; goto p7Mr_; xhfhy: exit; goto RwwaQ; n_Rve: echo json_encode($resArr); goto Kwe6B; iOvmo: if (strpos($data["content"], "span class=")) { goto T0r5L; } goto rc2yB; OzGEy: $tplcon = $data["nickname"] . "发送了图片"; goto GlAUk; aQJfQ: b7fUr: goto roE_a; ZqRbd: SdrgN: goto mZM_v; roE_a: uP0bv: goto lxWiZ; nxMIy: jkV6c: goto Yfbu8; J3k22: mtwxo: goto SB2UL; i5vJp: global $_W, $_GPC; goto Ebv3l; VLL3Z: echo json_encode($resArr); goto KOPA6; ojLGE: goto ybD3E; goto ZqRbd; n0coK: uxTI8: goto CTA1f; Em7SQ: XLOTD: goto CzpTa; nokM2: VlZ02: goto wrM8c; YjPLv: if (!($zdhf["hftype"] == 2)) { goto VlZ02; } goto VqRjx; bLbjU: exit; goto NFndp; vXK9d: tYNRJ: goto DR8iN; Vczi3: CUzsZ: goto xycIR; PZmSL: if (!($cservice["day4"] == 0)) { goto PdcWX; } goto CQk7T; fbg6s: echo json_encode($resArr); goto TONe_; yBsso: $zhouji = date("w"); goto YNRcc; eD4PW: exit; goto FWLNE; Y3kG_: $dataup_fanskefu["kefudel"] = 0; goto lsDcv; Cs84l: $resArr["error"] = 1; goto o4AIJ; jl50t: Q7sMA: goto P6MiA; Hw1xN: $resArr["nowtime"] = TIMESTAMP; goto bXPn3; AHeqb: $resArr["error"] = 1; goto rr62k; a7MyH: $resArr["content"] = $this->doReplacecon($data["content"], $data["type"], $chatid); goto tlMUu; s0J3U: $dataup_fanskefu["wherefrom"] = 0; goto kluZp; b2jtg: a2JB4: goto sM7Ds; hIQ28: $this->sendtplmsg($senddata); goto HQl4V; NVlCQ: $jqrtime = $data["time"] + 1; goto boo1I; KOPA6: exit; goto aQJfQ; hlMT6: if ($type == 7) { goto wesyB; } goto iOvmo; LI3dT: $resArr["jqrcontent"] = $zdhf["content"]; goto xFPxl; rr62k: $resArr["msg"] = $notonlinemsg; goto efCsd; iKDhK: $resArr["jqrcontent"] = htmlspecialchars_decode($zdhf["allcon"]); goto zdShw; qInUO: exit; goto H4hQu; Xp1o0: if (!($nowhour + 1 > $cservice["endhour"] && $nowhour < $cservice["starthour"])) { goto CUzsZ; } goto aN836; kbv_L: if ($type == 3 || $type == 4) { goto Gx5CD; } goto XNoIe; n6xIj: ENqBz: goto gl9iF; BqPZm: I8R2L: goto ZvtZj; UkNS2: $data["weid"] = $_W["uniacid"]; goto etH9V; aPHAo: $resArr["error"] = 1; goto hxoj2; foid3: exit; goto OimLE; rc2yB: $tplcon = $data["content"]; goto fwp5_; TbtVu: if (!($cservice["day2"] == 0)) { goto ENqBz; } goto AHeqb; xzcqb: $resArr["error"] = 1; goto bJQ3Z; kVQR3: exit; goto Vczi3; oL4rJ: $resArr["msg"] = $notonlinemsg; goto IwAIk; jI4jD: pdo_update(BEST_FANSKEFU, $dataup_fanskefu, array("id" => $fanskefu["id"])); goto NrVIF; UeyWw: $chatid = pdo_insertid(); goto Uww64; eUwi5: exit; goto b2jtg; DR8iN: $tplcon = $this->guolv($tplcon); goto CCIYw; ZXjUt: $dataup_fanskefu["msgtype"] = $type; goto yEsQT; yEsQT: $dataup_fanskefu["lasttime"] = TIMESTAMP; goto jI4jD; VqRjx: $resArr["jqrcontent"] = $datajqr["content"] = tomedia($zdhf["imgcon"]); goto nokM2; lxWiZ: goto Sun11; goto nF32M; lGK0X: goto tYNRJ; goto I5gKU; vUAlK: if (empty($zdhf)) { goto BHFFz; } goto gc8JE; euMwL: if (!($this->module["config"]["tplonlineon"] == 1)) { goto mtwxo; } goto JbkZ8; FnQkM: $datajqr["openid"] = trim($_GPC["toopenid"]); goto P0Q3N; qpKuL: echo json_encode($resArr); goto foid3; y0cJD: $chatcontent = emoji_unified_to_html($chatcontent); goto SseOV; SB2UL: if (!($fanskefu["nowjd"] == 0)) { goto olxA1; } goto RwFan; j_7MX: $tplcon = $data["nickname"] . "发送了位置"; goto vXK9d; ZvtZj: if (!($cservice["day3"] == 0)) { goto adUwP; } goto gkMYv; bXPn3: $resArr["chatid"] = $chatid; goto rN1ti; I5gKU: Gx5CD: goto OzGEy; ZKYcG: $datajqr["time"] = $jqrtime; goto oi7Pp; Csnlo: ueybR: goto lGK0X; uESQy: if ($zhouji == "6") { goto Vmtoq; } goto OSWa4; s69wk: $dataup_fanskefu["notread"] = $fanskefu["notread"] + 1; goto XOITF; zdShw: mCGrF: goto r_55v; kxPFj: if (empty($ishei)) { goto Bplx7; } goto bOnsl; CxLVC: pdo_insert(BEST_CHAT, $data); goto UeyWw; w5iML: cKlGU: goto TVyQQ; boo1I: $resArr["jqrtime"] = date("Y-m-d H:i:s", $jqrtime); goto E9hS8; XNoIe: if ($type == 5 || $type == 6) { goto cKlGU; } goto hlMT6; Kwe6B: exit; goto TRJjX; CTA1f: $nowhour = intval(date("H", TIMESTAMP)); goto Xp1o0; efCsd: echo json_encode($resArr); goto jImgd; wrM8c: if (!($zdhf["hftype"] == 3)) { goto mCGrF; } goto g2bMC; iVL4z: $data["openid"] = $fanskefu["fansopenid"]; goto HMw3N; Z83JJ: echo json_encode($resArr); goto srCSg; nF32M: Vmtoq: goto x7mX0; wR7ii: $senddata = array("openid" => $fanskefu["kefuopenid"], "url" => $this->gettpldomain() . "app/" . str_replace("./", '', $this->createMobileUrl("servicechat", array("ssopenid" => $fanskefu["fansopenid"], "toopenid" => $fanskefu["fansopenid"], "fromid" => $fromid, "cityid" => $cityid))), "first" => $tplcon, "keyword1" => $fanskefu["fansnickname"]); goto hIQ28; jpELS: $data["content"] = $chatcontent; goto UkNS2; hxbuG: oQ5Fc: goto PZmSL; H4hQu: m_ake: goto kd4A2; RwwaQ: TUDcL: goto XFIJn; YNRcc: if ($zhouji == "1") { goto SdrgN; } goto FU7q_; BN3Hi: $cityid = intval($_GPC["cityid"]); goto wR7ii; dC7W_: goto vtuay; goto lVhPw; lsDcv: $dataup_fanskefu["lastcon"] = $lastcon; goto ZXjUt; yAO_R: $resArr["error"] = 1; goto gbefj; uXIwQ: goto tYNRJ; goto e7u9r; nYUxg: Gg2c3: goto hZzr3; RwMLx: goto uP0bv; goto nxMIy; gkMYv: $resArr["error"] = 1; goto oL4rJ; CzpTa: goto zq0RL; goto hxbuG; kkUlM: $chatcontent = trim($_GPC["content"]); goto az0m0; sjq63: if (!($zdhf["kefuids"] == '' || in_array($cservice["id"], $zdhf_kefuids))) { goto z8V1y; } goto dESR5; M5Svn: $datajqr["type"] = $zdhf["hftype"] == 0 || $zdhf["hftype"] == 3 ? 2 : 4; goto yh2NP; er3DD: echo json_encode($resArr); goto kVQR3; YKDc2: if (!($cservice["isrealzx"] == 0)) { goto a2JB4; } goto toyWb; IAqUV: $fanskefu = pdo_fetch("SELECT * FROM " . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND id = {$data["fkid"]}"); goto iVL4z; NFndp: dSsdl: goto ADJK2; ThNY5: $chatcontent = emoji_docomo_to_unified($chatcontent); goto y0cJD; OEc1V: $otherfanskefus = pdo_fetchall("SELECT id,kefuopenid FROM " . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND nowjd > 0 AND fansopenid = '{$openid}' AND kefuopenid != '{$cservice["content"]}'"); goto z6EM4; p0MvT: $tplcon = $data["nickname"] . "发送了表情"; goto Csnlo; GQtZg: goto h2l2p; goto n0coK; kd4A2: Sun11: goto qy2Qe; toyWb: $notonlinemsg = !empty($cservice["notonline"]) ? $cservice["notonline"] : "客服不在线哦！"; goto xzcqb; PtkJi: $resArr["error"] = 1; goto M9XoX; dESR5: $resArr["jqr"] = 1; goto NVlCQ; yh2NP: $datajqr["isjqr"] = 1; goto pg5y2; vR1Xp: $this->updatenowjdnum(); goto ozS2l; tlMUu: $resArr["datetime"] = date("Y-m-d H:i:s", $data["time"]); goto Hw1xN; XQnA4: $fromid = intval($_GPC["fromid"]); goto BN3Hi; SVf5X: k3r9s: goto vR1Xp; iQRmX: $resArr["msg"] = $notonlinemsg; goto duWgM; sqCCq: $nowhour = intval(date("H", TIMESTAMP)); goto Czjei; Ebv3l: if (checksubmit("submit")) { goto TUDcL; } goto xhfhy; r7y7o: Bplx7: goto V5Kh8; yZHto: $datajqr["weid"] = $_W["uniacid"]; goto e6b__; pg5y2: pdo_insert(BEST_CHAT, $datajqr); goto uMmuS; lahYT: $data["avatar"] = $fanskefu["fansavatar"]; goto uqjSw; g2bMC: $datajqr["content"] = $zdhf["allcon"]; goto iKDhK; QwKxn: goto Q7sMA; goto BqPZm; hxoj2: $resArr["msg"] = $notonlinemsg; goto VLL3Z; sM7Ds: vtuay: goto G02gP; tvt5X: $datajqr["avatar"] = tomedia($cservice["thumb"]); goto M5Svn; wCn2c: exit; goto dKSbh; IISpH: $resArr["error"] = 1; goto iQRmX; aN836: $notonlinemsg = !empty($cservice["notonline"]) ? $cservice["notonline"] : "客服不在线哦！"; goto mpX2Z; duWgM: echo json_encode($resArr); goto qInUO; p7Mr_: echo json_encode($resArr); goto wCn2c; CCIYw: $tplcon = preg_replace("/<br\\s*?\\/??>/i", '', $tplcon); goto CxLVC; mp3ES: BHFFz: goto euMwL; V5Kh8: $data["toopenid"] = trim($_GPC["toopenid"]); goto O7uwx; gS7GU: echo json_encode($resArr); goto eUwi5; qy2Qe: goto XLOTD; goto nYUxg; cJRjC: $resArr["error"] = 1; goto oAnlp; XOITF: $dataup_fanskefu["guanlinum"] = $fanskefu["guanlinum"] + 1; goto s0J3U; Nk3tl: if (!empty($chatcontent)) { goto mpHBf; } goto cJRjC; R8DTA: exit; goto q4HVH; mpX2Z: $resArr["error"] = 1; goto lT_Fu; z18ds: if (!($zdhf["hftype"] == 0)) { goto C3taC; } goto ajMzF; OSWa4: if ($zhouji == "0") { goto jkV6c; } goto yAO_R; bJQ3Z: $resArr["msg"] = $notonlinemsg; goto gS7GU; a_hWK: if ($cservice["lingjie"] == 1) { goto uxTI8; } goto sqCCq; xFPxl: C3taC: goto YjPLv; z6EM4: foreach ($otherfanskefus as $k => $v) { goto fdMvE; eX2cA: q9704: goto rhV5M; fdMvE: $dataotherfk["nowjd"] = 0; goto uiMSh; JaKtY: pdo_update(BEST_FANSKEFU, $dataotherfk, array("id" => $v["id"])); goto eX2cA; uiMSh: $dataotherfk["jdtime"] = 0; goto JaKtY; rhV5M: } goto SVf5X; gl9iF: PQyXy: goto ojLGE; TONe_: exit; goto tkeGF; NrVIF: $resArr["error"] = 0; goto w2Lqn; XFIJn: include_once ROOT_PATH . "emoji/emoji.php"; goto kkUlM; HiV86: echo json_encode($resArr); goto pz24J; w2Lqn: $resArr["msg"] = ''; goto a7MyH; Sh2Za: $resArr["msg"] = $notonlinemsg; goto lajA8; irTAE: if ($zhouji == "4") { goto oQ5Fc; } goto FHOw2; pz24J: exit; goto RwMLx; o4AIJ: $resArr["msg"] = $notonlinemsg; goto fbg6s; fwp5_: goto ueybR; goto ffq7I; BZVQF: if ($zhouji == "3") { goto I8R2L; } goto irTAE; FU7q_: if ($zhouji == "2") { goto uD_2y; } goto BZVQF; tkeGF: GJFYO: goto GQtZg; Uww64: $zdhf = pdo_fetch("select * from " . tablename(BEST_ZIDONGHUIFU) . " where weid = {$_W["uniacid"]} AND ((title = '{$chatcontent}' AND type = 1) OR (INSTR('{$chatcontent}',title) AND type = 2) OR title = '*') ORDER BY paixu DESC"); goto vUAlK; kRJBk: $notonlinemsg = !empty($cservice["notonline"]) ? $cservice["notonline"] : "客服不在线哦！"; goto Cs84l; O7uwx: $data["time"] = TIMESTAMP; goto jpELS; jImgd: exit; goto n6xIj; ozS2l: olxA1: goto s69wk; lVhPw: V0TI_: goto YKDc2; JbkZ8: $guotime = TIMESTAMP - $fanskefu["lasttime"]; goto T1nef; fBPBD: echo json_encode($resArr); goto eD4PW; Du_tn: $resArr["error"] = 1; goto Sh2Za; RwFan: $dataup_fanskefu["nowjd"] = 1; goto PkK74; HMw3N: $data["nickname"] = $fanskefu["fansnickname"]; goto lahYT; TRJjX: PdcWX: goto mEaeO; lT_Fu: $resArr["msg"] = $notonlinemsg; goto er3DD; mZM_v: if (!($cservice["day1"] == 0)) { goto dSsdl; } goto Du_tn; FWLNE: mpHBf: goto vCQpa; gbefj: $resArr["msg"] = $notonlinemsg; goto HiV86; CCy2A: $resArr["msg"] = $notonlinemsg; goto n_Rve; lajA8: echo json_encode($resArr); goto bLbjU; uqjSw: $ishei = pdo_fetch("SELECT id FROM " . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND fansopenid = '{$data["openid"]}' AND ishei = 1"); goto kxPFj; yIGyS: eCFIe: goto ThNY5; IwAIk: echo json_encode($resArr); goto R8DTA; srCSg: exit; goto r7y7o; e7u9r: wesyB: goto j_7MX; PZF4L: uD_2y: goto TbtVu; P0Q3N: $datajqr["toopenid"] = $data["openid"]; goto ZKYcG; FHOw2: if ($zhouji == "5") { goto Gg2c3; } goto uESQy; gc8JE: $zdhf_kefuids = unserialize($zdhf["kefuids"]); goto sjq63; Czjei: if (!($nowhour < $cservice["starthour"] || $nowhour + 1 > $cservice["endhour"])) { goto GJFYO; } goto kRJBk; G02gP: if (!($cservice["isxingqi"] == 1)) { goto eCFIe; } goto BMzeH; T1nef: if (!($guotime > $this->module["config"]["kefutplminute"])) { goto pRuN_; } goto XQnA4; P6MiA: goto PQyXy; goto PZF4L; ADJK2: ybD3E: goto yIGyS; SseOV: $data["fkid"] = intval($_GPC["fkid"]); goto IAqUV; rN1ti: $resArr["kefulasttime"] = $fanskefu["lasttime"]; goto WAen5; WAen5: $resArr["tplcon"] = $tplcon; goto z37Za; vCQpa: $cservice = pdo_fetch("SELECT * FROM " . tablename(BEST_CSERVICE) . " WHERE weid = {$_W["uniacid"]} AND ctype = 1 AND content = '{$_GPC["toopenid"]}'"); goto OOqU6; jYYTH: $data["type"] = $type; goto kbv_L; ajMzF: $datajqr["content"] = $zdhf["content"]; goto LI3dT; TVyQQ: $tplcon = $data["nickname"] . "发送了语音"; goto uXIwQ; etH9V: $type = intval($_GPC["type"]); goto jYYTH; bOnsl: $resArr["error"] = 1; goto aYUNi; HQl4V: pRuN_: goto J3k22; az0m0: $lastcon = preg_replace("/\\xEE[\\x80-\\xBF][\\x80-\\xBF]|\\xEF[\\x81-\\x83][\\x80-\\xBF]/", "[无法识别字符]", $chatcontent); goto Nk3tl; z37Za: $resArr["tplonlineon"] = $this->module["config"]["tplonlineon"]; goto qpKuL; x7mX0: if (!($cservice["day6"] == 0)) { goto m_ake; } goto IISpH; e6b__: $datajqr["fkid"] = intval($_GPC["fkid"]); goto FnQkM; aYUNi: $resArr["msg"] = "您暂时不能咨询！"; goto Z83JJ; PkK74: $dataup_fanskefu["jdtime"] = TIMESTAMP; goto OEc1V; hZzr3: if (!($cservice["day5"] == 0)) { goto hhcYA; } goto PtkJi; oAnlp: $resArr["msg"] = "请输入对话内容！"; goto fBPBD; oi7Pp: $datajqr["nickname"] = $cservice["name"]; goto tvt5X; xycIR: h2l2p: goto dC7W_; GlAUk: goto tYNRJ; goto w5iML; Yfbu8: if (!($cservice["day7"] == 0)) { goto b7fUr; } goto aPHAo; ffq7I: T0r5L: goto p0MvT; r_55v: $resArr["jqravatar"] = tomedia($cservice["thumb"]); goto yZHto; q4HVH: adUwP: goto jl50t; uMmuS: z8V1y: goto mp3ES; BMzeH: $notonlinemsg = !empty($cservice["notonline"]) ? $cservice["notonline"] : "客服不在线哦！"; goto yBsso; mEaeO: zq0RL: goto QwKxn; E9hS8: $resArr["hftype"] = $zdhf["hftype"]; goto z18ds; OOqU6: if ($cservice["iszx"] == 1) { goto V0TI_; } goto a_hWK; OimLE: } public function doMobileTixingkefu() { goto rWQSA; uZmb3: GInFp: goto Idp4O; TBTnZ: $senddata = array("openid" => $fanskefu["kefuopenid"], "url" => $this->gettpldomain() . "app/" . str_replace("./", '', $this->createMobileUrl("servicechat", array("ssopenid" => $fanskefu["fansopenid"], "toopenid" => $fanskefu["fansopenid"]))), "first" => $tplcon, "keyword1" => $fanskefu["fansnickname"]); goto vDrHM; a41ms: $fkid = intval($_GPC["fkid"]); goto Yd6g6; ZYYW2: $kefulasttime = intval($_GPC["kefulasttime"]); goto TCTYS; TCTYS: $guotime = TIMESTAMP - $kefulasttime; goto UiWkp; vDrHM: $this->sendtplmsg($senddata); goto uZmb3; Yd6g6: $tplcon = trim($_GPC["tplcon"]); goto nsfSH; nsfSH: $fanskefu = pdo_fetch("SELECT * FROM " . tablename(BEST_FANSKEFU) . " WHERE id = {$fkid}"); goto ZYYW2; UiWkp: if (!($guotime > $this->module["config"]["kefutplminute"])) { goto GInFp; } goto TBTnZ; rWQSA: global $_W, $_GPC; goto a41ms; Idp4O: } public function doMobileDonotread() { goto wr77s; vyJVu: $type = trim($_GPC["type"]); goto xlFcY; lNPaY: $data["notread"] = 0; goto ZW9xO; chufR: $fkid = intval($_GPC["fkid"]); goto vyJVu; xlFcY: if (!($type == "fans")) { goto nM083; } goto hl7c9; dPlWF: nM083: goto b5bIr; ZW9xO: pdo_update(BEST_FANSKEFU, $data, array("id" => $fkid)); goto wZeKb; wr77s: global $_W, $_GPC; goto chufR; hl7c9: $data["kefunotread"] = 0; goto JUwRl; JUwRl: pdo_update(BEST_FANSKEFU, $data, array("id" => $fkid)); goto dPlWF; b5bIr: if (!($type == "kefu")) { goto qQb0E; } goto lNPaY; wZeKb: qQb0E: goto dHtIG; dHtIG: } public function doMobileDonotreadxcx() { goto huHYN; qgtMS: pdo_update(BEST_XCXFANSKEFU, $data, array("id" => $fkid)); goto szgBT; huHYN: global $_W, $_GPC; goto B4kRU; xY7_Y: $data["notread"] = 0; goto qgtMS; B4kRU: $fkid = intval($_GPC["fkid"]); goto xY7_Y; szgBT: } public function doMobileAddchat2() { goto zrlC3; zrlC3: global $_W, $_GPC; goto JYSHu; RMk6q: $dataup_fanskefu["fansdel"] = 0; goto xywwU; gnnBZ: $account_api->sendCustomNotice($custom); goto I1C2f; Cp9bN: $touser = pdo_fetch("SELECT * FROM " . tablename(BEST_CSERVICE) . " WHERE weid = {$_W["uniacid"]} AND content = '{$data["openid"]}'"); goto nPo8K; KZgFk: $tplcon = $data["nickname"] . "给您发送了表情"; goto gOZOr; E1tON: $resArr["datetime"] = date("Y-m-d H:i:s", $data["time"]); goto Gnbra; wD2oY: exit; goto ruvn5; oNrni: if (!empty($chatcontent)) { goto BZ2F8; } goto uPDU0; Xy0j0: $data["content"] = $chatcontent; goto vCDuO; JYSHu: if (checksubmit("submit")) { goto RjrYJ; } goto wD2oY; KzPtB: if ($fanskefu["wherefrom"] == 1 && TIMESTAMP - $fanskefu["lasttime"] < 24 * 3600) { goto CuMCr; } goto vYZw9; RdKIE: $senddata = array("openid" => $fanskefu["fansopenid"], "url" => $this->gettpldomain() . "app/" . str_replace("./", '', $this->createMobileUrl("chat", array("ssopenid" => $fanskefu["kefuopenid"], "toopenid" => $fanskefu["kefuopenid"], "fromid" => $fromid, "cityid" => $cityid))), "first" => $tplcon, "keyword1" => $fanskefu["kefunickname"]); goto lj8SO; vFLBq: if (strpos($data["content"], "span class=")) { goto dp380; } goto U1oTL; yzbzD: Qfu1p: goto us73r; bPEzd: pdo_insert(BEST_CHAT, $data); goto XVGYW; QtKxK: $tplcon = $data["nickname"] . "给您发送了位置"; goto DLobE; AEq4O: $guotime = TIMESTAMP - $fanskefu["kefulasttime"]; goto daPbw; SgNvC: if ($type == 5 || $type == 6) { goto z8d5s; } goto N6YJC; ZNT_e: etHYI: goto mA0U2; DLobE: XjytZ: goto WsyFM; u_J6r: $dataup_fanskefu["guanlinum"] = $fanskefu["guanlinum"] + 1; goto RMk6q; mA0U2: $account_api = WeAccount::create(); goto ISnyG; XVGYW: $chatid = pdo_insertid(); goto toXWE; ISnyG: $access_token = $account_api->getAccessToken(); goto ac6j8; svLbl: pdo_update(BEST_CSERVICE, array("nowfkid" => $fanskefu["id"]), array("id" => $cservice["id"])); goto QB97q; rEN9d: $tplcon = $data["nickname"] . "给您发送了图文"; goto ocygI; HbEMw: $chatcontent = trim($_GPC["content"]); goto btQOE; HRq2A: echo json_encode($resArr); goto mUxY2; v_XmL: $resArr["content"] = $this->doReplacecon($data["content"], $data["type"], $chatid, $data["istuwen"]); goto E1tON; ac6j8: $fileName = time() . ".jpg"; goto Qrojq; xvTy0: $imgres = $this->curl_post2($imgurl, "../addons/cy163_customerservice/" . $fileName); goto Hcq0G; nu613: $imgurl = "https://api.weixin.qq.com/cgi-bin/media/upload?access_token=" . $access_token . "&type=image"; goto xvTy0; v2pLU: Xk7C_: goto vFLBq; nhWMj: Cj3Vd: goto QMprI; Hcq0G: unlink("../addons/cy163_customerservice/" . $fileName); goto Z26Wl; geEOd: r8dHj: goto QtKxK; Zymz3: $data["time"] = TIMESTAMP; goto Xy0j0; hn6yo: $account_api->sendCustomNotice($custom); goto AVywJ; rGdzM: $resArr["tplcon"] = $tplcon; goto qDio9; VQI_L: $data["toopenid"] = trim($_GPC["toopenid"]); goto Zymz3; A9YlI: OFgUy: goto DaC5D; aCUyK: $fromid = intval($_GPC["fromid"]); goto IqXWW; TLcab: if (!($fanskefu["nowjd"] > 0)) { goto vHhKJ; } goto q9C8x; qQqGf: $chatcontent = emoji_unified_to_html($chatcontent); goto CyLJY; CyLJY: $data["openid"] = $_W["fans"]["from_user"]; goto Cp9bN; mUxY2: exit; goto R5EZz; ruvn5: RjrYJ: goto vQqnQ; toXWE: $fanskefu = pdo_fetch("SELECT * FROM " . tablename(BEST_FANSKEFU) . " WHERE weid = {$_W["uniacid"]} AND kefuopenid = '{$data["openid"]}' AND fansopenid = '{$data["toopenid"]}'"); goto KzPtB; KaVYs: $account_api->sendCustomNotice($custom); goto Mhq8j; uI6nG: $type = intval($_GPC["type"]); goto WsgFj; gOZOr: RM0Ej: goto Ug3rO; DaC5D: $dataup_fanskefu["kefunotread"] = $fanskefu["kefunotread"] + 1; goto u_J6r; C1Mns: $account_api = WeAccount::create(); goto hn6yo; WsyFM: $tplcon = $this->guolv($tplcon); goto hTlE_; q9C8x: $dataup_fanskefu["nowjd"] = 2; goto svLbl; uPDU0: $resArr["error"] = 1; goto HNaWm; lj8SO: $this->sendtplmsg($senddata); goto nhWMj; ZkqMa: if ($data["istuwen"] == 0) { goto Xk7C_; } goto rEN9d; tgS4l: $custom = array("touser" => $fanskefu["fansopenid"], "msgtype" => "voice", "voice" => array("media_id" => $data["content"])); goto zPQ5C; zPQ5C: $account_api = WeAccount::create(); goto KaVYs; QCK1R: if ($type == 5 || $type == 6) { goto Qfu1p; } goto SrbAm; xywwU: $dataup_fanskefu["kefudel"] = 0; goto lCTHp; U1oTL: $tplcon = $data["content"]; goto n23Cd; qDio9: $resArr["nowtime"] = TIMESTAMP; goto dFEzu; F_qNY: $resArr["msg"] = ''; goto v_XmL; btQOE: $kefulastcon = preg_replace("/\\xEE[\\x80-\\xBF][\\x80-\\xBF]|\\xEF[\\x81-\\x83][\\x80-\\xBF]/", "[无法识别字符]", $chatcontent); goto oNrni; nPo8K: $data["nickname"] = $touser["name"]; goto mE3_x; vYZw9: if (!($this->module["config"]["tplonlineon"] == 1)) { goto Y4WnF; } goto AEq4O; AVywJ: goto dTJwH; goto ZNT_e; Hz5JG: $dataup_fanskefu["kefulasttime"] = TIMESTAMP; goto JxBHZ; QMprI: Y4WnF: goto heTA8; SrbAm: if ($type == 7) { goto r8dHj; } goto ZkqMa; vCDuO: $data["weid"] = $_W["uniacid"]; goto gBWtL; HNaWm: $resArr["msg"] = "请输入对话内容！"; goto VVJ8g; q_7mn: $resArr["tplonlineon"] = $this->module["config"]["tplonlineon"]; goto HRq2A; fki0S: goto XjytZ; goto yzbzD; yQfrq: dp380: goto KZgFk; Gnbra: $resArr["chatid"] = $chatid; goto vDsCm; QB97q: vHhKJ: goto S0Sh8; us73r: $tplcon = $data["nickname"] . "给您发送了语音"; goto VmW7h; c_DJ9: if ($type == 3 || $type == 4) { goto OiPf1; } goto QCK1R; PjdNS: exit; goto CyLxE; MDHyE: CuMCr: goto B8xgG; IqXWW: $cityid = intval($_GPC["cityid"]); goto RdKIE; vQqnQ: include_once ROOT_PATH . "emoji/emoji.php"; goto HbEMw; n23Cd: goto RM0Ej; goto yQfrq; DNgO1: z8d5s: goto tgS4l; SynWe: OiPf1: goto kfLT8; y0wdY: file_put_contents("../addons/cy163_customerservice/" . $fileName, $source); goto nu613; CyLxE: BZ2F8: goto XEb7c; heTA8: goto OFgUy; goto MDHyE; dFEzu: $resArr["wherefrom"] = $fanskefu["wherefrom"]; goto q_7mn; daPbw: if (!($guotime > $this->module["config"]["kefutplminute"])) { goto Cj3Vd; } goto aCUyK; Qrojq: $source = file_get_contents($chatcontent); goto y0wdY; gBWtL: $data["fkid"] = intval($_GPC["fkid"]); goto ICZ6R; vDsCm: $resArr["kefulasttime"] = $fanskefu["kefulasttime"]; goto rGdzM; Y4eG6: $resArr["error"] = 0; goto F_qNY; Z26Wl: $custom = array("touser" => $fanskefu["fansopenid"], "msgtype" => "image", "image" => array("media_id" => $imgres["media_id"])); goto gnnBZ; lCTHp: $dataup_fanskefu["kefulastcon"] = $kefulastcon; goto Hz5JG; XEb7c: $chatcontent = emoji_docomo_to_unified($chatcontent); goto qQqGf; ICZ6R: $data["istuwen"] = intval($_GPC["istuwen"]); goto uI6nG; ocygI: goto Dr_98; goto v2pLU; Mhq8j: dTJwH: goto A9YlI; N6YJC: $custom = array("msgtype" => "text", "text" => array("content" => urlencode($data["content"])), "touser" => $fanskefu["fansopenid"]); goto C1Mns; kfLT8: $tplcon = $data["nickname"] . "给您发送了图片"; goto fki0S; Ug3rO: Dr_98: goto I5SI2; VmW7h: goto XjytZ; goto geEOd; B8xgG: if ($type == 3 || $type == 4) { goto etHYI; } goto SgNvC; I1C2f: goto dTJwH; goto DNgO1; hTlE_: $tplcon = preg_replace("/<br\\s*?\\/??>/i", '', $tplcon); goto bPEzd; I5SI2: goto XjytZ; goto SynWe; JxBHZ: $dataup_fanskefu["kefumsgtype"] = $type; goto TLcab; WsgFj: $data["type"] = $type; goto c_DJ9; mE3_x: $data["avatar"] = tomedia($touser["thumb"]); goto VQI_L; S0Sh8: pdo_update(BEST_FANSKEFU, $dataup_fanskefu, array("id" => $fanskefu["id"])); goto Y4eG6; VVJ8g: echo json_encode($resArr); goto PjdNS; R5EZz: } public function doMobileTixingkehu() { goto qBQkL; qBQkL: global $_W, $_GPC; goto r_xQk; ALcWC: $guotime = TIMESTAMP - $kefulasttime; goto Gj1dC; P6Ahf: $senddata = array("openid" => $fanskefu["fansopenid"], "url" => $this->gettpldomain() . "app/" . str_replace("./", '', $this->createMobileUrl("chat", array("ssopenid" => $fanskefu["kefuopenid"], "toopenid" => $fanskefu["kefuopenid"]))), "first" => $tplcon, "keyword1" => $fanskefu["kefunickname"]); goto vlJH5; Gj1dC: if (!($guotime > $this->module["config"]["kefutplminute"])) { goto zBXZc; } goto P6Ahf; vlJH5: $this->sendtplmsg($senddata); goto FM7Y8; r_xQk: $fkid = intval($_GPC["fkid"]); goto KTgkv; i8H41: $fanskefu = pdo_fetch("SELECT * FROM " . tablename(BEST_FANSKEFU) . " WHERE id = {$fkid}"); goto ceQwa; KTgkv: $tplcon = trim($_GPC["tplcon"]); goto i8H41; ceQwa: $kefulasttime = intval($_GPC["kefulasttime"]); goto ALcWC; FM7Y8: zBXZc: goto WB4bS; WB4bS: } public function doReplacecon($content, $msgtype, $chatid = 0, $istuwen = 0) { goto g85i0; WzRGx: $content = "<div class=\"concon toaddress flex\" data-lat=\"" . $add_arr[0] . "\" data-lng=\"" . $add_arr[1] . "\" data-name=\"" . $add_arr[2] . "\" data-address=\"" . $add_arr[3] . "\">\r\n\t\t\t\t\t\t\t<img src=\"" . NEWSTATIC_ROOT . "/icon/map.png\" class=\"map\" />\r\n\t\t\t\t\t\t\t<div class=\"mapadd\">" . $add_arr[3] . "</div>\r\n\t\t\t\t\t\t\t<div class=\"flex1\"></div>\r\n\t\t\t\t\t\t</div>"; goto lL1h1; ITHBB: $content = $this->guolv($content); goto iQ3oR; uCFyb: $content = "<div class=\"concon voiceplay flex\" data-con=\"" . $content . "\" data-id=\"" . $chatid . "\">\r\n\t\t\t\t\t\t\t<img src=\"" . NEWSTATIC_ROOT . "/icon/voice2.png\" class=\"voice2\" />\r\n\t\t\t\t\t\t\t<div class=\"flex1\"></div>\r\n\t\t\t\t\t\t</div>"; goto gSL_7; kigBq: if ($msgtype == 3 || $msgtype == 4) { goto UE9qH; } goto i_kSP; EDNTp: qkVXS: goto Ix6D5; Amzr5: if (!(!empty($array2[0]) && ($msgtype == 1 || $msgtype == 2))) { goto GHAFK; } goto LWJ6U; i_kSP: if ($msgtype == 5 || $msgtype == 6) { goto ks_WM; } goto qJ75Y; lL1h1: MOPdc: goto V8MKY; V8MKY: return htmlspecialchars_decode($content); goto GJJD5; Aqn1c: ks_WM: goto uCFyb; SFq5o: u175t: goto Pb6Ln; NLDac: $add_arr = explode(",", $content); goto WzRGx; g85i0: if (!($istuwen == 0)) { goto u175t; } goto EqgXY; Pb6Ln: if ($msgtype == 1 || $msgtype == 2) { goto qkVXS; } goto kigBq; qRYEM: preg_match_all($regex, $content, $array2); goto Amzr5; OU9HK: UE9qH: goto u5UeF; H3_Do: goto MOPdc; goto OU9HK; gSL_7: goto MOPdc; goto yofl5; lyrSm: goto MOPdc; goto Aqn1c; u5UeF: $content = "<div class=\"concon\"><img src=\"" . $content . "\" class=\"sssbbb\" /></div>"; goto lyrSm; LWJ6U: foreach ($array2[0] as $kk => $vv) { goto DbEKL; VS6Js: $content = str_replace($vv, "<a href='" . $vvurl . "'>" . $vv . "</a>", $content); goto x72vy; MnFPi: DPVBd: goto xNRYC; x72vy: wGtnS: goto MnFPi; k0zXO: $vvurl = strstr($vv, "http") ? $vv : "http://" . $vv; goto VS6Js; DbEKL: if (empty($vv)) { goto wGtnS; } goto k0zXO; xNRYC: } goto RMZuC; qJ75Y: if ($msgtype == 7) { goto z2sFa; } goto sebN_; EqgXY: $content = preg_replace("/\\xEE[\\x80-\\xBF][\\x80-\\xBF]|\\xEF[\\x81-\\x83][\\x80-\\xBF]/", "[无法识别字符]", $content); goto ITHBB; iQ3oR: $regex = "@(?i)\\b((?:[a-z][\\w-]+:(?:/{1,3}|[a-z0-9%])|www\\d{0,3}[.]|[a-z0-9.\\-]+[.][a-z]{2,4}/)(?:[^\\s()<>]+|\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\))+(?:\\(([^\\s()<>]+|(\\([^\\s()<>]+\\)))*\\)|[^\\s`!()\\[\\]{};:'\".,<>?«»“”‘’]))@"; goto qRYEM; ORYin: GHAFK: goto SFq5o; RMZuC: kwQCu: goto ORYin; yofl5: z2sFa: goto NLDac; Ix6D5: $content = "<div class=\"concon\">" . $content . "</div>"; goto H3_Do; sebN_: goto MOPdc; goto EDNTp; GJJD5: } public function doMobileGetmedia() { goto EWMPZ; xuOgW: $resarr["error"] = 1; goto T6yRJ; MbNXL: die(json_encode($resarr)); goto wuI0S; qsVnd: echo json_encode($resarr, true); goto AyZtd; cPPmE: if (!($result["errcode"] == "40001")) { goto W8Z5V; } goto RaHZP; IHy6Q: $response = ihttp_get($url); goto zZrUP; P3UR2: $resarr["message"] = "获取微信媒体参数失败！"; goto MbNXL; ANGjG: KuIRt: goto Ozgmq; sjyb2: $account_api = WeAccount::create(); goto F7Ejn; UgUAq: $resarr["error"] = 1; goto TTiGH; wBAiT: yk3kF: goto LX6Ja; RaHZP: $account_api->clearAccessToken(); goto Yxvzv; Lh0yB: $resarr["message"] = "访问公众平台接口失败, 错误: {$response["message"]}"; goto mOHk6; V0QLZ: b10xZ: goto FKIeJ; x358a: wOmm4: goto h4w4S; GKvsj: $response = ihttp_get($url); goto qhP3W; cbuVe: if (is_error($remotestatus)) { goto AMXVJ; } goto OLGsL; GiQJ3: @fclose($fp); goto z0NrJ; WcvdW: $resarr["error"] = 1; goto gkEtp; bRDgy: if (is_error($remotestatus)) { goto y0PNA; } goto H9jY0; vNv3U: die(json_encode($resarr)); goto nQq6s; zZrUP: $result = @json_decode($response["content"], true); goto vQ1aj; eoCFL: die(json_encode($resarr)); goto ZU4LX; hkLD2: $resarr["imgurl"] = $this->module["config"]["qiniuurl"] . "/" . $randimgurl; goto fYelc; tY403: $resarr["error"] = 1; goto P3UR2; h4w4S: $randimgurl = "images/" . $_W["uniacid"] . "/" . date("Y", time()) . "/" . date("m", time()) . "/" . date("YmdHis") . rand(1000, 9999) . ".jpg"; goto wgcM2; EWMPZ: global $_W, $_GPC; goto sjyb2; Xlg8U: if ($this->module["config"]["isqiniu"] == 3) { goto J79fV; } goto K30_O; rUl39: $resarr["imgurl"] = tomedia($randimgurl); goto waG8h; XzK5y: if (empty($result["errcode"])) { goto fGlnU; } goto WcvdW; z0NrJ: if (file_exists($targetName)) { goto yk3kF; } goto Fji2B; T6yRJ: $resarr["message"] = "远程附件上传失败，请检查配置并重新上传"; goto wq37L; Yxvzv: $access_token = $account_api->getAccessToken(); goto qLzKF; F7Ejn: $access_token = $account_api->getAccessToken(); goto s5aMJ; IL8QE: @fwrite($fp, $response["content"]); goto GiQJ3; gkEtp: $resarr["message"] = "访问微信接口错误, 错误代码: {$result["errcode"]}, 错误信息: {$result["errmsg"]}"; goto AjJms; sQrNn: fGlnU: goto ozLvZ; Jq2I2: Bkc4n: goto rYqLo; KyUre: $remotestatus = file_remote_upload($randimgurl, true); goto bRDgy; nQq6s: goto e6ilm; goto y4_Jq; Noc5q: kUNtd: goto HDKBZ; OLGsL: $resarr["realimgurl"] = $randimgurl; goto hkLD2; YyKpB: if (empty($_W["setting"]["remote"]["type"])) { goto eusER; } goto Eu_ra; AyZtd: exit; goto jhwaS; mHfFq: J79fV: goto YyKpB; Qp1WY: if (!($img_info[0] > 1200)) { goto mHRbp; } goto g6KNj; wgcM2: $targetName = "../attachment/" . $randimgurl; goto jTbl4; ZU4LX: e6ilm: goto Rcfks; qhP3W: if (!is_error($response)) { goto kUNtd; } goto D9ap_; Fji2B: $resarr["error"] = 1; goto HM5W4; HDKBZ: $result = @json_decode($response["content"], true); goto cPPmE; AjJms: die(json_encode($resarr)); goto sQrNn; n3GH8: if ($this->module["config"]["isqiniu"] == 1) { goto Bkc4n; } goto Xlg8U; ozLvZ: $updir = "../attachment/images/" . $_W["uniacid"] . "/" . date("Y", time()) . "/" . date("m", time()) . "/"; goto Epvci; vQ1aj: W8Z5V: goto XzK5y; fYelc: $resarr["message"] = "上传成功"; goto vNv3U; rYqLo: $remotestatus = $this->doQiuniu($randimgurl, true); goto cbuVe; HIhjP: if (!empty($media_id)) { goto kS40_; } goto tY403; g6KNj: $this->mkThumbnail($targetName, 1200, null, $targetName); goto pk8uh; y4_Jq: AMXVJ: goto UgUAq; TTiGH: $resarr["message"] = "远程附件上传失败，请检查配置并重新上传"; goto eoCFL; H9jY0: $resarr["realimgurl"] = $randimgurl; goto rUl39; pk8uh: mHRbp: goto n3GH8; rKW3S: $resarr["imgurl"] = tomedia($randimgurl); goto WpTGw; HM5W4: $resarr["message"] = "上传失败"; goto XyUsy; tJgDf: PVftm: goto qsVnd; waG8h: $resarr["message"] = "上传成功"; goto Poqxk; D9ap_: $resarr["error"] = 1; goto Lh0yB; NMJyo: $img_info = getimagesize($targetName); goto Qp1WY; LX6Ja: $resarr["error"] = 0; goto NMJyo; Poqxk: die(json_encode($resarr)); goto OD0me; s5aMJ: $media_id = $_GPC["media_id"]; goto HIhjP; Rcfks: goto KuIRt; goto mHfFq; qCwRz: $url = "https://file.api.weixin.qq.com/cgi-bin/media/get?access_token=" . $access_token . "&media_id=" . $media_id; goto GKvsj; jTbl4: $fp = @fopen($targetName, "wb"); goto IL8QE; Eu_ra: load()->func("file"); goto KyUre; K30_O: goto KuIRt; goto Jq2I2; wuI0S: kS40_: goto qCwRz; WpTGw: $resarr["message"] = "上传成功"; goto tJgDf; wq37L: die(json_encode($resarr)); goto V0QLZ; i1_iN: y0PNA: goto xuOgW; OD0me: goto b10xZ; goto i1_iN; mOHk6: die(json_encode($resarr)); goto Noc5q; FKIeJ: eusER: goto ANGjG; qLzKF: $url = "https://file.api.weixin.qq.com/cgi-bin/media/get?access_token=" . $access_token . "&media_id=" . $media_id; goto IHy6Q; Ozgmq: $resarr["realimgurl"] = $randimgurl; goto rKW3S; XyUsy: goto PVftm; goto wBAiT; cbHiO: mkdir($updir, 0777, true); goto x358a; Epvci: if (file_exists($updir)) { goto wOmm4; } goto cbHiO; jhwaS: } public function doMobileDuvoice() { goto z7zFY; Hd_KI: pdo_update(BEST_CHAT, $dataup, array("id" => $chatres["id"])); goto paep1; S3_4A: $chatres = pdo_fetch("SELECT * FROM " . tablename(BEST_CHAT) . " WHERE weid = {$_W["uniacid"]} AND content = '{$media_id}' AND fkid = {$fkid}"); goto dlhoR; V2DpJ: $fkid = intval($_GPC["fkid"]); goto S3_4A; RSl9g: $dataup["hasyuyindu"] = 1; goto Hd_KI; b0ryz: $resarr["error"] = 0; goto xzlnY; dlhoR: if (!($chatres["openid"] != $_W["fans"]["from_user"])) { goto yChk0; } goto RSl9g; z7zFY: global $_W, $_GPC; goto rCBY2; paep1: yChk0: goto b0ryz; rCBY2: $media_id = $_GPC["media_id"]; goto V2DpJ; xzlnY: die(json_encode($resarr)); goto ub9Ql; ub9Ql: } public function doMobileGetvoice() { goto NaJGh; imIka: die(json_encode($resarr)); goto d_dPi; Z2p6M: load()->func("file"); goto wWQ35; mHz3V: if (!($chatres["yyzming"] == 1)) { goto YHjJ6; } goto tLwdy; LqwbI: tAA9a: goto mHz3V; sWGG2: if (!($this->module["config"]["isqiniu"] == 0 || $qiniuaccesskey == '' || $qiniusecretkey == '' || $qiniubucket == '')) { goto XsMjA; } goto KE8xQ; s6L26: f0uks: goto ax867; qj16b: if ($err !== null) { goto UxRpX; } goto K_zKW; lpKUI: $resarr["error"] = 1; goto jeiUq; jeiUq: $resarr["msg"] = "获取微信媒体参数失败！"; goto KCB0h; KE8xQ: $resarr["error"] = 1; goto zGdrk; m3LVF: $resarr["voicefile"] = $chatres["content"]; goto C80d8; ax867: $amrname = date("YmdHis") . rand(1000, 9999); goto OiWZ0; j87R5: $resarr["msg"] = "访问微信接口错误, 错误代码: {$result["errcode"]}, 错误信息: {$result["errmsg"]}"; goto Veti7; RIYna: iD2Ko: goto TqbRb; gblFw: $response = ihttp_get($url); goto nF7ey; NaJGh: global $_W, $_GPC; goto G0vW2; Jqaov: if (!empty($chatres)) { goto tAA9a; } goto lpKUI; xfeFz: $access_token = $account_api->getAccessToken(); goto jJtRV; iyL83: goto HLwCL; goto RsWuk; bM02y: $auth = new Qiniu\Auth($qiniuaccesskey, $qiniusecretkey); goto je3FI; seOh2: dRTa5: goto Dmd42; t5DR2: $resarr["msg"] = "语音暂未解析完成！"; goto pFw45; zGdrk: $resarr["msg"] = "获取语音资源配置错误！"; goto JcGIy; zXCTR: $chatres = pdo_fetch("SELECT * FROM " . tablename(BEST_CHAT) . " WHERE weid = {$_W["uniacid"]} AND id = {$chatid}"); goto Jqaov; fqfij: $resarr["voicefile"] = $chatres["content"]; goto r0lbB; cJVNi: $policy = array("persistentOps" => $fops, "persistentPipeline" => $liedui, "persistentNotifyUrl" => $notifyUrl); goto wWLfb; C80d8: die(json_encode($resarr)); goto seOh2; jJtRV: $url = "https://file.api.weixin.qq.com/cgi-bin/media/get?access_token=" . $access_token . "&media_id=" . $media_id; goto gblFw; Qdb2B: iIO27: goto c5fxN; yRjgA: list($ret, $err) = $uploadmgr->putFile($uploadtoken, $key, $targetName); goto qj16b; XwyfS: @fclose($fp); goto uSIJO; pFw45: die(json_encode($resarr)); goto s1CEp; k0EDM: $resarr["error"] = 1; goto dUYOn; MSypa: if (strpos($chatres["content"], ".mp3") !== false) { goto mgN2p; } goto wCusD; K_zKW: pdo_update(BEST_CHAT, array("mp3du" => 1, "yyzming" => 1), array("id" => $chatres["id"])); goto SID8l; SID8l: sleep(4); goto BQ1yw; ZDDxX: file_delete($targetName); goto RIYna; wjp8K: $policy = array("persistentOps" => $fops, "persistentNotifyUrl" => $notifyUrl); goto iyL83; RsWuk: Pm8hs: goto cJVNi; oFk2t: $uploadtoken = $auth->uploadToken($qiniubucket, null, 3600, $policy); goto yRjgA; QRcCv: $fops = "avthumb/mp3/ab/320k/ar/44100/acodec/libmp3lame"; goto UW25P; JcGIy: die(json_encode($resarr)); goto kUxRF; WrIf6: $qiniuurl = $this->module["config"]["isqiniu"] == 1 ? $this->module["config"]["qiniuurl"] : $_W["setting"]["remote"]["qiniu"]["url"]; goto sWGG2; uSIJO: $key = $targetName; goto U5PQq; d_dPi: m6YYZ: goto Jd8yG; Jd8yG: $result = @json_decode($response["content"], true); goto AQGoi; tLwdy: $resarr["error"] = 1; goto CXgAy; Xw1n0: die(json_encode($resarr)); goto YhwG2; kUxRF: XsMjA: goto OCNyN; AGgWu: $resarr["msg"] = "访问公众平台接口失败, 错误: {$response["message"]}"; goto imIka; YhwG2: YHjJ6: goto ls4kf; BQ1yw: if (!file_exists($targetName)) { goto iD2Ko; } goto ZDDxX; B0NcD: $uploadmgr = new Qiniu\Storage\UploadManager($config); goto Jnd_k; wWQ35: require_once IA_ROOT . "/framework/library/qiniu/autoload.php"; goto bM02y; UW25P: $fops = $fops . "|saveas/" . $putpolicy; goto Fxe6S; ls4kf: if (!(strpos($chatres["content"], ".mp3") !== false)) { goto dRTa5; } goto tIR0d; nF7ey: if (!is_error($response)) { goto m6YYZ; } goto K11X1; wWLfb: HLwCL: goto oFk2t; RuKuk: m_1Dl: goto OUDMg; xMt14: if (!empty($liedui)) { goto Pm8hs; } goto wjp8K; U5PQq: $mpname = "audios/" . $_W["uniacid"] . "/" . date("Y", time()) . "/" . date("m", time()) . "/" . date("YmdHis") . rand(1000, 9999); goto wLuTN; K11X1: $resarr["error"] = 1; goto AGgWu; AQGoi: if (empty($result["errcode"])) { goto f0uks; } goto vYIiu; BYFTZ: $qiniubucket = $this->module["config"]["isqiniu"] == 1 ? $this->module["config"]["qiniubucket"] : $_W["setting"]["remote"]["qiniu"]["bucket"]; goto WrIf6; KCB0h: die(json_encode($resarr)); goto LqwbI; vYIiu: $resarr["error"] = 1; goto j87R5; qFXB5: $resarr["error"] = 0; goto fqfij; jPAHE: $notifyUrl = $_W["siteroot"] . "app/" . str_replace("./", '', $this->createMobileUrl("yyzhuanmastatus", array("chatid" => $chatid, "amrname" => $amrname, "mpname" => $mpname))); goto xMt14; dUYOn: $resarr["msg"] = "远程附件上传失败，请检查配置并重新上传"; goto STELz; TxJju: @fwrite($fp, $response["content"]); goto XwyfS; je3FI: $config = new Qiniu\Config(); goto B0NcD; TqbRb: $chatres = pdo_fetch("SELECT * FROM " . tablename(BEST_CHAT) . " WHERE weid = {$_W["uniacid"]} AND id = {$chatid}"); goto MSypa; CXgAy: $resarr["msg"] = "语音正在转码中，请稍后！"; goto Xw1n0; Fxe6S: $liedui = empty($this->module["config"]["liedui"]) ? '' : $this->module["config"]["liedui"]; goto jPAHE; r0lbB: die(json_encode($resarr)); goto RuKuk; tIR0d: $resarr["error"] = 0; goto m3LVF; LaS6t: UxRpX: goto k0EDM; OiWZ0: $targetName = $amrname . ".amr"; goto Uh8O6; Veti7: die(json_encode($resarr)); goto s6L26; Dmd42: $qiniuaccesskey = $this->module["config"]["isqiniu"] == 1 ? $this->module["config"]["qiniuaccesskey"] : $_W["setting"]["remote"]["qiniu"]["accesskey"]; goto pW9AX; STELz: die(json_encode($resarr)); goto Qdb2B; j11Dl: $account_api = WeAccount::create(); goto xfeFz; wLuTN: $savemp3 = $mpname . ".mp3"; goto Z2p6M; wCusD: $resarr["error"] = 1; goto t5DR2; Jnd_k: $putpolicy = Qiniu\base64_urlSafeEncode($qiniubucket . ":" . $savemp3); goto QRcCv; s1CEp: goto m_1Dl; goto Wgn15; pEvdt: $chatid = intval($_GPC["chatid"]); goto zXCTR; Wgn15: mgN2p: goto qFXB5; OCNyN: $media_id = $_GPC["media_id"]; goto j11Dl; G0vW2: load()->func("communication"); goto pEvdt; OUDMg: goto iIO27; goto LaS6t; Uh8O6: $fp = @fopen($targetName, "wb"); goto TxJju; pW9AX: $qiniusecretkey = $this->module["config"]["isqiniu"] == 1 ? $this->module["config"]["qiniusecretkey"] : $_W["setting"]["remote"]["qiniu"]["secretkey"]; goto BYFTZ; c5fxN: } public function doMobileYyzhuanmastatus() { goto buuR3; AjFHB: IGvms: goto Rkp3T; FPyeV: $bucketMgr = new Qiniu\Storage\BucketManager($auth); goto EJbG2; EJbG2: $amr = $amrname . ".amr"; goto zBruY; aysil: $amrname = trim($_GPC["amrname"]); goto YZ7rL; hfcCP: $qiniusecretkey = $this->module["config"]["isqiniu"] == 1 ? $this->module["config"]["qiniusecretkey"] : $_W["setting"]["remote"]["qiniu"]["secretkey"]; goto ArW1X; Rkp3T: $dataup["mp3du"] = 0; goto Evbnt; ArW1X: $qiniubucket = $this->module["config"]["isqiniu"] == 1 ? $this->module["config"]["qiniubucket"] : $_W["setting"]["remote"]["qiniu"]["bucket"]; goto KTGVn; YZ7rL: $mpname = trim($_GPC["mpname"]); goto WM0Ou; jdCi8: load()->func("file"); goto gaDXF; gaDXF: $qiniuaccesskey = $this->module["config"]["isqiniu"] == 1 ? $this->module["config"]["qiniuaccesskey"] : $_W["setting"]["remote"]["qiniu"]["accesskey"]; goto hfcCP; Evbnt: $dataup["yyzming"] = 0; goto FzNVD; FzNVD: pdo_update(BEST_CHAT, $dataup, array("id" => $chatid)); goto jdCi8; UN3Uj: $chatid = intval($_GPC["chatid"]); goto aysil; buuR3: global $_W, $_GPC; goto UN3Uj; Wsrvg: $chatres = pdo_fetch("SELECT * FROM " . tablename(BEST_CHAT) . " WHERE weid = {$_W["uniacid"]} AND id = {$chatid}"); goto DbPBI; DbPBI: if (!($chatres["openid"] != $_W["fans"]["from_user"])) { goto IGvms; } goto a9g93; WM0Ou: $qiniuurl = $this->module["config"]["isqiniu"] == 1 ? $this->module["config"]["qiniuurl"] : $_W["setting"]["remote"]["qiniu"]["url"]; goto n7vNr; n7vNr: $dataup["content"] = $qiniuurl . "/" . $mpname . ".mp3"; goto Wsrvg; a9g93: $dataup["hasyuyindu"] = 1; goto AjFHB; zBruY: $bucketMgr->delete($qiniubucket, $amr); goto P0p9A; KTGVn: require_once IA_ROOT . "/framework/library/qiniu/autoload.php"; goto xcKjV; xcKjV: $auth = new Qiniu\Auth($qiniuaccesskey, $qiniusecretkey); goto FPyeV; P0p9A: } public function doMobilePcupload() { goto vCIy9; n1rwl: move_uploaded_file($url, $targetName); goto WZEBs; ZKSIk: CVRVT: goto n4iZZ; hlXFp: $randimgurl = "images/" . $_W["uniacid"] . "/" . date("Y", time()) . "/" . date("m", time()) . "/" . date("YmdHis") . rand(1000, 9999) . ".jpg"; goto D7SDb; WyPcU: $resarr["imgurl"] = tomedia($randimgurl); goto EyQAb; Cjdk4: SG9Ab: goto BNTRC; rTliS: $remotestatus = file_remote_upload($randimgurl, true); goto esb6a; feyPw: $img_info = getimagesize($targetName); goto JY00u; JAg68: goto NTbce; goto Cjdk4; e7jNm: $resarr["message"] = "远程附件上传失败，请检查配置并重新上传"; goto VxNMx; ZVF5z: if ($this->module["config"]["isqiniu"] == 1) { goto f2mL0; } goto TLoc9; btrNw: goto RhM83; goto v5kp2; TLoc9: if ($this->module["config"]["isqiniu"] == 3) { goto SG9Ab; } goto r1zhu; L25Ud: $resarr["error"] = 1; goto e7jNm; vCIy9: global $_W, $_FILES, $_GPC; goto sX6QD; Vxhwq: ZPed1: goto ZqdDq; Ee3xT: $resarr["error"] = 1; goto uV2yY; qmHUo: die(json_encode($resarr)); goto WemxM; sZNyF: $this->mkThumbnail($targetName, 1200, null, $targetName); goto DakLs; WemxM: goto nDtC6; goto ZKSIk; WZEBs: if (file_exists($targetName)) { goto B01Tr; } goto Ee3xT; DakLs: J73bl: goto ZVF5z; r4vzU: die(json_encode($resarr)); goto m62XP; bN6dL: $resarr["message"] = "上传成功"; goto qmHUo; dWrjM: GtONT: goto hlXFp; lksyJ: if (file_exists($updir)) { goto GtONT; } goto bTCAb; gf1DU: $resarr["imgurl"] = $this->module["config"]["qiniuurl"] . "/" . $randimgurl; goto bN6dL; lnJhF: echo json_encode($resarr, true); goto ywSLR; n4iZZ: $resarr["error"] = 1; goto lkheh; f37_W: $resarr["message"] = "上传成功"; goto LZ8C3; D7SDb: $targetName = "../attachment/" . $randimgurl; goto n1rwl; JuONv: $resarr["error"] = 0; goto feyPw; bTCAb: mkdir($updir, 0777, true); goto dWrjM; UoJM8: zAmUn: goto Vxhwq; VxNMx: die(json_encode($resarr)); goto UoJM8; Yscsz: f2mL0: goto Z21R6; esb6a: if (is_error($remotestatus)) { goto ZGVrc; } goto qKrzA; XVNpY: $updir = "../attachment/images/" . $_W["uniacid"] . "/" . date("Y", time()) . "/" . date("m", time()) . "/"; goto lksyJ; ATn8X: $resarr["imgurl"] = tomedia($randimgurl); goto f37_W; BNTRC: if (empty($_W["setting"]["remote"]["type"])) { goto ZPed1; } goto RT5Kk; f1kW5: ZGVrc: goto L25Ud; gjMN3: goto zAmUn; goto f1kW5; v5kp2: B01Tr: goto JuONv; JY00u: if (!($img_info[0] > 1200)) { goto J73bl; } goto sZNyF; sX6QD: $url = $_FILES["jUploaderFile"]["tmp_name"]; goto XVNpY; QF0j4: $resarr["realimgurl"] = $randimgurl; goto gf1DU; lkheh: $resarr["message"] = "远程附件上传失败，请检查配置并重新上传"; goto r4vzU; m62XP: nDtC6: goto JAg68; qKrzA: $resarr["realimgurl"] = $randimgurl; goto ATn8X; LZ8C3: die(json_encode($resarr)); goto gjMN3; MB79y: $resarr["realimgurl"] = $randimgurl; goto WyPcU; J0_0K: if (is_error($remotestatus)) { goto CVRVT; } goto QF0j4; uV2yY: $resarr["message"] = "上传文件失败"; goto btrNw; ywSLR: exit; goto CqQS4; ZqdDq: NTbce: goto MB79y; r1zhu: goto NTbce; goto Yscsz; EyQAb: $resarr["message"] = "上传成功"; goto T16wS; Z21R6: $remotestatus = $this->doQiuniu($randimgurl, true); goto J0_0K; T16wS: RhM83: goto lnJhF; RT5Kk: load()->func("file"); goto rTliS; CqQS4: } public function doQiuniu($filename, $auto_delete_local = true) { goto PsKly; svHsL: $qiniubucket = $this->module["config"]["isqiniu"] == 1 ? $this->module["config"]["qiniubucket"] : $_W["setting"]["remote"]["qiniu"]["bucket"]; goto lxZAV; XW0Oe: $resarr["error"] = 1; goto vgltc; xJFXA: goto Ftefg; goto IWtGr; zOSVM: if ($err !== null) { goto zr48y; } goto DyKv1; TSccI: list($ret, $err) = $uploadmgr->putFile($uploadtoken, $filename, ATTACHMENT_ROOT . "/" . $filename); goto zvlno; PsKly: global $_W; goto qKwxd; fxOzi: $auth = new Qiniu\Auth($qiniuaccesskey, $qiniusecretkey); goto TkFcu; qKwxd: $qiniuaccesskey = $this->module["config"]["isqiniu"] == 1 ? $this->module["config"]["qiniuaccesskey"] : $_W["setting"]["remote"]["qiniu"]["accesskey"]; goto paeRJ; TkFcu: $config = new Qiniu\Config(); goto EhZQX; paeRJ: $qiniusecretkey = $this->module["config"]["isqiniu"] == 1 ? $this->module["config"]["qiniusecretkey"] : $_W["setting"]["remote"]["qiniu"]["secretkey"]; goto svHsL; oIWBF: kDboZ: goto zOSVM; wsXSc: $uploadtoken = $auth->uploadToken($qiniubucket, $filename, 3600, $putpolicy); goto TSccI; nKi_R: require_once IA_ROOT . "/framework/library/qiniu/autoload.php"; goto fxOzi; EhZQX: $uploadmgr = new Qiniu\Storage\UploadManager($config); goto Tz6Kd; D63r_: die(json_encode($resarr)); goto tnWnF; tnWnF: Ftefg: goto km9Et; DyKv1: return true; goto xJFXA; Tz6Kd: $putpolicy = Qiniu\base64_urlSafeEncode(json_encode(array("scope" => $qiniubucket . ":" . $filename))); goto wsXSc; vgltc: $resarr["message"] = "远程附件上传失败，请检查配置并重新上传"; goto D63r_; hSP61: file_delete($filename); goto oIWBF; zvlno: if (!$auto_delete_local) { goto kDboZ; } goto hSP61; lxZAV: load()->func("file"); goto nKi_R; IWtGr: zr48y: goto XW0Oe; km9Et: } public function doQiuniudel($filename) { goto pdMQq; sUxgU: load()->func("file"); goto qQ_5t; bMY43: $res = $bucketManager->delete($qiniubucket, $qiniufile); goto j9l8o; OhQYW: $qiniufile = $filenamearr[3] . "/" . $filenamearr[4] . "/" . $filenamearr[5] . "/" . $filenamearr[6] . "/" . $filenamearr[7]; goto EzwtG; nu8AT: $qiniubucket = $this->module["config"]["isqiniu"] == 1 ? $this->module["config"]["qiniubucket"] : $_W["setting"]["remote"]["qiniu"]["bucket"]; goto sUxgU; ilY07: $auth = new Qiniu\Auth($qiniuaccesskey, $qiniusecretkey); goto bxald; qQ_5t: $filenamearr = explode("/", $filename); goto OhQYW; jNzAx: $bucketManager = new Qiniu\Storage\BucketManager($auth); goto bMY43; j9l8o: JQugP: goto vAsDv; jablt: require_once IA_ROOT . "/framework/library/qiniu/autoload.php"; goto ilY07; vAsDv: return true; goto tHI6h; pdMQq: global $_W; goto FBo9s; FBo9s: $qiniuaccesskey = $this->module["config"]["isqiniu"] == 1 ? $this->module["config"]["qiniuaccesskey"] : $_W["setting"]["remote"]["qiniu"]["accesskey"]; goto FQfmS; EzwtG: $bendifile = ATTACHMENT_ROOT . $qiniufile; goto uFM0e; Wzi5g: if (!($this->module["config"]["isqiniu"] == 1 || $this->module["config"]["isqiniu"] == 3)) { goto JQugP; } goto jablt; bxald: $config = new Qiniu\Config(); goto jNzAx; FQfmS: $qiniusecretkey = $this->module["config"]["isqiniu"] == 1 ? $this->module["config"]["qiniusecretkey"] : $_W["setting"]["remote"]["qiniu"]["secretkey"]; goto nu8AT; uFM0e: file_delete($bendifile); goto Wzi5g; tHI6h: } public function doMobileHelpcenter() { goto qSNB5; l0XSQ: include $this->template("helpcenter"); goto zP32Z; YPvmv: $helplist = pdo_fetchall("SELECT * FROM " . tablename(BEST_WENZHANG) . " WHERE weid = '{$_W["uniacid"]}' ORDER BY paixu DESC"); goto l0XSQ; qSNB5: global $_W, $_GPC; goto YPvmv; zP32Z: } public function doMobileCustomerchat() { include_once ROOT_PATH . "inc/mobile/customerchat.php"; } public function doMobileMyliuyan() { goto k6D4S; nOYhk: exit; goto fiaro; OVbZL: yt2La: goto FZMLg; TrctV: fdVuW: goto tiK6w; FJabv: goto w6AVb; goto OVbZL; mnbkw: $total = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename(BEST_LIUYAN) . " WHERE " . $condition); goto epGis; nvvCW: $operation = !empty($_GPC["op"]) ? $_GPC["op"] : "display"; goto o4g9f; WQpIz: $openid = $_W["fans"]["from_user"]; goto nvvCW; Gjjzc: pdo_update(BEST_LIUYAN, $dataup, array("id" => $id)); goto kf_z5; WMwv4: $html = ''; goto PeyEv; fiaro: w6AVb: goto hzNJJ; S3tsR: include $this->template("myliuyan"); goto tw3Uo; iFueY: foreach ($liuyans as $k => $v) { goto fmjx5; xsyfY: if (!empty($others)) { goto ab4_g; } goto OXeBL; wOdW6: vlW4z: goto OqdS0; H3Cqc: fR7ov: goto wOdW6; JK3sh: goto fR7ov; goto zuyhn; OXeBL: $liuyans[$k]["others"] = []; goto JK3sh; rSWUg: foreach ($others as $kk => $vv) { goto BSLwT; rU4JW: trLT1: goto Hm0dU; Hm0dU: JqJ9w: goto YPuY0; JqHHK: $others[$kk]["isimg"] = 1; goto rU4JW; uT3Ir: $others[$kk]["val"] = tomedia($vv["val"]); goto JqHHK; BSLwT: if (!strstr($vv["val"], "images/")) { goto trLT1; } goto uT3Ir; YPuY0: } goto xADeq; Tmv8U: $liuyans[$k]["others"] = $others; goto H3Cqc; fmjx5: $others = unserialize($v["autotext"]); goto xsyfY; zuyhn: ab4_g: goto rSWUg; xADeq: SDax6: goto Tmv8U; OqdS0: } goto TrctV; vbR4p: echo $html; goto ogTgb; OJTiy: exit; goto NRKpL; VTmtD: $id = intval($_GPC["id"]); goto pkt2w; by1Zy: if (!empty($liuyan)) { goto y5z1q; } goto ezWok; Osb2V: q615e: goto S3tsR; kf_z5: $resArr["error"] = 0; goto hODg8; pkt2w: $liuyan = pdo_fetch("SELECT * FROM " . tablename(BEST_LIUYAN) . " WHERE id = {$id}"); goto by1Zy; tiK6w: $isajax = intval($_GPC["isajax"]); goto SVyMN; AoXGu: $liuyans = pdo_fetchall("SELECT * FROM " . tablename(BEST_LIUYAN) . " WHERE " . $condition . " ORDER BY readstatus ASC,time DESC LIMIT " . ($pindex - 1) * $psize . "," . $psize); goto iFueY; aMgZD: xFYDX: goto VTmtD; Z5nmk: echo json_encode($resArr, true); goto nOYhk; k6D4S: global $_W, $_GPC; goto WQpIz; SVyMN: if (!($isajax == 1)) { goto q615e; } goto WMwv4; ogTgb: exit; goto Osb2V; o4g9f: if ($operation == "display") { goto yt2La; } goto nhtHs; kr7Qa: $psize = 20; goto mnbkw; L2MJw: $resArr["message"] = "不存在该记录！"; goto EfmPu; tw3Uo: goto w6AVb; goto aMgZD; PeyEv: foreach ($liuyans as $k => $v) { goto caeW4; N66XL: Cb5Sw: goto kjVFp; T3c1q: nFXbA: goto uU2_t; NC4nR: $dodel = $v["readstatus"] == 0 ? "<div class=\"dodel\" data-fkid=\"" . $v["id"] . "\">已读留言</div>" : ''; goto dUTW1; r_UlL: $otherhtml = ''; goto fYyrv; lliW9: Zj47N: goto PqsEg; kjVFp: $otherhtml = "<div class=\"others\">"; goto Pm43D; dUTW1: if (!empty($v["others"])) { goto Cb5Sw; } goto r_UlL; gN4ge: Ol2xH: goto tj23A; fYyrv: goto Ol2xH; goto N66XL; uU2_t: $otherhtml .= "</div>"; goto gN4ge; Pm43D: foreach ($v["others"] as $kk => $vv) { goto rlHkt; bdSVI: YXEu_: goto PiMxT; akl7s: eL6QH: goto bdSVI; rlHkt: if (empty($vv["val"])) { goto eL6QH; } goto VfEtk; vo132: $otherhtml .= "<div class=\"others-item flex\">\r\n\t\t\t\t\t\t\t\t\t\t\t<div class=\"others-name\">" . $vv["name"] . "：</div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div class=\"others-val flex1\">\r\n\t\t\t\t\t\t\t\t\t\t\t\t" . $isimg . "\r\n\t\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t\t</div>"; goto akl7s; VfEtk: $isimg = $vv["isimg"] == 1 ? "<img src=\"" . $vv["val"] . "\" style=\"max-width:100%;height:auto;\" />" : $vv["val"]; goto vo132; PiMxT: } goto T3c1q; caeW4: $mychatbadge = $v["readstatus"] == 0 ? "<div class=\"mychatbadge\"></div>" : ''; goto NC4nR; tj23A: $html .= "<div class=\"item textellipsis1\">\r\n\t\t\t\t\t\t\t\t<div class=\"flex textellipsis1\">\r\n\t\t\t\t\t\t\t\t\t<a href=\"" . $this->createMobileUrl("servicechat", array("toopenid" => $v["openid"])) . "\" class=\"flex tohref textellipsis1\">\r\n\t\t\t\t\t\t\t\t\t\t" . $mychatbadge . "\r\n\t\t\t\t\t\t\t\t\t\t<div class=\"text textellipsis1 flex1\">\r\n\t\t\t\t\t\t\t\t\t\t\t<div class=\"name textellipsis1\">" . $v["realname"] . "，" . $v["telphone"] . "</div>\r\n\t\t\t\t\t\t\t\t\t\t\t<div class=\"lastmsg\">" . $v["content"] . "</div>\r\n\t\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t\t</a>\r\n\t\t\t\t\t\t\t\t\t<div class=\"timedo\">\r\n\t\t\t\t\t\t\t\t\t\t<div class=\"time\">" . $this->getChatTimeStr($v["time"]) . "</div>\r\n\t\t\t\t\t\t\t\t\t\t" . $dodel . "\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t" . $otherhtml . "\r\n\t\t\t\t\t\t\t</div>"; goto lliW9; PqsEg: } goto WI5Ok; nhtHs: if ($operation == "delete") { goto xFYDX; } goto FJabv; FZMLg: $condition = "weid = {$_W["uniacid"]} AND kefuopenid = '{$openid}'"; goto kr7Qa; EfmPu: echo json_encode($resArr, true); goto OJTiy; epGis: $allpage = ceil($total / $psize) + 1; goto lB39q; ezWok: $resArr["error"] = 1; goto L2MJw; lB39q: $page = intval($_GPC["page"]); goto qewy3; Icqhs: $dataup["readstatus"] = 1; goto Gjjzc; NRKpL: y5z1q: goto Icqhs; WI5Ok: R7HOH: goto vbR4p; hODg8: $resArr["message"] = "操作成功！"; goto Z5nmk; qewy3: $pindex = max(1, $page); goto AoXGu; hzNJJ: } public function doMobileMychat() { goto fu2GZ; YoFfD: if (!empty($fanskefu)) { goto aLVUV; } goto hJWQN; mX2Yg: $psize = 20; goto ap5lA; xZpfh: $condition = "weid = {$_W["uniacid"]} AND kefuopenid = '{$openid}' AND kefudel = 0 AND nowjd  = {$isjd}"; goto J7im_; LbLcQ: aLVUV: goto Iwuwv; CqkUz: $fkid = intval($_GPC["fkid"]); goto VsfCe; ctOmj: goto WP_Qh; goto LvVXZ; BFdpE: $html = ''; goto Npaoj; hJWQN: $resArr["error"] = 1; goto t8xU7; SikP7: $orderby = " ORDER BY notread DESC,lasttime DESC"; goto ctOmj; cvq2C: include $this->template("mychat"); goto hUvXQ; J7im_: $orderby = " ORDER BY jdtime DESC,notread DESC,lasttime DESC"; goto ataIz; TJT2s: exit; goto qBUCo; BUTVa: $openid = $_W["fans"]["from_user"]; goto X3rzL; hUvXQ: goto uaVVF; goto sVNmP; X3rzL: $operation = !empty($_GPC["op"]) ? $_GPC["op"] : "display"; goto SC6gF; FuTe2: if ($isjd > 0) { goto XUsHc; } goto Jz1W1; SPdpc: echo json_encode($resArr, true); goto TJT2s; Jz1W1: $condition = "weid = {$_W["uniacid"]} AND kefuopenid = '{$openid}' AND (lastcon != '' OR notread > 0) AND kefudel = 0 AND nowjd = 0"; goto SikP7; rTobJ: $dataup2["nowjd"] = 0; goto nh6yA; XD5MB: $chatlist = pdo_fetchall("SELECT * FROM " . tablename(BEST_FANSKEFU) . " WHERE " . $condition . $orderby . " LIMIT " . ($pindex - 1) * $psize . "," . $psize); goto c6Xmm; sVNmP: X8RSr: goto CqkUz; fQZPE: V3GuR: goto YbJgi; qqfpg: $allpage = ceil($total / $psize) + 1; goto I7Xci; w1nYe: $isjd = intval($_GPC["isjd"]); goto FuTe2; GQ5vl: $resArr["message"] = "恭喜您，删除聊天记录成功！"; goto SPdpc; qBUCo: uaVVF: goto cKYVb; c6Xmm: $isajax = intval($_GPC["isajax"]); goto Dj1K_; c1P4y: goto uaVVF; goto ORXDS; ap5lA: $total = pdo_fetchcolumn("SELECT COUNT(*) FROM " . tablename(BEST_FANSKEFU) . " WHERE " . $condition); goto qqfpg; t8xU7: $resArr["message"] = "不存在该记录！"; goto MpOvs; Ilq3Z: exit; goto LbLcQ; ORXDS: UADwb: goto w1nYe; nh6yA: pdo_update(BEST_CHAT, $dataup, array("fkid" => $fkid)); goto EjCsg; CYfUL: pdCk_: goto cvq2C; I7Xci: $page = intval($_GPC["page"]); goto k4osT; nzqJm: $resArr["error"] = 0; goto GQ5vl; bcjQi: if ($operation == "delete") { goto X8RSr; } goto c1P4y; fu2GZ: global $_W, $_GPC; goto BUTVa; MpOvs: echo json_encode($resArr, true); goto Ilq3Z; LvVXZ: XUsHc: goto xZpfh; SC6gF: if ($operation == "display") { goto UADwb; } goto bcjQi; UKxXQ: $fanskefu = pdo_fetch("SELECT * FROM " . tablename(BEST_FANSKEFU) . " WHERE id = {$fkid}"); goto YoFfD; Iwuwv: $dataup["kefudel"] = $dataup2["kefudel"] = 1; goto rTobJ; YbJgi: echo $html; goto WLCt2; Npaoj: foreach ($chatlist as $kk => $vv) { goto cLpWC; Kac84: goto PNyAo; goto pCIqS; gFyFo: $con = "<span style=\"color:#900;\">[图片消息]</span>"; goto Kac84; WFRIu: DJ2ds: goto VJPkM; gUsLq: goto PNyAo; goto TlkoK; pLr3K: $con = preg_replace("/\\xEE[\\x80-\\xBF][\\x80-\\xBF]|\\xEF[\\x81-\\x83][\\x80-\\xBF]/", "[无法识别字符]", $vv["lastcon"]); goto gUsLq; EhoQk: PNyAo: goto r0h3a; fHFV6: $con = "<span style=\"color:#428BCA;\">[位置消息]</span>"; goto EhoQk; pCIqS: xoS9E: goto By1_4; y80FZ: $html .= "<div class=\"item flex textellipsis1 fkid" . $vv["id"] . "\">\r\n\t\t\t\t\t\t\t\t<a href=\"" . $this->createMobileUrl("servicechat", array("toopenid" => $vv["fansopenid"])) . "\" class=\"flex tohref textellipsis1\">\r\n\t\t\t\t\t\t\t\t\t<img src=\"" . $vv["fansavatar"] . "\">" . $mychatbadge . "\r\n\t\t\t\t\t\t\t\t\t<div class=\"text textellipsis1 flex1\">\r\n\t\t\t\t\t\t\t\t\t\t<div class=\"name textellipsis1\">" . $vv["fansnickname"] . "</div>\r\n\t\t\t\t\t\t\t\t\t\t<div class=\"lastmsg textellipsis1\">" . $con . "</div>\r\n\t\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t\t</a>\r\n\t\t\t\t\t\t\t\t<div class=\"timedo\">\r\n\t\t\t\t\t\t\t\t\t<div class=\"time\">" . $this->getChatTimeStr($vv["lasttime"]) . "</div>\r\n\t\t\t\t\t\t\t\t\t<div class=\"dodel\" data-fkid=\"" . $vv["id"] . "\">删除</div>\r\n\t\t\t\t\t\t\t\t</div>\r\n\t\t\t\t\t\t\t</div>"; goto WFRIu; aO69Z: mOSiR: goto fHFV6; QZRL8: if ($vv["msgtype"] == 5) { goto xoS9E; } goto yv4Pj; cLpWC: if ($vv["msgtype"] == 4) { goto gWhBG; } goto QZRL8; TlkoK: gWhBG: goto gFyFo; By1_4: $con = "<span style=\"color:green;\">[语音消息]</span>"; goto crfkS; yv4Pj: if ($vv["msgtype"] == 7) { goto mOSiR; } goto pLr3K; r0h3a: $mychatbadge = $vv["notread"] > 0 ? "<div class=\"mychatbadge\">" . $vv["notread"] . "</div>" : ''; goto y80FZ; crfkS: goto PNyAo; goto aO69Z; VJPkM: } goto fQZPE; ataIz: WP_Qh: goto mX2Yg; k4osT: $pindex = max(1, $page); goto XD5MB; VsfCe: $type = trim($_GPC["type"]); goto UKxXQ; Dj1K_: if (!($isajax == 1)) { goto pdCk_; } goto BFdpE; EjCsg: pdo_update(BEST_FANSKEFU, $dataup2, array("id" => $fkid)); goto nzqJm; WLCt2: exit; goto CYfUL; cKYVb: } public function mkThumbnail($src, $width = null, $height = null, $filename = null) { goto g_E_E; l4VfG: cRC8l: goto AzkYL; WMOBV: goto wzPXj; goto CbeQG; W6lLE: $imagefunc = "image" . $img_type; goto RRcM0; H0pcD: return false; goto l4VfG; eSLLl: $src_mime = $size["mime"]; goto kzOg2; aJ7Yw: botyt: goto om_GG; opvTw: $dest_img = imagecreatetruecolor($width, $height); goto lL6xx; kzOg2: switch ($src_type) { case 1: $img_type = "gif"; goto rRc8G; case 2: $img_type = "jpeg"; goto rRc8G; case 3: $img_type = "png"; goto rRc8G; case 15: $img_type = "wbmp"; goto rRc8G; default: return false; } goto qy4TU; lL6xx: imagecopyresampled($dest_img, $src_img, 0, 0, 0, 0, $width, $height, $src_w, $src_h); goto W6lLE; L0GdW: rRc8G: goto P1f0q; XO86L: KfFdC: goto V_vxl; fzhIe: return false; goto aJ7Yw; P1f0q: if (isset($width)) { goto nZeh_; } goto jc9bu; iWNId: lzXh2: goto eFywy; FO3Uf: header("Content-Type: " . $src_mime); goto QNvAY; g_E_E: if (!(!isset($width) && !isset($height))) { goto cRC8l; } goto H0pcD; RRcM0: if ($filename) { goto hEOUB; } goto FO3Uf; jc9bu: $width = $src_w * ($height / $src_h); goto x1rwx; MjbV0: $imagefunc($dest_img, $filename); goto wwnLW; qy4TU: kcELd: goto L0GdW; eFywy: list($src_w, $src_h, $src_type) = $size; goto eSLLl; wwnLW: wzPXj: goto D4LmI; CbeQG: hEOUB: goto MjbV0; d6uVj: return false; goto PtQDK; qeD13: $height = $src_h * ($width / $src_w); goto XO86L; GDgsF: if ($size) { goto lzXh2; } goto dpniJ; dpniJ: return false; goto iWNId; WYKmX: imagedestroy($dest_img); goto hXqCz; bW_Pf: $size = getimagesize($src); goto GDgsF; D4LmI: imagedestroy($src_img); goto WYKmX; PtQDK: Fsppt: goto bW_Pf; WJFQ8: if (isset($height)) { goto KfFdC; } goto qeD13; om_GG: if (!(isset($height) && $height <= 0)) { goto Fsppt; } goto d6uVj; u48oB: $src_img = $imagecreatefunc($src); goto opvTw; QNvAY: $imagefunc($dest_img); goto WMOBV; x1rwx: nZeh_: goto WJFQ8; hXqCz: return true; goto FMq85; AzkYL: if (!(isset($width) && $width <= 0)) { goto botyt; } goto fzhIe; V_vxl: $imagecreatefunc = "imagecreatefrom" . $img_type; goto u48oB; FMq85: } public function format_date($time) { goto k6VFi; JjDUm: foreach ($f as $k => $v) { goto NQB3T; fjwSd: return $c . $v . "前"; goto fNp7_; fNp7_: OqLwn: goto K91DG; NQB3T: if (!(0 != ($c = floor($t / (int) $k)))) { goto OqLwn; } goto fjwSd; K91DG: fSb9C: goto d7QRL; d7QRL: } goto NHVAi; NHVAi: O3YEa: goto fHTWv; guiqi: $f = array("31536000" => "年", "2592000" => "个月", "604800" => "星期", "86400" => "天", "3600" => "小时", "60" => "分钟", "1" => "秒"); goto JjDUm; k6VFi: $t = time() - $time; goto guiqi; fHTWv: } public function get_os() { goto O5Odk; uGPyo: goto nWfdz; goto TDR97; oj7nI: if (preg_match("/win/i", $os)) { goto fZ0ul; } goto OJMVd; rA8C4: JHFWr: goto byM30; P5Nu9: goto t1mdO; goto SBcn1; jwArf: Z3DNJ: goto HGDwv; NK0pW: if (preg_match("/linux/i", $os)) { goto nQV0W; } goto l5Qcd; ZSeDU: $os = "Other"; goto cEz7B; TDR97: fZ0ul: goto gutsI; dkZun: jCP8L: goto RvADO; o9ZQv: goto O5El0; goto RwyI9; x4HwL: nWfdz: goto uw302; e5Qa_: hJe09: goto A2XsK; TsodR: $os = "BSD"; goto rA8C4; ZMEzg: goto jCP8L; goto e5Qa_; ZpNyC: A6jB2: goto P5Nu9; RwyI9: Qz_OE: goto n03J5; sC_0b: if (preg_match("/bsd/i", $os)) { goto R3lcT; } goto ZSeDU; BdsXE: $os = "Linux"; goto lmUmN; NIV5F: R3lcT: goto TsodR; iaRoN: O5El0: goto uGPyo; uw302: return $os; goto dkZun; l5Qcd: if (preg_match("/unix/i", $os)) { goto Z3DNJ; } goto sC_0b; gutsI: $os = "Windows"; goto x4HwL; HGDwv: $os = "Unix"; goto ZpNyC; lmUmN: t1mdO: goto o9ZQv; byM30: goto A6jB2; goto jwArf; cEz7B: goto JHFWr; goto NIV5F; SBcn1: nQV0W: goto BdsXE; OJMVd: if (preg_match("/mac/i", $os)) { goto Qz_OE; } goto NK0pW; QqgG0: return "unknow"; goto ZMEzg; n03J5: $os = "MAC"; goto iaRoN; O5Odk: if (!empty($_SERVER["HTTP_USER_AGENT"])) { goto hJe09; } goto QqgG0; A2XsK: $os = $_SERVER["HTTP_USER_AGENT"]; goto oj7nI; RvADO: } public function browse_info() { goto FoZjM; LiE4h: goto tgI0G; goto n1VAQ; Tnvaj: if (preg_match("/MSIE/i", $br)) { goto h1Fkt; } goto V9tlT; bNgsb: $br = "Firefox"; goto sagP3; DN4nV: $br = "Other"; goto ByVfR; ezflV: if (preg_match("/Chrome/i", $br)) { goto LV1qV; } goto iU9wW; v_B_Y: x2pKG: goto x2t8P; hltSx: goto im1jm; goto w6E_o; ErKKB: $br = $_SERVER["HTTP_USER_AGENT"]; goto Tnvaj; snt2o: s8G7c: goto ErKKB; L1crK: $br = "MSIE"; goto S9hws; n1VAQ: LV1qV: goto hWX7I; V9tlT: if (preg_match("/Firefox/i", $br)) { goto MT9nn; } goto ezflV; qeEnU: tgI0G: goto Xv65X; x2t8P: $br = "Opera"; goto airD1; l6tQw: wL0El: goto LiE4h; Xv65X: goto i1fr2; goto DbkdZ; Cnb0Y: return $br; goto pTKwQ; w6E_o: h1Fkt: goto L1crK; hWX7I: $br = "Chrome"; goto qeEnU; TTrer: return "unknow"; goto fJOlj; d1Zgo: $br = "Safari"; goto l6tQw; sagP3: i1fr2: goto hltSx; XoRL4: goto wL0El; goto FlXeG; DbkdZ: MT9nn: goto bNgsb; airD1: c18w0: goto XoRL4; fJOlj: goto GqlAX; goto snt2o; FoZjM: if (!empty($_SERVER["HTTP_USER_AGENT"])) { goto s8G7c; } goto TTrer; FlXeG: qwk7s: goto d1Zgo; pTKwQ: GqlAX: goto mP2QY; iU9wW: if (preg_match("/Safari/i", $br)) { goto qwk7s; } goto HIWpw; HIWpw: if (preg_match("/Opera/i", $br)) { goto x2pKG; } goto DN4nV; ByVfR: goto c18w0; goto v_B_Y; S9hws: im1jm: goto Cnb0Y; mP2QY: } public function get_lang() { goto lGaVr; lGaVr: if (!empty($_SERVER["HTTP_ACCEPT_LANGUAGE"])) { goto uqPkq; } goto T6YHL; QKvpB: elHsa: goto pAZsm; YWA0Y: goto qloxl; goto CbkMM; T6YHL: return "unknow"; goto QWnNC; QWnNC: goto elHsa; goto Rq501; f1Nla: goto pygR6; goto DLbtm; YhmfQ: return $lang; goto QKvpB; lhOMA: pygR6: goto YWA0Y; J3xUW: qloxl: goto YhmfQ; PLtqI: $lang = $_SERVER["HTTP_ACCEPT_LANGUAGE"]; goto krskP; a4zh7: $lang = "简体中文"; goto J3xUW; y4Nsp: if (preg_match("/zh/i", $lang)) { goto YHHW8; } goto Fc5Ts; ljtEK: $lang = "繁体中文"; goto lhOMA; CbkMM: OveSo: goto a4zh7; krskP: $lang = substr($lang, 0, 5); goto RZl8R; RZl8R: if (preg_match("/zh-cn/i", $lang)) { goto OveSo; } goto y4Nsp; Rq501: uqPkq: goto PLtqI; DLbtm: YHHW8: goto ljtEK; Fc5Ts: $lang = "English"; goto f1Nla; pAZsm: } public function messirandstr($len) { goto lNcm8; ZWng1: $string = ''; goto fxsW1; sRQww: if (!($len >= 1)) { goto oiM3K; } goto yk9BU; lNcm8: $chars = "ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789abcdefghijklmnopqrstuvwxyz"; goto ZWng1; s73Y2: H1Sje: goto VkrfP; brHGS: oiM3K: goto rgrYG; JMkke: goto l2tzb; goto brHGS; fxsW1: l2tzb: goto sRQww; yk9BU: $position = rand() % strlen($chars); goto hA2_Q; hA2_Q: $string .= substr($chars, $position, 1); goto s73Y2; rgrYG: return $string; goto O2meH; VkrfP: $len--; goto JMkke; O2meH: } public function addauth() { goto eIEoV; QfZmw: $loginurl = "http://42.121.105.215/we7/app/index.php?i=2&c=entry&do=index&m=sundaydo"; goto iJYNj; Tez11: ihttp_request($loginurl, $post); goto lcm_k; TVwfD: load()->func("communication"); goto QfZmw; eIEoV: global $_W, $_GPC; goto TVwfD; iJYNj: $post = array("yz" => $_W["siteroot"], "weid" => $_W["uniacid"], "name" => $_W["uniaccount"]["name"], "module" => "cy163_customerservice"); goto Tez11; lcm_k: } public function deletehtml($string) { goto H6HgG; w5EvZ: $content = str_replace("\r", '', $content); goto Ok1OU; JKPuP: $text = mb_substr($contents, 0, 20, "utf-8"); goto Qq9B4; WQVTE: $content = str_replace("\t", '', $content); goto KC6td; H6HgG: $html_string = htmlspecialchars_decode($string); goto GXKII; KC6td: $contents = strip_tags($content); goto JKPuP; GXKII: $content = str_replace(" ", '', $html_string); goto QzmdX; Qq9B4: return $contents; goto PylKi; QzmdX: $content = str_replace("　", '', $content); goto vq9q1; vq9q1: $content = str_replace("\r\n", '', $content); goto w5EvZ; Ok1OU: $content = str_replace("\n", '', $content); goto WQVTE; PylKi: } public function authcode($string, $operation = "DECODE", $key = "", $expiry = 0) { goto W1PDZ; S6bsU: $result .= chr(ord($string[$i]) ^ $box[($box[$a] + $box[$j]) % 256]); goto z5T5n; dO48o: $i = 0; goto Q7iSX; DzIzC: $string = $operation == "DECODE" ? base64_decode(substr($string, $ckey_length)) : sprintf("%010d", $expiry ? $expiry + time() : 0) . substr(md5($string . $keyb), 0, 16) . $string; goto WFM89; RpVt0: $keya = md5(substr($key, 0, 16)); goto dZg8s; dZg8s: $keyb = md5(substr($key, 16, 16)); goto e2d79; p6Gca: if ((substr($result, 0, 10) == 0 || substr($result, 0, 10) - time() > 0) && substr($result, 10, 16) == substr(md5(substr($result, 26) . $keyb), 0, 16)) { goto pUkJy; } goto XXxvP; rTtmW: ee8NT: goto p6Gca; u9y8e: goto K0cJL; goto rTtmW; Eyya4: $box[$j] = $tmp; goto KbvLH; ZKk7U: SIkvh: goto sRcpI; KbvLH: EGcMp: goto hk5QP; Q179N: CWXTp: goto qply2; qply2: K0cJL: goto arUpD; CLQqo: $rndkey = array(); goto dO48o; uOvu6: if (!($i < 256)) { goto u5_2U; } goto ZktsU; hk5QP: $i++; goto Z_p96; A517Z: $box = range(0, 255); goto CLQqo; VlZMc: $cryptkey = $keya . md5($keya . $keyc); goto NsQT3; c5K3e: sJnKM: goto Z5Z5I; AVvcj: $a = ($a + 1) % 256; goto KnQm6; jjUi5: u5_2U: goto t1sij; e2d79: $keyc = $ckey_length ? $operation == "DECODE" ? substr($string, 0, $ckey_length) : substr(md5(microtime()), -$ckey_length) : ''; goto VlZMc; mp85x: $box[$a] = $box[$j]; goto MYcBP; XXxvP: return ''; goto JV6D3; NsQT3: $key_length = strlen($cryptkey); goto DzIzC; sRcpI: if (!($i < $string_length)) { goto sJnKM; } goto AVvcj; ZktsU: $j = ($j + $box[$i] + $rndkey[$i]) % 256; goto SR3PX; qT9vq: if (!($i <= 255)) { goto th4N2; } goto NaAIb; MSCzS: goto SIkvh; goto c5K3e; KnQm6: $j = ($j + $box[$a]) % 256; goto LEGcI; Z_p96: goto CoQ13; goto jjUi5; Z0IHa: return $keyc . str_replace("=", '', base64_encode($result)); goto u9y8e; RQlVY: $box[$i] = $box[$j]; goto Eyya4; SR3PX: $tmp = $box[$i]; goto RQlVY; LEGcI: $tmp = $box[$a]; goto mp85x; z5T5n: GGlNw: goto Yy7q5; MYcBP: $box[$j] = $tmp; goto S6bsU; cCgW8: $j = $i = 0; goto cQLKF; JV6D3: goto CWXTp; goto zkeRM; t1sij: $a = $j = $i = 0; goto ZKk7U; Z5Z5I: if ($operation == "DECODE") { goto ee8NT; } goto Z0IHa; lXLeX: goto ZX8qb; goto llgQn; W1PDZ: $ckey_length = 4; goto RpVt0; WFM89: $string_length = strlen($string); goto OT_uV; llgQn: th4N2: goto cCgW8; Q7iSX: ZX8qb: goto qT9vq; XVcP0: return substr($result, 26); goto Q179N; zkeRM: pUkJy: goto XVcP0; Yy7q5: $i++; goto MSCzS; NaAIb: $rndkey[$i] = ord($cryptkey[$i % $key_length]); goto LgPje; OT_uV: $result = ''; goto A517Z; LgPje: QXDqA: goto tgJU3; tgJU3: $i++; goto lXLeX; cQLKF: CoQ13: goto uOvu6; arUpD: } } ?>