<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="initial-scale=1.0,maximum-scale=1.0,minimum-scale=1,user-scalable=no">
    <meta content="yes" name="apple-mobile-web-app-capable">
    <meta content="black" name="apple-mobile-web-app-status-bar-style">
    <meta content="telephone=no" name="format-detection">
    <meta content="email=no" name="format-detection">
    <title>{$fansandkefu['kefunickname']}与{$fansandkefu['fansnickname']}的聊天记录</title>
    <link rel="stylesheet" href="{MD_ROOT}static/css/weui.min.css"/>
	<link rel="stylesheet" href="{MD_ROOT}static/css/jquery-weui.min.css"/>
	<link rel="stylesheet" href="{NEWSTATIC_ROOT}/common.css?v=20200520"/>
	<link rel="stylesheet" href="{MD_ROOT}/emoji/emoji.css"/>
	<link rel="stylesheet" href="{MD_ROOT}static/newui/css/swiper-3.3.1.min.css"/>
    <script>
        var deviceWidth = document.documentElement.clientWidth;
        document.documentElement.style.fontSize = deviceWidth / 7.5 + 'px';
    </script>
	{php echo register_jssdk(false);}
	<style>
	#messibox{
		width:100%;height:100%;background:#f5f5f5;
		position:absolute; 
		overflow:scroll; 
		-webkit-overflow-scrolling: touch; 
		top:0; 
		left:0; 
		bottom:0;right:0;
	}
	
	audio{max-width:100%;}

	#messibox #chatcon{background:{php echo $this->module['config']['bgcolor']};}
	
	#chatcon .right .con .concon{background:{php echo $this->module["config"]['temcolor']};}
	#messifooter .docomment{background:{php echo $this->module["config"]['temcolor']};}
	#chatcon .right .con .triangle-right{border-left:0.15rem solid {php echo $this->module["config"]['temcolor']};}
	
	.weui-dialog__btn{color:{php echo $this->module["config"]['temcolor']};}
	.weui-photo-browser-modal{z-index:99;}
	
	.jdmsg{background:#fff;padding:0.1rem 0.2rem;width:100%;}
	.jdmsg .jdnum{
		flex:1;color:#333;font-size:0.28rem;
		display:flex;align-items:center;height:0.5rem;line-height:normal;
	}
	.jdmsg .kefucenter{
		padding:0 0.2rem;background:#41D0FC;color:#fff;border-radius:0.05rem;font-size:0.24rem;margin-right:0.1rem;
		display:flex;align-items:center;height:0.5rem;line-height:normal;
	}
	.jdmsg .finishjd{
		padding:0 0.2rem;background:#41D0FC;color:#fff;border-radius:0.05rem;font-size:0.24rem;
		display:flex;align-items:center;height:0.5rem;line-height:normal;
	}
	
	.fkitem{font-size:0.28rem;margin-bottom:0.2rem;width:80%;margin:0 auto;}
	.fkitem span{color:#4B535F;}
	.fkitem strong{color:#333;margin-left:0.1rem;}
	
	#chatcon{-webkit-tap-highlight-color:transparent;}
	
	#chatcon .right .con .concon{color:{php echo $this->module["config"]['textcolor']};}
	
	.moredata{text-align:center;font-size:0.28rem;color:#ccc;padding:0.1rem 0;}
	</style>
</head>

<body>
<div id="messibox" class="messibox flex">
	<div id="chatcon" class="messibox flex1">
		{loop $chatcon $row}
			{if !empty($row['time'])}<div class="time text-c">{php echo date('Y-m-d H:i:s',$row['time'])}</div>{/if}
			<div class="{$row['class']} flex">
				<img src="{$row['avatar']}" class="avatar" />
				<div class="con flex flex1">
					<div class="triangle-{$row['class']}"></div>
					{if $row['type'] == 3 || $row['type'] == 4}
					<div class="concon"><img src="{$row['content']}" class="sssbbb" /></div>
					{elseif $row['type'] == 5 || $row['type'] == 6}
						<div class="concon voiceplay flex" data-con="{$row['content']}" data-id="{$row['id']}">
							<img src="{NEWSTATIC_ROOT}/icon/voice2.png" class="voice2" />
							<div class="flex1"></div>
						</div>
					{elseif $row['type'] == 7}
						<div class="concon toaddress flex" data-lat="{$row['address'][0]}" data-lng="{$row['address'][1]}" data-name="{$row['address'][2]}" data-address="{$row['address'][3]}">
							<img src="{NEWSTATIC_ROOT}/icon/map.png" class="map" />
							<div class="mapadd">{$row['address'][3]}</div>
							<div class="flex1"></div>
						</div>
					{else}
						<div class="concon">{$row['content']}</div>
					{/if}
					<div class="flex1"></div>
				</div>
			</div>
		{/loop}
	</div>
</div>
<!--loading页开始-->
<div class="loading hide">
	<div class="loader"></div>
</div>
<div id="voicecon" style="display:none;">
	<audio id="audio" src="{NEWSTATIC_ROOT}/bai.mp3"></audio>
</div>
<script src="{MD_ROOT}/static/newui/js/jquery-3.1.1.min.js"></script>
<script src="{MD_ROOT}/static/newui/js/jquery-weui.min.js"></script>
<script src="{MD_ROOT}static/newui/js/swiper.min.js"></script>
<script src="{MD_ROOT}static/js/jquery.form.js"></script>
<script type="text/javascript">
$("#chatcon").on("click",".sssbbb", function() {
	var that = $(this);
	$.ajax({
		url:"{php echo $this->createMobileUrl('getchatbigimg')}",
		data:{
			fkid:{$fkid},
			con:that.attr("src"),
		},
		dataType:'json',
		type:'post',        
		success:function(data){
			if(data.error == 0){
				var imglistjson = data.message.split(",");
				var pb = $.photoBrowser({
					items:imglistjson,
					initIndex:data.index,
				});
				pb.open();  //打开
			}
		},
	});
});


//播放语音
{if $this->module['config']['voiceon'] != 1}
$("#chatcon").on("click",".voiceplay", function() {
	objvoice = $(this);
	var media_id = $(this).attr('data-con');
	var chatid = objvoice.attr('data-id');
	if(media_id.indexOf(".mp3") == -1){
		$.ajax({
			url:"{php echo $this->createMobileUrl('duvoice');}",   
			type:'post', 
			data:{
				fkid:{$fkid},
				media_id:media_id,
			},
			beforeSend:function(){
				$(".loading .loader").text('语音加载中');
				$(".loading").removeClass("hide");
			},
			dataType:'json',
			success:function(data){
				wx.downloadVoice({
					serverId: media_id,
					success: function (res) {
						$(".loading .loader").text('语音播放中');
						wx.playVoice({
							localId: res.localId, // 需要播放的音频的本地ID，由stopRecord接口获得
							success: function () {
							},
							fail:function(ret){
			
							},
						});
					},
					fail:function(ret){
						$(".loading").addClass("hide");
						$.alert('语音已失效！');
					},
				});
			}
		});
	}else{
		$.ajax({
			url:"{php echo $this->createMobileUrl('duvoice');}",   
			type:'post', 
			data:{
				fkid:{$fkid},
				media_id:media_id,
			},
			beforeSend:function(){
				$(".loading .loader").text('语音加载中');
				$(".loading").removeClass("hide");
				document.getElementById('audio').play();
				document.getElementById('audio').pause();
			},
			dataType:'json',
			success:function(data){
				playMusic(media_id);
			}
		});	
	}
});
{/if}

{if $this->module['config']['voiceon'] != 2}		
	$("#chatcon").on("click",".voiceplay", function() {
		objvoice = $(this);
		var media_id = objvoice.attr('data-con');
		var chatid = objvoice.attr('data-id');
		if(media_id.indexOf(".mp3") == -1){
			$.ajax({
				url:"{php echo $this->createMobileUrl('getvoice');}",   
				type:'post', 
				data:{
					media_id:media_id,
					chatid:chatid,
				},
				beforeSend:function(){
					$(".loading .loader").text('语音加载中');
					$(".loading").removeClass("hide");
					document.getElementById('audio').play();
					document.getElementById('audio').pause();
				},
				dataType:'json',
				success:function(data){
					if (data.error == 1) {
						$(".loading").addClass("hide");
						$.alert(data.msg);
					}else{
						objvoice.attr('data-con',data.voicefile);
						objvoice.children('.weidu').remove();
						playMusic(data.voicefile);
					}
				}
			});
		}else{
			$.ajax({
				url:"{php echo $this->createMobileUrl('duvoice');}",   
				type:'post', 
				data:{
					fkid:{$fkid},
					media_id:media_id,
				},
				beforeSend:function(){
					$(".loading .loader").text('语音加载中');
					$(".loading").removeClass("hide");
					document.getElementById('audio').play();
					document.getElementById('audio').pause();
				},
				dataType:'json',
				success:function(data){
					objvoice.children('.weidu').remove();
					playMusic(media_id);
				}
			});
		}
	});
{/if}

function playMusic(path) {
	var audioEle = document.getElementById('audio');
	audioEle.src = path;
	$(".loading .loader").text('语音播放中');
	audioEle.pause();
	audioEle.currentTime = 0;
	audioEle.play();
	audioEle.addEventListener('error', function (e) {
		$(".loading").addClass("hide");
		$.alert('加载语音失败，请重新尝试！');
	});	
	audioEle.addEventListener('ended', function () {
		$(".loading").addClass("hide");
	}, false);
}

//查看QQ表情结果
function replace_em(str){
	str = str.replace(/\[em_([0-9]*)\]/g,'<img src="{MD_ROOT}/static/arclist/$1.png" style="width:0.4rem;height:0.4rem;margin-left:0.05rem;" border="0" />');
	return str;
}
function domInit(){
	$("#chatcon").animate({scrollTop:10000000},300);
	$('.concon').each(function(){
		$(this).html(replace_em($(this).html()));
	});
}
$(function(){
	domInit();
})
</script>
</body>
</html>