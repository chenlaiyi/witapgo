{template 'common/header'}

<ul class="we7-page-tab">
	<li {if $do == 'upgrade'}class="active"{/if}><a href="{php echo url('cloud/upgrade')}">系统更新</a></li>
	<li {if $do == 'setcloud'}class="active"{/if}><a href="{php echo url('cloud/upgrade/setcloud')}">更新设置</a></li>
	<li {if $do == 'setsms'}class="active"{/if}><a href="{php echo url('cloud/upgrade/setsms')}">短信管理</a></li>
</ul>

{if $do == 'setcloud'}
<div class="upgrade-content" id="js-cloud-upgrade"  ng-controller="CloudSetCtrl" ng-cloak> 
	<form action="" method="post" class="we7-form form" id="form">
	<div class="form-group">
		<label class="col-sm-2 control-label">配置说明</label>
		<div class="col-sm-10">
			<div class="form-control-static">1. 忽略更新文件：添加文件路径后，更新时此文件将不会被更新</div>
			<div class="form-control-static">2. 应用来源设置：用来切换应用的安装来源，设置为【内测版】后，可以实现部分小程序后台一键上传。</div>
		</div>
	</div>
	<div class="form-group">
		<label class="col-sm-2 control-label">忽略更新文件</label>
		<div class="col-sm-5">
			<textarea name="cloudcfg[ignore][file]" class="form-control" rows="4">{$cloudcfg['ignore']['file']}</textarea>
			<div class="help-block">填写完整的路径, 如: /xxx/xxx.jpg, 换行输入, 一行一个路径.</div>
		</div>
	</div>	
	<div class="form-group">
		<label class="col-sm-2 control-label">应用商城切换</label>
		<div class="col-sm-10">
			<input type="radio" name="cloudcfg[module_server]" id="radio_image_thumb_0" value="we7" {if  $cloudcfg['module_server'] == 'we7'} checked{/if} />
			<label for="radio_image_thumb_0" class="radio-inline">
				 正式版
			</label>
			<input type="radio" name="cloudcfg[module_server]" id="radio_image_thumb_1" value="lovev" {if $cloudcfg['module_server'] == 'lovev'} checked{/if} />
			<label for="radio_image_thumb_1" class="radio-inline">
				 内测版
			</label>
		</div>
	</div>
	<div class="form-group" >
			<div class="col-sm-offset-2 col-md-offset-2 col-lg-offset-2 col-sm-10 col-md-10 col-lg-10">

				<input name="submit" type="submit" value="提交" class="btn btn-primary span3" />
{if  ($cloudcfg['module_server'] == 'we7')}
				<input name="submit" type="submit" value="{{showtext}}" class="btn btn-danger" disabled ng-show="submitDisabled">
				<span class="btn btn-danger" ng-show="!submitDisabled" ng-click="getnew()">{{showtext}}</span>

{/if}
				<input type="hidden" name="token" value="{$_W['token']}" />
			</div>
	</div>
	</form>
	<form action="" class="we7-form form" id="form2" ng-if="showinfo">
		<div class="form-group">
			<label class="col-sm-2 control-label">TapGo 应用标识符({{moduleNum}})</label>
			<div class="col-sm-5">
				<textarea name="cloudcfg[ignore][module]" class="form-control" rows="4" readonly="readonly">{{cloudcfg.ignore.module}}</textarea>
			</div>
		</div>
		<div class="form-group">
			<label class="col-sm-2 control-label">TapGo 模板标识符({{themeNum}})</label>
			<div class="col-sm-5">
				<textarea name="cloudcfg[ignore][theme]" class="form-control" rows="4" readonly="readonly">{{cloudcfg.ignore.theme}}</textarea>
			</div>
		</div>
	</form>
</div>
<script type="text/javascript">
	angular.module('cloudUpgradeApp',[]);
	angular.module('cloudUpgradeApp').value('config',{
		'getSetInfo': "{php echo url('cloud/upgrade/get_set_info')}",
		'aaaa':'love',
		'is_we7':"{php echo $cloudcfg['module_server'] == 'we7' ? 1 : 0}"
	});
	angular.module('cloudUpgradeApp').controller('CloudSetCtrl',['$scope', '$http' , 'config' , function($scope,$http,config){
		if(config.is_we7 == '1'){
		$scope.showtext = '正在自动获取购买数据...';
		$scope.submitDisabled = true;
		$http.post(config.getSetInfo).then(function(v){
				cloudcfg=v.data;
				$scope.moduleNum = cloudcfg.ignore.module.length;
				$scope.themeNum = cloudcfg.ignore.theme.length;
				cloudcfg.ignore.module = cloudcfg.ignore.module.join('\n');
				cloudcfg.ignore.theme = cloudcfg.ignore.theme.join('\n');
				$scope.cloudcfg = cloudcfg;
				$scope.showtext = '立即同步最新购买数据';
				$scope.showinfo = 1;
				$scope.submitDisabled =0;
			},function(v){
				$scope.showtext = 'no';
				$scope.submitDisabled =1;
			}	
		);

		$scope.getnew = function(){
			$scope.showtext = '正在同步最新购买数据...';
			$scope.submitDisabled = true;
			$http.post(config.getSetInfo).then(
				function(v){
					$scope.showinfo = 1;
					$scope.submitDisabled =0;
					$scope.showtext = '立即同步最新购买数据';
					cloudcfg=v.data;
					$scope.moduleNum = cloudcfg.ignore.module.length;
					$scope.themeNum = cloudcfg.ignore.theme.length;
					cloudcfg.ignore.module = cloudcfg.ignore.module.join('\n');
					cloudcfg.ignore.theme = cloudcfg.ignore.theme.join('\n');

					$scope.cloudcfg = cloudcfg;
					util.message("数据更新完毕", '', 'success');
				}
			);
		}
		}
	}]);

	angular.bootstrap($('#js-cloud-upgrade'), ['cloudUpgradeApp']);

	$(function(){
		$('input[name="cloudcfg[module_server]"]').click(function(){
			if($(this).val() == 'lovev'){
				$('.upload-image-thumb-width-height').css('display', '');
			} else {
				$('.upload-image-thumb-width-height').css('display', 'none');
			}
		});
	});
</script>
<!------END SetCloud BBS.ZSWEIXIN.CN-------->
{/if}


{if $do == 'setsms'}
<iframe src="{php echo url('cloud/cloud-sms')}" marginheight="0" marginwidth="0" frameborder="0" style="width: 100%; height:1500px; margin: 0 auto;" scrolling="no" allowtransparency="true"></iframe>
<!------END SetSMS BBS.ZSWEIXIN.CN-------->
{/if}

{if $do == 'upgrade'}
<div class="upgrade-content" id="js-cloud-upgrade" ng-controller="CloudUpgradeCtrl" ng-cloak>
	<div class="upgrade-heading we7-padding-vertical text-center">
		<h2 class="upgrade-version">系统当前版本: {IMS_FAMILY}{IMS_VERSION}（{IMS_RELEASE_DATE}）|   <span style="color:red">{{upgrade.overdue}}</span></h2>
		<p><i class="wi wi-info-sign"></i>{{upgrade.message}}</p>
		<p ng-if="upgrade.showad" style="color:#428bca"><i class="wi wi-notice"></i>{{upgrade.ad}}</p>
	</div>
	<form action="" class="form we7-form" ng-if="upgrade && upgrade.upgrade">
		<div class="upgrade-info we7-padding-bottom">
			<div class="panel we7-panel">
				<div class="panel-heading we7-padding hidden">
					<span class="col-sm-2 we7-padding-none color-gray">最新版本</span>
					<span class="col-sm-7 we7-padding-none">TapGo {{upgrade.family}}{{upgrade.version}}【{{upgrade.release}}】版</span>
				</div>
				<div class="panel-body we7-padding">
					<div class="form-group">
						<label for="" class="control-label color-gray col-sm-2">需要更新文件</label>
						<div class="form-controls col-sm-7 form-control-static">{{upgrade.files.length > 0 ? upgrade.files.length : 0}} 个</div>
						<span class="color-default col-sm-3 text-right"><a href="#upgrade-file" data-toggle="modal" >查看</a></span>
					</div>
					<div class="form-group">
						<label for="" class="control-label color-gray col-sm-2">需要更新数据库</label>
						<div class="form-controls col-sm-7 form-control-static">{{upgrade.database.length > 0 ? upgrade.database.length : 0}} 项</div>
						<span class="color-default col-sm-3 text-right"><a href="#upgrade-databases" data-toggle="modal" >查看</a></span>
					</div>
					<div class="form-group">
						<label for="" class="control-label color-gray col-sm-2">需要更新脚本</label>
						<div class="form-controls col-sm-7 form-control-static">{{upgrade.scripts.length > 0 ? upgrade.scripts.length : 0}} 项</div>
						<span class="color-default col-sm-3 text-right"><a href="#upgrade-scripts" data-toggle="modal" >查看</a></span>
					</div>
					<div class="form-group  we7-padding-none">
						<label for="" class="control-label color-gray col-sm-2">更新协议事项</label>
						<div class="form-controls col-sm-10 form-control-static">
							<div class="">
								<input id='agreement_0' type="checkbox" name='agreement_0' autocomplete="off" />
								<label for="agreement_0">确保您的系统文件与 TapGo 官方文件保持一致，避免被非法篡改</label>
							</div>
							<div class="">
								<input id='agreement_1' type="checkbox" name='agreement_1' autocomplete="off"/>
								<label for="agreement_1">已经做好了相关文件的备份工作，认同 TapGo 的更新内容并自愿承担更新所存在的风险</label>
							</div>
							<div class="">
								<input id='agreement_2' type="checkbox" name='agreement_2' autocomplete="off"/>
								<label for="agreement_2">认同 TapGo 系统使用协议</label>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div class="text-center">
				<input type="button" name="" id="forward" value="一键更新" class="btn btn-danger" ng-click="submit()"/>
				<input name="rollback" type="button" value="撤回更新" class="btn btn-default" data-toggle="modal" data-target="#rollback-panel" />
			</div>
		</div>
	</form>
	<form action="" method="post" ng-if="!upgrade || !upgrade.upgrade">
		<div class="upgrade-info we7-padding-bottom">
			<div class="panel we7-panel">
				<div class="panel-heading we7-padding">
					<span class="we7-padding-none color-gray">当前版本为最新版本，您可以点击此按钮, 立即检查是否有新版本。</span>
				</div>
			</div>
			<div class="text-center">
				<input name="submit" type="submit" value="{{showtext}}" class="btn btn-danger" disabled ng-show="submitDisabled">
				<input name="submit" type="submit" value="{{showtext}}" class="btn btn-danger" ng-show="!submitDisabled">
				<input name="rollback" type="button" value="撤回更新" class="btn btn-default" data-toggle="modal" data-target="#rollback-panel" />
				<input type="hidden" name="token" value="{$_W['token']}" />
			</div>
		</div>
	</form>
	<div class="panel we7-panel">
		<div class="panel-heading">
			更新通知
		</div>
		<div class="panel-body we7-padding">
			<ul class="list-unstyled">
			<script type="text/javascript" src="//bbs.lovev.xin/api.php?mod=js&bid=5"></script>
			</ul>
		</div>
	</div>
	<div class="panel we7-panel" >
		<style>
			.list-wxapp{
				font-size:12px;
				color:#666;
				width:100%;
			}
			.list-wxapp li{
				float:left;
              	width: 12.5%;
                padding: 10px 0;
                text-align: center;
			}
			.list-wxapp img{
				width:60px;
				height:60px;
              	border-radius: 8px;
                margin-bottom: 15px;
                transition: all .3s;
				vertical-align: bottom;
			}
			.list-wxapp span{
			    line-height: 20px;
			    height: 20px;
              	display: block;
			}
		</style>
		<div class="panel-heading">
		专享应用
		</div>
		<div class="panel-body we7-padding">
			<ul class="list-wxapp">
			<script type="text/javascript" src="//api-wx.lovev.xin/jsdata/wxapplist/js"></script>
			</ul>
		</div>
	</div>
	<div class="modal fade" id="upgrade-file" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog we7-modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">
						<span aria-hidden="true">&times;</span>
						<span class="sr-only">Close</span>
					</button>
					<h4 class="modal-title">更新文件</h4>
				</div>
				<div class="modal-body color-dark">
					<div ng-repeat="line in upgrade.files track by $index" ng-if="upgrade.files.length > 0">{{line}}</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary"  data-dismiss="modal">确定</button>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="upgrade-databases" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog we7-modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">
						<span aria-hidden="true">&times;</span>
						<span class="sr-only">Close</span>
					</button>
					<h4 class="modal-title">更新数据库</h4>
				</div>
				<div class="modal-body color-dark">
					<div class="row" ng-repeat="database in upgrade.database" ng-if="upgrade.database">
						<div class="col-sm-2">表名:</div>
						<div class="col-sm-4" ng-bind="database.tablename"></div>
						<div class="col-sm-6" ng-if="database.new">New</div>
						<div class="col-sm-6" ng-if="!database.new">
							<span ng-if="database.fields">fields: {{database.fields}}</span>
							<span ng-if="database.indexes">indexes: {{database.indexes}}</span>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" data-dismiss="modal">确定</button>
				</div>
			</div>
		</div>
	</div>

	<div class="modal fade" id="upgrade-scripts" tabindex="-1" role="dialog" aria-hidden="true">
		<div class="modal-dialog we7-modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<button type="button" class="close" data-dismiss="modal">
						<span aria-hidden="true">&times;</span>
						<span class="sr-only">Close</span>
					</button>
					<h4 class="modal-title">更新脚本</h4>
				</div>
				<div class="modal-body color-dark">
					<div ng-repeat="scripts in upgrade.scripts" ng-if="upgrade.scripts"><span style="display:inline-block; width:100px;" ng-bind="scripts.release"></span>{{scripts.message}}</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-primary" data-dismiss="modal">确定</button>
				</div>
			</div>
		</div>
	</div>
	<div class="modal fade" id="rollback-panel" tabindex="-1" role="dialog" aria-labelledby="rollback-label">
		<div class="modal-dialog">
			<div class="modal-content">
				<div class="modal-header">
					<h4 class="modal-title">更新回滚列表</h4>
				</div>
				<div class="modal-body">
					<div class="alert alert-danger">
						如果要恢复更早的记录请直接查看 <b>/data/patch/</b> 目录
					</div>
					<div class="alert alert-success">
						恢复时，请手动将此目录中的文件上传至网站即可（选中全部文件和目录直接上传）
					</div>
					{if !empty($patchs)}
					<table class="table">
						<tr>
							<th style="width: 200px">日期</th>
							<th >路径</th>
						</tr>
						{loop $patchs $path}
						<tr>
							<td>{php echo date('Y-m-d')} {php echo substr($path, 0, 2)}:{php echo substr($path, 2, 2)}</td>
							<td>{$path}</td>
						</tr>
						{/loop}
					</table>
					{else}
					今天暂无更新
					{/if}
				</div>
			</div>
		</div>
	</div>
</div>
</div>
<script>
	angular.module('cloudUpgradeApp', []);
	angular.module('cloudUpgradeApp').value('config', {
		'links': {
			'process': "{php echo url('cloud/process')}",
			'getUpgradeInfo': "{php echo url('cloud/upgrade/get_upgrade_info')}",
		}
	});
	angular.module('cloudUpgradeApp').controller('CloudUpgradeCtrl', ['$scope', '$http', 'config', function($scope, $http, config) {
		$scope.upgrade = {};
		$scope.showtext = '正在检查更新...';
		$scope.submitDisabled = true;
		$scope.submit = function() {
			var a = $("#agreement_0").is(':checked');
			var b = $("#agreement_1").is(':checked');
			var c = $("#agreement_2").is(':checked');
			if(a && b && c) {
				if(confirm('更新将直接覆盖本地文件, 请注意备份文件和数据. \n\n**另注意** 更新过程中不要关闭此浏览器窗口.')) {
					location.href = config.links.process;
				}
			} else {
				util.message("抱歉，更新前请仔细阅读更新协议！", '', 'error');
				return false;
			}
		};
		$http.post(config.links.getUpgradeInfo)
			.success(function (data) {
				console.log(data);
				$scope.showtext = '立即检查新版本';
				$scope.submitDisabled = false;
				if (data.message.errno == 0) {
					$scope.upgrade = data.message.message;
				} else {
					util.message(data.message);
				}
				if(data.message.message.ad !== null ){
					$scope.upgrade.showad = 1;
				}
				console.log($scope.upgrade);
			});
	}]);
	angular.bootstrap($('#js-cloud-upgrade'), ['cloudUpgradeApp']);
</script>
{/if}

{template 'common/footer'}
